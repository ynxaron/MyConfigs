"use strict";(globalThis.webpackChunknotion_next=globalThis.webpackChunknotion_next||[]).push([[37554],{438665:(e,t,a)=>{a.d(t,{zL:()=>u,lB:()=>f,ZF:()=>p,DV:()=>v,an:()=>m,n9:()=>_,WV:()=>y});var r=()=>a(799891),n=()=>a(741633);const i={plans_page:["lic_25","lic_50","resurrection_offer","ai_fifty_percent_upgrade"],sidebar_upsell:["lic_25","lic_50"]};var o=()=>a(792409),s=()=>a(824462),c=()=>a(308186),l=()=>a(594546),d=()=>a(876822);async function p(e,t){var a;const{spaceId:r,offerCampaign:n}=t;if(!r||!n||null===(a=d().default.state.currentSpaceStore)||void 0===a||!a.canAdmin())return;const i=await s().callApi({eventName:"getCustomerOffer",environment:e,data:{spaceId:r,offerCampaign:n}});return"failed"!==i.type&&"offer"in i.data&&i.data.offer?i.data.offer:void 0}async function u(e){const{environment:t,spaceId:a,offerCampaign:r,entrypoint:n}=e,i=await s().callApi({eventName:"applyCustomerOffer",environment:t,data:{spaceId:a,offerCampaign:r,entrypoint:n??"unknown"}});if("failed"!==i.type)return i;c().x2(i)}async function f(e,t){const a=await s().callApi({eventName:"applyCustomerOffer",environment:e,data:{...t}});if("failed"!==a.type)return a;c().x2(a)}async function m(e){const{environment:t,spaceId:a,offerCampaign:r}=e;return void 0!==await p(t,{spaceId:a,offerCampaign:r})}async function y(e){var t;const{environment:a,hasReceived:i,offerType:c,newPlan:l,coupon:p}=e,u=null===(t=d().default.state.currentSpaceStore)||void 0===t?void 0:t.getSpaceId();if(!u)return;const f=await s().callApi({eventName:"updateCustomerOffer",environment:a,data:{spaceId:u,hasReceived:i,offerType:c,newPlan:l,coupon:p},headers:(0,n().Bb)({cellId:void 0,spaceId:u})});"failed"===f.type&&r().log({level:"error",from:"offerActions",type:"updateLegacyCustomerOfferFailed",error:(0,o().Ui)(f.error)})}async function v(e,t,a){const r=function(e){if(i.hasOwnProperty(e))return i[e]}(a);if(r)for(const n of r){const a=await p(e,{spaceId:t,offerCampaign:n});if((null==a?void 0:a.campaign)===n)return a}}function _(e){let{environment:t,spaceName:a,offerCampaign:r}=e;if(a)switch(r){case"lic_25":case"lic_50":(0,l().lu)(t,"lic_offer_eligible","lic_offer_eligible",3600,{workspace_name:a,lic_25:"lic_25"===r,lic_50:"lic_50"===r});break;case"resurrection_offer":(0,l().lu)(t,"resurrection_offer_eligible","resurrection_offer_eligible",3600,{workspace_name:a});break;default:return}}},334510:(e,t,a)=>{a.r(t),a.d(t,{applyMultiplayerReverseTrialIfEligible:()=>l().jG,applyReversePlusTrial:()=>l().tY,handleTrialUpgradeFromOnboarding:()=>l().TQ,handleTrialUpgradeFromOnboardingImpl:()=>l().M_,isEligibleForBlockLimitTimedTrial:()=>c});var r=()=>a(575861),n=()=>a(629719),i=()=>a(518019),o=()=>a(444297),s=()=>a(438665);async function c(e,t){const a=await i().Z.awaitData(e,{spaceId:null==t?void 0:t.id});if("free"!==(0,n().zt)(null==a?void 0:a.subscription))return!1;const c=null==t?void 0:t.getSetting("reach_block_limit_time");if(!c||(0,r().O5)(c)<3)return!1;if(await(0,o().n)(e))return!1;const l=t.getSpaceId();return!!(await(0,s().an)({environment:e,spaceId:l,offerCampaign:"default"}))}var l=()=>a(125165)},125165:(e,t,a)=>{a.d(t,{M_:()=>A,TQ:()=>M,jG:()=>U,tY:()=>O});a(821057);var r=()=>a(730120),n=(a(667294),()=>a(799891)),i=()=>a(629719),o=()=>a(976102),s=()=>a(681941),c=()=>a(788860),l=()=>a(792409),d=()=>a(342792),p=()=>a(979614),u=()=>a(824462),f=()=>a(308186),m=()=>a(594546),y=()=>a(876822),v=()=>a(518019),_=()=>a(749826),g=()=>a(801072),w=()=>a(444297),b=()=>a(576387),I=()=>a(438665),h=()=>a(254687),S=()=>a(548812),C=()=>a(18281),D=()=>a(419157),N=()=>a(897257),T=()=>a(723721),k=a(785893);async function A(e){var t,a;const{environment:l,stripe:d,elements:u,trialData:m,trialDays:_,sessionId:g,customerName:w,businessName:I}=e;if(!N().subscriptionDataStoreInstance.state)return void n().log({level:"error",from:"trialUpsellActions",type:"StripeError",error:{miscDataString:"Unable to get subscription data."}});if(!u||!d)return void n().log({level:"error",from:"trialUpsellActions",type:"StripeError",error:{miscDataString:"Stripe elements not initialized when user tried to upgrade"}});const{error:S}=await u.submit();if(S)return void p().iL(l,{error:"could not submit form",error_type:"payment_method"});const A=await d.createPaymentMethod({elements:u});if(A.error)return void p().iL(l,{error:A.error.message,error_type:"payment_method"});if(!A.paymentMethod)return void p().iL(l,{error:"could not create token",error_type:"payment_method"});const M={type:"paymentMethodId",value:A.paymentMethod.id},U=y().default.state.currentSpaceStore;if(!U)return;const O=U.id,E=await h().aQ({environment:l,spaceId:O}),P=await v().Z.awaitData(l,{spaceId:O});if(!P)throw new Error("Billing data not loaded");const Z=(0,i().Lg)(P),j=D().Z.state.selectedCurrencyCode??"USD",L=(0,T().Hy)(),x=(0,s().Vj)({prices:E,quantity:1,domainsQuantity:0}),B={product:L,interval:"month",currency:j},R=(0,o().dP)(x,Z,B),F=r().ou.now().plus({days:_});return await async function(e){const{environment:t,spaceStore:a,paymentData:r,desiredState:n,stripe:i,trialData:o,customerName:s,businessName:l,addressZip:d,addressCountry:u,sessionId:m}=e,y=await v().Z.awaitData(t,{spaceId:a.id});try{const e=await b().Mg({environment:t,sessionId:m,spaceStore:a,desiredState:n,paymentData:r,from:"onboarding",trialData:o,billingEmail:(0,C().pu)(y),customerName:s,businessName:l,addressZip:d,addressCountry:u}),p=e.paymentIntentClientSecret,v=e.paymentIntentStatus;if(p&&"requires_action"===v){const{error:e}=await i.handleNextAction({clientSecret:p});e&&(await b().EO({environment:t,spaceStore:a,from:"subscription_upgrade_onboarding_failed_payment"}),f().UW((0,k.jsx)(c()._H,{id:"subscription.upgrade.payment_failed",defaultMessage:"Your payment could not be processed. Please provide an alternate payment method or you will lose access to Notion."})))}return"success"}catch{return void p().Bg(t)}}({environment:l,spaceStore:U,desiredState:{...R,trialEnd:F},paymentData:M,stripe:d,subscriptionTier:(0,T().Hy)(),trialData:m,customerName:w,businessName:I,addressZip:(null===(t=A.paymentMethod.billing_details.address)||void 0===t?void 0:t.postal_code)||"",addressCountry:(null===(a=A.paymentMethod.billing_details.address)||void 0===a?void 0:a.country)||"",sessionId:g})}const M=(0,a(513670).Ds)(A,1e3,{leading:!0,trailing:!1});async function U(e){let{spaceId:t,environment:a}=e;if(await(0,I().an)({environment:a,spaceId:t,offerCampaign:"reverse"})&&(0,S().jK)(a)){await O(t,a,"going_multiplayer")&&await g().Z.resetData(a,{spaceId:t})}}async function O(e,t,a){let r="reverse";try{const n=await(0,w().n)(t),i=Boolean(_().default.checkGate({gateName:"apply_reverse_trial_key"}));n&&(r="reverse_mm_ent");const o=`${e}_timed_trial`,s=i?(0,d().Ul)(o):void 0,c=await u().callApi({eventName:"applyReverseTrial",environment:t,data:{spaceId:e,trialData:{id:r,from:a},idempotencyKey:s}});return"success"===c.type?((0,m().j)({environment:t,event:{eventName:"trial_apply_attempt",eventProperties:{trial_id:r,success:"success"===c.data.status}}}),await b().bi(t),"success"===c.data.status):(E(r,t,c.error),!1)}catch(n){return E(r,t,n),!1}}function E(e,t,a){(0,m().j)({environment:t,event:{eventName:"trial_apply_attempt",eventProperties:{trial_id:e,success:!1}}}),n().log({level:"error",from:"trialUpsellActions",type:"applyReverseTrialError",error:(0,l().Ui)(a)})}}}]);