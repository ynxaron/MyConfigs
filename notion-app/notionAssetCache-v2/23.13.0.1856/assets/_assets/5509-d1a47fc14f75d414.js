"use strict";(globalThis.webpackChunknotion_next=globalThis.webpackChunknotion_next||[]).push([[5509],{371837:(e,t,n)=>{n.d(t,{KW:()=>o().KW,wW:()=>i().getCurrentClientSessionId});var o=()=>n(105509),i=()=>n(564588)},105509:(e,t,n)=>{n.d(t,{m7:()=>C,pv:()=>R,_r:()=>_,Oz:()=>k,PH:()=>y,JD:()=>D,y0:()=>ae,a_:()=>X,KW:()=>oe});n(821057);var o=()=>n(761588),i=()=>n(799891),s=()=>n(956057),r=()=>n(792409),a=()=>n(839002),c=()=>n(326966),d=()=>n(957042),l=()=>n(205228),u=()=>n(874023),h=()=>n(895967),v=()=>n(795597),m=()=>n(876822);const g=!1;var p=()=>n(492788),f=()=>n(594546),S=()=>n(749826);function b(e,t){p().default.afterNextFlush((()=>{S().default.checkGate({gateName:"audio_processor_client_send_request_metric_enabled"})&&f().K4(e,"audio_processor.client.send_request",t)}))}var w=()=>n(564588);const k="transcription",y="vad",_="rate_limited",C="forbidden",R="openai_error",D=(0,n(59391).Z)(),I=async()=>Promise.all([n.e(52183),n.e(87168)]).then(n.bind(n,564588)),x=!1,T=90*c().C0;function B(e){return{_id:e,charactersSent:0,requestsSent:0,requestsTimedOut:0,responsesReceivedWithoutHandlers:0,successfulResponsesReceived:0,unsuccessfulResponsesReceived:0,invalidMessagesReceived:0,notificationsReceived:0,messagesReceived:0}}const A=new(n(79179).z)(20),E=new Map,M=(Date.now(),"audioProcessorInternals"),q=new(i().BatchedLogger)({from:M,type:"BulkDebug",level:"info",maxLength:250,logToConsole:x});let P,L=0,N=0,j=0,F=0,O=B(0),Z=null,U=null,W=null,G=0,$=n(158418).O,K=!1,J="uninitialized";const z=!0;function H(e){q.log({level:"info",from:M,type:e})}function V(){P=function(e){var t;const n=null==e||null===(t=e.socket)||void 0===t||null===(t=t.transport)||void 0===t||null===(t=t.query)||void 0===t?void 0:t.transport;if("websocket"===n||"polling"===n)return n}(this),H(`ping:${P}`),Z=Date.now(),de(`Incoming primus ping received from server via ${P}.`)}function Q(){return{...A.getStats()}}function Y(e){switch(q.log({level:"info",from:M,type:"readyStateChange",data:{message:e}}),W=Date.now(),e){case"end":J="closed";break;case"open":J="open";break;case"opening":J="opening"}}const X=n(513670).HP((e=>async function(e){if(g)return;L+=1;const{createClient:t}=await I(),o=t({minReconnectDelayMs:.5*c().C0,maxReconnectDelayMs:2*c().C0});return o.on("data",se),o.on("open",(()=>{v().Z.setState("connected"),H("open"),O=B(O._id+1),x&&function(){const e=Date.now(),t=20;function n(){const o=Q();if(0===o.queue&&0===o.running)return de(`Queues emptied after ${Date.now()-e} ms`),void(ee=void 0);ee=window.setTimeout(n,t)}ee&&window.clearTimeout(ee),de("Starting measurement of time until send queues are empty."),n()}()})),o.on("reconnected",(e=>{var t;(t=null==e?void 0:e.duration)&&t>1e4?ne():K=!1,q.log({level:"info",from:M,type:"reconnected",data:{message:`Reconnected in ${null==e?void 0:e.duration} ms`}})})),o.on("reconnect",(()=>{H("reconnect")})),o.on("reconnect scheduled",(e=>{(void 0===(null==e?void 0:e.attempt)||void 0===(null==e?void 0:e.duration)||e.attempt>2||e.duration>5e3||void 0===v().Z.state)&&v().Z.setState("disconnected"),q.log({level:"info",from:M,type:"reconnect scheduled",data:{message:`Reconnecting in ${null==e?void 0:e.scheduled} ms, attempt ${null==e?void 0:e.attempt} of ${null==e?void 0:e.retries}`}})})),o.on("reconnect timeout",(()=>{H("reconnect timeout")})),o.on("reconnect failed",(()=>{H("reconnect failed")})),o.on("timeout",(()=>{H("timeout")})),o.on("destroy",(()=>{H("destroy")})),o.on("close",(()=>{H("close")})),o.on("online",(()=>{H("online")})),o.on("offline",(()=>{H("offline")})),o.on("error",(e=>{let t;t="TransportError"===e.type?{level:"info",from:M,type:"primusTransportError",error:(0,r().Ui)(e)}:{level:"error",from:M,type:"unknownPrimusError",error:(0,r().Ui)(e)};(0,n(150266).lB)(1)&&i().rateLimitedLog(t),q.log(t),j+=1})),o.on("incoming::ping",V),o.on("readyStateChange",Y),o.on("end",(()=>{H("end"),o.off("readyStateChange",Y),N+=1,re(o,e)})),window.__primusClient_audioProcessor=o,o}(e)),(function(){return"primus_audioProcessor"}));let ee,te;function ne(){var e;K=!1,A.cancel(),function(){for(const e of E.values())window.clearTimeout(e.timeout);E.clear()}(),null===(e=te)||void 0===e||e()}async function oe(e){var t,n;const{base64Audio:o,environment:i,language:s}=e,r=null===(t=m().default.state.currentUserStore)||void 0===t?void 0:t.id,a=null===(n=m().default.state.currentSpaceStore)||void 0===n?void 0:n.id;var c;if(r&&a)return await(null===(c=ie({method:"audioData",request:{base64Audio:o,language:s,userId:r,spaceId:a},environment:i}))||void 0===c?void 0:c.response);{const e=r||a?r?"Space":"User":"Both";return await(0,u().stopDictation)({environment:i,error:new(h().c2)(e)})}}function ie(e){if(g)return;const{method:t,request:n,environment:o}=e;b(o,{status:"enqueued",endpoint:t});const i=A.enqueue((()=>{var i;const r=s().Il();!function(e,t){p().default.afterNextFlush((()=>{S().default.checkGate({gateName:"audio_processor_client_send_request_metric_enabled"})&&(f().K4(e,"audio_processor.client.send_request.queue_running_size",{value:t.running}),f().K4(e,"audio_processor.client.send_request.queue_backup_size",{value:t.queue}))}))}(o,A.getStats());const c=a().UZ(),d=Date.now(),u=z?window.setTimeout((()=>{"open"===J&&(O.requestsTimedOut+=1,q.log({level:"info",from:M,type:"requestTimeout",data:{requestId:r,time:Date.now()-d}}))}),T):void 0;E.set(r,{resolve:c.resolve,reject:c.reject,timeout:u,sendTime:d}),q.log({level:"info",from:M,type:"requestSent",data:{requestId:r,method:t}});const h={type:`${l().default.audioProcessor.api}/${t}`,requestId:r,...n};return O.requestsSent+=1,async function(e){const{message:t,environment:n}=e,o=JSON.stringify(t);O.charactersSent+=o.length,G<o.length&&(G=o.length);const i=await X(n);null==i||i.write(t)}({message:h,environment:o}),null===(i=e.onRequestSent)||void 0===i||i.call(e),c.promise.then((e=>{b(o,{status:"success",endpoint:t})})).catch((e=>{const n=A.getStats();b(o,{status:"failure",endpoint:t,queue_running_size:n.running,queue_backup_size:n.queue})})),c.promise}));return{response:i.catch((e=>{e instanceof ce&&!K?(K=!0,F+=1,H("connectionResetDueToFailedRequest"),X(o).then((e=>{null==e||e.end()})),de(`sendRequest() for ${t} returned server error (${e.message}), resetting connection`,n)):de(`sendRequest() cancelled or errored for ${t} (${e.message})`,n)})),asyncQueuePromise:i}}function se(e){O.messagesReceived+=1;const t=(0,d().Gu)(o().yx,e);if(t)return O.invalidMessagesReceived+=1,void i().rateLimitedLog({level:"warning",from:M,type:"ValidationError",data:{miscDataToConvertToString:e},error:(0,r().Ui)(t)});const n=e;switch(n.type){case"response":{var s;const{requestId:e,status:t,result:o}=n,i=E.get(e);if(E.delete(e),q.log({level:"info",from:M,type:"responseReceived",data:{requestId:e,response:t,time:i&&Date.now()-i.sendTime,internalProcessingTimeMs:null===(s=n.result)||void 0===s?void 0:s.internalProcessingTimeMs}}),!i)return void(O.responsesReceivedWithoutHandlers+=1);U=Date.now(),window.clearTimeout(i.timeout),"ok"===t?(O.successfulResponsesReceived+=1,i.resolve(o)):(O.unsuccessfulResponsesReceived+=1,i.reject(new ce(o)));break}case"transcription":D.emit(k,n);break;case"vad":D.emit(y,n);break;case"rate_limited":D.emit(_,n);break;case"forbidden":D.emit(C,n);break;case"openai_error":D.emit(R,n)}}function re(e,t){let n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];var o,s;n&&i().log({level:"info",from:M,type:"audioProcessorEnd",error:{message:`SocketId: ${null==e||null===(o=e.socket)||void 0===o?void 0:o.id} Query:${null==e||null===(s=e.transport)||void 0===s?void 0:s.query}`}});$.setTimeout((()=>{void 0!==e&&e.destroy()}),0),X.cache.clear(),ne(),n&&$.setTimeout((()=>{X(t)}),2*c().C0)}async function ae(e){if(e&&X.cache.has("primus_audioProcessor")){const t=await X(e);if(t){const n={type:`${l().default.audioProcessor.api}/destroySession`,requestId:s().Il()};t.write(n),t.removeAllListeners("end"),re(t,e,!1),(0,w().generateNewClientSessionId)()}}}class ce extends Error{constructor(e){super(e),this.name="FailedAudioProcessorRequestError"}}function de(){if(x){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];console.info("audioProcessorInternals:",...t)}}},564588:(e,t,n)=>{n.r(t),n.d(t,{createClient:()=>c,generateNewClientSessionId:()=>r,getCurrentClientSessionId:()=>a});var o=()=>n(956057),i=()=>n(205228);let s=o().Il();function r(){s=o().Il()}function a(){return s}function c(e){const{maxReconnectDelayMs:t,minReconnectDelayMs:o}=e,r=`${i().default.audioProcessor.url}?sessionId=${encodeURIComponent(s)}`;return new(n(952183))(r,{reconnect:{max:t,min:o,"reconnect timeout":2500,retries:1e20},timeout:2500,credentials:!0,transport:{withCredentials:!0},transportOverrides:{transports:["websocket"]}})}},874023:(e,t,n)=>{n.r(t),n.d(t,{AudioSessionBlockWriter:()=>x,DictationManager:()=>M,Segment:()=>D,StreamingDictationManager:()=>j,smartToggleDictation:()=>q,startDictation:()=>P,stopDictation:()=>L});n(821057),n(670560),n(409045),n(453627),n(994774),n(122556),n(582845),n(250570),n(533019),n(721473),n(788208),n(22624),n(995194),n(520522),n(200082),n(379976),n(724224),n(761121),n(637133),n(267602),n(916054),n(653476),n(241792),n(228244);var o,i=()=>n(156642),s=()=>n(955620),r=()=>n(79179),a=()=>n(332542),c=()=>n(636340),d=()=>n(990966),l=()=>n(269299),u=()=>n(371837),h=()=>n(105509),v=()=>n(540413),m=()=>n(718959),g=()=>n(53060),p=()=>n(239482),f=()=>n(128076),S=()=>n(931465),b=()=>n(895967),w=()=>n(283444),k=()=>n(309202),y=()=>n(539045),_=()=>n(201741),C=()=>n(354986);const R=/([\?\!\.])\s/;class D{constructor(e,t){this.id=void 0,this.text=void 0,this.isCompleteReceived=void 0,this.transcriptions=void 0,this.id=e,this.isCompleteReceived=!!t,this.transcriptions=new Map}updateText(){let e;for(const t of this.transcriptions.values()){if("pending"===t.status)break;"complete"===t.status&&(e=t.text)}this.text=e}setTranscription(e,t){this.transcriptions.set(e,t),this.updateText()}setIsCompleteReceived(e){!this.isCompleteReceived&&e&&(this.isCompleteReceived=!0)}getId(){return this.id}getText(){return this.text}isSettled(){return this.isCompleteReceived&&[...this.transcriptions.values()].every((e=>"pending"!==e.status))}}class I{constructor(e){this.blockStore=void 0,this.segments=void 0,this.isSettled=void 0;const{blockStore:t}=e;this.blockStore=t,this.segments=new Map,this.isSettled=!1}setSegment(e,t){this.segments.set(e,t)}getSegments(){return this.segments.values()}getBlockStore(){return this.blockStore}deleteSegment(e){this.segments.delete(e)}getIsSettled(){return this.isSettled}setIsSettled(e){this.isSettled=e}}class x{constructor(e){this.id=void 0,this.env=void 0,this.isCompleteReceived=void 0,this.segments=void 0,this.blockSegmentManager=void 0,this.blockSegmentManagers=void 0,this.latestSettledText=void 0;const{id:t,env:n,blockStore:o}=e,i=new I({blockStore:o});this.id=t,this.env=n,this.isCompleteReceived=!1,this.segments=new Map,this.blockSegmentManagers=new Set([i]),this.blockSegmentManager=i,this.latestSettledText=""}getEnvironment(){return this.env}getOrCreateSegment(e){const t=this.segments.get(e);if(t)return t;{const t=new D(e);return this.segments.set(e,t),this.blockSegmentManager.setSegment(e,t),t}}getBlockSegmentManager(){return this.blockSegmentManager}setIsCompleteReceived(e){!this.isCompleteReceived&&e&&(this.isCompleteReceived=!0)}getId(){return this.id}getFullText(e){return[...e.values()].map((e=>e.getText())).filter((e=>!!e)).join(" ").trim()}isSettled(){return this.isCompleteReceived&&[...this.segments.values()].every((e=>e.isSettled()))}setLatestSettledText(e){this.latestSettledText=e.trim()}getIndexOfBlockSegmentManagers(e){return Array.from(this.blockSegmentManagers).indexOf(e)}addToBlockSegmentManagers(e,t){if("number"==typeof t&&t>=0&&t<this.blockSegmentManagers.size){const n=Array.from(this.blockSegmentManagers);n.splice(t,0,e),this.blockSegmentManagers=new Set(n)}else this.blockSegmentManagers.add(e)}writeToBlock(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];const t=this.blockSegmentManager.getBlockStore(),n=this.blockSegmentManager.getBlockStore().getParentBlockStore();if(t&&t.isDictatableBlock()&&n){const o=new Map;for(const t of[...this.blockSegmentManager.getSegments()]){if(!e&&!t.isSettled())break;o.set(t.getId(),t)}const i=this.getFullText([...o.values()]),s=function(e){const t=e.split(R);for(let s=1;s<t.length;s++)"."!==t[s]&&"?"!==t[s]&&"!"!==t[s]||(t[s-1]+=t[s],t[s]="");const n=t.filter((function(e){return void 0!==e&&""!==e})),o=[];let i="";for(const s of n)i.length>=250&&(o.push(i.trim()),i=""),i+=` ${s}`;i.length>0&&(o.push(i.trim()),i="");return o}(this.latestSettledText?[this.latestSettledText,i].join(" "):i);if(s.length>1){const e=s.pop();for(const o of s){const{performResult:e}=T({environment:this.env,parentBlockStore:n,sibling:t,actionType:"before"}),i=new I({blockStore:e});i.setIsSettled(!0);const s=this.getIndexOfBlockSegmentManagers(this.blockSegmentManager);this.addToBlockSegmentManagers(i,s),B({environment:this.env,block:e,transcriptions:[{text:o,settled:!0}]})}[...o.values()].slice(-1).pop()&&e&&this.setLatestSettledText(e??"");for(const t of[...o.keys()])this.blockSegmentManager.deleteSegment(t)}const r=[];this.latestSettledText&&r.push({text:this.latestSettledText,settled:!0});for(const t of this.blockSegmentManager.getSegments()){const n=t.getText();n&&r.push({text:n,settled:t.isSettled()||e})}B({environment:this.env,block:this.blockSegmentManager.getBlockStore(),transcriptions:r})}}}function T(e){let{environment:t,parentBlockStore:n,sibling:o,actionType:s}=e;return l().createAndCommit({userAction:"dictationActions.createDictationBlock",environment:t,canUndo:!0,perform:e=>{const r=(null==o?void 0:o.getDictationRoleModel())??i().Ti.text;if(t.device.isMobile){const n=("before"===s?v().insertBlockAbove:v().insertBlockBelow)({environment:t,selection:o?[o]:[],createBlockItem:g().Hc[r],transaction:e,analyticsFrom:"dictation",preventSetSelection:!0});return d().setSelectionAtEnd({store:n.getBlockTitleStore()}),n}{const i=c().j4({environment:t,type:r,inMemoryRecordCache:n.inMemoryRecordCache,transaction:e});return"before"===s?a().SH({parentStore:n.getContentStore(),childStore:f().G.createChildStore(n.getContentStore(),i.pointer),before:null==o?void 0:o.id,transaction:e}):a().jG({parentStore:n.getContentStore(),childStore:f().G.createChildStore(n.getContentStore(),i.pointer),after:null==o?void 0:o.id,transaction:e}),i}}})}function B(e){let{environment:t,block:o,transcriptions:i}=e;if(o.isDictatableBlock()){const e=[],r=i.filter((e=>!!e.text));for(const[t,o]of r.entries()){const i=t===r.length-1?o.text:`${o.text} `,a=o.settled?(0,s().V3y)(i):(0,s().V3y)(i,[["dut",Date.now(),n(114976).LB]]);e.push(a)}l().createAndCommit({userAction:"dictationActions.updateDictatableBlock",environment:t,canUndo:!0,perform:i=>{if(!o)throw new Error("No block store provided.");n(970105).sO({environment:t,store:o.getBlockTitleStore(),value:e,transaction:i}),t.device.isMobile&&d().setSelectionAtEnd({store:o.getBlockTitleStore()})}})}}function A(e){return new Promise(((t,n)=>{try{const o=new Blob(e),i=new FileReader;i.readAsDataURL(o),i.onloadend=()=>{var e;const o=null===(e=i.result)||void 0===e?void 0:e.toString().split(",")[1];o?t(o):n(new Error("No base64Audio"))}}catch(o){n(o)}}))}function E(e,t,n){var o;if(n&&!n.pathIsDead()&&n.id!==t.id&&(null===(o=(0,p().Dg)(n))||void 0===o?void 0:o.id)===t.id){const t=n.getParentBlockStore();if(n.isEmptyDictatableBlock()&&[..._().default.state.audioSessionBlockWriters.values()].every((e=>e.getBlockSegmentManager().getBlockStore().id!==n.id)))return n;if(t)return T({environment:e,parentBlockStore:t,sibling:n,actionType:"after"}).performResult}return T({environment:e,parentBlockStore:t}).performResult}class M{static async getAllProcessableFramesAsBase64(e){const t=16*Math.max(1,e),n=Math.floor(this.audioBuffer.length/t);if(n>0){const e=n*t,o=this.audioBuffer.slice(0,e);return this.audioBuffer=this.audioBuffer.slice(e),this.audioEncoderQueue.enqueue((()=>A([o])))}return!1}static getDictationAudioRecorder(e){const{environment:t}=e,n=_().default.state.audioRecorder;return n?(n.stop(),n):new(w().hn)({onDataReceived:e=>{_().TI.state&&(this.audioBuffer=new Float32Array([...this.audioBuffer,...e]),this.getAllProcessableFramesAsBase64(96).then((e=>{if(e){const n=(0,C().PN)((0,C()._A)(t.currentUser.id));(0,u().KW)({base64Audio:e,environment:t,language:n}).catch((()=>{}))}})).catch((()=>{})))},onStop:e=>{L({environment:t,error:e})}})}static get dictationIsActive(){return Boolean(this.startController&&!this.startController.signal.aborted)}static async smartToggleDictation(e){var t;const n=(0,m().np)();return this.dictationIsActive&&(null===(t=_().default.state.pageBlock)||void 0===t?void 0:t.id)===(null==n?void 0:n.id)?this.stopDictation(e):this.startDictation(e)}static async startDictation(e){try{await this.stopDictation({environment:e.environment}),this.startController=new AbortController;const o=this.startController.signal;_().default.setState({..._().default.state,loading:!0});const s=e.blockStore??(0,m().np)(),{environment:r}=e;let a;if(e.preCreateDictationBlock&&s){const e=T({environment:r,parentBlockStore:s,sibling:void 0,actionType:"after"}).performResult;a=e,await n(492788).default.afterNextFlush((()=>{d().setSelectionAtStart({store:e.getBlockTitleStore()})}))}const c=(0,u().wW)();e.from&&(0,S().EE)(e.environment,{dictation_session_id:c,from:e.from});const l=(null==s?void 0:s.isPageBlock())||(null==s?void 0:s.isCollectionViewPageWithContent()),v=s?(0,p().eG)(s):[];if(!(v.some((e=>e.table===n(396136).iU&&e.getType()===i().Ti.transcription))&&s||l&&(0,n(23338).d)()))throw new Error("Page is not dictatable.");const g=this.getDictationAudioRecorder(e);N.start();try{const{environment:t}=e;if(await g.start(),y().ZP.setState(y().pY),o.aborted)throw new Error("start dictation aborted");const i=n(965903).default.state.stores.slice(-1).pop();await(0,h().a_)(e.environment),_().default.setState({..._().default.state,audioRecorder:g,enabled:!0,talking:!1,pageBlock:s,block:a??E(t,s,i),environment:t}),(0,S().tx)(t,{dictation_session_id:c})}catch(t){if(!o.aborted)try{const t=await y().ZP.checkPermissions();(0,S().Gf)(e.environment,{type:"mic_permissions",dictation_session_id:c,reason:t})}catch(t){}g.destroy()}}catch{this.stopDictation({environment:e.environment})}finally{_().default.setState({..._().default.state,loading:!1})}}static async stopDictation(e){if(this.startController&&!this.startController.signal.aborted){this.startController.abort();const{environment:n,error:o,from:i}=e,s=(0,u().wW)();i&&(0,S().Ue)(n,{dictation_session_id:s,from:i});const r=_().default.state.audioRecorder,a=_().default.state.enabled;_().default.setState({..._().default.state,audioRecorder:void 0,enabled:!1,loading:!1,pageBlock:void 0,block:void 0}),null==r||r.destroy();try{o instanceof b().cq?((0,S().Gf)(n,{type:"throttle",dictation_session_id:s}),(0,k().Sc)()):o instanceof b().c2?((0,S().Gf)(n,{type:"missing_user_or_space",dictation_session_id:s,reason:o.message}),(0,k().CZ)()):o instanceof b().Ay?(0,S().Gf)(n,{type:"mic_permissions",dictation_session_id:s,reason:y().ZP.state}):o instanceof b().if?((0,S().Gf)(n,{type:"forbidden",dictation_session_id:s}),(0,k().CZ)()):(o instanceof b().LN||o instanceof Error)&&(0,k().CZ)(),await(0,h().y0)(n)}catch(t){}finally{N.stop();const e=_().default.state.audioSessionBlockWriters;let t=!1;for(const n of e.values())n.writeToBlock(!0),e.delete(n.getId()),t=!0;t&&_().default.emit(),a&&(0,S().DC)(n,{dictation_session_id:s})}}}}async function q(e){return M.smartToggleDictation(e)}async function P(e){return M.startDictation(e)}async function L(e){const{environment:t,error:n,from:o}=e;return M.stopDictation({environment:t,error:n,from:o})}M.startController=void 0,M.audioBuffer=new Float32Array,M.audioEncoderQueue=new(r().z)(1);class N{constructor(){if(N.instance)return N.instance;N.instance=this}static start(){this.listening||(this.listening=!0,h().JD.on(h().Oz,N.processTranscriptionResult),h().JD.on(h().PH,N.processVadEvent),h().JD.on(h()._r,N.processRateLimitEvent),h().JD.on(h().m7,N.processForbiddenEvent),h().JD.on(h().pv,N.processOpenAIErrorEvent))}static stop(){this.listening&&(this.listening=!1,h().JD.off(h().Oz,N.processTranscriptionResult),h().JD.off(h().PH,N.processVadEvent),h().JD.off(h()._r,N.processRateLimitEvent),h().JD.off(h().m7,N.processForbiddenEvent),h().JD.off(h().pv,N.processOpenAIErrorEvent))}static processOpenAIErrorEvent(e){if(429===e.status){const{environment:t}=_().default.state;L({environment:t,error:new(b().LN)(e.message,e.status)})}}static processForbiddenEvent(e){const{environment:t}=_().default.state;L({environment:t,error:new(b().if)("Not eligible for dictation")})}static processRateLimitEvent(e){const{environment:t}=_().default.state;L({environment:t,error:new(b().cq)("Audio usage limit reached")})}static processVadEvent(e){_().default.setState({..._().default.state,talking:e.talking})}static processTranscriptionResult(e){const{audioSessionId:t,segmentId:n,isSegmentComplete:o,isAudioSessionComplete:i}=e,{enabled:s,pageBlock:r,audioSessionBlockWriters:a,environment:c,block:d}=_().default.state;let l=!1;if(!a.has(t)&&c&&s){const e=r?E(c,r,d):void 0;if(e){const n=new x({id:t,env:c,blockStore:e});a.set(t,n),l=!0,_().default.setState({..._().default.state,block:e})}else L({environment:c})}const u=a.get(t);if(u){u.setIsCompleteReceived(i);const t=u.getOrCreateSegment(n);t.setIsCompleteReceived(o),t.setTranscription(e.transcription.id,e.transcription)}for(const v of a.values())v.writeToBlock();for(const v of[...a.values()].filter((e=>e.isSettled()))){var h;a.delete(v.getId()),l=!0,s&&c&&r&&(null===(h=_().default.state.block)||void 0===h?void 0:h.id)===v.getBlockSegmentManager().getBlockStore().id&&_().default.setState({..._().default.state,block:E(c,r,_().default.state.block)})}l&&_().default.emit()}}N.instance=void 0,N.listening=!1;class j{static getAllProcessableFramesAsBase64(e){const t=16*Math.max(1,e),n=Math.floor(this.audioBuffer.length/t);if(n>0){const e=n*t,o=this.audioBuffer.slice(0,e);return this.audioBuffer=this.audioBuffer.slice(e),this.audioEncoderQueue.enqueue((()=>A([o])))}return Promise.resolve(!1)}static async start(e){try{this.isActive&&this.stop(),this.startController=new AbortController,this.env=e.environment,this.isActive=!0,this.currentTranscript="",this.segments.clear(),this.transcriptionListener=e.onTranscription,this.onErrorListener=e.onError,this.streamingSessionId=(0,u().wW)(),this.audioRecorder=new(w().hn)({onDataReceived:t=>{this.audioBuffer=new Float32Array([...this.audioBuffer,...t]),this.getAllProcessableFramesAsBase64(96).then((t=>{if(t){const n=(0,C().PN)((0,C()._A)(e.environment.currentUser.id));(0,u().KW)({base64Audio:t,environment:e.environment,language:n}).catch((()=>{}))}})).catch((()=>{}))},onStop:e=>{j.stop()}}),await this.audioRecorder.start(),h().JD.on(h().Oz,this.handleTranscriptionEvent)}catch(t){this.onErrorListener&&t instanceof Error&&this.onErrorListener(t),this.stop()}}static stop(){var e;this.isActive&&(this.isActive=!1,this.startController&&!this.startController.signal.aborted&&this.startController.abort(),h().JD.off(h().Oz,this.handleTranscriptionEvent),null===(e=this.audioRecorder)||void 0===e||e.destroy(),this.audioRecorder=void 0,this.streamingSessionId=void 0,this.env=void 0)}}o=j,j.startController=void 0,j.env=void 0,j.audioBuffer=new Float32Array,j.audioEncoderQueue=new(r().z)(1),j.audioRecorder=void 0,j.streamingSessionId=void 0,j.isActive=!1,j.transcriptionListener=void 0,j.onErrorListener=void 0,j.segments=new Map,j.currentTranscript="",j.handleTranscriptionEvent=e=>{const t=e.segmentId;let n=o.segments.get(t);n||(n=new D(t),o.segments.set(t,n)),n.setIsCompleteReceived(e.isSegmentComplete),n.setTranscription(e.transcription.id,e.transcription);const i=Array.from(o.segments.values()).map((e=>e.getText()||"")).join(" ").trim();o.currentTranscript=i,o.transcriptionListener&&o.transcriptionListener(o.currentTranscript)}},931465:(e,t,n)=>{n.d(t,{DC:()=>a,EE:()=>i,Gf:()=>c,Ue:()=>s,qZ:()=>d,tx:()=>r});var o=()=>n(594546);function i(e,t){e&&o().K4(e,"dictation_modal_open",t)}function s(e,t){e&&o().K4(e,"dictation_modal_close",t)}function r(e,t){e&&o().K4(e,"dictation_start",t)}function a(e,t){e&&o().K4(e,"dictation_end",t)}function c(e,t){e&&o().K4(e,"dictation_error",t)}function d(e,t){e&&o().K4(e,"update_dictation_language",t)}},895967:(e,t,n)=>{n.d(t,{Ay:()=>o,LN:()=>r,c2:()=>a,cq:()=>i,if:()=>s});n(821057);class o extends Error{constructor(e){super(e),this.name="DictationAudioRecorderFailedError"}}class i extends Error{constructor(e){super(e),this.name="DictationRateLimitError"}}class s extends Error{constructor(e){super(e),this.name="DictationForbiddenError"}}class r extends Error{constructor(e,t){super(e),this.status=void 0,this.status=t,this.name="DictationOpenAIError"}}class a extends Error{constructor(e){super(e),this.name="DictationMissingUserOrSpaceError"}}},283444:(e,t,n)=>{n.d(t,{hn:()=>c,oF:()=>a});n(267602),n(916054),n(470928),n(398858),n(461318),n(33228),n(409045),n(453627),n(994774),n(995194),n(520522),n(200082),n(379976),n(724224),n(761121),n(637133);class o{constructor(e,t){this._inputSampleRate=void 0,this._outputSampleRate=void 0,this._inputSampleRate=e,this._outputSampleRate=t}downsample(e){return this.downSampleAudioFrame(e,this._inputSampleRate,this._outputSampleRate)}downSampleAudioFrame(e,t,n){if(n===t||n>t)return e;const o=t/n,i=Math.round(e.length/o),s=new Float32Array(i);let r=0,a=0;for(;a<i;){const t=Math.round((a+1)*o);let n=0,i=0;for(;r<t&&r<e.length;)n+=e[r++],i++;s[a++]=n/i}return s}}var i=()=>n(982774),s=()=>n(385485),r=()=>n(452701);const a="ms_change";class c{constructor(e){this._mediaStream=void 0,this._emitter=void 0,this.recorder=void 0,this.onDataReceived=void 0,this.onStop=void 0,this.startController=void 0,this.handleDeviceChange=async()=>{var e;const t=null===(e=this.mediaStream)||void 0===e||null===(e=e.getAudioTracks()[0])||void 0===e?void 0:e.getSettings(),n=this.getPreferredOrDefaultDevice();if(!t||n&&(n.deviceId!==t.deviceId||n.groupId!==t.groupId)){this.stop(!1);try{await this.start()}catch{this.destroy()}}},this._emitter=(0,n(59391).Z)(),this.recorder=new d,this.onDataReceived=e.onDataReceived,this.onStop=e.onStop}get emitter(){return this._emitter}set mediaStream(e){var t;if(this._mediaStream)for(const n of this._mediaStream.getTracks())n.stop();if(e)for(const i of e.getTracks())i.addEventListener("ended",(async()=>{if(e.getTracks().every((e=>"ended"===e.readyState))){"allowed"!==await n(539045).ZP.checkPermissions()&&this.stop(!0,new(n(895967).Ay))}}));const o=null==e||null===(t=e.getAudioTracks()[0])||void 0===t?void 0:t.getSettings();n(892184).Z.setState(s().UR.state.find((e=>e.deviceId===(null==o?void 0:o.deviceId)))),this._mediaStream=e,this._emitter.emit(a)}get mediaStream(){return this._mediaStream}getPreferredOrDefaultDevice(){var e;return(null===(e=s().UR.state)||void 0===e?void 0:e.find((e=>{var t;return e.deviceId===(null===(t=r().Z.state)||void 0===t?void 0:t.deviceId)})))??s().UR.state[0]}async start(){if(void 0===this.startController||this.startController.signal.aborted){this.startController=new AbortController;const e=this.startController.signal,t=this.getPreferredOrDefaultDevice(),n=(0,i().G)();if(this.mediaStream=await n.getUserMedia({audio:{deviceId:t?{exact:t.deviceId}:void 0,echoCancellation:!1,noiseSuppression:!1,autoGainControl:!1,channelCount:1}}),e.aborted)return void(this.mediaStream=void 0);if(await this.recorder.record(this.mediaStream,(t=>{e.aborted||this.onDataReceived(t)}),16e3),e.aborted)return void this.recorder.releaseMediaResources();r().Z.addListener(this.handleDeviceChange),s().UR.addListener(this.handleDeviceChange)}}stop(){let e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],t=arguments.length>1?arguments[1]:void 0;void 0===this.startController||this.startController.signal.aborted||(this.startController.abort(),this.recorder.releaseMediaResources(),this.mediaStream=void 0,e&&this.onStop&&this.onStop(t),r().Z.removeListener(this.handleDeviceChange),s().UR.removeListener(this.handleDeviceChange))}destroy(){r().Z.removeListener(this.handleDeviceChange),s().UR.removeListener(this.handleDeviceChange),this.stop()}}class d{constructor(){this._audioWorkletNode=void 0,this._sourceNode=void 0,this._audioContext=void 0}set sourceNode(e){this._sourceNode&&this._sourceNode.disconnect(),this._sourceNode=e}set audioWorkletNode(e){this._audioWorkletNode&&this._audioWorkletNode.disconnect(),this._audioWorkletNode=e}set audioContext(e){this._audioContext&&this._audioContext.close(),this._audioContext=e}get audioContext(){return this._audioContext}async record(e,t,s){if(this.releaseMediaResources(),this.audioContext=(0,i().k)(s),Boolean(this.audioContext.audioWorklet))try{const i=new o(this.audioContext.sampleRate,s),r=this.audioContext.createMediaStreamSource(e);await this.audioContext.audioWorklet.addModule(new URL(n(240366),n.b));const a=new AudioWorkletNode(this.audioContext,"pcm-processor");a.port.onmessage=e=>{if(e.data){const n=e.data,o=i.downsample(n);t(o)}},r.connect(a),this._audioWorkletNode=a,this._sourceNode=r}catch{console.info("unable to create worklet"),this.releaseMediaResources()}else this.releaseMediaResources()}releaseMediaResources(){this.sourceNode=void 0,this.audioWorkletNode=void 0,this.audioContext=void 0}}},982774:(e,t,n)=>{n.d(t,{G:()=>o,k:()=>i});n(821057);function o(){const e=navigator.mediaDevices;if(e instanceof MediaDevices)return e;throw new Error("Media devices unavailable in current context.")}function i(e){const t=window.AudioContext||window.webkitAudioContext||!1;var n;if(Boolean(t))return new t({...(null===(n=navigator)||void 0===n||null===(n=n.mediaDevices)||void 0===n?void 0:n.getSupportedConstraints().sampleRate)&&{sampleRate:e}});throw new Error("Browser does not support Web Audio API (AudioContext is not available).")}},309202:(e,t,n)=>{n.d(t,{CZ:()=>g,Sc:()=>m,fB:()=>v});n(667294);var o=()=>n(788860),i=()=>n(102182),s=()=>n(527278),r=()=>n(114976),a=n(785893);const c=(0,o().vU)({dictationError:{id:"dictation.generic.snackbar.error",defaultMessage:"Dictation failed. Please try again."}});function d(){return(0,a.jsx)(o()._H,{defaultMessage:"No microphone permission. Allow access to your microphone in system settings",id:"dictation.permission.microphone.snackbar.error"})}function l(){return(0,a.jsx)(o()._H,{defaultMessage:"No microphone available. Connect your microphone in system settings",id:"dictation.unavailable.microphone.snackbar.error"})}function u(){return(0,a.jsx)(o()._H,{defaultMessage:"An unknown error occurred when trying to access the microphone.",id:"dictation.permission.unknown.snackbar.error"})}function h(){return(0,a.jsx)(o()._H,{defaultMessage:"Audio usage limit reached. Try again later.",id:"dictation.usage.snackbar.error"})}r().Zh,r().gg,r().oB;function v(e){e===r().Zh?i().lB({item:{label:(0,a.jsx)(d,{})}}):e===r().gg?i().lB({item:{label:(0,a.jsx)(l,{})}}):i().lB({item:{label:(0,a.jsx)(u,{})}})}function m(){i().oV({label:(0,a.jsx)(h,{})})}function g(){i().oV({label:s().Z.formatMessage(c.dictationError)})}},892184:(e,t,n)=>{n.d(t,{Z:()=>i});class o extends(()=>n(263184))().default{constructor(){super()}getInitialState(){}}const i=new o},539045:(e,t,n)=>{n.d(t,{ZP:()=>u,pY:()=>s});n(821057);var o=()=>n(309202);const i="initial",s="allowed",r="denied",a="no_devices",c="insecure_context",d="unknown_error";class l extends(()=>n(263184))().default{async checkPermissions(){const e=await l.checkAudioPermissionsThrottled();return this.setState(e),e}getInitialState(){return window.isSecureContext?i:c}}l.checkAudioPermissionsThrottled=(0,n(513670).P2)((async()=>{if(!window.isSecureContext)return c;try{const e=(0,n(982774).G)();return function(e){for(const t of e.getTracks())t.stop()}(await e.getUserMedia({video:!1,audio:!0})),s}catch(e){if(e instanceof Error)switch(e.name){case"NotAllowedError":return(0,o().fB)(r),r;case"NotFoundError":case"OverconstrainedError":return(0,o().fB)(a),a}return(0,o().fB)(d),d}}),1e3);const u=new l},385485:(e,t,n)=>{n.d(t,{TZ:()=>c,UR:()=>a,ZP:()=>d});n(670560),n(267602),n(653476),n(470928),n(731107);var o=()=>n(435308),i=()=>n(982774);class s extends(()=>n(263184))().default{async updateMediaDevices(){try{const e=await async function(){const e=(0,i().G)();return(await e.enumerateDevices()).reduce(((e,t)=>{if(t.kind&&t.label&&t.deviceId&&t.groupId)switch(t.kind){case"videoinput":e.videoInput.push(t);break;case"audioinput":e.audioInput.push(t);break;case"audiooutput":e.audioOutput.push(t)}return e}),{videoInput:[],audioInput:[],audioOutput:[]})}();this.setState(e)}catch{}}constructor(){super();try{(0,i().G)().addEventListener("devicechange",(()=>{this.updateMediaDevices()}))}catch{}n(539045).ZP.addListener((()=>{this.updateMediaDevices()}))}getInitialState(){return{videoInput:[],audioInput:[],audioOutput:[]}}}const r=new s,a=new(o().default)((()=>{var e,t;return(null===(e=r.state)||void 0===e||null===(e=e.audioInput)||void 0===e||null===(t=e.filter)||void 0===t?void 0:t.call(e,(e=>null==e?void 0:e.label)))??[]}),{debugName:"AudioInputDevicesStore"}),c=new(o().default)((()=>{var e;const t=n(892184).Z.state,o=null===(e=n(452701).Z.state)||void 0===e?void 0:e.label,i=a.state.find((e=>e.label===o));return t||(i||a.state[0])}),{debugName:"SelectedAudioInputDeviceStore"}),d=r},452701:(e,t,n)=>{n.d(t,{Z:()=>i});class o extends(()=>n(263184))().default{constructor(){super()}getInitialState(){}}const i=new o},354986:(e,t,n)=>{n.d(t,{PN:()=>l,TG:()=>d,Yg:()=>g,_A:()=>p});n(714566);var o=()=>n(761588),i=()=>n(35980),s=()=>n(18610),r=()=>n(371837),a=()=>n(876822),c=()=>n(931465);function d(){return Object.entries(o().jH)}function l(e){return o().jH[e][1]}function u(e){switch(e){case"en-US":default:return"English";case"de-DE":return"German";case"ko-KR":return"Korean";case"zh-CN":case"zh-TW":return"Chinese";case"ja-JP":return"Japanese";case"es-ES":case"es-LA":return"Spanish";case"pt-BR":return"Portuguese";case"fr-FR":return"French";case"da-DK":return"Danish";case"fi-FI":return"Finnish";case"nb-NO":return"Norwegian";case"nl-NL":return"Dutch";case"sv-SE":return"Swedish"}}class h extends(()=>n(263184))().default{constructor(){super(),this.lastLocalStorageRetrieval=void 0}syncLocalStorageIfNecessary(e){if(!this.lastLocalStorageRetrieval||e!==this.lastLocalStorageRetrieval[0]||Date.now()-this.lastLocalStorageRetrieval[1]>30*n(326966).C0){this.lastLocalStorageRetrieval=[e,Date.now()];const n=i().Z.get({userId:e,key:m});if(Object.hasOwn(o().jH,n))this.state!==n&&this.setState(n);else{var t;const n=u((null===(t=a().default.state.currentUserSettingsStore)||void 0===t||null===(t=t.getSettings())||void 0===t?void 0:t.preferred_locale)??s().al);n!==this.state&&this.setState(n),i().Z.set({userId:e,key:m,value:this.state})}}}getInitialState(){var e;return u((null===(e=a().default.state.currentUserSettingsStore)||void 0===e||null===(e=e.getSettings())||void 0===e?void 0:e.preferred_locale)??s().al)}}const v=new h,m="DictationLanguage";function g(e,t){(0,c().qZ)(e,{from_language:v.state,to_language:t,dictation_session_id:(0,r().wW)()}),v.setState(t),i().Z.set({userId:e.currentUser.id,key:m,value:t})}function p(e){return v.syncLocalStorageIfNecessary(e),v.state}},761588:(e,t,n)=>{n.d(t,{jH:()=>i,yx:()=>d});n(241792);var o=()=>n(124199);const i={English:["English","en"],Chinese:["Chinese","zh"],Spanish:["Spanish","es"],French:["French","fr"],German:["German","de"],Japanese:["Japanese","ja"],Korean:["Korean","ko"],Portuguese:["Portuguese","pt"],Russian:["Russian","ru"],Thai:["Thai","th"],Vietnamese:["Vietnamese","vi"],Danish:["Danish","da"],Finnish:["Finnish","fi"],Norwegian:["Norwegian","no"],Dutch:["Dutch","nl"],Swedish:["Swedish","sv"]},s=o().union([o().number(),o().string(),o().boolean(),o().isNull(),o().array(o().string())]),r=o().undefinable(s),a=(o().union([s,o().record(o().string(),s)]),o().union([r,o().record(o().string(),r)])),c=(o().union([a,o().record(o().string(),a)]),o().union([o().object({required:{id:o().string(),status:o().literal("pending"),audioDuration:o().number()},optional:{}}),o().object({required:{id:o().string(),status:o().literal("complete"),text:o().string(),audioDuration:o().number()},optional:{}}),o().object({required:{id:o().string(),status:o().literal("error"),reason:o().string(),audioDuration:o().number()},optional:{}}),o().object({required:{id:o().string(),status:o().literal("ignore"),audioDuration:o().number()},optional:{}})])),d=o().union([o().object({required:{type:o().literal("transcription"),audioSessionId:o().string(),segmentId:o().string(),transcription:c,isSegmentComplete:o().boolean(),isAudioSessionComplete:o().boolean()},optional:{}}),o().object({required:{type:o().literal("response"),status:o().literals("ok","error"),requestId:o().string(),result:o().any()},optional:{}}),o().object({required:{type:o().literal("vad"),talking:o().boolean()},optional:{}}),o().object({required:{type:o().literal("rate_limited"),status:o().literal(429),name:o().literal("UserRateLimitResponse"),message:o().string()},optional:{}}),o().object({required:{type:o().literal("forbidden"),status:o().literal(403),name:o().literal("ForbiddenError"),message:o().string()},optional:{}}),o().object({required:{type:o().literal("openai_error"),message:o().string()},optional:{status:o().number()}})]);o().object({required:{base64Audio:o().string(),userId:o().string(),spaceId:o().string()},optional:{language:o().literals(...Object.values(i).map((e=>{let[t,n]=e;return n})))}}),o().object({required:{},optional:{}}),o().object({required:{userId:o().string(),spaceId:o().string()},optional:{language:o().literals(...Object.values(i).map((e=>{let[t,n]=e;return n})))}}),o().object({required:{},optional:{}}),o().object({required:{},optional:{}}),o().object({required:{},optional:{}}),o().object({required:{},optional:{}}),o().object({required:{},optional:{}})},240366:(e,t,n)=>{e.exports=n.p+"dbc10b469ee58d20.js"},714566:(e,t,n)=>{n(79989)({target:"Object",stat:!0},{hasOwn:n(336812)})}}]);