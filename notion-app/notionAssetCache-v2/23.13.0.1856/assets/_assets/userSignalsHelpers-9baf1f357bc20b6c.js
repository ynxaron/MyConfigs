"use strict";(globalThis.webpackChunknotion_next=globalThis.webpackChunknotion_next||[]).push([[18638],{126621:(e,a,s)=>{s.r(a),s.d(a,{computeSimilarUserRecentPagesState:()=>g,fetchUserSignals:()=>v,initializeAndLoadAllUserSignals:()=>m,refreshAndBroadcastSimilarUserSignals:()=>I,setUserSignals:()=>p});s(670560),s(267602),s(30005),s(241792);var i=()=>s(741633),t=()=>s(513670),n=()=>s(824462),r=()=>s(507795),d=()=>s(749826),l=()=>s(485014),o=()=>s(768905);const c=5*s(326966).hM;function u(e){const a=d().default.getEligibleGroup({experimentId:e,parameter:"editedPagesLookbackDays",defaultGroup:"control"});return void 0===a||"control"===a?"1":a}function g(e){const a={};return e.forEach((e=>{let{userId:s,recentPages:i,similarity:n}=e;if(!i.length)return;const r=t().vM(i,(e=>{let{pageId:a}=e;return a}));Object.entries(r).forEach((e=>{let[i,t]=e;const r=t.map((e=>{let{visitedAt:a}=e;return a})).sort(((e,a)=>a-e));a[i]||(a[i]={pageId:i,sortedSimilarUserSignals:[]}),a[i].sortedSimilarUserSignals.push({userId:s,similarity:n,visitedAt:r})}))})),Object.values(a).forEach((e=>{e.sortedSimilarUserSignals.sort(((e,a)=>a.similarity-e.similarity))})),a}async function I(e){var a;const{spaceId:s,userId:i,environment:t}=e,n=await v({spaceId:s,environment:t,signalsOverride:[{name:"similarUserRecentPages",includeRecords:!0},{name:"similarUsersEditedPages",includeRecords:!0,lookbackDays:1}]});void 0!==n&&(p({spaceId:s,userId:i,environment:t,newSignals:n,initialize:!1}),await(null===(a=l().Z.state.broadcastChannel)||void 0===a?void 0:a.postMessage({type:"userSignals",data:n})))}async function m(e){const{spaceId:a,userId:s,environment:i,refreshTimer:t=c}=e,n=await v({spaceId:a,environment:i});if(void 0===n)return;p({spaceId:a,userId:s,environment:i,newSignals:n,initialize:!0});var r;"on"===d().default.getGroup("search_refresh_user_signals")?(await o().default.waitUntil((()=>Boolean(o().default.getUserSignals({spaceId:a,userId:s})))),null===(r=l().Z.state.broadcastChannel)||void 0===r||r.addEventListener("message",(e=>{"userSignals"===e.type&&p({spaceId:a,userId:s,environment:i,newSignals:e.data,initialize:!1})})),await l().Z.waitUntil((()=>Boolean(l().Z.state.elector))),l().Z.state.elector.awaitLeadership().then((()=>{o().default.update((e=>{e.refreshIntervalId&&window.clearInterval(e.refreshIntervalId);const n=window.setInterval((async()=>{await I({spaceId:a,userId:s,environment:i})}),t);return{...e,refreshIntervalId:n}}))}))):o().default.update((e=>{e.refreshIntervalId&&window.clearTimeout(e.refreshIntervalId);const n=window.setTimeout((async()=>{const e=await v({spaceId:a,environment:i});void 0!==e&&p({spaceId:a,userId:s,environment:i,newSignals:e,initialize:!1})}),t);return{...e,refreshIntervalId:n}}))}function p(e){const{spaceId:a,userId:s,environment:i,newSignals:t,initialize:n}=e;t&&(o().default.setUserSignals({spaceId:a,userId:s,userSignals:t,initialize:n}),r().S(i,n?"userSignalsInitialization":"userSignalsReload"))}async function v(e){const{spaceId:a,environment:s,signalsOverride:r}=e,d=u("search-local-edited-pages-max"),l=u("search-local-sim-users-edited-pages-max"),c=parseInt(l),I=parseInt(d),m=await n().callApi({eventName:"getUserSignals",environment:s,data:{spaceId:a,signals:r??[{name:"similarUserRecentPages",includeRecords:!0},{name:"topPages7dPageView",includeRecords:!0},{name:"editedPages",includeRecords:!0,lookbackDays:I},{name:"similarUsersEditedPages",includeRecords:!0,lookbackDays:c}]},headers:(0,i().Bb)({cellId:void 0,recordId:void 0,spaceId:a})});if("success"!==m.type)return;const p=r?t().ei((0,o().getInitialUserSignalsState)(),r.map((e=>e.name))):(0,o().getInitialUserSignalsState)();return m.data.signals.forEach((e=>{if("error"===e.status)return;const a=e.name;switch(a){case"similarUserRecentPages":p.similarUserRecentPages=g(e.data);break;case"recentPages":p.recentPages=e.data;break;case"topPages7dPageView":p.topPages7dPageView=e.data;break;case"similarUsersEditedPages":p.similarUsersEditedPages=e.data;break;case"editedPages":p.editedPages=e.data}})),p}}}]);