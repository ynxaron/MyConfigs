"use strict";(globalThis.webpackChunknotion_next=globalThis.webpackChunknotion_next||[]).push([[87647],{509417:(e,t,s)=>{s.d(t,{Vy:()=>I,YN:()=>y,fJ:()=>f,kj:()=>A,mY:()=>q});s(492176),s(7961),s(267602),s(653476),s(241792);var a=()=>s(548347),n=()=>s(255933),i=()=>s(989478),r=()=>s(513670),o=()=>s(930085),u=()=>s(395362),c=()=>s(824462),d=()=>s(784234),l=()=>s(636340),m=()=>s(269299),p=()=>s(572623),_=()=>s(779522),v=()=>s(826955),g=()=>s(219099),b=()=>s(576387);async function y(e){const{environment:t,store:s,status:a,requests:n}=e,o=t.currentUser.id;u().VM(t,{status:a,user_count:n.length,from:e.from,request_type:"member"});const c=await Promise.all(n.map((e=>h(t,{id:e.getForActorId(),table:i().KJ})))).then((e=>(0,r().oA)(e)));if("approved"===a){const e=c.map((e=>({type:"existingUser",value:e.__IM_SORRY__getValue(),spaceRole:"read_and_write"})));if(!(await d().n_({environment:t,store:s,inviteTargets:e,inviteRole:"read_and_write",isOnboarding:!1,invite:{inviteOrigin:"membership_request"}})).success)return{failedUsers:c,resolvedUsers:[]}}return m().createAndCommit({userAction:"accessRequestActions.resolveMembershipRequests",environment:t,canUndo:!0,perform:r=>{n.map((n=>{const c=new(v().oK)(t,n.pointer);l().sW({store:c,transaction:r,data:{granted_time:Date.now(),granted_by_table:i().KJ,granted_by_id:o,resolved_time:Date.now(),resolved_by_table:i().KJ,resolved_by_id:o,status:a}}),u().O8(t,{status:a,request_id:n.id,from:e.from,for_actor_id:n.for_actor_id,space_role:s.getRole()})}))}}),{failedUsers:[],resolvedUsers:c}}async function f(e){const{environment:t,store:s,status:a,requests:n}=e,c=t.currentUser.id;u().VM(t,{status:a,user_count:n.length,from:e.from,request_type:"member"});const p=await Promise.all(n.map((e=>h(t,{id:e.getForActorId(),table:i().KJ})))).then((e=>(0,r().oA)(e)));if("approved"===a){const e=p.map((e=>({type:"existingUser",value:e.__IM_SORRY__getValue(),spaceRole:"read_and_write"})));if(!(await d().n_({environment:t,store:s,inviteTargets:e,inviteRole:"read_and_write",isOnboarding:!1,invite:{inviteOrigin:"membership_request"}})).success)return{failedUsers:p,resolvedUsers:[]};const a=s.id,n=await _().Z.awaitData(t,{spaceId:a}),i=n?n.map((e=>e.domain.url)):[];o().oI(t,{invite_flow_id:void 0,invite_origin:"membership_request",user_ids:p.map((e=>e.id)),internal_domains:i})}return m().createAndCommit({userAction:"accessRequestActions.resolveMembershipRequests",environment:t,canUndo:!0,perform:e=>{n.map((s=>{const n=new(v().oK)(t,s.pointer);l().sW({store:n,transaction:e,data:{granted_time:Date.now(),granted_by_table:i().KJ,granted_by_id:c,resolved_time:Date.now(),resolved_by_table:i().KJ,resolved_by_id:c,status:a,type:"space_membership_request"}})}))}}),{failedUsers:[],resolvedUsers:p}}async function q(e){const{environment:t,status:s,requests:a,from:n}=e;u().VM(t,{status:s,user_count:a.length,from:n,request_type:"guest"});const d=await Promise.all(a.map((async e=>{var a,r,d;const l=await h(t,{id:e.getForActorId(),table:i().KJ});if(!l)return{type:"failed",user:void 0};if(!e.isGuestInviteRequest())return{type:"failed",user:l};const m=await c().callApi({eventName:"resolveAccessRequest",environment:t,data:{accessRequestId:e.id,status:s,spaceId:e.getParentId()}}),_=null===(a=e.getAttributes().permission_records_and_roles.at(0))||void 0===a?void 0:a.role,v=null===(r=e.getAttributes().permission_records_and_roles.at(0))||void 0===r?void 0:r.id,g=(null===(d=e.getAttributes().invite_message)||void 0===d?void 0:d.length)??0;return"success"===m.type&&"approved"===s&&o().jB(t,{role:_,is_space:!1,invite_targets:[{type:"existingUser",value:{id:l.id,version:0,email:l.getEmail()},spaceRole:"none"}],is_onboarding:!1,invite_origin:"guest_invite_request",permission_items:[{type:"user_permission",role:_,user_id:l.id}],invite_message_length:g,domainType:(0,p().JF)()}),"success"===m.type&&u().Cg(t,{status:s,request_id:e.id,for_actor_id:e.getForActorId(),created_by_id:e.getCreatedById(),requested_page_id:v,requested_role:_,from:n}),{type:m.type,user:l}})));await b().bi(t);const l=d.filter((e=>"failed"===e.type)).map((e=>e.user)),m=d.filter((e=>"success"===e.type)).map((e=>e.user));return{failedUsers:(0,r().oA)(l),resolvedUsers:(0,r().oA)(m)}}async function A(e){if(g().Z.reset(),!e.canAdmin)return;const{environment:t,spaceId:s}=e,a=await c().callApi({eventName:"getUnreadAccessRequestCount",environment:t,data:{parentTable:n().bx,parentId:s,size:1}});"success"===a.type&&g().Z.setState({spaceId:s,count:a.data.count})}async function I(e,t,s){const n=function(e){return Object.values((0,r().vM)(e,(e=>function(e){if(e.isGuestInviteRequest()){const t=e.getAttributes().permission_records_and_roles[0];return`guest_invite_${e.getForActorId()}:${null==t?void 0:t.id}:${e.getCreatedById()}`}return e.isSpaceMembershipRequest()?`space_membership_${e.getForActorId()}:${e.getCreatedById()}}`:e.isTeamMembershipRequest()?void 0:void e.isPageAccessRequest()}(e)))).map((e=>{const t=(0,r().MR)(e,(e=>e.getCreatedTime()));return t[t.length-1]}))}(await Promise.all(s.map((async t=>{const s=a().J8,n=new(v().oK)(e,{table:s,id:t});return await n.load(),n.getModel()}))).then((e=>(0,r().oA)(e)))),o=await function(e,t){const s=Object.values((0,r().vM)(t,(e=>function(e){if(e.isGuestInviteRequest()){const t=e.getAttributes().permission_records_and_roles[0];return`guest_invite_${e.getForActorId()}:${null==t?void 0:t.id}:${null==t?void 0:t.role}`}return e.isSpaceMembershipRequest()?`space_membership_${e.getForActorId()}`:e.isTeamMembershipRequest()?void 0:void e.isPageAccessRequest()}(e))));return Promise.all(s.map((async t=>{const s=(0,r().MR)(t,(e=>e.getCreatedTime())),a=s[0];return{createdByActorsWithReason:await Promise.all(s.map((async t=>{const s=await h(e,{id:t.created_by_id,table:i().KJ});if(s)return{actor:s,reason:t.message}}))).then((e=>(0,r().oA)(e))),accessRequest:a}})))}(e,n);return Promise.all(o.map((async t=>{const s=await h(e,{id:t.accessRequest.getForActorId(),table:i().KJ});if(s)return{forActor:s,...t}}))).then((e=>(0,r().oA)(e)))}async function h(e,t){const s=new(v().U6)(e,t);return await s.load(),s.getModel()}},594777:(e,t,s)=>{s.d(t,{U:()=>r});s(241792);var a=()=>s(219727),n=()=>s(142735),i=()=>s(779522);function r(e){const t=(0,a().O7)();return(0,n().VK)((()=>{var s;const a=null==e?void 0:e.id;if(a)return null===(s=i().Z.getData(t,{spaceId:a}))||void 0===s?void 0:s.map((e=>e.domain))}),[t,e])}},613119:(e,t,s)=>{s.d(t,{v:()=>_,E:()=>v});s(492176),s(7961),s(241792);var a=()=>s(219727),n=()=>s(142735),i=()=>s(217388),r=()=>s(989478),o=()=>s(513670),u=s(667294),c=()=>s(429490);var d=()=>s(826955),l=()=>s(367246),m=()=>s(897257),p=()=>s(591914);function _(e){var t;let{spaceStore:s,request:i}=e;const u=(0,a().O7)(),c=(0,n().VK)((()=>{if(i)return new(d().U6)(u,{id:i.getForActorId(),table:r().KJ}).getModel()}),[i,u]),l=i&&c?{accessRequest:i,forActor:c}:void 0;return null===(t=v({spaceStore:s,requests:(0,o().oA)([l])}))||void 0===t?void 0:t.at(0)}function v(e){let{spaceStore:t,requests:s}=e;const r=function(e){let{spaceStore:t,requests:s}=e;const i=(0,a().O7)(),r=function(e){const t=(0,c().U)(e);return(0,u.useCallback)((e=>t.memberEmails.has(e)?"member":t.guestEmails.has(e)?"guest":void 0),[t])}(m().subscriptionDataStoreInstance),o=(0,n().VK)((()=>null==s?void 0:s.map((e=>({email:e.forActor.email,currentRole:r(e.forActor.email)})))),[s,r]),d=i.currentUser.id,_=d?(0,p().VK)(t,d):void 0;return(0,l().WT)({space:t,spaceUser:_,team:void 0,optimism:"optimistic",invitees:o??[],publicPageDataGuestSetting:void 0})}({spaceStore:t,requests:s});return(0,n().VK)((()=>null==s?void 0:s.map((e=>{var t;const s=(0,i().Z)(e.accessRequest),a=null==r||null===(t=r[e.forActor.email])||void 0===t?void 0:t.type;return"guest_invite_request"!==s?s:"cannot_add"===a?"space_membership_request":"guest_invite_request"}))),[s,r])}},847354:(e,t,s)=>{s.d(t,{u:()=>u});var a=()=>s(219727),n=()=>s(142735),i=()=>s(658096),r=()=>s(749826);const o=new(s(168469).q)((e=>{if("block-space"===e.type)return`${e.type}-${e.blockId}-${e.spaceId}`;(0,s(696459).t1)(e.type)}),(async(e,t)=>{const a=await Promise.resolve().then(s.bind(s,824462)),n={[s(547913).YM]:t.spaceId},i=await a.callApi({eventName:"getPublicPageData",environment:e,data:t,headers:n});return"success"===i.type?i.data:void 0}));function u(e){const{blockStore:t}=e,s=(0,a().O7)();return(0,n().VK)((()=>{const e=t.id,a=t.getSpaceId(),n=i().default.state.publicPageData;if(r().default.checkGate({gateName:"ui_guest_disable_changes"})){var u;if((null==n?void 0:n.pageId)===e)return(null==n||null===(u=n.securitySettings)||void 0===u?void 0:u.guestSetting)??{type:"can_add"};{var c;const t=o.getData(s,{type:"block-space",blockId:e,spaceId:a});return(null==t||null===(c=t.securitySettings)||void 0===c?void 0:c.guestSetting)??{type:"can_add"}}}}),[t,s])}},429490:(e,t,s)=>{s.d(t,{U:()=>c});s(122556),s(582845),s(250570),s(533019),s(721473),s(788208),s(22624),s(267602),s(653476),s(241792);var a=()=>s(219727),n=()=>s(142735),i=()=>s(989478),r=()=>s(696459),o=()=>s(826955),u=()=>s(18281);function c(e){const t=(0,a().O7)();return(0,n().VK)((()=>{const s=e.state;if(!s)return{memberEmails:new Set,guestEmails:new Set};const a=u().hn(s),n=u().ND(s),c=e=>new(o().U6)(t,{table:i().KJ,id:e.userId}).getEmail();return{memberEmails:new Set(a.map(c).filter(r().$K)),guestEmails:new Set(n.map(c).filter(r().$K))}}),[t,e])}},219099:(e,t,s)=>{s.d(t,{Z:()=>n});class a extends(()=>s(263184))().default{getInitialState(){return{count:0}}}const n=new a},367246:(e,t,s)=>{s.d(t,{AW:()=>d,WT:()=>l});var a=()=>s(219727),n=()=>s(142735),i=()=>s(557876),r=()=>s(594777),o=()=>s(847354),u=()=>s(458335),c=()=>s(815277);function d(e){let{space:t,team:s,spaceUser:a,invitees:u,blockStore:d}=e;const l=(0,n().VK)((()=>null==a?void 0:a.getUserId()),[a]),v=(0,c().oo)({name:"internal_guests",spaceId:null==t?void 0:t.id,userId:l,amount:0}),g=(0,c().oo)({name:"guests",spaceId:null==t?void 0:t.id,userId:l,amount:0}),b=(0,o().u)({blockStore:d}),y=m(t),f=p(a),q=_(f,s),A=(0,r().U)(t);return(0,n().VK)((()=>{if(y&&f&&g&&v&&A)return(0,i().CR)({space:y,domains:A,team:q,spaceUser:f,invitees:u,internalGuestFeatureAvailability:v,guestFeatureAvailability:g,publicPageDataGuestSetting:b})}),[y,q,v,g,f,u,A,b])}function l(e){let{space:t,team:s,spaceUser:a,invitees:o,optimism:u="pessimistic",publicPageDataGuestSetting:d}=e;const l=(0,n().VK)((()=>null==a?void 0:a.getUserId()),[a]),v=(0,c().oo)({name:"internal_guests",spaceId:null==t?void 0:t.id,userId:l,amount:0}),g=(0,c().oo)({name:"guests",spaceId:null==t?void 0:t.id,userId:l,amount:0}),b=m(t),y=p(a),f=_(y,s),q=(0,r().U)(t);return(0,n().VK)((()=>{if(b&&y&&g&&v&&q)return(0,i().Lw)({space:b,domains:q,team:f,spaceUser:y,invitees:o,optimism:u,guestFeatureAvailability:g,internalGuestFeatureAvailability:v,publicPageDataGuestSetting:d})}),[b,y,q,f,o,g,v,u,d])}function m(e){const t=(0,a().O7)(),s=(0,n().VK)((()=>null==e?void 0:e.getModel()),[e]),i=(0,n().VK)((()=>{if(null==e||!e.id)return;const s=u().Z.getData(t,{spaceId:e.id});return s?{id:s.id,disable_guests:s.disableGuests,getSettings:()=>({disable_membership_requests:!1,enable_guest_invite_requests:s.enableGuestInviteRequest})}:void 0}),[e,t]);return s??i}function p(e){return(0,n().VK)((()=>null==e?void 0:e.getModel()),[e])??{isMember:()=>!1,isWorkspaceOwner:()=>!1}}function _(e,t){const s=(0,n().VK)((()=>null==t?void 0:t.getModel()),[t]);return(0,n().VK)((()=>null==e?void 0:e.isMember()),[e])?s:{getDisableGuests:()=>!1}}},217388:(e,t,s)=>{s.d(t,{Z:()=>n});var a=()=>s(696459);function n(e){return e.isGuestInviteRequest()?"guest_invite_request":e.isPageAccessRequest()?"page_access_request":e.isSpaceMembershipRequest()?"space_membership_request":e.isTeamMembershipRequest()?"team_membership_request":void(0,a().t1)(e)}},557876:(e,t,s)=>{s.d(t,{CR:()=>o,I2:()=>p,Lw:()=>u,tV:()=>m,tX:()=>l});s(267602),s(653476),s(241792),s(228244);var a=()=>s(513670),n=()=>s(696459),i=()=>s(446866),r=()=>s(703976);function o(e){let{space:t,domains:s,team:i,spaceUser:r,invitees:o,internalGuestFeatureAvailability:c,guestFeatureAvailability:l,publicPageDataGuestSetting:m}=e;const p=u({domains:s,internalGuestFeatureAvailability:c,guestFeatureAvailability:l,invitees:o,space:t,spaceUser:r,team:i,publicPageDataGuestSetting:m}),v=d({domains:s,internalGuestFeatureAvailability:c,guestFeatureAvailability:l,invitees:o,space:t,spaceUser:r,team:i,publicPageDataGuestSetting:m}),g=o.some((e=>{const t=v[e.email],s=p[e.email];return"can_autojoin"!==t.type&&_(s)}));return(0,a().Pe)(o.map((e=>{const{email:t,currentRole:s}=e,a=v[t],i=p[t];if("member"===s)return[t,{type:"member_page_add"}];if("guest"===s&&"can_add"===i.type)return[t,{type:"guest_page_add"}];if("can_autojoin"===a.type)return[t,{type:"member",reason:"autojoin_domain"}];if("cannot_add"===(r=p[t]).type&&"over_general_guest_limit"===r.reason)return[t,{type:"none",reason:"must_upgrade"}];if("can_add"===a.type&&g)return[t,{type:"member",reason:"over_internal_guest_limit"}];if("can_add"===i.type)return[t,{type:"guest"}];if("can_request"===i.type)return[t,{type:"guest_request"}];if("can_add"===a.type)return[t,{type:"member",reason:"guests_disabled"}];if("can_request"===a.type)return[t,{type:"member_request"}];if("cannot_add"===a.type&&"not_authorized_domain"===a.reason)return[t,{type:"none",reason:"not_authorized_domain"}];if("cannot_add"===i.type){return[t,{type:"none",reason:i.reason}]}if("cannot_add"===a.type){return[t,{type:"none",reason:a.reason}]}return(0,n().t1)(a)&&(0,n().t1)(i);var r})))}function u(e){let{space:t,domains:s,team:n,internalGuestFeatureAvailability:i,guestFeatureAvailability:o,optimism:u="pessimistic",spaceUser:d,invitees:m,publicPageDataGuestSetting:_}=e;const v=l({space:t,team:n,spaceUser:d,publicPageDataGuestSetting:_}),g=c(u,o,p(m)),b=function(e,t){return e.filter((e=>(0,r().is)(e.email,t)&&!e.currentRole)).length}(m,s),y=c(u,i,b);return(0,a().Pe)(m.map((e=>{const t=(0,r().is)(e.email,s),a=void 0!==e.currentRole;let n;return n=a||g?!t||a||y?"cannot_add"===v.type?{type:"cannot_add",reason:"disabled_by_admins"}:v:{type:"cannot_add",reason:"over_internal_guest_limit"}:{type:"cannot_add",reason:"over_general_guest_limit"},[e.email,n]})))}function c(e,t,s){const a=t.limit,n="unlimited"===a.total?"unlimited":a.total-a.current;return"optimistic"===e?"unlimited"===n||n>=1:"unlimited"===n||n>=s}function d(e){let{space:t,team:s,domains:r,spaceUser:o,invitees:c,internalGuestFeatureAvailability:d,guestFeatureAvailability:l,publicPageDataGuestSetting:p}=e;const v=m({space:t,domains:r,spaceUser:o}),g=u({space:t,domains:r,internalGuestFeatureAvailability:d,guestFeatureAvailability:l,team:s,spaceUser:o,invitees:c,publicPageDataGuestSetting:p}),b=!o.isMember();return(0,a().Pe)(c.map((e=>{const t=(0,i().Gd)(e.email);if(!t)return[e.email,{type:"cannot_add",reason:"invalid_email"}];const s=_(g[e.email]),a=v.autojoinDomains;let r;return a.includes(t)?r={type:"can_autojoin"}:"can_add"===v.type?r={type:"can_add"}:"can_request"===v.type||s&&!b?r={type:"can_request"}:a.length>0?r={type:"cannot_add",reason:"not_authorized_domain"}:"cannot_add"===v.type?r={type:"cannot_add",reason:"disabled_by_admins"}:(0,n().t1)(v),[e.email,r]})))}function l(e){let{space:t,team:s,spaceUser:a,publicPageDataGuestSetting:i}=e;const r=a.isWorkspaceOwner(),o=(0,n().$K)(i)?i:function(e){let t,s,{space:a,team:n}=e;t=n&&n.getDisableGuests()?"cannot_add":n&&!n.getDisableGuests()?"can_add":void 0;const i=a.disable_guests,r=a.getSettings().enable_guest_invite_requests;s=r?"can_request":i?"cannot_add":"can_add";return"can_request"===s?{type:"can_request"}:void 0!==t?{type:t}:{type:s}}({space:t,team:s});return r&&"can_request"===o.type?{type:"can_add"}:o}function m(e){let{space:t,domains:s,spaceUser:a}=e;const n=!a.isMember(),i=function(e){let{space:t,domains:s}=e;const a=s.filter((e=>e.isAutojoinable)).map((e=>e.url));return t.getSettings().disable_membership_requests?{type:"cannot_add",autojoinDomains:a}:{type:"can_request",autojoinDomains:a}}({space:t,domains:s});return n?{type:"cannot_add",autojoinDomains:[]}:a.isWorkspaceOwner()?{...i,type:"can_add"}:i}function p(e){return e.filter((e=>!e.currentRole)).length}function _(e){return"cannot_add"===e.type&&"over_internal_guest_limit"===e.reason}},703976:(e,t,s)=>{s.d(t,{TC:()=>r,dr:()=>n,is:()=>i});s(267602),s(470928);var a=()=>s(446866);function n(e,t){return!!e&&i(e.getEmail(),t)}function i(e,t){return void 0!==r(e,t)}function r(e,t){if(!e)return;const s=(0,a().Gd)(e);return t.find((e=>e.url===s))}}}]);