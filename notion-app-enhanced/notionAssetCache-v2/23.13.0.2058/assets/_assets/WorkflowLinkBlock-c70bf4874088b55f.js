"use strict";(globalThis.webpackChunknotion_next=globalThis.webpackChunknotion_next||[]).push([[52668],{464982:(e,t,n)=>{n.r(t),n.d(t,{default:()=>u});var o=n(667294),r=()=>n(142735),a=()=>n(506347),i=()=>n(627990),s=()=>n(614027),d=()=>n(429725),c=n(785893);function l(e,t){const{store:l}=e,u=(0,n(219727).O7)(),f=(0,o.useContext)(n(41340).Z),p=(0,r().VK)((()=>(0,n(509555).S)()),[]),m=(0,o.useRef)(null),h=(0,n(846550).yK)((t=>({linkBox:{borderRadius:4,paddingTop:3,paddingBottom:3,paddingLeft:2,...e.style},titleWrap:{display:"flex",alignItems:"center",gap:8,marginLeft:4},icon:{width:16,height:16},statusPill:{borderRadius:12,padding:"2px 8px",fontSize:12,fontWeight:500,color:t.contentBackground},statusPillEnabled:{backgroundColor:t.accentColors.green[400]},statusPillDisabled:{backgroundColor:t.accentColors.gray[300]}})),[e.style]),y=(0,o.useCallback)((()=>{n(381140).Se(u),n(30238).SK(u,{page_visit_id:n(56810).$g.getCurrentPageVisitId(),mentioned_page_id:e.store.id,source_type:"page_block",hover_preview_enabled:!0,is_navigable_block:e.store.isNavigableBlock()}),n(773725).Z.recordVisit({id:e.store.id,systemBlockType:e.store.getSystemBlockTypeStore().getValue(),type:s().vu.Link,currentUserId:u.currentUser.id})}),[u,e.store]),g=(0,o.useCallback)((()=>{if(f){const t=(0,d().ZP)({store:e.store,pageVisitSource:a().tY.Create});f(t)}else n(47443)._c({environment:u,store:e.store,visitType:s().vu.Link,openInSidePeek:n(482162).default.isSidePeekOpen(),pageVisitSource:a().tY.Create})}),[u,f,e.store]),v=(0,r().VK)((()=>(0,d().ZP)({store:l,fullyQualified:!1,pageVisitSource:a().tY.LinkInPage})),[l]),b=(0,r().VK)((()=>{var e;const t=null===(e=l.getFormat())||void 0===e?void 0:e.workflow_id;if(t)return n(826955).hA.createChildStore(l,{table:n(361929).An,id:t,spaceId:l.getSpaceId()})}),[l]),w=(0,r().VK)((()=>b?(0,n(10986).xI)(b).name:"New Workflow"),[b]);return(0,n(480089).ez)(e.store,t,(0,o.useMemo)((()=>({renderedType:"workflow",getNode:()=>m.current,getBlockStore:()=>e.store,activate:g,handleCreated(){g(),n(475335).default.setKeyboardMode(!1)}})),[g,e.store]),p?(0,c.jsx)(n(58836).p,{allowSelectionWithin:!1,ref:m,children:(0,c.jsx)(n(729775).Z,{href:v,external:!1,onClick:y,style:h.linkBox,children:(0,c.jsx)(i().ZP,{alignment:i().v2.Center,children:(0,c.jsxs)("div",{style:h.titleWrap,children:[(0,n(29248).K)(h.icon),(0,c.jsx)("div",{children:w||"New Workflow"}),(0,c.jsx)("div",{style:{...h.statusPill,...h.statusPillEnabled},children:"Enabled"})]})})})}):null)}const u=o.memo(o.forwardRef(l),n(632314).Z)},10986:(e,t,n)=>{n.d(t,{JC:()=>l,M_:()=>w,On:()=>v,a5:()=>f,h:()=>b,jI:()=>u,xI:()=>c});n(670560),n(267602),n(653476),n(241792),n(228244);var o=()=>n(59694),r=()=>n(513670),a=()=>n(144628),i=()=>n(826955),s=()=>n(530924),d=()=>n(735167);function c(e){var t;return(null===(t=e.getModel())||void 0===t?void 0:t.getData())||o().$A}function l(e){const{clientStore:t,threadStore:n}=e,o=(0,a().G)({clientStore:t,threadStore:n});for(let r=o.length-1;r>=0;r--){const e=o[r];if("workflow"===e.type)return e.completed&&!e.saved?e:void 0}}function u(e){const{workflowStore:t,threadStore:n,clientStore:o}=e;if(n&&o){const e=l({threadStore:n,clientStore:o});if(e)return e.value}return t?c(t):void 0}function f(e){return u(e)??c(e.workflowStore)}function p(e,t,n){if(!e)return(null==t?void 0:t.map((e=>({value:e,diff:"added"}))))||[];if(!t)return e.map((e=>({value:e,diff:"removed"})));const o=new Map(e.map((e=>[e[n],e]))),a=new Map(t.map((e=>[e[n],e]))),i=[];for(const[s,d]of a)if(o.has(s)){const e=o.get(s);r().Xy(e,d)||i.push({value:d,diff:"changed"})}else i.push({value:d,diff:"added"});for(const[r,s]of o)a.has(r)||i.push({value:s,diff:"removed"});return i}function m(e){return Object.entries(e).map((e=>{let[t,n]=e;return{key:t,property:(0,d().pf)(n)}}))}function h(e){const{oldSchema:t,newSchema:n}=e;return p(m(t),m(n),"key")}function y(e){const{savedModules:t,newModules:n,store:o}=e,a=t.filter((e=>(0,s().f)({databaseModule:e,store:o}))),i=n.filter((e=>(0,s().f)({databaseModule:e,store:o}))),d=new Map(a.map((e=>[e.key,e]))),c=new Map(i.map((e=>[e.key,e]))),l=[];for(const[s,u]of c)if(d.has(s)){const e=d.get(s),{schema:t,...n}=e.state||{},{schema:o,...a}=u.state||{},i=r().Xy(n,a)?"none":"changed",c=h({oldSchema:t||{},newSchema:o||{}});(c.length>0||"changed"===i)&&l.push({module:u,schemaChanges:c,metadataDiff:i,diff:"changed"})}else l.push({module:u,diff:"added",schemaChanges:[],metadataDiff:"none"});for(const[r,s]of d)c.has(r)||l.push({module:s,diff:"removed",schemaChanges:[],metadataDiff:"none"});return l}function g(e){return e.filter((e=>"database"!==e.type&&"users"!==e.type&&"files"!==e.type&&"recurrence"!==e.type&&"discussions"!==e.type&&"agent"!==e.type))}function v(e){var t,n;const{savedWorkflow:o,newWorkflow:r,store:a}=e;return{description:o.description===r.description?"none":"changed",databaseModules:y({store:a,savedModules:(null===(t=o.modules)||void 0===t?void 0:t.filter((e=>"database"===e.type)))||[],newModules:(null===(n=r.modules)||void 0===n?void 0:n.filter((e=>"database"===e.type)))||[]}),connections:p(g(o.modules||[]),g(r.modules||[]),"key"),triggers:p(o.triggers,r.triggers,"key"),functions:p(o.functions,r.functions,"key"),views:p(o.views,r.views,"key")}}function b(e){var t;const{module:n,store:o}=e,r=null===(t=n.state)||void 0===t?void 0:t.pointer;if(!r)return!1;return i().NW.createChildStore(o,r).getParentId()!==o.id}function w(e){const{diff:t,newWorkflow:n,isNewWorkflow:o,store:r}=e;return!!(t.functions.some((e=>"removed"===e.diff))||t.triggers.some((e=>"removed"===e.diff))||t.connections.some((e=>"removed"===e.diff))||t.views.some((e=>"removed"===e.diff))||t.databaseModules.some((e=>"removed"===e.diff)))||(o?!(null===(a=n.modules)||void 0===a||!a.some((e=>"database"===e.type&&b({module:e,store:r})))):t.databaseModules.some((e=>e.schemaChanges.length>0)));var a}},530924:(e,t,n)=>{n.d(t,{F:()=>d,f:()=>c});n(821057);var o=()=>n(933868),r=()=>n(955620),a=()=>n(335696),i=()=>n(594860),s=()=>n(826955);function d(e){const{collectionStore:t,databaseModules:n,collectionViewId:o}=e,s=(0,r().QaF)(t.getName())||"",d=(0,a().Gw)(s),c={type:"database",key:d,name:s,version:i().O.database.latestVersion,state:{schema:{},propertyKeyToIdMap:{},pointer:t.getSpaceShardedPointer(),collectionViewId:o,accessScope:"read"}},{schema:l,propertyKeyToIdMap:u}=(0,a().dw)({databaseKey:d,schema:t.getSchema(),databaseModules:[...n,c]}),f=c.state;if(!f)throw new Error("Database state not found");return f.schema=l,f.propertyKeyToIdMap=u,c}function c(e){const{databaseModule:t,store:n}=e;if(!t.state)return!1;if("read"===t.state.accessScope)return!1;const r=t.state.pointer;if(!r)return!1;const a=s().NW.createChildStore(n,r).getRole();return!!a&&o().zz(a)}},735167:(e,t,n)=>{n.d(t,{DS:()=>p,Dk:()=>u,N6:()=>s,VI:()=>l,_4:()=>d,ge:()=>f,pf:()=>c});n(821057),n(670560),n(267602),n(653476),n(30005),n(241792);var o=()=>n(335696),r=()=>n(513670),a=()=>n(543172),i=()=>n(826955);function s(e){var t,n,a;const{workflowValue:s,databaseModule:d,store:l}=e,u=null==d||null===(t=d.state)||void 0===t?void 0:t.pointer,f=Object.fromEntries(Object.entries((null==d||null===(n=d.state)||void 0===n?void 0:n.propertyKeyToIdMap)||{}).filter((e=>{let[t]=e;return"content"!==t}))),p=null==d||null===(a=d.state)||void 0===a?void 0:a.schema;if(!u||!p||!f)return null;const m=i().NW.createChildStore(l,u);if(!m)return null;const h=(s.modules||[]).filter((e=>"database"===e.type)),{schema:y,propertyKeyToIdMap:g}=(0,o().dw)({databaseKey:d.key,schema:m.getSchema(),databaseModules:h}),v=[],b=[],w=[];return Object.entries(y).forEach((e=>{let[t,n]=e;t in p?r().Xy(c(n),c(p[t]))||b.push({name:t,type:n.type}):v.push({name:t,type:n.type})})),Object.keys(p).forEach((e=>{e in y||w.push({name:e,type:p[e].type})})),{propertyMapChanged:!r().Xy(f,g),addedProperties:v,removedProperties:w,changedProperties:b}}function d(e){var t,n,r;const{workflowValue:a,databaseModule:s,store:d}=e,c=null==s||null===(t=s.state)||void 0===t?void 0:t.pointer,l=Object.fromEntries(Object.entries((null==s||null===(n=s.state)||void 0===n?void 0:n.propertyKeyToIdMap)||{}).filter((e=>{let[t]=e;return"content"!==t}))),u=null==s||null===(r=s.state)||void 0===r?void 0:r.schema;if(!c||!u||!l)return null;const f=i().NW.createChildStore(d,c);if(!f)return null;const p=(a.modules||[]).filter((e=>"database"===e.type)),{schema:m,propertyKeyToIdMap:h}=(0,o().dw)({databaseKey:s.key,schema:f.getSchema(),databaseModules:p});return{notionState:{schema:m,propertyKeyToIdMap:h},moduleState:{schema:u,propertyKeyToIdMap:l}}}function c(e){if(r().PO(e)){const t=Object.fromEntries(Object.entries(e).map((e=>{let[t,n]=e;return[t,c(n)]})).filter((e=>{let[t,n]=e;return void 0!==n})));return r().xb(t)?void 0:t}if(Array.isArray(e)){const t=r().oA(e.map(c));return r().xb(t)?void 0:t}if(null!=e&&("string"!=typeof e||""!==e))return e}function l(e){var t,n,r;const{databaseModule:i,workflowValue:s,getCollectionSchema:d}=e,l=null==i||null===(t=i.state)||void 0===t?void 0:t.pointer,u=null==i||null===(n=i.state)||void 0===n?void 0:n.propertyKeyToIdMap;if(!l||!u)return"needs-create";const f=d(l);if(!f)return"loading-database";if(!i.state)throw new Error("Database module state not found");const p=(null===(r=s.modules)||void 0===r?void 0:r.filter((e=>"database"===e.type)))||[],m={};for(const o of[...p,i]){const{state:e}=o.key===i.key?i:o;if(!e)throw new Error("Database state not found");if(e.pointer&&e.propertyKeyToIdMap){m[o.key]={collectionPointer:e.pointer,propertyKeyToIdMap:e.propertyKeyToIdMap};for(const t of Object.keys(e.schema))m[o.key].propertyKeyToIdMap[t]=e.propertyKeyToIdMap[t]||(0,a().ZP)()}}const h=(0,o().c1)({notionSchema:f,databaseKey:i.key,databaseKeyMap:m}),{schema:y}=(0,o().yr)({databaseKey:i.key,databaseKeyMap:m,workflowSchema:i.state.schema,notionSchema:f,connectedRelationCollections:h,databaseModules:p});return{workflowSchema:c(y),notionSchema:c(f)}}function u(e){const t=l({databaseModule:e.databaseModule,workflowValue:e.workflowValue,getCollectionSchema:e.getCollectionSchema});if("needs-create"===t||"loading-database"===t)return t;return r().Xy(c(t.workflowSchema),c(t.notionSchema))?"synced":"needs-update"}function f(e){return t=>{const n=i().NW.createChildStore(e,t);return null==n?void 0:n.getSchema()}}const p={getDescription:e=>e.formatMessage({defaultMessage:"This connection allows accessing and editing the connected Notion database.",id:"workflow.module.database.description"}),getName:(e,t)=>t.state?(0,r().kC)(t.name||"Untitled"):e.formatMessage({defaultMessage:"Database",id:"workflow.module.database.title"}),isValidAndConnected:(e,t,o)=>"synced"===u({databaseModule:e,workflowValue:(0,n(10986).xI)(t),getCollectionSchema:f(o)}),getMessageIfNotValid:e=>e.formatMessage({defaultMessage:"The workflow and database are out of sync. Sync them to continue using this workflow.",id:"workflow.module.database.notConnected"})}},157955:(e,t,n)=>{n.r(t),n.d(t,{DEFAULT_MAX_RECURRENCE_DUPLICATION_PER_TASK:()=>R,MAXIMUM_DAILY_RECURRENCES_IN_PATH:()=>_,MAXIMUM_NESTED_RECURRENCE_LEVEL:()=>M,MAX_RECURRENCE_INTERVAL:()=>y,MAX_RECURRENCE_NUMBER_OF_RUNS:()=>g,RRULE_WEEKDAYS_MAP:()=>h,convertFromUnpersistedRecurrenceConfig:()=>N,convertToUnpersistedRecurrenceConfig:()=>I,getFormattedEndCondition:()=>T,getFormattedNextRecurrenceTime:()=>A,getNewEndTimestamp:()=>D,getNextDateUtc:()=>E,getRecurrenceAfter:()=>S,isRunningBetweenMidnightAnd3AM:()=>C,isValidRecurrenceInterval:()=>v,isValidRecurrenceNumberOfRuns:()=>b,rruleFromRecurrence:()=>w,templateAncestorsViolateRecurrenceNesting:()=>k});n(267602),n(653476),n(241792);var o=()=>n(730120);n(670560);function r(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),o=1;o<t;o++)n[o-1]=arguments[o];if(0===n.length)return e.map((e=>[e]));const a=[];for(const i of e)a.push(...r(n[0],...n.slice(1)).map((e=>[i,...e])));return a}var a=()=>n(696459),i=()=>n(326966),s=()=>n(803021),d=()=>n(646574),c=()=>n(998411),l=()=>n(578292);class u extends(()=>n(484885))().Ci{constructor(e,t){super(e,t)}after(e,t){return super.after(e,t)}}var f=()=>n(494616);const p=(0,n(788860).vU)({dateAtTime:{id:"automations.recurrenceHelpers.dateAtTime",defaultMessage:"{date} at {time}"},dateBetweenMidnightAnd3AM:{id:"automations.recurrenceHelpers.dateBetweenMidnightAnd3AM",defaultMessage:"{date} between 12–3 AM"},numberEndConditionDescription:{id:"automations.recurrenceHelpers.numberEndConditionDescription",defaultMessage:"{number, plural, one {After {number} run} other {After {number} runs}}"},noEndCondition:{id:"automations.recurrenceHelpers.noEndCondition",defaultMessage:"Never"}}),m={day:u.DAILY,week:u.WEEKLY,month:u.MONTHLY,year:u.YEARLY},h={MO:u.MO,TU:u.TU,WE:u.WE,TH:u.TH,FR:u.FR,SA:u.SA,SU:u.SU},y=99,g=999;function v(e){return(0,i().hj)(e)&&Number.isInteger(e)&&e>0&&e<=y}function b(e){return(0,i().hj)(e)&&Number.isInteger(e)&&e>0&&e<=g}function w(e){const{start_date:t,frequency:n,interval:o,weekdays:i,timezone:d,hour:c,minute:l}=e,f="week"===n&&i?i.map((e=>h[e])):void 0,p={};return(0,a().$K)(e.end_condition)&&("date"===e.end_condition.type?p.until=(0,s().pd)(e.end_condition.end_at):"number"===e.end_condition.type?p.count=e.end_condition.number_of_occurrences:(0,a().t1)(e.end_condition)),"month"===e.frequency&&(0,a().$K)(e.monthly_restriction)&&("monthdays"===e.monthly_restriction.type?p.bymonthday=e.monthly_restriction.monthdays:"weekdays_in_month"===e.monthly_restriction.type?p.byweekday=r(e.monthly_restriction.weekdays,e.monthly_restriction.week_numbers).map((e=>{let[t,n]=e;return h[t].nth(n)})):(0,a().t1)(e.monthly_restriction)),new u({freq:m[n],dtstart:(0,s().pd)(t),interval:o,byweekday:f,tzid:d,byhour:c??0,byminute:l??0,bysecond:0,...p})}const M=1,_=1;function k(e){var t;if(0===e.length)return{violatesConstraint:!1,templateNestingExceedsMaxDepth:!1,ancestorHasDailyTemplate:!1,nestedDepthOfAutomationAncestors:void 0,immediateAncestorRecurrenceType:void 0};const n=e.filter((e=>{var t;return"day"===(null===(t=e.getRecurrence())||void 0===t?void 0:t.frequency)})),o=e.length,r=null===(t=e[0].getRecurrence())||void 0===t?void 0:t.frequency,a=o>M,i=n.length>=_;return{violatesConstraint:a||i,templateNestingExceedsMaxDepth:a,ancestorHasDailyTemplate:i,nestedDepthOfAutomationAncestors:o,immediateAncestorRecurrenceType:r}}function S(e){const{recurrence:t,afterDate:n}=e;if((0,f().nA)(t)){const e=(0,s().kq)(n);return t.start_date>=e?new Date(t.start_date):void 0}{const e=w(t).after((0,s().pd)(n));if(!e)return;return(0,s().YL)(e)}}function C(e){return 0===e.hour||1===e.hour||2===e.hour}function E(e){return w(e).after((0,s().pd)((0,s().Jh)()))||void 0}function A(e){const{recurrence:t,intl:n}=e,r=E(N(t));if(!r)return;const a=C(t),i=o().ou.fromJSDate(r).toUTC().setZone("local",{keepLocalTime:!0}).setLocale((0,l().E2)(n)).setZone(t.timezone),s=(0,d().p6)({date:i,dateFormat:"relative",allowRelativeDates:!0,intl:n,shortenDate:!0});if(a)return n.formatMessage(p.dateBetweenMidnightAnd3AM,{date:s});{let e=i.toLocaleString(o().ou.TIME_SIMPLE);return t.timezone!==(0,c().r)()&&(e+=` ${i.toFormat("ZZZZ")}`),n.formatMessage(p.dateAtTime,{date:s,time:e})}}function T(e,t){return(0,a().$K)(e)?"number"===e.type?t.formatMessage(p.numberEndConditionDescription,{number:e.number_of_occurrences}):"date"===e.type?(0,d().p6)({date:o().ou.fromMillis(e.end_at),dateFormat:"relative",allowRelativeDates:!0,intl:t,shortenDate:!0}):void(0,a().t1)(e):t.formatMessage(p.noEndCondition)}const R=100;function I(e){return{...e,start_date:(0,s().kq)(e.start_date),end_condition:e.end_condition?"number"===e.end_condition.type?e.end_condition:"date"===e.end_condition.type?{type:"date",end_at:(0,s().kq)(e.end_condition.end_at)}:(0,a().t1)(e.end_condition):void 0}}function D(e,t,n){return e.plus(n-t)}function K(e,t){const n=o().ou.fromMillis(t.end_at).set({hour:e.hour??0,minute:e.minute??0});return{type:"date",end_at:(0,s().Jh)(n.toJSDate())}}function N(e){return{...e,start_date:(0,s().Jh)(new Date(e.start_date)),end_condition:e.end_condition?"number"===e.end_condition.type?e.end_condition:"date"===e.end_condition.type?K(e,e.end_condition):(0,a().t1)(e.end_condition):void 0}}},29248:(e,t,n)=>{n.d(t,{K:()=>r});n(667294);var o=n(785893);const r=(0,n(827282).IU)("boltFilled",{svg:(0,o.jsx)("path",{d:"M0 12.117c0 .38.293.664.703.664h5.518l-2.91 7.91c-.381 1.006.664 1.543 1.318.723l8.877-11.094c.166-.205.254-.4.254-.625 0-.371-.293-.664-.703-.664H7.539l2.91-7.91C10.83.115 9.785-.422 9.131.408L.254 11.492c-.166.215-.254.41-.254.625z"}),viewBox:"0 0 14 22"})}}]);