"use strict";(globalThis.webpackChunknotion_next=globalThis.webpackChunknotion_next||[]).push([[20634],{832024:(e,t,o)=>{o.d(t,{AK:()=>m,Mc:()=>a,OS:()=>p,Td:()=>f,Uu:()=>l,XC:()=>c,ZK:()=>h,e8:()=>u,gV:()=>d,hc:()=>g,n0:()=>S,u0:()=>v,xi:()=>s});var n=()=>o(594546),i=()=>o(572623),r=()=>o(697623);function a(e){n().K4(e,"add_slack_integration")}function l(e){n().K4(e,"remove_slack_integration")}function c(e,t){n().K4(e,"slack_notification_create",t)}function s(e,t){n().K4(e,"slack_notification_delete",t)}function p(e,t){n().K4(e,"slack_notification_update",t)}function d(e,t){const o=r().zt(),a=i().JF();n().K4(e,"slack_imports_invite_render_button",{subscription_tier:o,domain_type:a,origin:t.origin,invite_flow_id:t.invite_flow_id})}function u(e,t){const o=r().zt(),a=i().JF();n().K4(e,"slack_imports_invite_render_invite_popup",{subscription_tier:o,domain_type:a,origin:t.origin,invite_flow_id:t.invite_flow_id})}function m(e,t){const o=r().zt(),a=i().JF();n().K4(e,"slack_imports_invite_click_invite_button",{subscription_tier:o,domain_type:a,invited_user_count:t.invited_user_count,origin:t.origin,invite_token_query:t.inviteTokenQuery,invite_targets:t.inviteTargets,invite_flow_id:t.invite_flow_id})}function v(e,t){const o=r().zt(),a=i().JF();n().K4(e,"slack_imports_invite_completed",{subscription_tier:o,domain_type:a,invited_user_count:t.invited_user_count,is_success:t.is_success,origin:t.origin,invite_flow_id:t.invite_flow_id,error:t.error,invite_stage:t.invite_stage})}function f(e,t){const o=r().zt(),a=i().JF();n().K4(e,"slack_imports_invite_dismiss_popup",{subscription_tier:o,domain_type:a,origin:t.origin,invite_flow_id:t.invite_flow_id})}function g(e,t){const o=r().zt(),a=i().JF();n().K4(e,"slack_imports_invite_click_select_all",{subscription_tier:o,domain_type:a,origin:t.origin,invite_flow_id:t.invite_flow_id,invited_user_count:t.invited_user_count,is_unselect:t.is_unselect,invite_token_query:t.invite_token_query})}function S(e,t){const o=r().zt(),a=i().JF();n().K4(e,"slack_imports_invite_start_slack_integration",{subscription_tier:o,domain_type:a,origin:t.origin,invite_flow_id:t.invite_flow_id,from:t.from})}function h(e,t){const o=r().zt(),a=i().JF();n().K4(e,"slack_imports_invite_complete_slack_integration",{subscription_tier:o,domain_type:a,origin:t.origin,invite_flow_id:t.invite_flow_id,from:t.from,is_success:t.is_success})}},49396:(e,t,o)=>{o.r(t),o.d(t,{addAutomationAction:()=>K,clearInvalidVariables:()=>z,createAutomation:()=>N,deleteAutomation:()=>H,disableAutomation:()=>Q,duplicateAutomation:()=>D,duplicateAutomationAction:()=>G,enableAutomation:()=>J,insertEmptyTextInDuplicateBlockAction:()=>q,messages:()=>O,removeAutomationAction:()=>L,reorderAutomationActions:()=>j,restartAutomation:()=>W});o(821057),o(122556),o(582845),o(250570),o(533019),o(721473),o(788208),o(22624),o(267602),o(653476),o(470928),o(30005),o(241792);var n=o.n(o(369282)),i=()=>o(730120),r=()=>o(492788),a=()=>o(912203),l=()=>o(271896),c=()=>o(764052),s=()=>o(157955),p=()=>o(559102),d=()=>o(92960),u=()=>o(481529),m=()=>o(827370),v=()=>o(494616),f=()=>o(922713),g=()=>o(81954),S=()=>o(955620),h=()=>o(513670),y=()=>o(543172),_=()=>o(855741),w=()=>o(696459),I=()=>o(832024),T=()=>o(282662),C=()=>o(332542),b=()=>o(636340),k=()=>o(990966),M=()=>o(269299),P=()=>o(205228),V=()=>o(872308),A=()=>o(594546),x=()=>o(615676),R=()=>o(487270),F=()=>o(32969),B=()=>o(637118),E=()=>o(309841),$=()=>o(658517),U=()=>o(807629);const O=(0,o(788860).vU)({genericErrorMessage:{id:"automations.buttonTrigger.genericErrorMessage",defaultMessage:"Button failed to execute"},open:{defaultMessage:"Open",id:"automations.buttonTrigger.open"},undo:{defaultMessage:"Undo",id:"automations.buttonTrigger.undo"},defaultConfirmationWorkflowText:{defaultMessage:"Are you sure you want to continue?",id:"automations.buttonTrigger.defaultConfirmationWorkflowText"},defaultContinueWorkflowMessage:{defaultMessage:"Continue",id:"automations.buttonTrigger.defaultContinueWorkflowMessage"},defaultStopWorkflowMessage:{defaultMessage:"Cancel",id:"automations.buttonTrigger.defaultStopWorkflowMessage"},errorQueryCollectionTooManyPages:{defaultMessage:"Button impacts too many pages",id:"automations.buttonTrigger.errorQueryCollectionTooManyPages"},errorRecordInTrash:{id:"automations.buttonTrigger.errorRecordInTrash",defaultMessage:"Button is editing a page in trash"}});function N(e){const{actionIds:t,automationId:o,automationName:i,environment:r,inMemoryRecordCache:a,parentPointer:l,transaction:c,trigger:s}=e,p=o??(0,R().TS)({environment:r,table:v().cv,spaceId:l.spaceId}),d=b().ae({environment:r,inMemoryRecordCache:a??r.defaultRecordCache.inMemoryRecordCache,table:v().cv,transaction:c,value:{action_ids:t,alive:!0,id:p,parent_id:l.id,parent_table:l.table,properties:{name:i},space_id:l.spaceId,status:"active",trigger:s}});return n()(d.isTriggerType(s.type),"Trigger type mismatch"),d}function K(e){const{actionId:t,environment:o,intl:i,automationStore:a,actionType:c,transaction:s,insertionPoint:p,config:d,createDuplicateBlocksContainer:u=!0,builderType:g="sidebar"}=e,h=a.getSpaceId();if(!h)return;let _;if("duplicate_blocks"===c&&u){_=b().j4({environment:o,inMemoryRecordCache:a.inMemoryRecordCache,transaction:s,type:"text"});const e=q({environment:o,contentStore:_.getContentStore(),transaction:s});r().default.afterNextFlush((()=>{const t=F().C.find((t=>m().dr.isEqual(t.props.store.pointer,e.pointer)));t&&k().setSelectionAtStart({store:t.props.store.getBlockTitleStore()})}))}const I=d??function(e){const{actionType:t,automationStore:o,intl:n}=e;if("modal_confirmation"===t)return{continue_button:{text:n.formatMessage(O.defaultContinueWorkflowMessage)},cancel_button:{text:n.formatMessage(O.defaultStopWorkflowMessage)},text:{type:"simple",value:(0,S().TPx)(n.formatMessage(O.defaultConfirmationWorkflowText))}};if("define_variables"===t){const e=(0,y().ZP)();return{values:{[e]:{name:(0,$().h)(o.getActionStores(),n.formatMessage(f().eC)),value:{type:"simple",value:[[""]]}}},variableIds:[e]}}}({actionType:c,automationStore:a,intl:i})??{},C=b().ae({environment:o,inMemoryRecordCache:a.inMemoryRecordCache,table:f().Xj,transaction:s,value:{id:t,type:c,parent_id:a.id,parent_table:v().cv,alive:!0,space_id:h,config:I,blocks:_?[_.id]:[]}});return _&&T().R3({transaction:s,parentStore:C.getKeyStore("blocks"),appendStore:_}),!p||"afterActionId"in p?T().R3({transaction:s,parentStore:a.getActionIdsStore(),appendStore:C,after:null==p?void 0:p.afterActionId}):"beforeActionId"in p?T().Ce({transaction:s,parentStore:a.getActionIdsStore(),prependStore:C,before:p.beforeActionId}):(0,w().t1)(p),Z({transaction:s,automationStore:a}),(0,E().GV)(((e,t,n)=>{const i=(0,A().mc)(o),r=(0,E().TI)({automationActionStore:C,formulaAnalyticsModule:t,formulasModule:e,simpleFormulasModule:n});(0,w().$K)(r)&&(0,l().A2)(i,{automation_action:r,automation_action_id:C.id,automation_id:C.getParentId(),builder_type:g}),C.isDefined()&&(0,l().eI)(i,{automation_action_id:C.id,automation_action_type:C.getType(),automation_id:a.id,builder_type:g})})),n()(C.isType(c),"Action type mismatch"),C}function W(e){var t,o;const{automationStore:n,transaction:r}=e,a=n.getRecurrence();if(!a)return;const l=i().ou.now().plus({day:1}).startOf("day"),c={...a,start_date:l.toMillis(),end_condition:"date"===(null===(t=a.end_condition)||void 0===t?void 0:t.type)?{type:"date",end_at:(0,s().getNewEndTimestamp)(l,a.start_date,null===(o=a.end_condition)||void 0===o?void 0:o.end_at).toMillis()}:a.end_condition};b().sW({store:n,transaction:r,data:{status:"active"}}),b().sW({store:n.getKeyStore("trigger"),transaction:r,data:{recurrence:(0,s().convertFromUnpersistedRecurrenceConfig)(c)}})}function D(e){const{actorPointer:t,environment:o,includeParenting:n,sourceAutomationStore:i,targetAutomationId:r,transaction:a}=e,l=i.getParentStore();if(!l||!l.isReady())throw new Error("Automation parent store not ready");const c=i.getValue(),s=i.getSpaceId();if(!(0,w().$K)(c)||!(0,w().$K)(s))throw new Error("Undefined automation value or space id");const d={},u={...(0,h().Xh)(c),id:r??(0,R().TS)({environment:o,table:v().cv,spaceId:(0,g().J)(s)})};d[i.id]=u.id,(0,w().$K)(u.action_ids)&&(0,w().Of)(u.action_ids)&&u.action_ids.forEach((e=>d[e]=(0,R().TS)({environment:o,table:f().Xj,spaceId:(0,g().J)(s)})));const m=e=>{let{requested:t}=e;const o=d[t.id];return(0,w().$K)(o)?{...t,id:o}:t};(0,p().J_)({actor:t,duplicateRecord:u,options:{},mapper:m,originalRecord:c});const S=b().ae({environment:o,inMemoryRecordCache:i.inMemoryRecordCache,table:v().cv,transaction:a,value:u});n&&C().jG({childStore:S,parentStore:l,transaction:a});const y=i.getActionStores(),_=Promise.all(y.map((e=>{const t=d[e.id],{automationActionStore:n,onComplete:i}=G({environment:o,includeParenting:!1,mapper:m,sourceActionStore:e,targetAutomationActionId:t,transaction:a});return C().jG({childStore:n,parentStore:S,transaction:a}),i}))),I=_.then((e=>e.flat()));return{automationStore:S,onComplete:I}}function G(e){const{environment:t,includeParenting:o,insertionPoint:n,mapper:i,sourceActionStore:r,targetAutomationActionId:a,transaction:c}=e,s=r.getParentStore();if(!s||!s.isReady())throw new Error("Automation store is not ready");const d=r.getValue(),u=r.getSpaceId();if(!(0,w().$K)(d)||!(0,w().$K)(u))throw new Error("Undefined action value or space id");const m={...(0,h().Xh)(d),id:a??(0,R().TS)({environment:t,table:f().Xj,spaceId:(0,g().J)(u)})},v=t.currentUser.id,S=r.inMemoryRecordCache.makeGetRecordRoleFn(v);(0,p().XJ)({duplicateRecord:m,getRecordRole:S,originalRecord:d,mapper:e=>(null==i?void 0:i(e))??e.requested,options:{},originOptions:{baseUrl:P().default.domainBaseUrl,publicDomainName:P().default.publicDomainName},duplicateBlocks:!1});const y=b().ae({environment:t,inMemoryRecordCache:r.inMemoryRecordCache,table:f().Xj,transaction:c,value:m});o&&(!n||"afterActionId"in n?C().jG({after:null==n?void 0:n.afterActionId,childStore:y,parentStore:s,transaction:c}):"beforeActionId"in n?C().SH({before:null==n?void 0:n.beforeActionId,childStore:y,parentStore:s,transaction:c}):(0,w().t1)(n),Z({transaction:c,automationStore:s}));const _=Promise.all(r.getBlockStores().map((e=>{const[o,n]=V().duplicateBlock({addCopyName:!1,baseUrl:P().default.domainBaseUrl,deepCopyTransclusionContainers:!1,environment:t,preferDuplicateLocation:"local",publicDomainName:P().default.publicDomainName,resolveTemplateVariables:!1,stores:[e],targetSpaceId:(0,g().J)(e.pointer.spaceId),transaction:c}),i=o[0];return C().jG({childStore:i,parentStore:y,transaction:c}),n}))),I=y.getModel();return(0,w().$K)(I)&&(0,E().GV)(((e,o,n)=>{const i=(0,A().mc)(t),r=(0,E().TI)({automationActionStore:y,formulaAnalyticsModule:o,formulasModule:e,simpleFormulasModule:n});(0,w().$K)(r)&&(0,l().A2)(i,{automation_action:r,automation_action_id:I.id,automation_id:I.parent_id,from:"duplicate"}),(0,l().eI)(i,{automation_action_id:I.id,automation_action_type:I.type,automation_id:s.id,from:"duplicate"})})),{automationActionStore:y,onComplete:_}}function j(e){const{environment:t,automationStore:o,automationTypecheckModule:n,contextType:i,formulasModule:r,intl:a,newActionIds:l,transaction:c,from:s,movedActionId:p}=e;b().sW({store:o,transaction:c,data:{action_ids:l}}),Z({automationStore:o,transaction:c});X({automationStore:o,transaction:c,typecheckResult:(0,U().k)({environment:t,automationStore:o,automationTypecheckModule:n,contextType:i,formulasModule:r,intl:a})}),(0,A().j)({environment:t,event:{eventName:"automation_action_move",eventProperties:{automation_id:o.id,automation_action_id:p,from:s}}})}function L(e){const{actionStore:t,automationStore:o,automationTypecheckModule:n,contextType:i,environment:r,formulasModule:a,intl:c,transaction:s}=e,p=(0,U().k)({environment:r,automationStore:o,automationTypecheckModule:n,contextType:i,formulasModule:a,intl:c});!function(e){const{automationActionStore:t,automationStore:o,environment:n,transaction:i,hasError:r=!1}=e;let a=t.getParentStore();if((0,w().$K)(o)){const e=t.getParentPointer();if(!(0,w().$K)(e))throw new Error("Automation action does not have a parent pointer");if(!m().dr.isEqual(e,o.pointer))throw new Error(`Automation action parent pointer does not match argument: ${m().dr.toKey(e)}, ${m().dr.toKey(o.pointer)}`);a=o}else if(!(0,w().$K)(a))throw new Error("Automation store is undefined");C().hr({childStore:t,parentStore:a,transaction:i});const c=t.getModel();(0,w().$K)(c)&&(0,E().GV)(((e,o,i)=>{const s=(0,A().mc)(n),p=(0,E().TI)({automationActionStore:t,formulaAnalyticsModule:o,formulasModule:e,simpleFormulasModule:i});(0,w().$K)(p)&&(0,l().OK)(s,{automation_action:p,automation_action_id:c.id,automation_id:c.parent_id,has_error:r}),(0,l().co)(s,{automation_action_id:c.id,automation_action_type:c.type,automation_id:a.id,has_error:r})}))}({automationActionStore:t,environment:r,transaction:s,hasError:(_().x.isSuccess(p)&&p.value.actionValidationFailures[t.id]||[]).length>0}),X({automationStore:o,transaction:s,typecheckResult:p})}function z(e){const{environment:t,automationStore:o,automationTypecheckModule:n,contextType:i,formulasModule:r,intl:a,transaction:l}=e;X({automationStore:o,transaction:l,typecheckResult:(0,U().k)({environment:t,automationStore:o,automationTypecheckModule:n,contextType:i,formulasModule:r,intl:a})})}function Z(e){const{automationStore:t,transaction:o}=e;t.getSpaceId()&&t.getActionStores().forEach(((e,t)=>{var n;if(!e.isDefined())return;const i=e.getModel();i.isType("open_page")&&"url"===(null===(n=i.getConfig())||void 0===n||null===(n=n.target)||void 0===n?void 0:n.type)&&!(0,a().GQ)(t)&&b().sW({store:e.getConfigStore(),transaction:o,data:{target:null}})}))}function X(e){const{automationStore:t,transaction:o,typecheckResult:n}=e,i=t.getSpaceId(),r=t.getModel();if(i&&r&&!_().x.isFail(n))for(const a of r.getActionIds()){const e=t.getRecordStore(t,{table:f().Xj,id:a,spaceId:i});if(!e.isDefined())continue;const r=e.getModel(),l=new Set(n.value.actionInputValueTypes[a].map((e=>{if(e.kind===d().FormulaContextValueKind.Binding||e.kind===d().FormulaContextValueKind.ContextValue)return e.id;e.kind!==d().FormulaContextValueKind.ThisRow&&(0,w().t1)(e)})).filter(w().$K)),{value:s}=(0,c().e)({automationActionModel:r,baseUrl:P().default.domainBaseUrl,preventClearingConfig:!0,publicDomainName:P().default.publicDomainName,sourceSpaceId:i,visitors:{visitCollectionProperty:void 0,visitCollectionPropertyPointer:void 0,visitFormulaContextValue:e=>l.has(e)?{type:"keep"}:{type:"replace",value:void 0},visitFormulaPageProperty:void 0,visitRecordPointer:void 0}}),p=u().op.update({pointer:e.pointer,path:["config"],args:s.getConfig()??{}});M().applyOperation({store:e,operation:p,transaction:o})}}function q(e){const{environment:t,contentStore:o,transaction:n}=e,i=b().j4({environment:t,type:"text",inMemoryRecordCache:o.inMemoryRecordCache,transaction:n,spaceId:o.pointer.spaceId});return T().R3({parentStore:o,appendStore:i,transaction:n}).childStore}function J(e){const{automationStore:t,environment:o,transaction:n}=e;b().sW({store:t,data:{status:"active"},transaction:n});const i=t.getModel();(0,w().$K)(i)&&(0,E().GV)(((e,n,r)=>{const a=(0,B().Ep)(t);let c=[];a&&_().x.isSuccess(a)&&(c=a.value.valueTypes);const s=(0,A().mc)(o),p=(0,l().TY)({automationModel:i,formulaAnalyticsModule:n,formulasModule:e,formulaTypecheckContextValues:c,getRecordModel:t.getRecordModel,featureGates:(0,x().W)(),simpleFormulasModule:r});(0,l().Rt)(s,p)}))}function Q(e){const{automationStore:t,environment:o,status:n,transaction:i}=e,r=n??"disabled";b().sW({store:t,data:{status:r},transaction:i}),t.isTriggerType("recurrence")&&b().sW({store:t,data:{run_at:void 0},transaction:i});const a=t.getModel();(0,w().$K)(a)&&(0,E().GV)(((e,n,i)=>{const r=(0,B().Ep)(t);let c=[];r&&_().x.isSuccess(r)&&(c=r.value.valueTypes);const s=(0,A().mc)(o),p=(0,l().TY)({automationModel:a,formulaAnalyticsModule:n,formulasModule:e,formulaTypecheckContextValues:c,getRecordModel:t.getRecordModel,featureGates:(0,x().W)(),simpleFormulasModule:i});(0,l().ai)(s,p)}))}function H(e){const{automationStore:t,environment:o,transaction:n}=e;b().sW({store:t,data:{alive:!1},transaction:n});const i=t.getModel();(0,w().$K)(i)&&(0,E().GV)(((e,n,r)=>{const a=(0,B().Ep)(t);let c=[];a&&_().x.isSuccess(a)&&(c=a.value.valueTypes);const s=(0,A().mc)(o),p=(0,l().TY)({automationModel:i,formulaAnalyticsModule:n,formulasModule:e,formulaTypecheckContextValues:c,getRecordModel:t.getRecordModel,featureGates:(0,x().W)(),simpleFormulasModule:r});(0,l().uO)(s,p),i.isNotificationType()&&I().xi(o,{type:"granular",source:"collection_view_settings",collection_id:i.parent_id})}))}},309841:(e,t,o)=>{o.d(t,{GV:()=>u,TI:()=>p,yE:()=>d});o(267602),o(653476),o(241792);var n=()=>o(271896),i=()=>o(855741),r=()=>o(696459),a=()=>o(141735),l=()=>o(594546),c=()=>o(615676),s=()=>o(637118);function p(e){const{automationActionStore:t,automationStore:o,formulaAnalyticsModule:a,formulasModule:l,simpleFormulasModule:p}=e,d=t.getModel(),u=o??t.getParentStore();if(!d||!u)return;const m=u.getActionStores().map((e=>e.getModel())).filter(r().$K),v=(0,s().Ep)(u);let f=[];return v&&i().x.isSuccess(v)&&(f=v.value.valueTypes),(0,n().Bj)({automationActionModel:d,automationActionModels:m,formulaAnalyticsModule:a,formulasModule:l,simpleFormulasModule:p,formulaTypecheckContextValues:f,getRecordModel:t.getRecordModel,featureGates:(0,c().W)()})}function d(e,t){const{automationStore:o,automationActionStore:n}=t;o.isTriggerType("event")||o.isTriggerType("notification_event")||u(((t,i,r)=>{const a=p({automationActionStore:n,automationStore:o,formulaAnalyticsModule:i,formulasModule:t,simpleFormulasModule:r});a&&(0,l().A3)(e,"automation_action_update",n.id,1,{automation_action:a,automation_action_id:n.id,automation_id:o.id})}))}function u(e){return Promise.all([a().F.formulas.load(),a().F.formulaAnalytics.load(),a().F.simpleFormulas.load()]).then((t=>{let[o,n,i]=t;e(o,n,i)})).catch((e=>{console.error("Error sending analytics for automations",e)}))}},658517:(e,t,o)=>{o.d(t,{h:()=>n});o(122556),o(582845),o(250570),o(533019),o(721473),o(788208),o(22624),o(267602),o(731107);function n(e,t){const o=e.reduce(((e,t)=>{if(t.isType("define_variables")){var o;const n=null===(o=t.getModel())||void 0===o?void 0:o.getVariables();if(n)for(const t of Object.values(n))e.add(t.name)}return e}),new Set),n=t.replace(/\s*\d+$/,"");let i=1,r=`${n} ${i}`;for(;o.has(r);)r=`${n} ${i}`,i++;return r}},276124:(e,t,o)=>{o.d(t,{z:()=>a});o(267602),o(470928);var n=()=>o(421654),i=()=>o(636340),r=()=>o(749826);function a(e){const{collectionViewBlockStore:t,collectionPointer:o,transaction:a}=e;i().sW({store:t,data:{collection_id:null},transaction:a});if(r().default.checkGate({gateName:"workflow_container"})){const e=t.getCollectionPointers();(null==e?void 0:e.find((e=>e.id===o.id)))||n().FH({stores:[t],update:{collection_pointers:[...e??[],o]},transaction:a})}n().FH({stores:[t],update:{collection_pointer:o},transaction:a})}},965350:(e,t,o)=>{o.d(t,{jo:()=>z,l3:()=>W,Uo:()=>G,Ex:()=>D,Vb:()=>j});o(821057),o(670560),o(122556),o(582845),o(250570),o(533019),o(721473),o(788208),o(22624),o(241792);var n=()=>o(353329),i=()=>o(396136),r=()=>o(139978),a=()=>o(255933),l=()=>o(306164),c=()=>o(955620),s=()=>o(696459),p=()=>o(54512),d=()=>o(384667),u=()=>o(295274),m=()=>o(421654),v=()=>o(282662),f=()=>o(332542),g=()=>o(636340),S=()=>o(145284),h=()=>o(968377),y=()=>o(269299),_=()=>o(752778),w=()=>o(276124),I=()=>o(826955);function T(e){const{environment:t,collectionViewBlockStore:o,transaction:n,collectionValue:r}=e,a=g().ae({environment:t,table:_().vF,value:{...r,parent_id:o.id,parent_table:i().iU,alive:!0,space_id:o.getSpaceId()},inMemoryRecordCache:o.inMemoryRecordCache,transaction:n}),l=I().NW.createChildStore(o,a.pointer);return(0,w().z)({collectionViewBlockStore:o,collectionPointer:l.pointer,transaction:n}),l}var C=()=>o(581953),b=()=>o(748360),k=()=>o(576808),M=()=>o(907005),P=()=>o(527278),V=()=>o(714966),A=()=>o(876822),x=()=>o(985866),R=()=>o(938938),F=()=>o(877727),B=()=>o(281236),E=()=>o(382474),$=()=>o(122252),U=(o(267602),o(653476),()=>o(917881)),O=()=>o(688745);function N(e){const{environment:t,transaction:o,collectionStore:i,template:r,targetCollectionStore:a,logger:l}=e,{value:c}=r,s=(0,$().rU)(e);if(!s)throw new Error(`relationPropertyPointer not created for ${r.templateId}`);if("property"!==s.type)throw new Error(`Instance pointer returned is not of property type: ${s.type}`);const p=new(x().Z)(t);p.setContext({type:"collectionPage",collectionStore:i});const{inverseRelationPropertyId:d}=U().n7({environment:t,transaction:o,intl:P().Z.getIntl(),collectionContextStore:p,collectionStore:i,property:s.id,targetCollectionStore:a,hasInverseRelation:!0,inverseName:void 0,propertyName:c.name,autoRelate:c.autoRelate,propertyLimit:1===c.limit?"1":"no_limit"});if(d){const e=function(e){let{environment:t,sourceCollectionStore:o,targetCollectionStore:i}=e;const r=(0,E().Hq)({environment:t,collectionStore:o}),a=(0,E().Hq)({environment:t,collectionStore:i});if(!r||!a)return;const l=(0,n().Js)(a).map((e=>B().globalWorkflowTemplates.fromId(e))).filter((e=>(0,n().yw)(e)));for(const n of l)if(n.relatedCollectionTemplateId===r.templateId)return n}({environment:t,sourceCollectionStore:i,targetCollectionStore:a});e&&(l.log(`Instantiating relation property template "${e.templateId}" because it is the inverse of "${r.templateId}".`),(0,O().cP)({transaction:o,collectionStore:a,templateId:e.templateId,instance:{type:"property",id:d,collectionId:a.id},logger:l}))}return s}var K=()=>o(737128);function W(e){var t;let{environment:o,transaction:i,template:a,parentStore:l,existingCollectionInfo:s,inMemoryRecordCache:d,selectedFeatureTemplateIds:u,collectionViewBlockType:v="collection_view_page",relationInfos:f,disableExampleRows:g,logger:S}=e;S.log(`Instantiating collection template "${a.templateId}".`);const{collectionStore:h,collectionViewBlockStore:y}=function(e){var t;let o,{environment:n,transaction:i,template:r,parentStore:a,existingCollectionInfo:l,collectionViewBlockType:s="collection_view_page",inMemoryRecordCache:p,logger:d}=e;if(!(0,B().isCollectionTemplateParentStore)(a))throw new Error(`Parent store is not a valid  collection template parent store ${a.table}`);if(l){const{collectionStore:e,collectionViewStore:t}=l;o=l.collectionViewBlockStore,t&&(0,C().d)({collectionViewBlockStore:o,collectionViewStore:t,transaction:i}),e&&(0,b().A)({collectionViewBlockStore:o,collectionStore:e,transaction:i})}else o=L({environment:n,transaction:i,parentStore:a,collectionViewBlockType:s,inMemoryRecordCache:p});const{name:u,icon:m,description:v}=r.value.targetCollection,f=T({environment:n,collectionViewBlockStore:o,transaction:i,collectionValue:{name:(0,c().TPx)(u),icon:m,description:v,format:{item_name_config:r.value.targetCollection.itemName,item_name_config_v2:null===(t=r.value.targetCollection.format)||void 0===t?void 0:t.item_name_config_v2},schema:{title:{name:P().Z.formatMessage(M().Mg.namePropertyTitle),type:"title"}}}});if(!A().default.state.currentSpaceStore)throw new Error("No current space store");return{collectionStore:f,collectionViewBlockStore:o}}({environment:o,transaction:i,template:a,parentStore:l,existingCollectionInfo:s,collectionViewBlockType:v,inMemoryRecordCache:d,logger:S});(0,O().cP)({transaction:i,collectionStore:h,templateId:a.templateId,instance:{type:"collection",id:h.id},logger:S});const{allFeatureTemplates:_,nonRelationPropertyTemplates:w}=function(e){let{template:t,selectedFeatureTemplateIds:o}=e;if(o){const e=new Set((0,n().Js)(t));for(const n of o)if(!e.has(n))throw new Error(`Feature template ID ${n} is not part of collection template ${t.templateId}`)}const{templateItems:i}=t.value,r=(0,n().uC)(i,"required"),a=(0,n().uC)(i,"optionalDefaultOn"),l=new Set([...r,...o??a]),c=Array.from(l).map(B().globalWorkflowTemplates.featureFromId),s=[],p=[];for(const d of c)(0,n().yw)(d)?s.push(d):p.push(d);return{allFeatureTemplates:c,relationPropertyTemplates:s,nonRelationPropertyTemplates:p}}({template:a,selectedFeatureTemplateIds:u}),k=[];for(const n of w){const e=(0,$().ao)({environment:o,transaction:i,collectionStore:h,template:n,logger:S,origin:"collection_creation"});"collection_view"===(null==e?void 0:e.type)&&k.push(e)}if(0===k.length)throw new Error("No collection view templates to create");const V=I().Xr.createChildStore(y,{table:r().np,id:k[0].id});f&&function(e){let{environment:t,transaction:o,currentCollectionStore:n,relationInfos:i,logger:r}=e;for(const a of i){const{sourceCollectionStore:e,targetCollectionStore:i}=Z({currentCollectionStore:n,relationInfo:a});N({environment:t,transaction:o,origin:"collection_creation",collectionStore:e,targetCollectionStore:i,template:a.relationPropertyTemplate,logger:r})}}({environment:o,transaction:i,currentCollectionStore:h,relationInfos:f,logger:S});const x=(0,B().getPropertyTemplates)(_);(0,K().Uv)({transaction:i,collectionStore:h,propertyTemplates:x}),(0,K().MU)({transaction:i,collectionStore:h,propertyTemplates:x}),function(e){const{transaction:t,collectionStore:o,template:n,logger:i}=e,{format:r}=n.value.targetCollection;if("object"!=typeof(null==r?void 0:r.collection_default_template))return;const a=(0,E().CX)({collectionStore:o,sourceTemplateType:"block",dependencyMap:n.dependencyMap??{},sourcePrimitiveId:r.collection_default_template.template_page_id});a?m().FH({stores:[o],update:{collection_default_template:{template_page_id:a}},transaction:t}):i.warn("Unable to resolve collection default template, omitting it.")}({transaction:i,template:a,collectionStore:h,logger:S}),"tasks"===a.category&&(0,R().maybeAddAppTemplateMetadataForTasks)({environment:o,collectionStore:h,collectionViewBlockStore:y,transaction:i}),function(e){let{transaction:t,collectionViewBlockStore:o}=e;const n=o.getFormat();("workflow_template_placeholder"===n.collection_view_sub_type||n.placeholder_workflow_template_id)&&m().FH({stores:[o],update:{placeholder_workflow_template_id:void 0,collection_view_sub_type:void 0},transaction:t})}({transaction:i,collectionViewBlockStore:y});let U=[];return!g&&(0,F().mq)()&&null!==(t=a.value.exampleRows)&&void 0!==t&&t.length&&(U=G({environment:o,transaction:i,collectionStore:h,collectionViewStore:V,collectionViewBlockStore:y,exampleRows:a.value.exampleRows,dependencyMap:a.dependencyMap??{}})),i.postSubmitCallbacks.push((e=>{e||p().W(o,{from:"workflow_template",type:y.getType()??"collection_view_page",creating_block_id:y.id,collection_view_block_id:y.id,collection_view_id:V.id,collection_id:h.id,view_type:V.getType()})})),{collectionStore:h,collectionViewStore:V,collectionViewBlockStore:y,examplePageStores:U}}async function D(e){const{environment:t,parentStore:o,title:n,onFinish:i}=e,{serverCommitResult:a,performResult:{collectionViewBlockStore:l,collectionViewStore:s,collectionStore:d}}=y().createAndCommit({userAction:"workflowTemplatesOnboardingModal.addEmptyDatabase",environment:t,canUndo:!0,perform:i=>{let a=e.collectionViewBlockStore;void 0===a&&(a=L({environment:t,transaction:i,parentStore:o,collectionViewBlockType:"collection_view_page",inMemoryRecordCache:o.inMemoryRecordCache}),p().W(t,{from:"workflow_template",type:"page",new_page_id:a.id,creating_block_id:a.id}));const l=T({environment:t,collectionViewBlockStore:a,transaction:i,collectionValue:{name:n?(0,c().TPx)(n):void 0}}),s=g().ae({environment:t,table:r().np,inMemoryRecordCache:a.inMemoryRecordCache,value:{type:"table",parent_id:a.id,parent_table:a.table,space_id:a.getSpaceId(),format:{collection_pointer:l.pointer},alive:!0},transaction:i}),d=I().Xr.createChildStore(a,s.pointer);return(0,V().u)(d.id,{viewType:"table",isPlaceholderCollection:!0}),v().R3({parentStore:a.getCollectionViewsStore(),appendStore:d,transaction:i}),{collectionViewBlockStore:a,collectionViewStore:d,collectionStore:l}}});return await a,i&&i(l),{collectionViewBlockStore:l,collectionViewStore:s,collectionStore:d}}function G(e){let{environment:t,transaction:o,collectionStore:n,collectionViewStore:i,collectionViewBlockStore:r,exampleRows:a,dependencyMap:l}=e;const c=new(x().Z)(t);c.setContext({type:"collectionView",collectionViewBlockStore:r,collectionStore:n,collectionViewStore:i,pageVisitSourceOverride:void 0});const s=[],p=c.defaultPageTemplateStore.state,{inMemoryRecordCache:m}=r;for(const v of a){const{newStore:e}=d().IW({environment:t,collectionContextStore:c,groupsPointer:[],insertAtIndex:0,shouldCoerce:!0,transaction:o,from:{createBlock:"workflow_template"},inMemoryRecordCache:m});s.push(e);const i=j({collectionStore:n,dependencyMap:l,exampleRow:v});(0,k().b)({environment:t,store:e,properties:i.properties,transaction:o}),p&&u().ob({title:"template",environment:t,store:e,templateStore:p,isKeyboard:!1,isCreateIn:!1,transaction:o,inMemoryRecordCache:m,from:"collection_template_actions"});const r=e.getIconStore();v.icon&&r&&g().sO({store:r,value:v.icon,transaction:o})}return s}function j(e){let{exampleRow:t,dependencyMap:o,collectionStore:n}=e;const i={properties:{}};for(const[r,a]of Object.entries(t.properties))i.properties[(0,E().Zl)({collectionStore:n,sourceTemplateType:"property",dependencyMap:o,sourcePrimitiveId:r})]=a;return i}function L(e){let{environment:t,transaction:o,parentStore:n,collectionViewBlockType:i,inMemoryRecordCache:r}=e;const a=g().j4({environment:t,type:i,inMemoryRecordCache:r,transaction:o});return g().sW({store:a,transaction:o,data:{parent_id:n.id,parent_table:n.table,alive:!0}}),z({environment:t,spaceViewStore:A().default.state.currentSpaceViewStore,parentStore:n,collectionViewBlockStore:a,transaction:o,appendOrPrepend:"append"}),a}function z(e){let{environment:t,parentStore:o,collectionViewBlockStore:n,transaction:r,appendOrPrepend:c,spaceViewStore:p}=e;if(o.table===i().iU)f().jG({parentStore:o,childStore:n,transaction:r});else if(o.table===a().bx){if((null==p?void 0:p.getSpaceId())!==o.id)throw new Error(`spaceViewStore doesn't match parent with ID ${o.id}`);S().Hj({environment:t,spaceStore:o,spaceViewStore:p,pageStore:n,isPrivate:!0,transaction:r})}else o.table===l().e0?h().c0({teamStore:o,store:n,transaction:r,location:{type:c}}):(0,s().t1)(o)}function Z(e){let{currentCollectionStore:t,relationInfo:o}=e;const{type:n,collectionStore:i}=o;return"source"===n?{sourceCollectionStore:i,targetCollectionStore:t}:"target"===n?{sourceCollectionStore:t,targetCollectionStore:i}:void(0,s().t1)(n)}},122252:(e,t,o)=>{o.d(t,{rU:()=>Y,ao:()=>ee,rn:()=>oe});o(267602),o(470928);var n=()=>o(353329),i=()=>o(530980),r=()=>o(139978),a=()=>o(483791),l=()=>o(513670),c=()=>o(696459),s=()=>o(984871),p=()=>o(269299),d=()=>o(576808),u=()=>o(826955),m=()=>o(281236),v=()=>o(382474);function f(e){var t;let{environment:o,collectionStore:i,collectionViewValue:r,dependencyMap:a,logger:l}=e;if((0,m().remapPropertyIds)({collectionStore:i,object:r,dependencyMap:a}),function(e){let{environment:t,spaceId:o,collectionViewValue:n,logger:i}=e;for(const l of(null===(r=n.format)||void 0===r?void 0:r.collection_groups)??[]){var r,a;const{value:e}=l;if(("created_by"===e.type||"last_edited_by"===e.type)&&"notion_user"===(null===(a=e.value)||void 0===a?void 0:a.table)){const n=t.currentUser.id;if(!n){i.warn("No current user ID, unable to remap collection group user to current user!");continue}i.log(`Remapping user ID ${e.value.id} to ${n} in collection view group.`),e.value.id=n,e.value.spaceId=o}}}({environment:o,spaceId:i.getSpaceId(),collectionViewValue:r,logger:l}),r.query2&&function(e){let{collectionStore:t,query2:o,dependencyMap:i}=e;for(const r of n().py){const e=o[r];e&&(o[r]=(0,v().Zl)({collectionStore:t,sourceTemplateType:"property",dependencyMap:i,sourcePrimitiveId:e}))}}({collectionStore:i,query2:r.query2,dependencyMap:a}),"object"==typeof(null===(t=r.format)||void 0===t?void 0:t.collection_view_default_template)){const e=(0,v().CX)({collectionStore:i,sourceTemplateType:"block",dependencyMap:a,sourcePrimitiveId:r.format.collection_view_default_template.template_page_id});e?r.format.collection_view_default_template={template_page_id:e}:(l.warn("Unable to resolve collection_view default template, omitting it."),delete r.format.collection_view_default_template)}}var g=()=>o(43093),S=(o(241792),o.n(o(369282))),h=()=>o(764052),y=()=>o(177634),_=()=>o(956057),w=()=>o(275138),I=()=>o(827370),T=()=>o(494616),C=()=>o(922713),b=()=>o(396136),k=()=>o(752778),M=()=>o(989478),P=()=>o(49396),V=()=>o(205228),A=()=>o(487270),x=()=>o(527278);function R(e){let{collectionStore:t,environment:o,logger:n,template:r,transaction:a}=e;const l=function(e){let{environment:t,logger:o,parentStore:n,template:r,transaction:a}=e;const l=(0,A().Ii)({environment:t,spaceId:n.getSpaceId(),table:T().cv}),c=t.currentUser.id,s=i().kk5.fromAutomation({alive:!0,created_by_id:c??"",created_by_table:M().KJ,created_time:Date.now(),id:l.id,parent_id:n.pointer.id,parent_table:n.pointer.table,space_id:n.getSpaceId(),trigger:{...r.value.trigger,id:_().Il()},version:0,last_edited_by_id:c??"",last_edited_by_table:M().KJ,last_edited_time:Date.now(),status:"active"}),p=F({actionPlaceholderIdToActionId:new Map,collectionStore:n,dependencyMap:r.dependencyMap,logger:o}),{value:d}=(0,h().R)({automationModel:s,visitors:p}),u=d.getTrigger(),m=P().createAutomation({actionIds:[],environment:t,automationId:l.id,automationName:r.value.name,parentPointer:n.getSpaceShardedPointer(),transaction:a,trigger:u});return m}({environment:o,logger:n,parentStore:t,template:r,transaction:a}),c=new Map;return r.value.actions.map((e=>function(e){let{actionPlaceholderIdToActionId:t,actionTemplate:o,collectionStore:n,environment:i,logger:r,parentStore:a,parentTemplate:l,transaction:c}=e;const s=(0,A().Ii)({environment:i,spaceId:a.getSpaceId(),table:C().Xj}),{config:p,placeholderId:d,type:u}=o,{model:m}=w().IN.create({alive:!0,config:p,id:s.id,parent_id:a.pointer.id,parent_table:a.pointer.table,space_id:n.getSpaceId(),type:u,version:0}),v=F({actionPlaceholderIdToActionId:t,collectionStore:n,dependencyMap:l.dependencyMap,logger:r}),{value:f}=(0,h().e)({automationActionModel:m,baseUrl:V().default.domainBaseUrl,preventClearingConfig:!0,publicDomainName:V().default.publicDomainName,sourceSpaceId:n.getSpaceId(),visitors:v}),g=f.getConfig(),y=P().addAutomationAction({actionId:s.id,actionType:o.type,automationStore:a,config:g,createDuplicateBlocksContainer:!0,environment:i,intl:x().Z.getIntl(),transaction:c});return S()(y,"Failed to create automation action"),t.set(d,y.id),y}({actionPlaceholderIdToActionId:c,actionTemplate:e,collectionStore:t,environment:o,logger:n,parentStore:l,parentTemplate:r,transaction:a}))),l.isTriggerType("event")&&p().applyOperation({store:t,operation:{pointer:t.pointer,path:["format","automation_ids"],command:"listAfter",args:{id:l.id}},transaction:a}),{id:l.id,spaceId:t.getSpaceId(),type:"automation"}}function F(e){const{actionPlaceholderIdToActionId:t,collectionStore:o,dependencyMap:n,logger:i}=e;function a(e){const o=(0,y().MY)(e);if("action"===o.source){const e=t.get(o.action_id)??o.action_id;return(0,y().Kd)({...o,action_id:e})}if("global"===o.source)return e;(0,c().t1)(o)}function s(e){if(!n)return;if("title"===e)return e;const t=(0,v().CX)({collectionStore:o,sourceTemplateType:"property",sourcePrimitiveId:e,dependencyMap:n});return t||i.warn(`Failed to remap property ID ${e} in automation template`),t}return{visitCollectionProperty:e=>n?{type:"replace",value:s(e)}:{type:"keep"},visitCollectionPropertyPointer:e=>{if(!n)return{type:"keep"};const t=s(e.propertyId);if(!t)return{type:"replace",value:void 0};const r=(0,v().CX)({collectionStore:o,sourceTemplateType:"collection",sourcePrimitiveId:e.id,dependencyMap:n});return r?{type:"replace",value:{id:r,propertyId:t,spaceId:o.getSpaceId(),table:k().vF}}:(i.warn(`Failed to remap collection ID ${e.id} in automation template`),{type:"replace",value:void 0})},visitFormulaContextValue:e=>({type:"replace",value:a(e)}),visitFormulaPageProperty:e=>{if(!n)return{type:"keep"};const t=(0,l().Xh)(e),r=s(e.property);if(!r)return{type:"replace",value:void 0};if(t.property=r,"collection"in t&&t.collection){const e=(0,v().CX)({collectionStore:o,sourceTemplateType:k().vF,sourcePrimitiveId:t.collection.id,dependencyMap:n});if(!e)return i.warn(`Failed to remap collection ID ${t.collection.id} in automation template`),{type:"replace",value:void 0};t.collection=I().dr.fromSpaceShardRecordId({id:e,spaceId:o.getSpaceId()},k().vF)}else"contextValueId"in t&&t.contextValueId&&(t.contextValueId=a(t.contextValueId));return{type:"replace",value:t}},visitRecordPointer:e=>{if(!n)return{type:"keep"};if(e.table===b().iU||e.table===k().vF||e.table===T().cv||e.table===r().np){const t=(0,v().CX)({collectionStore:o,sourceTemplateType:e.table,sourcePrimitiveId:e.id,dependencyMap:n});return t?{type:"replace",value:I().dr.fromSpaceShardRecordId({id:t,spaceId:o.getSpaceId()},e.table)}:(i.warn(`Failed to remap record pointer ${I().dr.toKey(e)} in automation template`),{type:"replace",value:void 0})}return{type:"keep"}}}}o(821057);var B=()=>o(217465),E=()=>o(282662),$=()=>o(332542),U=()=>o(872308);var O=()=>o(965350),N=(o(670560),o(653476),()=>o(636340));function K(e){let{environment:t,transaction:o,collectionStore:n,template:i,logger:a}=e;const l=n.getParentBlockStore();if(!l)throw new Error("Collection view block store not found");const{value:c,dependencyMap:s}=i;if(!s)throw new Error("Dependency map not defined on view template");f({environment:t,collectionStore:n,collectionViewValue:c,dependencyMap:s,logger:a}),function(e){var t;let{collectionStore:o,collectionViewValue:n}=e;const i=null===(t=n.format)||void 0===t?void 0:t.table_properties;if(!i)return;const r=i.map((e=>e.property)),a=Object.keys(o.getSchema()).filter((e=>!r.includes(e)));for(const l of a)i.push({property:l,visible:!1})}({collectionStore:n,collectionViewValue:c});const p=N().ae({environment:t,table:r().np,inMemoryRecordCache:l.inMemoryRecordCache,value:{...c,parent_id:l.id,parent_table:l.table,space_id:l.getSpaceId(),format:{...c.format,collection_pointer:n.pointer},alive:!0},transaction:o}),d=u().Xr.createChildStore(l,p.pointer);return E().R3({parentStore:l.getCollectionViewsStore(),appendStore:d,transaction:o}),{type:"collection_view",id:d.id}}var W=()=>o(342792);var D=()=>o(349220),G=()=>o(142730);var j=()=>o(780741),L=()=>o(216316),z=()=>o(496205),Z=()=>o(543172),X=()=>o(612427);function q(e){const{environment:t,logger:o,transaction:i,collectionStore:r,template:a}=e,c=function(e){if("title"===e.value.type)return"title";if(e.templateId===j().FL)return z().EI.Verification;if(e.templateId===j().Iu)return z().EI.Owner;return(0,Z().ZP)()}(a);if((0,n().dI)(a,"formula"))J({...e,template:a});else if((0,n().IH)(a)){const t=m().globalWorkflowTemplates.featureFromId(a.buttonAutomationId);o.log(`Instantiating dependency "${t.templateId}" of button property template "${a.templateId}".`);const n=ee({...e,template:t});if(!n)throw new Error(`Failed to create instance of automation template "${t.templateId}"`);if("automation"!==n.type)throw new Error(`Unexpected instance pointer. Expected "automation" but got "${n.type}"`);a.value.automation_id=n.id}const s=(0,l().Xh)(a.value);return s.workflow_template_instance={template_id:a.templateId},(0,X().x)({environment:t,collectionStore:r,update:{[c]:s},transaction:i}),{type:"property",id:c,collectionId:r.id}}function J(e){let{template:t,collectionStore:o}=e;const{value:n,dependencyMap:i}=t;if(!i)return;if(!n.formula2)return;const{value:r}=(0,L().RA)({baseUrl:V().default.domainBaseUrl,formula:n.formula2.code,publicDomainName:V().default.publicDomainName,spaceId:o.getSpaceId(),visitors:{visitFormulaContextValue:void 0,visitFormulaPageProperty:e=>{const t={...e};return t.property=(0,v().Zl)({dependencyMap:i,collectionStore:o,sourcePrimitiveId:e.property,sourceTemplateType:"property"}),"collection"in t&&t.collection&&(t.collection=o.pointer),{type:"replace",value:t}},visitRecordPointer:void 0}});n.formula2.code=r}var Q=()=>o(688745),H=()=>o(737128);function Y(e){let{environment:t,transaction:o,collectionStore:n,template:l,logger:c,origin:s,examplePageStores:d}=e;const S=ee({transaction:o,environment:t,collectionStore:n,template:l,logger:c,origin:s}),h=(0,m().getPropertyTemplates)([l]);return(0,H().Uv)({transaction:o,collectionStore:n,propertyTemplates:h}),(0,H().MU)({transaction:o,collectionStore:n,propertyTemplates:h}),function(e){let{environment:t,transaction:o,collectionStore:n,template:l,logger:c,examplePageStores:s}=e;const d=(0,v().Vc)({environment:t,collectionStore:n});for(const{instancePointer:v,templateId:S}of d){const e=m().globalWorkflowTemplates.fromId(S),d=e.dependencyMap&&Object.values(e.dependencyMap).includes(l.templateId);if(!("dependencyMap"in e)||!e.dependencyMap||!d){te({environment:t,transaction:o,collectionStore:n,template:l,examplePageStores:s,instancePointer:v});continue}c.log(`Remapping dependency "${l.templateId}" in "${S}".`);const h={};if("layout"===v.type){const e=u().xj.createChildStore(n,{table:a().Bh,id:v.id,spaceId:v.spaceId}),t=e.getRawModules();if(t){const r=(0,g().NQ)({collectionStore:n,modules:t,dependencyMap:h});p().applyOperation({transaction:o,store:e,operation:i().CIp.updateModules(e.pointer,r)})}}else if("collection_view"===v.type){const e=u().Xr.createChildStore(n,{table:r().np,id:v.id}),o=e.getType();if(!o)continue;f({environment:t,collectionStore:n,collectionViewValue:{type:o,name:e.getName(),format:e.getFormat(),query2:e.getRawQuery()},dependencyMap:h,logger:c})}else c.warn(`Don't know how to remap instance type "${v.type}"!`)}}({environment:t,transaction:o,collectionStore:n,template:l,logger:c,examplePageStores:d}),S}function ee(e){const{collectionStore:t,template:o,transaction:i}=e;!function(e){const{template:t,logger:o}=e,i=(0,n().EL)({template:t,logger:o}),{environment:r,collectionStore:a}=e;for(const n of i){(0,v().A5)({environment:r,scopeStore:a,templateId:n.templateId})||(o.log(`Template "${t.templateId}" has implicit dependency "${n.templateId}" (source: ${n.debugSource}), instantiating it.`),ee({...e,template:m().globalWorkflowTemplates.featureFromId(n.templateId)}))}}(e);const r=function(e){const{logger:t}=e,o=l().Xh(e.template),{type:i}=o;switch(t.log(`Instantiating ${i} template "${o.templateId}".`),i){case"property":return q({...e,template:o});case"collection_view":return K({...e,template:o});case"layout":return function(e){let{environment:t,transaction:o,collectionStore:n,template:i}=e;if(!i.dependencyMap)throw new Error("Dependency map not defined on layout template");const r=(0,g().NQ)({collectionStore:n,modules:{page_layout_schema:void 0,page_info_layout_schema:void 0,form_layout_schema:void 0,...i.value},dependencyMap:i.dependencyMap}),{model:a}=(0,G().m2)({environment:t,transaction:o,collectionStore:n,userId:(0,D().TO)(t.currentUser.id),modules:r});return{type:"layout",id:a.id,spaceId:n.getSpaceId()}}({...e,template:o});case"compound":return function(e){const{environment:t,template:o,collectionStore:i,logger:r}=e,a=[],l=e=>{if(!(0,v().cb)(e)||"compound"===e.type)throw new Error(`Template in compound template generated a non-feature instance pointer of an illegal type: ${e.type}`);a.push(e)};for(const c of o.value.templateItems){const{optionality:a,pointer:s}=c;if("optionalDefaultOff"===a)continue;const p=(0,v().A5)({environment:t,scopeStore:i,templateId:c.pointer});if(p){l(p);continue}const d=m().globalWorkflowTemplates.fromId(s);if(!(0,n().qu)(d))throw new Error(`${d.templateId} in compound template is of an illegal type: ${d.type}`);r.log(`Instantiating dependency "${d.templateId}" of compound template "${o.templateId}".`);const u=Y({...e,template:d});u&&l(u)}return{type:"compound",id:(0,W().ZP)(),instancePointers:a,collectionId:i.id}}({...e,template:o});case"block":return function(e){let{environment:t,transaction:o,collectionStore:n,template:i}=e;const r=(0,A().Ii)({environment:t,spaceId:n.getSpaceId(),table:b().iU});if("block"!==i.type)throw new Error(`Expected block template, got ${i.type} template: ${i.templateId}`);if(!i.dependencyMap)throw new Error(`Dependency map not defined on block template: ${i.templateId}`);const{dependencyMap:a}=i,l=B().RecordMap.create(i.value.recordMap),c=l.getModel(i.value.blockPointer);if(c){const e=c.getProperties();for(const[t,o]of Object.entries(e)){const i=(0,v().Zl)({collectionStore:n,sourceTemplateType:"property",sourcePrimitiveId:t,dependencyMap:a});i&&(delete e[t],e[i]=o)}}const{targetBlockStore:s}=U().localDuplicate({environment:t,sourceBlockId:i.value.blockPointer.id,targetBlockPointer:r,sourceBlockSubtree:l,transaction:o,deepCopyTransclusionContainers:!1,targetInMemoryRecordCache:n.inMemoryRecordCache,resolveTemplateVariables:!1});return $().zw({childStore:s,parentStore:n,transaction:o}),s.isTemplate()&&E().R3({parentStore:n.getTemplatePagesStore(),appendStore:s,transaction:o}),{type:"block",id:s.id,spaceId:n.getSpaceId()}}({...e,template:o});case"automation":return R({...e,template:o});default:(0,c().t1)(i)}}(e);return r&&(0,Q().cP)({transaction:i,collectionStore:t,templateId:o.templateId,instance:r,logger:e.logger}),r}function te(e){let{environment:t,transaction:o,collectionStore:n,template:i,instancePointer:r,examplePageStores:a}=e;if(a&&"property"===r.type)for(const l of a){const e=(0,O().Vb)({collectionStore:n,dependencyMap:i.dependencyMap??{},exampleRow:{properties:l.getProperties()}});(0,d().b)({environment:t,store:l,properties:e.properties,transaction:o})}}function oe(e){let{environment:t,transaction:o,collectionStore:n,instancePointer:i}=e;const r=i.type;switch(r){case"property":s().E2({environment:t,collectionStore:n,schema:n.getSchema(),property:i.id,transaction:o,permanentlyDelete:!1});break;case"collection_view":case"layout":case"block":case"automation":break;default:(0,c().t1)(r)}}},737128:(e,t,o)=>{o.d(t,{MU:()=>u,Uv:()=>d,jw:()=>m});o(670560),o(122556),o(582845),o(250570),o(533019),o(721473),o(788208),o(22624),o(267602),o(653476),o(241792);var n=()=>o(353329),i=()=>o(955620),r=()=>o(139224),a=()=>o(421654),l=()=>o(970105),c=()=>o(269299),s=()=>o(887430),p=()=>o(382474);function d(e){var t;let{transaction:o,collectionStore:i,propertyTemplates:r}=e;const l=(null===(t=i.getParentBlockStore())||void 0===t?void 0:t.getCollectionViewStores().filter((e=>"table"===e.getType())))??[];if(0===l.length)return;const c=[];for(const a of r){const e=(0,p().ZQ)({collectionStore:i,templateId:a.templateId,instancePointerType:"property"});e&&c.push({property:e.id,visible:!(0,n().yw)(a),...a.tablePropertyFormat})}if(0!==c.length)for(const n of l){var s;const e=(null===(s=n.getPropertyFormatsStore("table_properties"))||void 0===s?void 0:s.getValue())??[],t=new Set(e.map((e=>e.property))),i=c.filter((e=>!t.has(e.property)));0!==i.length&&a().FH({stores:[n],update:{table_properties:[...e,...i]},transaction:o})}}function u(e){let{transaction:t,collectionStore:o,propertyTemplates:n}=e;const i=[];for(const a of n){const e=(0,p().ZQ)({collectionStore:o,templateId:a.templateId,instancePointerType:"property"});e&&i.push({property:e.id,visible:!0})}const r=o.getFormat().collection_page_properties??[],l=new Set(r.map((e=>e.property))),c=i.filter((e=>!l.has(e.property)));c.length&&a().FH({stores:[o],update:{collection_page_properties:[...r,...c]},transaction:t})}function m(e){let{environment:t,userAction:o,result:n,existingCollectionViewBlockStore:a}=e;if("canceled"!==n.type){if("accepted_empty_collection"===n.type&&a){const e=a.getTitleStore(),r=(0,i().TPx)(n.newCollectionTitle);e&&c().createAndCommit({userAction:o,environment:t,canUndo:!0,perform:o=>l().sO({environment:t,store:e,transaction:o,value:r})})}if(a){var p;const e=null===(p=(0,s().fm)(a))||void 0===p?void 0:p.settingsStore;e&&r().E3({collectionSettingsStore:e})}}}},113212:(e,t,o)=>{o.d(t,{AK:()=>c,Bc:()=>l,Ez:()=>s,Xn:()=>p,kR:()=>a});var n=()=>o(625230),i=()=>o(594546),r=()=>o(749826);function a(e){let{environment:t,eventProperties:o}=e;const n="suggested_collection_template_clicked";(0,i().j)({environment:t,event:{eventName:n,eventProperties:o}}),r().default.logEvent(n,o.collection_template_id,o)}function l(e){let{environment:t,eventProperties:o,setupGenerator:a}=e;const l="workflow_template_onboarding_done";(0,i().j)({environment:t,event:{eventName:l,eventProperties:o}}),r().default.logEvent(l,o.collection_template_id,o),n().j({name:"collection_created_from_workflow_template",args:{template_id:o.collection_template_id??"",origin:o.origin,experiment_group:"personalized"}}),null==a||a.trackSessionEnded({reason:"instantiated"})}function c(e){let{environment:t,eventProperties:o}=e;const n="setup_generator_session_started";(0,i().j)({environment:t,event:{eventName:n,eventProperties:o}}),r().default.logEvent(n,void 0,o)}function s(e){let{environment:t,eventProperties:o}=e;const n="setup_generator_generated_setup";(0,i().j)({environment:t,event:{eventName:n,eventProperties:o}}),r().default.logEvent(n,void 0,o)}function p(e){let{environment:t,eventProperties:o}=e;const n="template_picker_opened";(0,i().j)({environment:t,event:{eventName:n,eventProperties:o}}),r().default.logEvent(n,o.origin,o)}},938938:(e,t,o)=>{o.r(t),o.d(t,{createCollectionTemplateFromModalState:()=>le,createMinimalCollectionTemplateWithoutModal:()=>re,createPlaceholderWorkflowTemplateBlock:()=>ue,getSetupGeneratorForTemplate:()=>te,getTemplateOnboardingVersion:()=>Y,handleSelectTemplateFromOnboardingModal:()=>ne,maybeAddAppTemplateMetadataForTasks:()=>pe,moveToNextOnboardingStep:()=>he,moveToPreviousOnboardingStep:()=>Se,onNavigateToPlaceholderWorkflowTemplateBlock:()=>me,openSelectedTemplateOnboardingModalForInAppFlows:()=>oe,openTemplateOnboardingModal:()=>H,retryAiSetup:()=>ve,setFollowUpInputFocused:()=>fe,setPreviewCollectionViewTemplateId:()=>ge,switchModalToTemplate:()=>ie,toggleFeatureSelectionInPreview:()=>de});o(821057),o(267602),o(653476),o(470928),o(241792);var n=()=>o(506347),i=()=>o(926724),r=()=>o(353329),a=()=>o(156642),l=()=>o(956057),c=()=>o(255393),s=()=>o(955620),p=()=>o(513670),d=()=>o(855741),u=()=>o(696459),m=()=>o(384667),v=()=>o(421654),f=()=>o(528918),g=()=>o(636340),S=()=>o(47443),h=()=>o(102182),y=()=>o(269299),_=()=>o(576808),w=()=>o(614027),I=()=>o(527278),T=()=>o(803728),C=(o(492176),o(159867),o(93383),o(7961),o(228244),()=>o(680146)),b=()=>o(342792),k=()=>o(594546),M=()=>o(113212);o(670560);class P{constructor(){this.root=new V}append(e){if(this.root.isEmpty())this.root.addChild(e);else{const t=this.toNodes().at(-1);if(!t)throw new Error("Last node not found");t.addChild(e)}}toNodes(){return this.root.getSelectedPath()}toValues(){return this.toNodes().map((e=>e.value))}removeLast(){const e=this.toNodes().at(-1);if(!e)return;const t=e.value;return e.remove(),t}removeLastMatching(e){const t=this.toNodes().findLastIndex((t=>e(t.value)));if(-1===t)return[];const o=[];for(;this.toNodes().length>t;){const e=this.removeLast();void 0!==e&&o.push(e)}return o}}class V{constructor(){this.children=[],this.selectedChild=void 0}addChild(e){const t=new A(e,this);return this.children.push(t),this.selectedChild=t,t}getSelectedPath(){var e;return(null===(e=this.selectedChild)||void 0===e?void 0:e.toSelectedPath())??[]}isEmpty(){return 0===this.children.length}getChildren(){return this.children}setSelectedChild(e){if(!this.children.includes(e))throw new Error("Cannot select a node that is not a child");this.selectedChild=e}removeChild(e){const t=this.children.indexOf(e);-1!==t&&(this.children.splice(t,1),this.selectedChild===e&&(this.selectedChild=void 0))}}class A{constructor(e,t){this.value=void 0,this.children=[],this.selectedChild=void 0,this.parent=void 0,this.isRemoved=!1,this.value=e,this.parent=t}addChild(e){const t=new A(e,this);return this.children.push(t),this.selectedChild=t,t}toSelectedPath(){const e=[this];return this.selectedChild&&e.push(...this.selectedChild.toSelectedPath()),e}retry(e){if(this.isRemoved)throw new Error("Cannot retry on a removed node");this.parent.addChild(e)}select(e){if(this.isRemoved)throw new Error("Cannot select on a removed node");const t=this.parent.getChildren(),o=e(t.map((e=>e.value)),this.value);if(void 0===o)return!1;const n=t.find((e=>e.value===o));return n?this.parent.setSelectedChild(n):this.parent.addChild(o),!0}selectOrRetry(e){if(!this.select(e)){const t=e([],void 0);void 0!==t&&this.retry(t)}}remove(){if(this.children.length>0)throw new Error("Cannot remove a node that has children");if(this.isRemoved)throw new Error("Node is already removed");this.parent.removeChild(this),this.isRemoved=!0}getChildren(){return this.children}setSelectedChild(e){if(!this.children.includes(e))throw new Error("Cannot select a node that is not a child");this.selectedChild=e}removeChild(e){const t=this.children.indexOf(e);-1!==t&&(this.children.splice(t,1),this.selectedChild===e&&(this.selectedChild=void 0),e.isRemoved=!0)}}class x extends(()=>o(263184))().default{getInitialState(){return{isBusy:!1,transcriptTree:new P}}setPrompt(e){this.setState({...this.state,prompt:e})}}class R{constructor(e){var t;this.environment=void 0,this.generatedSetupCount=0,this.store=void 0,this.error=void 0,this.spaceId=void 0,this.eventBase=void 0,this.abortController=void 0,this.onSetupReady=void 0,this.setPrompt=e=>{this.store.setState({...this.store.state,prompt:e})},this.submitPrompt=async e=>{var t;const{from:n}=e,i="follow-up"===n,{isBusy:r,prompt:a}=this.store.state;if(r||!a)return!1;this.store.setState({...this.store.state,isBusy:!0}),null===(t=this.store.state.transcriptTree.toNodes().find((e=>"config"===e.value.type)))||void 0===t||t.selectOrRetry((e=>{const t=e.find((e=>"config"===e.type&&"setup-generator"===e.value.type));return t||{id:(0,b().ZP)(),type:"config",value:{type:"setup-generator"}}}));try{var l;const e=this.store.state.transcriptTree.toNodes().find((e=>"user"===e.value.type));if(e&&!i)e.selectOrRetry((e=>{const t=e.find((e=>"user"===e.type&&(0,s().Z$K)(a,e.value)));if(t)return t;{var o;const e=null===(o=this.environment.currentUser)||void 0===o?void 0:o.id;if(!e)throw new Error("Current user not found");return{id:(0,b().ZP)(),type:"user",value:a,userId:e}}}));else{var c;const e=null===(c=this.environment.currentUser)||void 0===c?void 0:c.id;if(!e)throw new Error("Current user not found");this.store.state.transcriptTree.append({id:(0,b().ZP)(),type:"user",value:a,userId:e})}const t=this.store.state.transcriptTree.toValues();if(!t.slice(t.findLastIndex((e=>"user"===e.type))+1).some((e=>"setup"===e.type))){const e=(0,b().ZP)(),n=new AbortController;this.abortController=n;let i=!1;try{const r=await(0,o(298721)._O)({environment:this.environment,abortSignal:n.signal,upsellFrom:"ai_limit_setup_generator",data:{traceId:e,generateTitle:!1,transcript:t,spaceId:this.spaceId},onResponse:e=>{"setup-operations"===e.type&&this.store.setState({...this.store.state,progress:e.progress}),"retry"!==e.type||i||(i=!0,h().oV({label:"This is taking a little longer than usual"}))}});if(this.abortController=void 0,this.store.setState({...this.store.state,progress:void 0,feedbackArgs:this.computeFeedbackArgs()}),!d().x.isSuccess(r))return C().rn(r.error,{from:"fullPageTranslationActions.generateAndApplyTranslationMapToPage",type:"error"}),this.onSetupReady({error:r.error}),!1;const a=function(e){const t=new Map;for(const o of e){const e="string"==typeof o.id?o.id:String(o.id),n=t.get(e);n&&"setup-operations"===n.type&&"setup-operations"===o.type?t.set(e,{...n,operations:[...n.operations,...o.operations]}):t.set(e,o)}return Array.from(t.values())}(r.value.filter((e=>"inference"!==e.type)));for(const e of a)this.store.state.transcriptTree.append(e)}finally{this.abortController=void 0}}const n=null===(l=this.store.state.transcriptTree.toValues().findLast((e=>"setup"===e.type)))||void 0===l?void 0:l.setup;if(!n)throw new Error("Missing setup step");return this.generatedSetupCount++,this.store.setState({...this.store.state,setup:n,prompt:void 0}),this.trackGeneratedSetup(n),this.onSetupReady({value:n}),!0}catch(p){return p instanceof Error&&"AbortError"===p.name||(C().rn(p,{from:"setupGenerator.submitPrompt",type:"error"}),this.onSetupReady({error:this.error})),!1}finally{this.store.setState({...this.store.state,isBusy:!1,feedbackArgs:this.computeFeedbackArgs()})}},this.stopGenerating=()=>{var e;null===(e=this.abortController)||void 0===e||e.abort()},this.discardLatestSetup=()=>{var e,t;const o=null===(e=this.store.state.transcriptTree.toValues().findLast((e=>"user"===e.type)))||void 0===e?void 0:e.value;if(!o)return;this.store.state.transcriptTree.removeLastMatching((e=>"user"===e.type));const n=null===(t=this.store.state.transcriptTree.toValues().findLast((e=>"setup"===e.type)))||void 0===t?void 0:t.setup;this.store.setState({...this.store.state,prompt:o,setup:n,feedbackArgs:this.computeFeedbackArgs()}),n&&this.onSetupReady({value:n}),(0,k().j)({environment:this.environment,event:{eventName:"setup_generator_try_again_clicked",eventProperties:this.eventBase}})};const{environment:n,spaceId:i,onSetupReady:r,initialPrompt:a,analyticsArgs:l}=e;this.environment=n,this.spaceId=i,this.eventBase={flow_id:l.workflowTemplatesFlowId??(0,b().ZP)(),origin:l.origin,has_selection_modal_search_query:l.hadSelectionModalSearchEntered},this.store=new x,this.store.state.transcriptTree.append({id:(0,b().ZP)(),type:"config",value:{type:"setup-generator"}});const c=null===(t=this.environment.currentUser)||void 0===t?void 0:t.id;if(!c)throw new Error("Current user not found");a&&(this.store.setState({...this.store.state,prompt:a}),this.store.state.transcriptTree.append({id:(0,b().ZP)(),type:"user",value:a,userId:c})),this.onSetupReady=r,this.trackSessionStarted()}computeFeedbackArgs(){const{setup:e}=this.store.state,t=null==e?void 0:e.metadata.setupId;if(t&&this.store.state.transcriptTree)return{spaceId:this.spaceId,traceId:t,transcript:this.store.state.transcriptTree.toValues()}}discardAllSetups(){var e;if(!this.store.state.transcriptTree)return;const t=this.store.state.transcriptTree.toNodes().findIndex((e=>"user"===e.value.type));if(-1===t)return;const o=this.store.state.transcriptTree.toValues().at(t);if(!o||"user"!==o.type)return;for(;this.store.state.transcriptTree.toNodes().length>t;)this.store.state.transcriptTree.removeLast();const n=null===(e=this.store.state.transcriptTree.toValues().findLast((e=>"setup"===e.type)))||void 0===e?void 0:e.setup;this.store.setState({...this.store.state,prompt:o.value,setup:n,feedbackArgs:this.computeFeedbackArgs()}),n&&this.onSetupReady({value:n})}trackSessionStarted(){(0,M().AK)({environment:this.environment,eventProperties:this.eventBase})}trackSessionEnded(e){const{reason:t}=e;(0,k().j)({environment:this.environment,event:{eventName:"setup_generator_session_ended",eventProperties:{...this.eventBase,generated_setup_count:this.generatedSetupCount,reason:t}}})}trackGeneratedSetup(e){const{metadata:t}=e,{setupId:o,promptInfo:n}=t,i=e.allTemplates.filter((e=>(0,r().U2)(e,"collection"))).length,a=e.allTemplates.filter((e=>(0,r().U2)(e,"collection_view"))).length,l=e.allTemplates.filter((e=>(0,r().U2)(e,"property"))).length;(0,M().Ez)({environment:this.environment,eventProperties:{...this.eventBase,setup_id:o,prompt_type:"custom",collection_count:i,collection_view_count:a,property_count:l,total_duration_ms:e.metadata.timing.total,warning_count:e.metadata.warnings.length,error_count:e.metadata.errors.length,use_case:null==n?void 0:n.useCase,prompt_specificity:null==n?void 0:n.specificity,prompt_language:null==n?void 0:n.language}})}}var F=()=>o(985866),B=()=>o(826955),E=()=>o(365929),$=()=>o(965350),U=()=>o(281236);function O(e){let{environment:t,parentStore:o,collectionTemplate:n}=e;if(!o.getSpaceId())throw new Error(`Space ID not found for ${o}`);const i=(0,r().Js)(n).map((e=>U().globalWorkflowTemplates.fromId(e))).filter((e=>(0,r().yw)(e))),a=[];for(const r of i){const{relatedCollectionTemplateId:e}=r,n=(0,U().getChildCollectionStoreByTemplateId)({environment:t,parentStore:o,collectionTemplateId:e});n&&a.push({type:"target",collectionStore:n,relationPropertyTemplate:r})}return a}var N=()=>o(877727),K=()=>o(382474),W=()=>o(247971),D=()=>o(533808),G=()=>o(184441),j=()=>o(586806),L=()=>o(612427),z=()=>o(887430),Z=()=>o(122252);function X(e){var t;let{environment:o,template:n,collectionViewBlockStore:i,previousFeatureSelections:r,examplePageStores:a}=e;const l=null==i?void 0:i.getCollectionStore();if(!l)return;const c=(0,K().A5)({environment:o,scopeStore:l,templateId:n.templateId});if(c&&!(0,K().cb)(c))return;(null===(t=r.find((e=>e.template.templateId===n.templateId)))||void 0===t?void 0:t.selected)??!1?c&&y().createAndCommit({userAction:"workflowTemplatesOnboardingPreview.removeFeatureTemplate",environment:o,canUndo:!1,perform:e=>{J({environment:o,transaction:e,collectionStore:l,instancePointer:c,previousSelectionIds:r.map((e=>e.template.templateId))})}}):y().createAndCommit({userAction:"workflowTemplatesOnboardingPreview.addFeatureTemplate",environment:o,canUndo:!1,perform:e=>{q({environment:o,transaction:e,collectionViewBlockStore:i,collectionStore:l,template:n,existingInstancePointer:c,examplePageStores:a})}})}function q(e){var t,o;let{environment:n,transaction:i,collectionViewBlockStore:a,collectionStore:l,template:c,existingInstancePointer:s,examplePageStores:p}=e;if(!a||!(0,r().Zl)(c))return;const d=s&&(0,K().i0)({environment:n,instancePointer:s,inMemoryRecordCache:l.inMemoryRecordCache});if(d&&"compound"!==s.type)return;if(d&&"compound"===s.type){for(const e of s.instancePointers)if("property"===e.type)Q({environment:n,transaction:i,propertyId:e.id,collectionStore:l});else{const t=(0,K().ip)({environment:n,collectionStore:l,instancePointerId:e.id});if(!t)return;q({environment:n,transaction:i,collectionViewBlockStore:a,collectionStore:l,template:t,existingInstancePointer:e,examplePageStores:p})}return}const u=null===(t=z().fm(a))||void 0===t?void 0:t.normalizedDeletedSchemaStore.state,m=u&&(null===(o=Object.entries(u))||void 0===o?void 0:o.find((e=>{var t;let[o,n]=e;return(null==n||null===(t=n.workflow_template_instance)||void 0===t?void 0:t.template_id)===c.templateId})));m?Q({environment:n,transaction:i,propertyId:m[0],collectionStore:l}):(0,Z().rU)({environment:n,transaction:i,collectionStore:l,template:c,logger:new(U().WorkflowTemplateLogger),origin:"onboarding_preview",examplePageStores:p})}function J(e){let{environment:t,transaction:o,collectionStore:n,instancePointer:i,previousSelectionIds:r}=e;"compound"===i.type?function(e){let{environment:t,transaction:o,collectionStore:n,instancePointer:i,previousSelectionIds:r}=e;if("compound"!==i.type)return;const a=(0,K().Ko)({environment:t,collectionStore:n}).find((e=>e.instancePointer.id===i.id));if(!a)return;const l=(0,K().OA)({environment:t,collectionStore:n,compoundTemplateInstancesToDelete:[a]}).filter((e=>{const o=(0,K().ip)({environment:t,collectionStore:n,instancePointerId:e.id});return o&&!r.includes(o.templateId)}));for(const c of l)J({environment:t,transaction:o,collectionStore:n,instancePointer:c,previousSelectionIds:r})}({environment:t,transaction:o,collectionStore:n,instancePointer:i,previousSelectionIds:r}):(0,Z().rn)({environment:t,transaction:o,collectionStore:n,instancePointer:i})}function Q(e){let{environment:t,transaction:o,collectionStore:n,propertyId:i}=e;const r=z().D8({deletedSchema:n.getDeletedSchema(),property:i});r&&((0,L().x)({environment:t,collectionStore:n,update:r.updateSchema,transaction:o}),(0,j().$)({collectionStore:n,update:r.updateDeletedSchema,transaction:o}))}function H(e){let{template:t,parentStore:o,origin:n,version:i,existingCollectionInfo:r,relationInfos:a,navigateToOnFinish:l="created_collection",setupGenerator:c,flowId:s,onClose:p}=e;const d=t?(0,D().BQ)({collectionTemplate:t,origin:n,flowId:s,parentStore:o}):(0,D().W)({origin:n,flowId:s,parentStore:o});E().wS(),G().default.setState({open:!0,isSaving:!1,currentStepIndex:0,version:i,existingCollectionInfo:r,relationInfos:a??[],navigateToOnFinish:l,setupGenerator:c,onClose:p,...d})}function Y(e){if(!e.template)return"in_app_template_onboarding_full_with_discovery";const{includeTemplateSelectionStep:t,hasSetupGenerator:o}=e;return o?t?"in_app_template_onboarding_ai_with_discovery":"in_app_template_onboarding_ai":t?"in_app_template_onboarding_full_with_discovery":"in_app_template_onboarding_full"}const ee=(0,o(788860).vU)({setupGenerationError:{id:"setupGenerator.error.failedToGenerateSetup",defaultMessage:"Sorry, something went wrong while completing this request. Please try again."}});function te(e){let{environment:t,parentStore:o,template:n,initialAiPrompt:i,analyticsArgs:a}=e;const l=o.getSpaceId(),s=(0,r().Wl)(n.templateId)&&void 0!==l?new R({environment:t,analyticsArgs:a,spaceId:l,initialPrompt:i,onSetupReady:e=>{const t=G().default.state;if(!t.open)return;if(d().x.isFail(e)){if(e.error instanceof c().vU)return;return void h().oV({label:I().Z.formatMessage(ee.setupGenerationError)})}const o=e.value;if(t.setupGenerator!==s)return;W().F.append(o.allTemplates.filter((e=>e.isAiGenerated)));const n=o.allTemplates.find((e=>(0,r().U2)(e,"collection")));if(!n)throw new Error("No collection template found");ie(n)}}):void 0;return s}function oe(e){var t;let{template:o,environment:n,aiPrompt:i,...r}=e;const{parentStore:a,relationInfos:l,origin:c,flowId:s}=r,d=O({environment:n,parentStore:a,collectionTemplate:o}),u=te({environment:n,template:o,parentStore:a,initialAiPrompt:i,analyticsArgs:{origin:c,hadSelectionModalSearchEntered:((null===(t=r.collectionTemplatesSearchQuery)||void 0===t?void 0:t.length)??0)>0,workflowTemplatesFlowId:s}});H({...r,template:o,version:Y({template:o,includeTemplateSelectionStep:!1,hasSetupGenerator:Boolean(u)}),relationInfos:p().mN([...l??[],...d],(e=>e.collectionStore.id)),setupGenerator:u})}function ne(e){var t,o;let{template:n,environment:i,analyticsArgs:r}=e;const a=G().default.state;if(!a.open)return;const{parentStore:l,relationInfos:c,origin:d,flowId:u}=a,m=O({environment:i,parentStore:l,collectionTemplate:n}),v=p().mN([...c??[],...m],(e=>e.collectionStore.id)),f=te({environment:i,template:n,parentStore:l,analyticsArgs:{origin:d,hadSelectionModalSearchEntered:((null===(t=a.collectionTemplatesSearchQuery)||void 0===t?void 0:t.length)??0)>0,workflowTemplatesFlowId:u},initialAiPrompt:a.collectionTemplatesSearchQuery?(0,s().TPx)(a.collectionTemplatesSearchQuery):void 0}),g=Y({template:n,includeTemplateSelectionStep:!0,hasSetupGenerator:Boolean(f)}),S={...a,open:!0,isSaving:!1,currentStepIndex:(0,D().J3)(a),version:g,relationInfos:v??[],setupGenerator:f,isFollowUpInputFocused:!1,...(0,D().BQ)({collectionTemplate:n,origin:d,flowId:u,parentStore:l})};null!==(o=n.value.onboarding)&&void 0!==o&&o.isMinimal?le({environment:i,modalState:S}):("suggested_template"===r.type&&(0,M().kR)({environment:i,eventProperties:{from_modal_template_picker:!0,selected_index:r.allOrderedTemplateIds.indexOf(n.templateId),collection_template_ids_shown:r.allOrderedTemplateIds,...(0,D().px)({origin:d,parentStore:l,collectionTemplatesSearchQuery:a.collectionTemplatesSearchQuery,flowId:u,collectionTemplate:n})}}),G().default.setState(S))}function ie(e){const t=G().default.state;if(!t.open||!t.collectionTemplate)return;let o={...t,...(0,D().BQ)({collectionTemplate:e,origin:t.origin,flowId:t.flowId,parentStore:t.parentStore}),isSaving:!1};if(t.collectionTemplate.templateId===e.templateId){const e=o.userCustomizations.featureTemplateSelections,n=t.userCustomizations.featureTemplateSelections,i=e.map((e=>{const t=n.find((t=>t.template.templateId===e.template.templateId));return"required"!==e.optionality&&t?{...e,selected:t.selected}:e}));o={...o,userCustomizations:{...o.userCustomizations,featureTemplateSelections:i}}}G().default.setState(o)}function re(e){let{environment:t,template:o,parentStore:n,existingCollectionInfo:i,relationInfos:r}=e;y().createAndCommit({userAction:"workflowTemplates.createMinimalCollectionTemplate",environment:t,canUndo:!0,perform:e=>{(0,$().l3)({environment:t,transaction:e,template:o,parentStore:n,existingCollectionInfo:i,inMemoryRecordCache:n.inMemoryRecordCache,relationInfos:r,logger:new(U().WorkflowTemplateLogger)})}})}function ae(e){var t;let{environment:o,modalState:i,collectionViewBlockStore:r,collectionStore:a,examplePageStores:l}=e;if(!a)return;const{existingCollectionInfo:c,userCustomizations:s,navigateToOnFinish:p}=i,d=(0,D().px)(i);!function(e){let{environment:t,eventProperties:o,collectionViewBlockStore:i,examplePageStores:r,navigateTo:a,result:l}=e;const c=(0,N().mq)();if("created_collection"===a)S()._c({environment:t,store:i,visitType:w().vu.Link,pageVisitSource:n().tY.WorkflowTemplateOnboarding,callback:()=>{c?E().aI({examplePageStores:r,collectionViewBlockStore:i,eventProperties:o}):(0,T().yM)(t,"collection_add_item_button_tooltip")}});else if("skip"===a){var s;c&&null!==(s=i.getModel())&&void 0!==s&&s.isFullPageCollectionView()&&E().aI({examplePageStores:r,collectionViewBlockStore:i,eventProperties:o})}else(0,u().t1)(a);const p=G().default.getState();!p.open&&p.isShowingLoadingState&&f().x();G().default.close(l)}({environment:o,eventProperties:d,collectionViewBlockStore:r,examplePageStores:l,navigateTo:p,result:{type:"accepted_template"}}),(0,M().Bc)({environment:o,setupGenerator:i.setupGenerator,eventProperties:{record_titles_is_empty:s.recordTitles.map((e=>0===e.length)),selected_feature_template_ids:s.featureTemplateSelections.filter((e=>"required"!==e.optionality&&e.selected)).map((e=>e.template.templateId)),step:(0,D().IA)(i),target_page_ids:[r.id],collection_ids:[a.id],example_page_ids:l.map((e=>e.id)),existing_block_id:null==c||null===(t=c.collectionViewBlockStore)||void 0===t?void 0:t.id,...d}})}function le(e){let{environment:t,modalState:o}=e;if(!o.collectionTemplate||o.isSaving)return;const{collectionTemplate:n,parentStore:i,existingCollectionInfo:r,relationInfos:a,userCustomizations:l}=o;G().default.setState({...o,isSaving:!0});const{performResult:c}=y().createAndCommit({userAction:"WorkflowTemplatesOnboardingModal.getStarted",environment:t,canUndo:!0,perform:e=>{const{collectionStore:o,collectionViewStore:c,collectionViewBlockStore:s,examplePageStores:p}=(0,$().l3)({environment:t,transaction:e,template:n,parentStore:i,existingCollectionInfo:r,inMemoryRecordCache:i.inMemoryRecordCache,selectedFeatureTemplateIds:(0,U().getSelectedFeatureTemplateIds)(l),relationInfos:a,logger:new(U().WorkflowTemplateLogger)});return function(e){let{environment:t,transaction:o,collectionStore:n,collectionViewStore:i,collectionViewBlockStore:r,recordTitles:a}=e;const l=new(F().Z)(t);l.setContext({type:"collectionView",collectionViewBlockStore:r,collectionStore:n,collectionViewStore:i,pageVisitSourceOverride:void 0});const c=a.filter((e=>e.length>0));for(const s of c)ce({environment:t,transaction:o,collectionContextStore:l,title:s})}({environment:t,transaction:e,collectionStore:o,collectionViewStore:c,collectionViewBlockStore:s,recordTitles:l.recordTitles}),{collectionViewBlockStore:s,collectionStore:o,examplePageStores:p}}});ae({environment:t,modalState:o,collectionViewBlockStore:c.collectionViewBlockStore,collectionStore:c.collectionStore,examplePageStores:c.examplePageStores})}function ce(e){let{environment:t,transaction:o,collectionContextStore:n,title:i}=e;const{newStore:r}=m().IW({environment:t,collectionContextStore:n,groupsPointer:[],insertAtIndex:0,shouldCoerce:!0,templateStore:n.defaultPageTemplateStore.state,transaction:o,from:{createBlock:"workflow_template"},inMemoryRecordCache:t.defaultRecordCache.inMemoryRecordCache}),a=[i];return(0,_().b)({environment:t,store:r,properties:{title:[a]},transaction:o}),r}const se={assigneeProperty:"notion://tasks/assign_property",statusProperty:"notion://tasks/status_property",dueDateProperty:"notion://tasks/due_date_property"};function pe(e){let{environment:t,transaction:o,collectionStore:n,collectionViewBlockStore:r}=e;const a=i().Ym,c=i().NB,s=(0,K().Vc)({environment:t,collectionStore:n}),p={};for(const[i,l]of Object.entries(se)){const e=s.find((e=>e.templateId.includes(i)));if(!e)return;p[l]=e.instancePointer.id}v().FH({stores:[n],update:{app_config_uri:a,app_uri_map:p},transaction:o}),v().FH({stores:[r],update:{app_id:l().Il(),app_config_uri:c,app_uri_map:{[a]:n.id,[c]:r.id}},transaction:o})}function de(e){let{template:t,environment:o}=e;const n=G().default.state;n.open&&n.collectionTemplate&&(G().default.setState({...n,userCustomizations:(0,D().xo)({userCustomizations:n.userCustomizations,templateId:t.templateId})}),(0,N().SV)()&&X({environment:o,template:t,collectionViewBlockStore:n.collectionViewBlockStore,previousFeatureSelections:n.userCustomizations.featureTemplateSelections,examplePageStores:n.examplePageStores}))}function ue(e){let{environment:t,transaction:o,parentStore:n,collectionTemplate:i}=e;const r=g().j4({environment:t,type:a().Ti.collectionViewPage,spaceId:n.getSpaceId(),format:{collection_view_sub_type:"workflow_template_placeholder",placeholder_workflow_template_id:i.templateId,page_icon:i.value.targetCollection.icon},properties:{title:(0,s().TPx)(i.value.targetCollection.name)},inMemoryRecordCache:n.inMemoryRecordCache,transaction:o});g().sW({store:r,data:{parent_id:n.id,parent_table:n.table,alive:!0},transaction:o});const l=B().G.createChildStore(n,r.pointer);return(0,$().jo)({environment:t,parentStore:n,collectionViewBlockStore:l,transaction:o,appendOrPrepend:"append"}),l}function me(e){let{environment:t,collectionTemplate:o,collectionViewBlockStore:i}=e;const r=i.getParentStore(),a=r&&(0,U().isCollectionTemplateParentStore)(r)?r:i;if(t.device.isMobile)return re({environment:t,template:o,parentStore:a,existingCollectionInfo:{collectionViewBlockStore:i,collectionStore:void 0,collectionViewStore:void 0},relationInfos:[]}),S()._c({environment:t,store:i,visitType:w().vu.Link,pageVisitSource:n().tY.WorkflowTemplateOnboarding}),{didOpenOnboardingModal:!1};const l="placeholder_block",c=(0,D().px)((0,D().BQ)({collectionTemplate:o,origin:l,flowId:void 0,parentStore:a}));return(0,M().kR)({environment:t,eventProperties:{...c,from_modal_template_picker:!1,selected_index:0,collection_template_ids_shown:[o.templateId]}}),oe({environment:t,template:o,origin:l,parentStore:a,aiPrompt:void 0,flowId:c.flow_id,existingCollectionInfo:{collectionViewBlockStore:i,collectionStore:void 0,collectionViewStore:void 0}}),{didOpenOnboardingModal:!0}}function ve(){const e=G().default.state;if(!e.open)return;const t=e.setupGenerator;t&&(t.discardLatestSetup(),void 0===t.store.state.setup&&Se())}function fe(e){const t=G().default.state;t.open&&G().default.setState({...t,isFollowUpInputFocused:e})}function ge(e){G().default.state.open&&G().default.updatePreviewCollectionViewTemplateId(e)}function Se(){const e=G().default.state;if(!e.open)return;const t=(0,D().AQ)(e);t>=0&&G().default.setState({...e,isFollowUpInputFocused:!1,currentStepIndex:t})}function he(){const e=G().default.state;if(!e.open)return;const t=(0,D().J3)(e);t>=0&&G().default.setState({...e,isFollowUpInputFocused:!1,currentStepIndex:t})}},184441:(e,t,o)=>{o.d(t,{default:()=>r});class n extends(()=>o(263184))().default{getInitialState(){return{open:!1,isShowingLoadingState:!1}}updateUserCustomizations(e,t){this.state.open&&this.state.collectionTemplate&&this.setState({...this.state,userCustomizations:{...this.state.userCustomizations,[e]:t}})}updateCollectionTemplate(e){this.state.open&&this.state.collectionTemplate&&this.setState({...this.state,collectionTemplate:e})}updatePreviewCollectionViewTemplateId(e){this.state.open&&this.state.collectionTemplate&&this.setState({...this.state,previewCollectionViewTemplateId:e})}setExamplePageStores(e){this.state.open&&this.state.collectionTemplate&&this.setState({...this.state,examplePageStores:e})}getParentStore(){return this.state.open?this.state.parentStore:void 0}getShouldShowExpandedTemplateList(){return this.state.open&&this.state.shouldShowExpandedTemplateList}setShouldShowExpandedTemplateList(e){this.state.open&&this.setState({...this.state,shouldShowExpandedTemplateList:e})}close(e){var t,o;this.state.open&&(null===(t=(o=this.state).onClose)||void 0===t||t.call(o,e),this.setState({open:!1,isShowingLoadingState:!1}))}reset(){this.setState(this.getInitialState())}}const i=new n;(0,o(947115).exposeDebugValue)("InitializeWorkflowTemplateModalStore",i);const r=i}}]);