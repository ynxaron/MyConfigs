"use strict";(globalThis.webpackChunknotion_next=globalThis.webpackChunknotion_next||[]).push([[47295,39447],{881068:(e,t,n)=>{n.r(t),n.d(t,{getFormulaEditorInfoAtPosition:()=>x});n(670560),n(122556),n(582845),n(250570),n(533019),n(721473),n(788208),n(22624),n(267602),n(653476),n(470928),n(30005),n(241792);var o=()=>n(478701),r=()=>n(839002),i=()=>n(855741),a=()=>n(619186),s=()=>n(196024),c=()=>n(942265),l=()=>n(92960),p=()=>n(414853),u=()=>n(549045),d=()=>n(853031),y=()=>n(553296),m=()=>n(455222),f=()=>n(177634),h=()=>n(351062);async function v(e,t,n){const o=[],i=new Set;if(void 0!==e){const a=t.handleDataRequest({recordPointers:[e]}),s=((0,r().tI)(a)?await a:a).getRecordModel(e),c=null==s?void 0:s.getNormalizedSchema();if(c)for(const[r,p]of Object.entries(c))if(void 0!==(null==p?void 0:p.type)&&l().FormulaTokenSupportedBlockSystemPropertyList.includes(null==p?void 0:p.type)&&i.add(p.type),r!==t.sourceProperty&&null!=p&&p.name&&l().FORMULAS_SUPPORTED_COLLECTION_PROPERTY_TYPES.includes(null==p?void 0:p.type)&&T(n,p.name)){let n;"cross_space_only"===t.restrictUnaccessibleProperties?n=d().hasSameSpaceAccess:"read_permissions_only"===t.restrictUnaccessibleProperties?n=d().hasReadPermissionsAccess:"cross_space_and_read_permissions"===t.restrictUnaccessibleProperties&&(n=d().hasAccessDefaultFn);(!t.restrictUnaccessibleProperties||!n||await(0,d().hasAccessToProperty)({collectionPointer:e,collectionSchema:c,context:t,propertyId:r,hasAccessFn:n}))&&o.push({kind:l().FormulaEditorInfoCompletionKind.Token,name:p.name,token:{type:l().FormulaTokenType.BlockProperty,property:(0,f().Uw)(r),collection:e}})}}for(const r of Object.values(l().FormulaTokenSupportedBlockSystemProperty)){if(i.has(r))continue;const e=(0,s().V)(r);(""===n||T(n,e))&&o.push({kind:l().FormulaEditorInfoCompletionKind.Token,token:{type:l().FormulaTokenType.BlockProperty,property:r,collection:void 0},name:e})}return o}function T(e,t){return""===e||(0,a().C6)(e,t)}async function k(e){const{prefix:t,context:n,receiverType:o,includeDeprecatedCompletions:r,dotMemberExpression:i}=e,s=[],c=[],p=[],u=new Set;if(void 0===o){var d;n.valueTypes.forEach((e=>{if(e.kind===l().FormulaContextValueKind.Binding){const n=e.id;!u.has(n)&&t!==e.id&&T(t,e.id)&&(s.push({kind:l().FormulaEditorInfoCompletionKind.Binding,text:n,type:e.type}),u.add(n))}}));const e=null===(d=n.valueTypes.find((e=>e.kind===l().FormulaContextValueKind.ThisRow)))||void 0===d?void 0:d.type;"block"===(null==e?void 0:e.type)&&void 0!==e.collection&&c.push(...await v(e.collection,n,t)),n.valueTypes.forEach((e=>{if(e.kind===l().FormulaContextValueKind.ContextValue&&T(t,e.name)){const t=(0,f().ij)(e.id);c.push({kind:l().FormulaEditorInfoCompletionKind.Token,name:e.name,token:{type:l().FormulaTokenType.ContextValue,valueId:t}})}}))}else"block"===o.type&&c.push(...await v(o.collection,n,t));for(const a in h().Vr)if(!u.has(a)&&T(t,a)&&(r||!a.startsWith("_"))&&("toNumber"!==a||null==o||!o.type||!h().N7.includes(o.type))&&(!i||!h().rq.includes(a))){const e=h().Vr[a];if(void 0!==o){var y,m;const t=(null===(y=e.parameters)||void 0===y||null===(y=y.expected)||void 0===y||null===(y=y[0])||void 0===y?void 0:y.type)??(null===(m=e.parameters)||void 0===m||null===(m=m.varargs)||void 0===m||null===(m=m[0])||void 0===m?void 0:m.type);if(void 0===t||!(0,f().qT)(o,t))continue}p.push({kind:l().FormulaEditorInfoCompletionKind.LibraryFunction,libraryFunction:e}),u.add(a)}return[...(0,a().ZP)(t,s,(e=>e.text)),...(0,a().ZP)(t,c,(e=>e.name??"")),...(0,a().ZP)(t,[],(e=>e.builtin)),...(0,a().ZP)(t,p,(e=>e.libraryFunction.name))]}function b(e,t){const n=[...e].reverse().find((e=>e.kind===m().bG.Call));if((null==n?void 0:n.kind)===m().bG.Call){let e=-1;if(t>n.lParenOffset&&(void 0===n.rParenOffset||t<=n.rParenOffset))for(e=0;e<n.commaOffsets.length&&!(n.commaOffsets[e]>t);e++);return{expression:n.expression,parameterIndex:e}}}const F={[l().FormulaEditorInfoCompletionKind.Binding]:0,[l().FormulaEditorInfoCompletionKind.Token]:1,[l().FormulaEditorInfoCompletionKind.Builtin]:2,[l().FormulaEditorInfoCompletionKind.LibraryFunction]:3};async function x(e){var t,n;const{formula:r,inputPosition:a,context:s,includeDeprecatedCompletions:d}=e,[v,x]=(0,p().dJ)(r),g=(0,p().Eh)(x,a);let C=v.substring(0,g);const I=C[C.length-1],E=/[\s.]/.test(I);E&&(C=`${C}_`);const M=(0,u().XR)(),N=(0,u().s)(M).tokenize(C).tokens,A=(0,u().Z8)(M);A.input=N;const R=A.expression(),S=(0,c().K)(R);if(i().x.isFail(S))return{value:void 0};const w=await(0,y().b)(S.value,s,x),{node:Y}=w,U=N[N.length-1];let O=!1,D=N;void 0!==U&&(0,o().ol)(U,M.IdentifierName)&&(D=[...D],D.pop(),O=!0);const _=A.computeContentAssist("expression",D),G=O?U.image.substring(0,U.image.length-(E?1:0)):void 0,V=(0,f().cQ)(Y,g),L={inputPosition:a,mappedPosition:g,nodePath:V,callParameter:b(V,g)},B=[],K=b(V,g),$={handleDataRequest:s.handleDataRequest,restrictUnaccessibleProperties:s.restrictUnaccessibleProperties,sourceProperty:s.sourceProperty,spaceId:s.spaceId,valueTypes:Y.valueTypes,featureGates:s.featureGates};let j;for(let o=1;o<=5;o++){const e=(0,f().cQ)(Y,g-o);if(j=e[e.length-1],void 0!==j)break}(null===(t=j)||void 0===t?void 0:t.kind)===m().bG.RecoveryNode&&(j=void 0);const W=void 0!==j&&0===V.length,q=!j||j.kind===m().bG.Unary||j.kind===m().bG.Equality||j.kind===m().bG.Identifier,H=!j||j.kind===m().bG.Equality||j.kind===m().bG.Identifier;for(const i of _){var z,X,Z,Q,J,ee,te,ne,oe;if(i.nextTokenType===M.IdentifierName){const e="dotMemberExpression"===i.ruleStack[i.ruleStack.length-1];if(e){const t=D[D.length-1];if(!(0,o().ol)(t,M.Dot))return{value:void 0};const n=V[V.length-1];if(void 0!==n&&(n.kind===m().bG.UnifiedFunctionProperty||n.kind===m().bG.MemberBlockProperty)){const t=n.expression;L.completionsInfo={type:"member dot receiver",prefix:G,receiverNode:t};const o=await k({prefix:G??"",context:$,receiverType:t.type,includeDeprecatedCompletions:d,dotMemberExpression:e});B.push(...o)}}else{L.completionsInfo={type:"free identifier",prefix:G};const t=await k({prefix:G??"",context:$,includeDeprecatedCompletions:d,dotMemberExpression:e});if(B.push(...t),K&&(K.expression.kind===m().bG.UnifiedFunctionProperty&&0===K.parameterIndex||K.expression.kind===m().bG.Identifier&&1===K.parameterIndex)){const e=K.expression.kind===m().bG.UnifiedFunctionProperty?K.expression.name:K.expression.text,t=h().Vr[e];if(((null==t?void 0:t.parameters)===h().yx||(null==t?void 0:t.parameters)===h().uX)&&T(G??"",l().CURRENT_VALUE_NAME)&&G!==l().CURRENT_VALUE_NAME&&G!==`${l().CURRENT_VALUE_NAME}.`){var re,ie;const e=K.expression,t="function"===e.type.type&&"array"===(null===(re=e.type.boundTargetType)||void 0===re?void 0:re.type)&&(null===(ie=e.type.boundTargetType)||void 0===ie?void 0:ie.of)||{type:"unknown"};B.push({kind:l().FormulaEditorInfoCompletionKind.Binding,text:l().CURRENT_VALUE_NAME,type:t}),B.push({kind:l().FormulaEditorInfoCompletionKind.Binding,text:l().CURRENT_INDEX_NAME,type:{type:"number"}})}}}}else if(i.nextTokenType===M.AdditionOperator&&W&&"text"===(null===(z=j)||void 0===z?void 0:z.type.type)){const e=P(["+"],G??"");B.push(...e)}else if(i.nextTokenType===M.AdditionOperator&&W&&"number"===(null===(X=j)||void 0===X?void 0:X.type.type)){const e=P(["+","-"],G??"");B.push(...e)}else if(i.nextTokenType===M.MultiplicationOperator&&W&&"number"===(null===(Z=j)||void 0===Z?void 0:Z.type.type)){const e=P(["*","/"],G??"");B.push(...e)}else if(i.nextTokenType!==M.RelationalOperator||!W||"number"!==(null===(Q=j)||void 0===Q?void 0:Q.type.type)&&"text"!==(null===(J=j)||void 0===J?void 0:J.type.type)&&"date"!==(null===(ee=j)||void 0===ee?void 0:ee.type.type)){if(i.nextTokenType===M.EqualityOperator&&W&&null!==(te=j)&&void 0!==te&&te.type.type&&"unknown"!==(null===(ne=j)||void 0===ne?void 0:ne.type.type)){const e=P(["==","!="],G??"");B.push(...e)}else if(i.nextTokenType===M.BooleanLiteral&&q){const e=P(["true","false"],G??"");B.push(...e)}else if(i.nextTokenType===M.And&&W&&"checkbox"===(null===(oe=j)||void 0===oe?void 0:oe.type.type)){const e=P(["and","or"],G??"");B.push(...e)}else if(i.nextTokenType===M.UnaryOperator&&H){const e=P(["not"],G??"");B.push(...e)}}else{const e=P([">",">=","<","<="],G??"");B.push(...e)}}const ae=null===(n=N[N.length-1])||void 0===n?void 0:n.tokenType;if(0===B.length&&ae===M.IdentifierName){const e=N.slice(-4).reverse(),t=[];for(let o=0;o<e.length;o++){var se;if((null===(se=e[o])||void 0===se?void 0:se.tokenType)!==M.IdentifierName)break;const n=O?e[o].image.substring(0,e[o].image.length-(E?1:0)):void 0;void 0!==n&&(0===o?t.push(n):t.push(n+t[o-1]))}let n=[];for(let o=1;o<t.length;o++){const e=t[o],r=await k({prefix:e.trim(),context:$,includeDeprecatedCompletions:d,dotMemberExpression:!1});if(r.length>0){n=r.map((t=>({...t,overridePrefixLength:e.length+o})))}}B.push(...n)}return L.completions=B.sort(((e,t)=>{const n=e.kind,o=t.kind;return F[n]-F[o]})),{value:L}}function P(e,t){return e.filter((e=>T(t,e))).map((e=>({kind:l().FormulaEditorInfoCompletionKind.Builtin,builtin:e})))}},756191:(e,t,n)=>{n.d(t,{FR:()=>m,OY:()=>y,ic:()=>d,sB:()=>u,sG:()=>p,y_:()=>f});n(241792);var o=()=>n(513670),r=()=>n(696459),i=()=>n(834458),a=()=>n(193962),s=()=>n(455222),c=()=>n(177634);function l(e){switch(e){case"checkbox":return"boolean";case"number":return"number";case"text":return"text";case"date":return"date";case"array":return"array";case"block":return"block";case"person":return"person";case"select":return"select";case"function":return"function";case"unknown":return"unknown";case"undefined":return"undefined";default:(0,r().t1)(e)}}function p(e){switch(e.type){case s().$E.InvalidCharacter:return{...a().mr.InvalidCharacter,values:{errorCharacter:e.character}};case s().$E.UnclosedStringLiteral:return a().mr.UnclosedStringLiteral;case s().$E.UnclosedComment:return a().mr.UnclosedComment;case s().$E.TokenExpected:return{...a().mr.TokenExpected,values:{expectedToken:e.token}};case s().$E.StringLiteralContainsToken:return a().mr.StringLiteralContainsToken;case s().$E.ExpressionExpected:return a().mr.ExpressionExpected;case s().$E.PropertyTokenOrFunctionExpected:return a().mr.PropertyTokenOrFunctionExpected;case s().$E.EndOfInputExpected:return a().mr.EndOfInputExpected;case s().$E.UnexpectedError:return a().mr.UnexpectedError;case s().$E.TooDeeplyNested:return a().mr.TooDeeplyNested;default:(0,r().t1)(e)}}function u(e){switch(e.type){case s().h4.FunctionCallArgumentWrongType:case s().h4.FunctionCallUnexpectedArgument:return e.argument;default:return e.node}}function d(e,t){let n;switch(t.type){case s().h4.ThisRowTypeNotFound:n=a().o8.ThisRowTypeNotFound;break;case s().h4.ThisRowNotBlockWithCollection:n=a().o8.ThisRowNotBlockWithCollection;break;case s().h4.MissingPropertyOnThisRow:n={...a().o8.MissingPropertyOnThisRow,values:{propertyName:t.property}};break;case s().h4.MissingContextVariable:{const e=(0,c().Xp)(t.token)?t.token.contextValueId:t.token.valueId;n={...a().o8.MissingContextVariable,values:{valueId:e}}}break;case s().h4.MissingBlock:n={...a().o8.MissingBlock,values:{blockId:t.token.blockId}};break;case s().h4.CallingNotFunction:n={...a().o8.CallingNotFunction,values:{expressionType:l(t.callee.type.type)}};break;case s().h4.FunctionCallTooFewArguments:n={...a().o8.FunctionCallTooFewArguments,values:{minNumParameters:t.minNumParameters,functionName:t.libraryFunction.name,numArguments:t.numArguments}};break;case s().h4.FunctionCallUnexpectedArgument:n={...a().o8.FunctionCallUnexpectedArgument,values:{functionName:t.libraryFunction.name}};break;case s().h4.FunctionCallArgumentWrongType:n={...a().o8.FunctionCallArgumentWrongType,values:{argumentType:l(t.argument.type.type),functionName:t.libraryFunction.name}};break;case s().h4.MemberPropertyMismatchCollection:n={...a().o8.MemberPropertyMismatchCollection,values:{propertyName:t.token.property}};break;case s().h4.MemberPropertyMissing:n={...a().o8.MemberPropertyMissing,values:{propertyName:t.property}};break;case s().h4.MemberPropertyTargetNotBlock:n=a().o8.MemberPropertyTargetNotBlock;break;case s().h4.MemberPropertyTypeInvalid:n={...a().o8.MemberPropertyTypeInvalid,values:{propertyName:t.propertyName,propertyType:t.propertyType}};break;case s().h4.UndefinedIdentifier:n={...a().o8.UndefinedIdentifier,values:{identifier:t.node.text}};break;case s().h4.UnifiedFunctionCannotFindFunction:n={...a().o8.UnifiedFunctionCannotFindFunction,values:{functionName:t.name}};break;case s().h4.UnifiedFunctionNoArguments:n={...a().o8.UnifiedFunctionNoArguments,values:{functionName:t.libraryFunction.name}};break;case s().h4.UnifiedFunctionTargetWrongType:n={...a().o8.UnifiedFunctionTargetWrongType,values:{functionName:t.libraryFunction.name,targetType:l(t.expression.type.type)}};break;case s().h4.CannotRelativelyCompareTypes:n={...a().o8.CannotRelativelyCompareTypes,values:{lhsType:l(t.lhsType.type),rhsType:l(t.rhsType.type)}};break;case s().h4.CannotDoMathOnType:n={...a().o8.CannotDoMathOnType,values:{lhsType:l(t.lhsType.type),rhsType:l(t.rhsType.type)}};break;case s().h4.UnaryMinusOnNonNumber:n={...a().o8.UnaryMinusOnNonNumber,values:{type:l(t.expression.type.type)}};break;case s().h4.IdentifierExpected:n=a().o8.IdentifierExpected;break;case s().h4.FunctionCallExpected:n={...a().o8.FunctionCallExpected,values:{functionName:t.functionName}};break;case s().h4.RenamedIdentifier:n={...a().o8.RenamedIdentifier,values:{identifier:t.identifier,renamedTo:t.renamedTo}};break;case s().h4.RemovedFunction:n={...a().o8.RemovedFunction,values:{functionName:t.functionName,alternative:t.alternative}};break;case s().h4.ContextVariableNotBlockWithCollection:n={...a().o8.ContextVariableNotBlockWithCollection,values:{valueId:t.token.contextValueId}};break;case s().h4.MissingPropertyOnContextVariable:n={...a().o8.MissingPropertyOnContextVariable,values:{propertyName:t.property,valueId:t.token.contextValueId}};break;case s().h4.BlockPropertyTypeInvalid:n={...a().o8.BlockPropertyTypeInvalid,values:{propertyName:t.propertyName}};break;case s().h4.DisallowedReturnType:{const o=t.allowedReturnTypes.map((t=>e.formatMessage((0,i().getHumanReadableType)(t)).toLocaleLowerCase()));n={...a().o8.DisallowedReturnType,values:{allowedReturnType:e.formatList(o,{style:"long",type:"conjunction"}),allowedReturnTypeCount:t.allowedReturnTypes.length,returnType:e.formatMessage((0,i().getHumanReadableType)(t.returnType)).toLocaleLowerCase()}};break}case s().h4.CrossSpacePropertyNotSupported:n={...a().o8.CrossSpacePropertyNotSupported};break;default:(0,r().t1)(t)}return{...n,values:{...n.values,startOffset:t.node.startOffset,endOffset:t.node.endOffset+1}}}function y(e,t){let n;switch(t.type){case s().FY.MissingThisRow:n=a().YG.MissingThisRow;break;case s().FY.MissingSchemaPropertyOnThisRow:n={...a().YG.MissingSchemaPropertyOnThisRow,values:{propertyName:t.property}};break;case s().FY.ThisRowBlockPropertyMismatchCollection:n=a().YG.ThisRowBlockPropertyMismatchCollection;break;case s().FY.MissingContextVariable:n={...a().YG.MissingContextVariable,values:{valueId:t.valueId}};break;case s().FY.IdentifierNotFound:n={...a().YG.IdentifierNotFound,values:{identifier:t.node.text}};break;case s().FY.CannotRelativelyCompareTypes:n={...a().YG.CannotRelativelyCompareTypes,values:{lhsType:l(t.lhsType),rhsType:l(t.rhsType)}};break;case s().FY.CannotDoMathOnType:n={...a().YG.CannotDoMathOnType,values:{valueType:l(t.valueType)}};break;case s().FY.CannotCallNonFunction:n={...a().YG.CannotCallNonFunction,values:{calleeType:l(t.calleeType)}};break;case s().FY.UnifiedFunctionPropertyNotFound:n={...a().YG.UnifiedFunctionPropertyNotFound,values:{functionName:t.node.name}};break;case s().FY.LibraryFunctionExecutionError:const o=t.error instanceof s().Mu?t.error:void 0;n=(null==o?void 0:o.info.type)===s().sj.DateInvalidDurationUnit?{...a().z8.DateInvalidDurationUnit,values:{functionName:t.libraryFunction.name,invalidUnit:o.info.invalidUnit}}:(null==o?void 0:o.info.type)===s().sj.CannotUseToNumberOnList?{...a().z8.CannotUseToNumberOnList}:(null==o?void 0:o.info.type)===s().sj.CannotRoundToNonInteger?{...a().z8.CannotRoundToNonInteger,values:{precision:o.info.precision}}:(null==o?void 0:o.info.type)===s().sj.CannotRoundToTooManyDecimalPlaces?{...a().z8.CannotRoundToTooManyDecimalPlaces,values:{precision:o.info.precision}}:{...a().YG.LibraryFunctionExecutionError,values:{functionName:t.libraryFunction.name}};break;case s().FY.FunctionCallTooFewArguments:n={...a().YG.FunctionCallTooFewArguments,values:{functionName:t.libraryFunction.name}};break;case s().FY.FunctionCallUnexpectedArgument:n={...a().YG.FunctionCallUnexpectedArgument,values:{functionName:t.libraryFunction.name}};break;case s().FY.FunctionCallArgumentWrongType:n={...a().YG.FunctionCallArgumentWrongType,values:{functionName:t.libraryFunction.name,argumentType:l(t.argumentType)}};break;case s().FY.AccessingPropertyOnNonBlock:n=a().YG.AccessingPropertyOnNonBlock;break;case s().FY.MissingDataDependencyBlock:n={...a().YG.MissingDataDependencyBlock,values:{blockId:t.blockPointer.id}};break;case s().FY.MissingDataDependencyPerson:n={...a().YG.MissingDataDependencyPerson,values:{personId:t.personPointer.id}};break;case s().FY.MemberPropertyMismatchCollection:n=a().YG.MemberPropertyMismatchCollection;break;case s().FY.MissingPropertyOnSchemaForMemberProperty:n=a().YG.MissingPropertyOnSchemaForMemberProperty;break;case s().FY.UnaryMinusOnNonNumber:n={...a().YG.UnaryMinusOnNonNumber,values:{expressionType:l(t.expressionType)}};break;case s().FY.UnexpectedRecoveryNode:n=a().YG.UnexpectedRecoveryNode;break;case s().FY.UnexpectedError:n=a().YG.UnexpectedError;break;case s().FY.DepthExceeded:n=a().YG.DepthExceeded;break;case s().FY.CycleDetected:n=a().YG.CycleDetected;break;case s().FY.DownstreamParseFailure:n=a().YG.DownstreamParseFailure;break;case s().FY.MaxEvaluationTimeExceeded:n=a().YG.MaxEvaluationTimeExceeded;break;case s().FY.MissingSchemaPropertyOnCollection:n={...a().YG.MissingSchemaPropertyOnCollection,values:{collectionId:t.collectionId,propertyName:t.property}};break;case s().FY.ContextVariableWrongType:n={...a().YG.ContextVariableWrongType,values:{expectedType:t.expectedType,propertyType:t.resultType,valueId:t.valueId}};break;case s().FY.DisallowedValueType:{const o=t.allowedValueTypes.map((t=>e.formatMessage((0,i().getHumanReadableType)(t)).toLocaleLowerCase()));n={...a().o8.DisallowedReturnType,values:{allowedValueType:e.formatList(o,{style:"long",type:"conjunction"}),allowedValueTypeCount:t.allowedValueTypes.length,valueType:e.formatMessage((0,i().getHumanReadableValueType)(t.expressionValue)).toLocaleLowerCase()}};break}default:(0,r().t1)(t)}return(0,c().w7)(t)?{...n,values:{...n.values,startOffset:t.node.startOffset,endOffset:t.node.endOffset+1}}:n}function m(e){const t=null==e?void 0:e.values;return[o().CE(e,"values"),t]}function f(e){return e.type===s().FY.DepthExceeded||e.type===s().FY.CycleDetected||e.type===s().FY.MaxEvaluationTimeExceeded||e.type===s().FY.LibraryFunctionExecutionError}},853031:(e,t,n)=>{n.r(t),n.d(t,{hasAccessDefaultFn:()=>T,hasAccessToCode:()=>x,hasAccessToProperty:()=>F,hasReadPermissionsAccess:()=>k,hasSameSpaceAccess:()=>b,testOnly:()=>P});n(122556),n(582845),n(250570),n(533019),n(721473),n(788208),n(22624),n(267602),n(653476);var o=()=>n(513670),r=()=>n(839002),i=()=>n(855741),a=()=>n(696459),s=()=>n(226413),c=()=>n(92960),l=()=>n(216316),p=()=>n(177634),u=()=>n(407589),d=()=>n(748627);function*y(e){const{collectionPointer:t,context:n,propertyId:o,propertySchema:r,visitedPointers:i,hasAccessFn:a}=e,s=(0,l().M)({...t,propertyId:o});if(i.has(s))return!0;i.add(s);const c=a({propertySchema:r,spaceId:n.spaceId});return"boolean"==typeof c?c:yield*c}function*m(e){var t,n;const{collectionPointer:r,depth:u,collectionSchema:y,context:m,propertyId:f,propertySchema:h,visitedPointers:T,hasAccessFn:k}=e;if("v2"!==h.version||u>c().FORMULA_MAX_DEPTH)return!1;const b=(0,l().M)({...r,propertyId:f});if(T.has(b))return!0;if(T.add(b),!(0,a().$K)(null===(t=h.formula2)||void 0===t?void 0:t.code))return!0;const F=(0,d().H)(null===(n=h.formula2)||void 0===n?void 0:n.code);if(i().x.isFail(F))return!1;const{spaceId:x}=m,P=(0,l().jm)({formulaTypecheckContextValues:[{kind:c().FormulaContextValueKind.ThisRow,type:{collection:r,type:"block"}}],node:F.value,spaceId:x}),g=(0,o().mN)(P,(e=>(0,l().M)(e)));if(0===g.length)return!0;const{getRecordModel:C}=yield{collectionBlockProperties:[{blockPointers:[],collectionPointer:r,property:f,schema:y}],recordPointers:g.filter((e=>(0,p().no)(e)))};for(const o of g)if((0,s().rv)(o)){const e=C(o);if(!(0,a().$K)(e))return!1;const t=o.propertyId,n=e.getSchema(),r=n[t];if(!r)continue;if((0,s().no)(r)||(0,s().AF)(r)){if(!(yield*v({collectionPointer:o,collectionSchema:n,context:m,depth:u+1,propertyId:t,propertySchema:r,visitedPointers:T,hasAccessFn:k})))return!1}else if((0,s().p_)(r)){if(!(yield*v({collectionPointer:o,collectionSchema:n,context:m,depth:u,propertyId:t,propertySchema:r,visitedPointers:T,hasAccessFn:k})))return!1}}else if(!(0,a().$K)(C(o)))return!1;return!0}function*f(e){const{collectionPointer:t,depth:n,collectionSchema:o,context:r,propertyId:i,propertySchema:a,visitedPointers:p,hasAccessFn:d}=e;if("v2"===a.version||n>c().FORMULA_MAX_DEPTH)return!1;const y=(0,l().M)({...t,propertyId:i});if(p.has(y))return!0;p.add(y);const m=(0,u().b$)(a.formula);if(0===m.length)return!0;for(const c of m){const e=o[c];if(e)if((0,s().no)(e)||(0,s().AF)(e)){if(!(yield*v({collectionPointer:t,depth:n+1,collectionSchema:o,context:r,propertyId:c,propertySchema:e,visitedPointers:p,hasAccessFn:d})))return!1}else if((0,s().p_)(e)){if(!(yield*v({collectionPointer:t,collectionSchema:o,context:r,depth:n,propertyId:c,propertySchema:e,visitedPointers:p,hasAccessFn:d})))return!1}}return!0}function*h(e){const{collectionPointer:t,depth:n,collectionSchema:o,context:r,propertyId:i,propertySchema:a,visitedPointers:p,hasAccessFn:u}=e;if(n>c().FORMULA_MAX_DEPTH)return!1;const d=(0,l().M)({...t,propertyId:i});if(p.has(d))return!0;if(p.add(d),!a.relation_property||!a.target_property)return!0;const y=o[a.relation_property];if(!y||"relation"!==y.type)return!0;const m=u({propertySchema:y,spaceId:r.spaceId});if(!("boolean"==typeof m?m:yield*m))return!1;const f=(0,s().j0)(y);if(!f)return!0;const{getRecordModel:h}=yield{recordPointers:[f]},T=h(f),k=null==T?void 0:T.getNormalizedSchema();if(a.target_property_type&&k){const e=k[a.target_property];if(e&&a.target_property_type===e.type){if((0,s().AF)(e))return yield*v({collectionPointer:f,collectionSchema:k,context:r,depth:n+1,propertyId:a.target_property,propertySchema:e,visitedPointers:p,hasAccessFn:u});if((0,s().p_)(e))return yield*v({collectionPointer:f,collectionSchema:k,context:r,depth:n,propertyId:a.target_property,propertySchema:e,visitedPointers:p,hasAccessFn:u})}}return!0}function*v(e){const{collectionPointer:t,depth:n,collectionSchema:o,context:r,propertyId:i,propertySchema:a,visitedPointers:c,hasAccessFn:l}=e;return(0,s().p_)(a)?yield*y({collectionPointer:t,context:r,propertyId:i,propertySchema:a,visitedPointers:c,hasAccessFn:l}):(0,s().AF)(a)?"v2"===a.version?yield*m({collectionPointer:t,depth:n,collectionSchema:o,context:r,propertyId:i,propertySchema:a,visitedPointers:c,hasAccessFn:l}):yield*f({collectionPointer:t,depth:n,collectionSchema:o,context:r,propertyId:i,propertySchema:a,visitedPointers:c,hasAccessFn:l}):!(0,s().no)(a)||(yield*h({collectionPointer:t,depth:n,collectionSchema:o,context:r,propertyId:i,propertySchema:a,visitedPointers:c,hasAccessFn:l}))}function*T(e){const{propertySchema:t,spaceId:n}=e,o=(0,s().j0)(t);if(!(0,a().$K)(o))return!0;const{getRecordModel:r}=yield{recordPointers:[o]},i=r(o);return(0,a().$K)(i)&&b({spaceId:n,propertySchema:t})}function*k(e){const{propertySchema:t}=e,n=(0,s().j0)(t);if(!(0,a().$K)(n))return!0;const{getRecordModel:o}=yield{recordPointers:[n]},r=o(n);return(0,a().$K)(r)}function b(e){const{propertySchema:t,spaceId:n}=e;return!(0,s().Qh)(n,t)}async function F(e){const{collectionPointer:t,collectionSchema:n,context:o,propertyId:i,hasAccessFn:a}=e,s=n[i];return!s||await async function(e){const{context:t}=e;try{const n=v(e);let o=n.next();for(;!o.done;){const e=t.handleDataRequest(o.value);o=n.next((0,r().tI)(e)?await e:e)}return o.value}catch(n){return!0}}({collectionPointer:t,depth:0,collectionSchema:n,context:o,propertyId:i,propertySchema:s,visitedPointers:new Set,hasAccessFn:a})}function x(e){const{context:t}=e;try{const n=function*(e){const{collectionPointer:t,depth:n,context:r,code:u,visitedPointers:y,hasAccessFn:m}=e,f=(0,d().H)(u);if(i().x.isFail(f))return!1;const{spaceId:h}=r,T=r.valueTypes.filter((e=>e.kind!==c().FormulaContextValueKind.ThisRow)),k=(0,l().jm)({formulaTypecheckContextValues:t?[...T,{kind:c().FormulaContextValueKind.ThisRow,type:{collection:t,type:"block"}}]:[],node:f.value,spaceId:h}),b=(0,o().mN)(k,(e=>(0,l().M)(e)));if(0===b.length)return!0;const{getRecordModel:F}=yield{collectionBlockProperties:[],recordPointers:b.filter((e=>(0,p().no)(e)))};for(const o of b)if((0,s().rv)(o)){const e=F(o);if(!(0,a().$K)(e))return!1;const t=o.propertyId,i=e.getSchema(),c=i[t];if(!c)continue;if((0,s().no)(c)||(0,s().AF)(c)){if(!(yield*v({collectionPointer:o,collectionSchema:i,context:r,depth:n+1,propertyId:t,propertySchema:c,visitedPointers:y,hasAccessFn:m})))return!1}else if((0,s().p_)(c)&&!(yield*v({collectionPointer:o,collectionSchema:i,context:r,depth:n,propertyId:t,propertySchema:c,visitedPointers:y,hasAccessFn:m})))return!1}else if(!(0,a().$K)(F(o)))return!1;return!0}(e);let r=n.next();for(;!r.done;){const e=t.handleDataRequest(r.value);r=n.next(e)}return r.value}catch(n){return!0}}const P={hasAccessDefaultFn:T,hasAccessToProperty:F,hasAccessToFormula1Property:f,hasAccessToFormula2Property:m,hasAccessToRelationProperty:y,hasAccessToRollupProperty:h}}}]);