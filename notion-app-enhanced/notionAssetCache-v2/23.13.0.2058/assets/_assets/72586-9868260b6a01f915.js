"use strict";(globalThis.webpackChunknotion_next=globalThis.webpackChunknotion_next||[]).push([[72586,81317],{491585:(e,t,n)=>{n.r(t),n.d(t,{loadWorkflowTemplateInstances:()=>l});n(670560),n(241792);var o=()=>n(494616),r=()=>n(696459),i=()=>n(826955);const c=!1;function l(e){const t=[];let n=!1;e.isDefined()||(n=!0);const l=e=>{var o;if(!e.isDefined())return void(n=!0);const r=null===(o=e.getProperties())||void 0===o?void 0:o.workflow_template_instance;r&&t.push({instancePointer:{type:"automation",id:e.id,spaceId:e.getSpaceId()},templateId:r.template_id})},a=e.getFormat().workflow_template_instance,s=e.getParentBlockStore();if(null==s||!s.isDefined())return{isLoading:!0,instances:[]};a&&t.push({instancePointer:{type:"collection",id:e.id},templateId:a.template_id});const p=s.getCollectionViewStores()??[];for(const o of p){if(!o.isDefined()){n=!0;continue}const e=o.getFormat().workflow_template_instance;e&&t.push({instancePointer:{type:"collection_view",id:o.id},templateId:e.template_id})}const d=e.getLayoutStore();if(d)if(d.isDefined()){var m;const e=null===(m=d.getFormat())||void 0===m?void 0:m.workflow_template_instance;e&&t.push({instancePointer:{type:"layout",id:d.id,spaceId:d.getSpaceId()},templateId:e.template_id})}else n=!0;const u=e.getTemplatePageStores();for(const o of u){const e=o.getModel();if(!e){n=!0;continue}if(!e.isPageBlock())continue;const r=e.getFormat().workflow_template_instance;r&&t.push({instancePointer:{type:"block",id:e.id,spaceId:e.getSpaceId()},templateId:r.template_id});const i=o.getAutomationStore();i&&l(i)}const f=e.getAutomationStores();for(const o of f)l(o);const y=e.getSpaceId(),I=e.getSchema();for(const[r,c]of Object.entries(I)){if(!c)continue;const n=c.workflow_template_instance;if(n&&t.push({instancePointer:{type:"property",id:r,collectionId:e.id},templateId:n.template_id}),"button"===c.type&&c.automation_id){l(i().Mz.createChildStore(e,{id:c.automation_id,spaceId:y,table:o().cv}))}}const g=e.getFormat().compound_workflow_template_instances??[];for(const o of g)t.push({instancePointer:{type:"compound",id:o.id,collectionId:e.id,instancePointers:o.instance_pointers.map((t=>{switch(t.type){case"automation":return{type:"automation",id:t.id,spaceId:y};case"block":return{type:"block",id:t.id,spaceId:y};case"collection_view":return{type:"collection_view",id:t.id};case"layout":return{type:"layout",id:t.id,spaceId:y};case"property":return{type:"property",id:t.id,collectionId:e.id}}(0,r().t1)(t)}))},templateId:o.template_id});return c&&console.log("loadWorkflowTemplateInstances: loaded workflow template instances for collection:",e.id,"isLoading:",n,"instances:",t),{isLoading:n,instances:t}}},281236:(e,t,n)=>{n.r(t),n.d(t,{TRUNCATE_COLLECTION_TEMPLATE_ITEMS_AT:()=>j,WorkflowTemplateLogger:()=>w,getChildCollectionStoreByTemplateId:()=>C,getCollectionTemplateFromId:()=>O,getIsSetupGeneratorEnabled:()=>D,getPropertyTemplates:()=>W,getSelectedFeatureTemplateIds:()=>_,getTemplatesInCompoundTemplate:()=>R,getWorkflowTemplateItemsCaption:()=>k,getWorkflowTemplateName:()=>M,globalWorkflowTemplates:()=>S,isCollectionTemplateParentStore:()=>h,remapPropertyIds:()=>P,shouldShowInSuggestedProperties:()=>F,useCaseByCollectionTemplateCategory:()=>E});n(821057),n(670560),n(267602),n(916054),n(653476),n(470928),n(241792);var o=()=>n(353329),r=()=>n(731424),i=()=>n(712198),c=()=>n(217465),l=()=>n(827370),a=()=>n(752778),s=()=>n(255933),p=()=>n(955620),d=()=>n(513670),m=()=>n(696459),u=()=>n(887430),f=()=>n(982855),y=()=>n(527278),I=()=>n(826955),g=()=>n(382474);const v=(0,n(788860).vU)({untitled:{id:"workflowTemplates.untitled",defaultMessage:"Untitled"}});class w{log(e){0}warn(e){0}debug(e){false}}function h(e){return e instanceof I().zX||e instanceof I().H2||e instanceof I().G}const T=new(n(435308).default)((()=>{var e;const t=y().Z.getIntl();return(0,n(926931).Uo)({},t,(null===(e=n(487333).Z.state)||void 0===e?void 0:e.templatesWithRowIds.map((e=>e.template)))??[],{shouldFakeLocalization:"pseudo"===t.locale,strict:!1})}),{debugName:"localizedDynamicBuilderTemplatesStore"}),S=new(o().ni)((e=>{const t=y().Z.getIntl(),o=[...T.state,...(0,n(780741).i1)(t,{localizeTemplates:!0,includeNextTemplates:!1}),...Object.values(n(247971).F.state)].find((t=>t.templateId===e));if(!o)throw new Error(`Template not found for ${e}`);return o}));function P(e){let{collectionStore:t,dependencyMap:n,object:r}=e;(0,o().DY)({object:r,callback:e=>function(e){let{collectionStore:t,dependencyMap:n,objectWithProperty:o}=e;const r=o.property,i=(0,g().Zl)({collectionStore:t,sourceTemplateType:"property",sourcePrimitiveId:r,dependencyMap:n});o.property=i}({collectionStore:t,dependencyMap:n,objectWithProperty:e})})}const b=3;function k(e){if(0===e.length)return;const t=e.slice(0,b),n=e.length-t.length,o=t.join(", ");return n>0?`${o}, ${n}+`:o}function M(e){const{type:t}=e;switch(t){case"collection_view":return e.value.name??y().Z.formatMessage(u().b1[e.value.type]);case"property":return e.value.name;case"collection":return e.value.targetCollection.name;case"layout":case"compound":return e.name;case"block":const n=c().RecordMap.create(e.value.recordMap),o=n.getModel(e.value.blockPointer);return o?(0,p().QaF)(o.getRenderTitleTextValue({getRecordModel:i().o.fromRecordMap(n)})):y().Z.formatMessage(v.untitled);case"automation":return e.value.name??(0,r().XO)(y().Z.getIntl());default:(0,m().t1)(t)}}function _(e){return e.featureTemplateSelections.filter((e=>e.selected)).map((e=>e.template.templateId))}function C(e){let{environment:t,parentStore:n,collectionTemplateId:o}=e;const r=n.getSpaceId();if(!r)throw new Error(`Space ID not found for ${n}`);const i=new(I().H2)(t,{table:s().bx,id:r}),c=(0,g().f4)({environment:t,spaceStore:i,templateId:o});for(const s of c){var p;const e=new(I().NW)(t,{table:a().vF,id:s.id}),o=null===(p=e.getParentBlockStore())||void 0===p?void 0:p.getParentPointer();if(o&&l().dr.isEqual(o,n.pointer))return e}}function R(e){const t=e.value.templateItems.map((e=>S.fromId(e.pointer))),n=[];for(const r of t){if(!(0,o().qu)(r))throw new Error(`Invalid template "${r.templateId}" in compound template "${e.templateId}"`);n.push(r)}return n}function W(e){const t=[];for(const n of e)"property"===n.type?t.push(n):"compound"===n.type&&t.push(...R(n).filter((e=>(0,o().U2)(e,"property"))));return d().mN(t,(e=>e.templateId))}const j=3;function D(e){return(0,f().GD)(e)}function F(e){return"property"===e.type||"compound"===e.type&&R(e).every((e=>"property"===e.type))}const E={goals:"goals",projects:"project",tasks:"other",docs:"docs",meetings:"notes"};function O(e){try{return S.fromIdOfType({templateId:e,type:"collection"})}catch(t){return}}},382474:(e,t,n)=>{n.d(t,{A5:()=>j,Bs:()=>F,CX:()=>k,Hq:()=>O,Ko:()=>$,OA:()=>N,Vc:()=>S,Wv:()=>w,ZQ:()=>R,Zl:()=>b,_U:()=>x,cb:()=>B,cj:()=>E,ej:()=>T,f4:()=>C,i0:()=>D,ip:()=>A,w2:()=>W});n(821057),n(670560),n(267602),n(653476),n(470928),n(749411),n(241792),n(228244);var o=()=>n(29488),r=()=>n(353329),i=()=>n(799891),c=()=>n(494616),l=()=>n(396136),a=()=>n(752778),s=()=>n(139978),p=()=>n(483791),d=()=>n(513670),m=()=>n(696459),u=()=>n(239482),f=()=>n(826955),y=()=>n(999582),I=()=>n(491585),g=()=>n(281236);const v=!1;function w(e){const t={};for(const n of e){const e=t[n.templateId]??[];e.push(n.instancePointer),t[n.templateId]=e}return t}function h(e){let t;if("collection"===e.table)t=w((0,I().loadWorkflowTemplateInstances)(e).instances);else{const n=(0,o().O)(e.pointer),r=y().Z.getState();t=(null==r?void 0:r[n])??{}}const n=T(t);return v&&(console.groupCollapsed("getTemplateIdToInstancePointersMap",e.pointer),console.trace(),console.log("Raw map:",t),console.log("Map with invalid template IDs removed:",n),console.groupEnd()),n}function T(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:g().globalWorkflowTemplates;const n={},o=(0,d().HP)((e=>{try{return t.fromId(e),!0}catch(n){return!1}}));for(const[r,i]of Object.entries(e))o(r)&&(n[r]=i);return n}function S(e){let{environment:t,collectionStore:n}=e;const o=h(n),r=[];for(const[i,c]of Object.entries(o))for(const e of c)D({environment:t,instancePointer:e,inMemoryRecordCache:n.inMemoryRecordCache})&&r.push({instancePointer:e,templateId:i});return r}const P="dependency_";function b(e){let{collectionStore:t,sourceTemplateType:n,sourcePrimitiveId:o,dependencyMap:r}=e;const i=M({sourceTemplateType:n,sourcePrimitiveId:o,dependencyMap:r});if(!i)return o;const c=_(t,i);if(0===c.length)return`${P}${i}`;return c[c.length-1].id}function k(e){let{collectionStore:t,sourceTemplateType:n,sourcePrimitiveId:o,dependencyMap:r}=e;const i=M({sourceTemplateType:n,sourcePrimitiveId:o,dependencyMap:r});if(!i)return;const c=_(t,i);if(0===c.length)return;return c[c.length-1].id}function M(e){let{sourceTemplateType:t,sourcePrimitiveId:n,dependencyMap:o}=e;if(n.startsWith(P))return n.replace(P,"");return o[(0,r().aJ)(t,n)]}function _(e,t){return h(e)[t]??[]}function C(e){let{environment:t,spaceStore:n,templateId:o}=e;return _(n,o).filter((e=>D({environment:t,instancePointer:e,inMemoryRecordCache:n.inMemoryRecordCache})))}function R(e){let{collectionStore:t,templateId:n,instancePointerType:o}=e;const r=_(t,n);if(0===r.length)return;const i=r[r.length-1];if(i.type!==o)throw new Error(`Expect to find instance pointer type ${o} for template ID ${n} but found ${i.type} instead`);return i}function W(e){let{environment:t,collectionStore:n,templateId:o}=e;return Boolean(j({environment:t,scopeStore:n,templateId:o}))}function j(e){let{environment:t,scopeStore:n,templateId:o}=e;const r=n.pointer,c=_(n,o).filter((e=>D({environment:t,instancePointer:e,inMemoryRecordCache:n.inMemoryRecordCache}))),l=(0,d().mN)(c,(e=>e.id));if(l.length!==c.length){const e=c.map((e=>e.id));i().log({level:"warning",from:"workflowTemplatesInstanceHelpers",type:"duplicateAliveInstancePointers",data:{miscDataToConvertToString:{templateId:o,instanceIds:e}}})}return 0===l.length?void 0:l.length>1?(i().log({level:"warning",from:"workflowTemplatesInstanceHelpers",type:"moreThanOneAliveInstancePointer",data:{miscDataToConvertToString:{templateId:o,scope:r,uniqueAliveInstancePointers:l}}}),l[0]):l[0]}function D(e){let{environment:t,instancePointer:n,inMemoryRecordCache:o}=e;if("property"===n.type){const e=new(f().NW)(t,{table:a().vF,id:n.collectionId},{inMemoryRecordCache:o});return Boolean(e.getSchema()[n.id])}if("collection_view"===n.type){const e=new(f().Xr)(t,{table:s().np,id:n.id},{inMemoryRecordCache:o});return Boolean(e.getAlive())}if("collection"===n.type){const e=new(f().NW)(t,{table:a().vF,id:n.id},{inMemoryRecordCache:o});return!(0,u().wf)(e)}if("layout"===n.type){const e=new(f().xj)(t,{table:p().Bh,id:n.id,spaceId:n.spaceId},{inMemoryRecordCache:o});return!(0,u().wf)(e)}if("compound"===n.type)return function(e){let{environment:t,instancePointer:n,inMemoryRecordCache:o}=e;return n.instancePointers.some((e=>D({environment:t,instancePointer:e,inMemoryRecordCache:o})))}({environment:t,instancePointer:n,inMemoryRecordCache:o});if("block"===n.type){const e=new(f().G)(t,{table:l().iU,id:n.id,spaceId:n.spaceId},{inMemoryRecordCache:o});return!(0,u().wf)(e)}if("automation"===n.type){const e=new(f().Mz)(t,{table:c().cv,id:n.id,spaceId:n.spaceId},{inMemoryRecordCache:o});return!(0,u().wf)(e)}(0,m().t1)(n)}function F(e,t){const n=h(t);return Object.keys(n).filter((n=>W({environment:e,collectionStore:t,templateId:n}))).map((e=>g().globalWorkflowTemplates.fromId(e)))}function E(e,t){const n=[],o=h(e);for(const r of Object.values(o))n.push(...r.filter((e=>e.type===t)));return n}function O(e){let{environment:t,collectionStore:n}=e;if(!n)return;const o=S({environment:t,collectionStore:n}).filter((e=>{let{instancePointer:t}=e;return"collection"===t.type&&t.id===n.id}));if(0!==o.length){if(o.length>1)throw new Error(`More than one collection preset templates found for collection ${n.id}`);return g().globalWorkflowTemplates.fromIdOfType({templateId:o[0].templateId,type:"collection"})}}function B(e){const{type:t}=e;return"collection_view"===t||"property"===t||"layout"===t||"compound"===t||"block"===t||"automation"===t}function $(e){let{environment:t,collectionStore:n}=e;return S({environment:t,collectionStore:n}).filter((e=>"compound"===e.instancePointer.type))}function A(e){let{environment:t,collectionStore:n,instancePointerId:o}=e;const r=S({environment:t,collectionStore:n}).find((e=>e.instancePointer.id===o));if(r)return g().globalWorkflowTemplates.featureFromId(r.templateId)}function Z(e){let{environment:t,collectionStore:n,propertyId:o}=e;const r=function(e){let{environment:t,collectionStore:n,propertyId:o}=e;return S({environment:t,collectionStore:n}).filter((e=>"property"===e.instancePointer.type&&e.instancePointer.id===o))}({collectionStore:n,environment:t,propertyId:o}),i=$({environment:t,collectionStore:n}).filter((e=>{let{instancePointer:t}=e;return r.some((e=>t.instancePointers.some((t=>t.id===e.instancePointer.id))))}));return{propertyTemplateInstances:r,compoundTemplateInstances:i}}function x(e){let{collectionStore:t,environment:n,propertyId:o}=e;const{propertyTemplateInstances:i,compoundTemplateInstances:c}=Z({environment:n,collectionStore:t,propertyId:o}),l=i.map((e=>{let{templateId:t}=e;return g().globalWorkflowTemplates.fromId(t)})).filter((e=>(0,r().U2)(e,"property")));return c.filter((e=>{let{templateId:t}=e;const n=g().globalWorkflowTemplates.fromId(t);if((0,r().U2)(n,"compound"))return l.some((e=>n.value.templateItems.some((t=>t.pointer===e.templateId&&"required"===t.optionality))))}))}function N(e){let{environment:t,collectionStore:n,compoundTemplateInstancesToDelete:o}=e;const r=o.flatMap((e=>e.instancePointer.instancePointers)),i=o.map((e=>e.instancePointer.id)),c=$({environment:t,collectionStore:n}),l=[];for(const a of c)if(!i.includes(a.instancePointer.id))for(const e of a.instancePointer.instancePointers)r.some((t=>t.id===e.id))&&l.push(e);return r.filter((e=>!l.some((t=>t.id===e.id))))}},247971:(e,t,n)=>{n.d(t,{F:()=>r});class o extends(()=>n(263184))().default{getInitialState(){return{}}append(e){const t={...this.state};for(const n of e)t[n.templateId]=n;this.setState(t)}}const r=new o},487333:(e,t,n)=>{n.d(t,{Z:()=>i});class o extends(()=>n(263184))().default{getInitialState(){return null}}const r=new o;n(947115).exposeDebugValue("WorkflowTemplatesBuilderStore",r);const i=r}}]);