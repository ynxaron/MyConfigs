"use strict";(globalThis.webpackChunknotion_next=globalThis.webpackChunknotion_next||[]).push([[66463],{766463:(e,t,s)=>{s.d(t,{s:()=>j});s(670560),s(122556),s(582845),s(250570),s(533019),s(721473),s(788208),s(22624),s(267602),s(653476),s(241792),s(228244);var r=s(667294),n=()=>s(629013),l=()=>s(219727),a=()=>s(142735),o=()=>s(511115),i=()=>s(364402),c=()=>s(565630),u=()=>s(647834),d=()=>s(752778),h=()=>s(899133),m=()=>s(788860),v=()=>s(513670),f=()=>s(855741),p=()=>s(696459),S=()=>s(326966),R=()=>s(824462),y=()=>s(505789),g=()=>s(594546),_=()=>s(43721),k=()=>s(15981),b=()=>s(549813),I=()=>s(8),q=()=>s(90065),T=()=>s(778265),C=()=>s(620218),L=()=>s(828946),M=()=>s(98228),P=()=>s(870391),w=()=>s(876822),B=()=>s(804217),V=()=>s(749826),x=()=>s(63317),O=()=>s(485014),E=()=>s(21965),K=()=>s(826955);class N extends(()=>s(263184))().default{getInitialState(){return{query:void 0,localResults:[],numTotalLocalResults:0,serverResults:[],numTotalServerResults:0,searchSessionId:(0,s(956057).Il)(),isResultsLoading:!1}}}const A=N;var U=()=>s(677559),F=()=>s(466970),G=()=>s(358565);function j(e){var t;const{searchQuery:s,limit:N,source:j,type:Q,disable:W,overrideSpaceStore:Z,overrideSearchSessionId:X,usePrefetch_EXPERIMENTAL:H,isTitleOnly:$=!0}=e,J=(0,l().O7)(),Y=(0,m().YB)(),ee=(0,c().D9)(s),te=(0,c().D9)(e.filters),se=(0,r.useRef)(0),re=(0,r.useRef)(!0),ne=(0,a().VK)((()=>B().default.state.online),[]),le=(0,a().VK)((()=>e.isLocalOnlyMode||!ne),[ne,e.isLocalOnlyMode]),ae=(0,T().P)(),oe=(0,r.useMemo)((()=>new A),[]),ie=(0,a().VK)((()=>X&&X!==oe.state.searchSessionId?(oe.update((e=>({...e,searchSessionId:X}))),X):oe.state.searchSessionId),[oe,X]),ce=(0,F().E)("search_quickfind_only_show_title_matches"),{searchLocalResults:ue,searchServerResults:de,isResultsLoading:he,numTotalLocalResults:me,numTotalServerResults:ve}=(0,a().VK)((()=>({searchLocalResults:oe.state.localResults,searchServerResults:oe.state.serverResults,isResultsLoading:oe.state.isResultsLoading,numTotalLocalResults:oe.state.numTotalLocalResults,numTotalServerResults:oe.state.numTotalServerResults})),[oe]),fe=(0,a().VK)((()=>{if(le||he&&re.current)return ue;let e=[];return e="mini_quick_find"===j?function(e){const{localResults:t,serverResults:s,includeNonTitleMatches:r,query:n,environment:l,intl:a}=e,o=t.map((e=>e.store.id)),i=new Set(o),c=s.filter((e=>!i.has(e.store.id))),u=c.filter((e=>{const t=(0,b().V)(e.store,a,l,!1);return(0,P().B)({query:n,resultText:t??"",isLastQueryTermPartialMatchOK:!0})})),d=c.filter((e=>!u.includes(e)));if(r)return[...t,...u,...d];return[...t,...u]}({localResults:ue,serverResults:de,includeNonTitleMatches:!ce,query:s,environment:J,intl:Y}):function(e){const{localResults:t,serverResults:s}=e,r=t.map((e=>e.store.id)),n=new Set(r),l=s.filter((e=>!n.has(e.store.id)));return[...t,...l]}({localResults:ue,serverResults:de}),Q===h().n8.CollectionsInSpace&&(e=D(e)),e}),[le,he,ue,de,Q,s,j,J,Y,ce]),pe=(0,a().VK)((()=>Z||w().default.state.currentSpaceStore),[Z]),Se=(0,a().VK)((()=>"on"===V().default.getEligibleGroup({experimentId:"search-use-local-reranker-layered",parameter:"shouldUseLocalReranker",defaultGroup:"control"})),[]),Re=(0,a().VK)((()=>le&&ne&&Boolean(H)),[le,ne,H]),ye=(0,a().VK)((()=>(0,I().bC)(J).hasPublicAccessPermission),[J]),ge=(0,r.useMemo)((()=>{const t={navigableBlockContentOnly:$,...e.filters};return(0,h().u4)(t)}),[e.filters,$]),_e=(0,r.useMemo)((()=>{var t;return function(e){const{blockTypes:t,queryType:s}=e;switch(s){case h().n8.CollectionsInSpace:return["collection_view","collection_view_page"];case h().n8.BlocksInCollection:return["page","collection_view_page"];case h().n8.BlocksInSpace:default:return[...t??[]]}}({blockTypes:null===(t=e.filters)||void 0===t?void 0:t.blockTypes,queryType:Q})}),[null===(t=e.filters)||void 0===t?void 0:t.blockTypes,Q]),ke=(0,r.useCallback)(((e,t)=>{const{isSuccess:s,totalResultsCount:r,localCacheMetadata:n,query:l}=t;C().default.measure(e,{environment:J,data:{start_time:e.startTime,success:s,surface:j,num_results:r,search_session_id:ie,local_cache_metadata:n,local_cache_readiness_timings:O().Z.state.readinessTimings,query_length:l.length}})}),[J,j,ie]),be=(0,r.useCallback)(((e,t)=>{const{isSuccess:s,totalResultsCount:r,query:n}=t;C().default.measure(e,{environment:J,data:{start_time:e.startTime,success:s,surface:j,num_results:r,search_session_id:ie,search_session_flow_number:se.current,query_length:n.length}})}),[J,j,ie]),Ie=(0,U().XJ)(L().x.searchActions),qe=(0,r.useCallback)((e=>{const t=C().default.mark("rum.local_quick_search_query"),{query:s,spaceStore:r}=e,n=ae&&!ne&&(0,p().DE)(h().gT,j);if("resolved"!==Ie.status)return;const l=Q===h().n8.CollectionsInSpace;let a=[];0===s.length&&l&&(a=function(e){const{spaceStore:t,environment:s}=e,r=(0,y().l)({currentUserId:s.currentUser.id,spaceId:t.id}).map((e=>{const s=K().NW.createChildStore(t,{table:d().vF,id:e}).getParentBlockStore();if(null==s?void 0:s.pathIsAccessibleAndAlive())return s}));return(0,v().oA)(r)}({environment:J,spaceStore:r}).map(((e,t)=>({store:e,originalPosition:t,id:e.id,score:0,spaceId:e.getSpaceId(),sources:[h().vp.Local],featureGroups:[],serverEventProperties:void 0}))));const o=O().Z.state.localSearchableBlocksCache,i=(0,_().U)({environment:J,overrideCurrentUserId:J.currentUser.id,overrideSpaceId:r.id,overrideLocalSearchableBlocksCache:o}),c=(0,G().NH)({environment:J,parentStore:r,isOnline:ne,requestInput:{query:{text:s,filters:{...ge,blockTypes:_e,isOfflineOnly:n},sort:{field:"relevance"}},limit:le?N:Math.min(N,5)},localSearchCache:o,shouldUseNewRerankerDebugOverrideEnabled:Se,shouldLimitLocalResultsWhenOnline:!le,hasPublicAccessPermission:ye}),u=Re?z({query:s,serverResults:Ke.current}):[],m=c&&f().x.unwrapOr(c,void 0),S=(null==m?void 0:m.results)??[],R=(null==m?void 0:m.total)??0;let g=v().mN([...a,...S,...u],(e=>e.id));g=l?D(g):g,oe.update((e=>e.query!==s?e:(Ae.current=g.map((e=>e.id)),ke(t,{query:s,isSuccess:Boolean(m),totalResultsCount:R,localCacheMetadata:i}),{...e,localResults:g,isResultsLoading:!le&&e.isResultsLoading,numTotalLocalResults:R})))}),[_e,J,ge,ye,le,ne,ae,N,Ie.status,oe,Se,Q,ke,Re,j]),Te="mini_quick_find"===j?40:M().E5,Ce=(0,n().y)(qe,Te),Le=(0,r.useCallback)((e=>{const{result:t,isMetaClick:r,context:n}=e,l=(0,b().V)(t.store,Y,J,!1),a=(0,P().B)({query:s,resultText:l??"",isLastQueryTermPartialMatchOK:!0});(0,g().j)({environment:J,event:{eventName:"select_search_item",eventProperties:{sources:t.sources,localSources:Array.from(t.localSource||new Set),searchSessionId:ie,searchSessionFlowNumber:se.current,context:n,queryStringLength:s.length,isTitleMatch:a,totalSearchResultCount:me+ve,numLocalResults:ue.length,numTotalLocalResults:me,isMobile:J.device.isMobile,isMetaClick:r,hasFilters:Boolean(ge),originalPosition:t.originalPosition,selectedItemIndex:t.originalPosition,selectedSearchResultMetadata:{blockId:t.id,blockType:t.store.getModel().type},searchSource:j,verificationState:(0,q().T7)(t.store)}}})}),[J,me,ve,ue,s,ie,se,ge,j,Y]),Me=ee===s,Pe=v().Xy(te,e.filters),we=Boolean(ee&&!s),Be=Pe&&Me,Ve=!W&&pe&&!Be,xe=we||!Pe,Oe=(0,r.useRef)(!1),Ee=(0,r.useRef)([]),Ke=(0,r.useRef)([]),Ne=(0,r.useRef)([]),Ae=(0,r.useRef)([]),Ue=(0,a().VK)((()=>{if("mention_menu"!==j)return;return E().Z.getMentionedIds(J.currentUser.id)}),[J.currentUser.id,j]),Fe=(0,r.useCallback)((async e=>{const t=C().default.mark("rum.server_quick_search_query"),{query:s,spaceStore:r,size:n}=e,l=r.id;if(le&&!Re)return;const a=!re.current&&Pe?Ee.current:[],o=Re?z({query:s,serverResults:Ke.current}):[];if(Re&&(s.length<=1||o.length>=5||Ne.current.some((e=>e===s))))return;Ne.current.push(s);const c=await R().callApi({eventName:"search",environment:J,data:{type:Q,query:s,spaceId:l,collectionId:(null==ge?void 0:ge.parentId)??"",limit:"mini_quick_find"===j?10:n+1,filters:ge,sort:{field:"relevance"},source:j,searchSessionId:ie,searchSessionFlowNumber:se.current,recentlyMentionedPageIds:Ue,recentPagesForBoosting:(0,k().Wk)(x().Z.getWithoutSubscribing(l)),excludedBlockIds:v().jj([...a.map((e=>e.id)),...Ae.current||[],...Ke.current.map((e=>e.id))]),ignoresHighlight:!0}});if(!c||"failed"===c.type)return;const d=c.data.total,h=(0,S().m8)((0,p().qP)(c.data.trackEventProperties).map((e=>{let[t,s]=e;return[`server-${t}`,s]}))),m=c.data.results.slice(0,n).map(((e,t)=>{const s=K().G.createChildStore(r,{id:e.id,spaceId:e.spaceId,table:"block"}),n=Re?function(e){const{result:t,store:s,environment:r}=e;if(t.terms)return t.terms;const n=s.getModel();if(!n)return[];const l=r.defaultRecordCache.inMemoryRecordCache.makeGetRecordValueFn(r.currentUser.id),a=(0,u().$B)((0,i().ut)({blockValue:n,getRecordValue:l}).text);if(!a)return[];return(0,P().y)(a)}({environment:J,store:s,result:e}):e.terms;return{store:s,originalPosition:t,...e,serverEventProperties:h,terms:n}}));Oe.current=!(d<=n);const f=[...a,...m];Ee.current=f,Ke.current=v().mN([...Re?m:[],...Ke.current],(e=>e.id)),Re||(oe.update((e=>e.query!==s?e:(be(t,{query:s,isSuccess:"success"===c.type,totalResultsCount:d}),{...e,serverResults:f,isResultsLoading:!1,numTotalServerResults:d}))),se.current+=1)}),[le,Pe,J,Q,ge,j,ie,Ue,Ae,oe,be,Re]),Ge=(0,r.useCallback)((e=>{!W&&pe&&Oe.current&&!he&&ne&&(oe.update((e=>({...e,isResultsLoading:!0}))),Oe.current=!1,re.current=!1,Fe({query:s,spaceStore:pe,size:e??20}))}),[pe,W,Fe,ne,he,s,oe]),je="mini_quick_find"===j?100:M().rE,ze=(0,o().z)(Ge,je),De=(0,n().y)(Fe,Re?0:M().rE);return(0,r.useEffect)((()=>{if(xe){const e=oe.getInitialState();oe.update((t=>({...e,searchSessionId:t.searchSessionId}))),Ke.current=[],Ne.current=[]}Ve&&(re.current=!0,oe.update((e=>({...e,isResultsLoading:!0,query:s}))),Ce({query:s,spaceStore:pe}),De({query:s,spaceStore:pe,size:N}))}),[pe,Ce,De,N,s,Ve,oe,xe]),{results:fe,isResultsLoading:he,searchSessionId:ie,fetchAdditionalServerResultsOnChange:!W&&!le&&Oe.current&&Be?ze:void 0,searchSessionFlowNumber:se.current,hasMoreResults:Oe.current,searchAnalytics:{trackSelectSearchItem:Le}}}function z(e){const{query:t,serverResults:s}=e;return t?s.filter((e=>(0,P().B)({query:t,resultText:(e.terms??[]).join(" "),isLastQueryTermPartialMatchOK:!0}))):[]}function D(e){const t=new Set;return e.filter((e=>{const s=e.store.getCollectionViewSourceCollectionStore();return!(!s||t.has(s.id))&&(t.add(s.id),!0)}))}}}]);