"use strict";(globalThis.webpackChunknotion_next=globalThis.webpackChunknotion_next||[]).push([[78934],{983317:(e,t,o)=>{o.r(t),o.d(t,{toggleTwoWaySyncOnCollection:()=>_,updateSyncedData:()=>g});o(821057),o(267602),o(470928),o(398858),o(461318),o(33228);var n=()=>o(434255),i=()=>o(396136),r=()=>o(602299),c=()=>o(955620),a=()=>o(932753),l=()=>o(388573),s=()=>o(527278),d=()=>o(338855),p=()=>o(826955),u=()=>o(824462),m=()=>o(421654),v=()=>o(102182),y=()=>o(269299);function _(e){var t;const{environment:o,taskCollectionStore:i,projectCollectionStore:r}=e,c=!(null===(t=i.getFormat().sync_state)||void 0===t?void 0:t.enable_two_way_sync);c&&function(e){const{environment:t,taskCollectionStore:o}=e,i=o.getSchema(),r={};for(const c of n().Dw){const e=i[c];e&&"read_write"!==e.synced_permissions&&("notion://tasks/assign_property"===c&&"person"===e.type?r[c]={...e,synced_permissions:"read_write",limit:1}:r[c]={...e,synced_permissions:"read_write"})}Object.keys(r).length>0&&y().createAndCommit({userAction:"updateSyncedCollectionActions.addSyncedPermissionsToSchema",environment:t,canUndo:!0,perform:e=>{a().xO({environment:t,collectionStore:o,update:r,transaction:e})}})}({environment:o,taskCollectionStore:i});const l=i.getFormat().sync_state||{syncing:!1};y().createAndCommit({userAction:"updateSyncedCollectionActions.toggleTwoWaySyncOnCollection",environment:o,canUndo:!0,perform:e=>{m().FH({stores:[i,r],update:{sync_state:{...l,enable_two_way_sync:c}},transaction:e})}})}async function g(e){const{transaction:t,environment:o}=e;try{const e=t.operations.find((e=>function(e){switch(e.command){case"set":case"addPersonAfter":case"removePerson":return!0;default:return!1}}(e)&&2===e.path.length&&"properties"===e.path[0]&&n().Dw.includes(e.path[1].toString())));if(e){const n=(0,d().SK)({transaction:t,updateOperation:e,environment:o});if(!n)return;return void(await async function(e){const{transaction:t,environment:o,updateOperation:n,syncedCollectionStore:i}=e,r=(0,d().c_)({updateOperation:n,transaction:t,collectionStore:i});if("UPDATE_PROPERTY"===r.syncCollectionUpdates[0].updateType){const e=d().b8({pageId:r.syncCollectionUpdates[0].collectionPagePointer.id,propertyId:r.syncCollectionUpdates[0].propertyId});d().lQ({uniquePropertyId:e});const t=await u().callApi({eventName:"updateSyncedCollectionData",environment:o,data:r});if(d().d4(e),"success"===t.type){if(t.data.success)return;var c;throw f({errorCode:t.data.errorCode,syncCollectionType:i.getFormat().external_collection_type,propertyName:1===r.syncCollectionUpdates.length?null===(c=i.getSchema()[r.syncCollectionUpdates[0].propertyId])||void 0===c?void 0:c.name:void 0}),new Error(t.data.message)}var a;throw f({syncCollectionType:i.getFormat().external_collection_type}),new Error((null===(a=t.error)||void 0===a||null===(a=a.name)||void 0===a?void 0:a.toString())??"Unknown error")}}({transaction:t,environment:o,updateOperation:e,syncedCollectionStore:n}))}const s=t.operations.find((e=>"set"===e.command&&1===e.path.length&&"text"===e.path[0]));if(s&&s.pointer.table===r().x_){const e=(0,d().q2)({transaction:t,commentPointer:s.pointer,environment:o});if(!e)return;const{collectionStore:n,collectionPagePointer:i}=e;return void(await async function(e){const{transaction:t,environment:o,updateOperation:n,syncedCollectionStore:i,collectionPagePointer:r}=e,c=(0,d().hN)({updateOperation:n,transaction:t,collectionStore:i,collectionPagePointer:r});d().Jb({commentId:n.pointer.id});const a=await u().callApi({eventName:"updateSyncedCollectionData",environment:o,data:c});if(d().dY(n.pointer.id),"success"===(null==a?void 0:a.type)){if(a.data.success)return;throw f({errorCode:a.data.errorCode,syncCollectionType:i.getFormat().external_collection_type}),new Error(a.data.message)}var l;throw f({syncCollectionType:i.getFormat().external_collection_type}),new Error((null===(l=a.error)||void 0===l||null===(l=l.name)||void 0===l?void 0:l.toString())??"Unknown error")}({transaction:t,environment:o,updateOperation:s,syncedCollectionStore:n,collectionPagePointer:i}))}const m=t.operations.find((e=>{var t;return"update"===e.command&&1===e.path.length&&"properties"===e.path[0]&&(null===(t=e.args)||void 0===t?void 0:t.source)}));if(m){const e=(0,d().Dv)({transaction:t,updateOperation:m,environment:o});if(!e)return;try{await async function(e){var t;const{transaction:o,environment:n,updateOperation:i,syncedCollectionStore:r,collectionPagePointer:a,commentPointer:l}=e,s=c().QaF(null===(t=i.args)||void 0===t?void 0:t.source);if(!s)return;const d=s.split("/").pop(),p=(m=s,new URL(m).pathname.slice(1));var m;if(!d)return;const v={spaceId:o.spaceId,syncType:r.getFormat().external_collection_type,syncCollectionUpdates:[{collectionPagePointer:a,notionCommentId:l.id,attachment:{fileName:d,s3Data:{path:p}},updateType:"APPEND_ATTACHMENT"}]},y=await u().callApi({eventName:"updateSyncedCollectionData",environment:n,data:v});if("success"===(null==y?void 0:y.type)){if(y.data.success)return;throw f({errorCode:y.data.errorCode,syncCollectionType:r.getFormat().external_collection_type}),new Error(y.data.message)}var _;throw f({syncCollectionType:r.getFormat().external_collection_type}),new Error((null===(_=y.error)||void 0===_||null===(_=_.name)||void 0===_?void 0:_.toString())??"Unknown error")}({transaction:t,environment:o,updateOperation:m,syncedCollectionStore:e.collectionStore,collectionPagePointer:e.collectionPagePointer,commentPointer:e.commentPointer})}catch(a){const n=new(p().T5)(o,e.commentPointer),r=new(p().G)(o,{id:m.pointer.id,table:i().iU,spaceId:t.spaceId});throw n&&r&&y().createAndCommit({userAction:"Comment.handleRemoveFileFromActionsDueToSyncFailure",environment:o,canUndo:!0,perform:e=>{l().Zo({commentStore:n,fileBlocks:[r],transaction:e})}}),a}return}}catch(a){throw f({}),a}}function f(e){const{errorCode:t,syncCollectionType:o,propertyName:n}=e,i=s().Z.getIntl();if(!o)return void v().mz({item:{label:i.formatMessage({id:"syncedCollectionUpdateError.syncCollectionTypeMissing",defaultMessage:"Failed to update: incorrect sync collection setup"})}});if(!t)return void v().mz({item:{label:`Failed to update ${n??o}`}});const r=d().Xp({syncCollectionType:o,errorCode:t,intl:i});v().mz({item:{label:r}})}},388573:(e,t,o)=>{o.d(t,{DF:()=>k,Ri:()=>A,Xi:()=>F,YF:()=>I,Zo:()=>U,bh:()=>x});o(670560),o(122556),o(582845),o(250570),o(533019),o(721473),o(788208),o(22624),o(267602),o(653476),o(30005);var n=()=>o(492788),i=()=>o(279865),r=()=>o(26970),c=()=>o(513670),a=()=>o(248825),l=()=>o(799454),s=()=>o(282662),d=()=>o(636340),p=()=>o(844085),u=()=>o(203927),m=()=>o(970105),v=()=>o(269299),y=()=>o(109757),_=()=>o(852465),g=()=>o(505462),f=()=>o(826955),S=()=>o(781022),C=()=>o(600785),w=()=>o(596308),P=()=>o(52566),h=()=>o(354988),T=()=>o(433908),b=()=>o(533492);function k(e){var t,o;const{environment:n,store:r,text:c,files:l,transaction:s,discussionLocation:d,property_id:p,blockStore:u}=e,v=_().GP(r);if(!v)return;const{filesToCreate:y,fileStoresToDelete:g}=function(e,t){const o=[],n=new Set;t.forEach((e=>{"local"===e.type&&e.file instanceof File?o.push(e.file):n.add(e.id)}));const i=_().le(e),r=i.filter((e=>e.getAlive()&&!n.has(e.id)));return{filesToCreate:o,fileStoresToDelete:r}}(r,l);U({commentStore:r,fileBlocks:g,transaction:s}),(0,h().J)({commentStore:r,files:y,environment:n,transaction:s});const f=_().zP(r);m().sO({environment:n,store:f,value:c,transaction:s}),(0,b().Q)(r,s);const C=null==r||null===(t=r.getParentStore())||void 0===t?void 0:t.getParentStore(),P=i().B7.includes(d),T=null==v||null===(o=v.getParentStore())||void 0===o?void 0:o.getNavigableBlockStore(),{property_type:k,collection_id:I,collection_view_id:x,view_type:F,collection_view_block_id:A}=(0,w().o)(p,u);a().zd(n,{from:d,comment_id:r.id,discussion_id:v.id,discussion_type:v.getType(),parent_block_id:v.getParentId(),parent_collection_id:null==C?void 0:C.getParentCollectionIdUpToTwoLevels(),...P&&{inbox_session_id:S().default.state.sessionId,notification_page_id:null==T?void 0:T.id},property_type:k,collection_id:I,collection_view_id:x,view_type:F,collection_view_block_id:A})}function I(e){var t,o;const{environment:n,commentStore:r,transaction:c,discussionLocation:l}=e,s=_().GP(r);if(!s)return;const p=_().ak(s),u=p.getValue();if(!u)return;U({commentStore:r,fileBlocks:_().le(r),transaction:c}),d().sW({store:r,transaction:c,data:{alive:!1}}),v().applyOperation({store:p,operation:{pointer:p.pointer,path:p.path,command:"listRemove",args:{id:r.id}},transaction:c}),(0===u.length||1===u.length&&u[0]===r.id)&&(0,T().d)({environment:n,discussionStore:s,transaction:c}),(0,b().Q)(r,c);const m=i().B7.includes(l),y=null==s||null===(t=s.getParentStore())||void 0===t?void 0:t.getNavigableBlockStore();a().k$(n,{from:e.discussionLocation,discussion_id:s.id,discussion_type:s.getType(),comment_id:r.id,parent_block_id:s.getParentId(),parent_collection_id:null===(o=s.getParentStore())||void 0===o?void 0:o.getParentCollectionIdUpToTwoLevels(),...m&&{inbox_session_id:S().default.state.sessionId,notification_page_id:null==y?void 0:y.id}})}function x(e){var t,o;const{environment:n,commentStore:r,discussionStore:c,transaction:l,discussionLocation:s}=e;d().sW({store:c,data:{resolved:!1},transaction:l});const p=i().B7.includes(s),u=null==c||null===(t=c.getParentStore())||void 0===t?void 0:t.getNavigableBlockStore();a().SU(n,{comment_id:r.id,discussion_id:c.id,from:e.discussionLocation,parent_block_id:c.getParentId(),parent_collection_id:null===(o=c.getParentStore())||void 0===o?void 0:o.getAssociatedCollectionId(),...p&&{inbox_session_id:S().default.state.sessionId,notification_page_id:null==u?void 0:u.id}})}function F(e){var t,o;const{environment:n,discussionStore:r,textValue:l,transaction:s,files:d,property_id:p,blockStore:u}=e,{id:m}=n.currentUser;if(!m)return;const v=y().dm(d);if(c().Xy(l,[])&&0===v.length)return;const _=(0,P().X)({discussionStore:r,text:l,files:v,environment:n,transaction:s}),g=i().B7.includes(e.discussionLocation),f=null===(t=r.getParentStore())||void 0===t?void 0:t.getNavigableBlockStore(),{property_type:C,collection_id:h,collection_view_id:T,view_type:b,collection_view_block_id:k}=(0,w().o)(p,u);a().d2(n,{from:e.discussionLocation,comment_id:_.id,discussion_id:r.id,discussion_type:r.getType(),parent_block_id:r.getParentId(),parent_collection_id:null==r||null===(o=r.getParentStore())||void 0===o?void 0:o.getParentCollectionIdUpToTwoLevels(),...g&&{inbox_session_id:S().default.state.sessionId,notification_page_id:null==f?void 0:f.id},property_type:C,collection_id:h,collection_view_id:T,view_type:b,collection_view_block_id:k})}function U(e){const{commentStore:t,fileBlocks:o,transaction:n}=e,i=_().ig(t);o.forEach((e=>{d().sW({store:e,data:{alive:!1},transaction:n}),s().Od({parentStore:i,childToRemoveStore:e,transaction:n})}))}async function A(e){var t;let{discussionStore:o,currentBlockStore:i,environment:c,analyticsFrom:a,currentEl:s}=e;if(!i)return null;if(!o.isDefined())return;function d(e){const t=(0,C().L)({discussionId:o.id,blockId:e});if(!t)return;const n=document.getElementsByClassName((0,r().dk)({discussionId:o.id}))[0];return n?p().bx({element:n,scrollerContext:t.getScrollerContext(),vertical:{reveal:"top"},horizontal:{reveal:"closest"},animate:!0}):p().XW({handle:t,vertical:{reveal:"top"},horizontal:{reveal:"closest"},animate:!0}),t.displaySelectionHalo(750),t}const m=(null===(t=o.getRecordStoreUIParent())||void 0===t?void 0:t.id)??o.getParentId();d(m)||(await u().Nz(i,[m]),await n().default.afterNextFlush(),d(m));const v=f().G.createChildStore(i,o.getParentPointer()),y=g().get(),_=null==y?void 0:y.commonAncestorContainer,S=!(null!=y&&y.collapsed)&&_&&(s===_||(null==s?void 0:s.contains(_)));l().Ib({environment:c,blockStore:v||i,analyticsFrom:a,discussionIds:[o.id],shouldFocusDiscussion:!S,recursivelyLoadAllDiscussions:!1})}}}]);