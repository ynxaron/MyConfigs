"use strict";(globalThis.webpackChunknotion_next=globalThis.webpackChunknotion_next||[]).push([[70206],{737244:(e,t,n)=>{n.d(t,{Z:()=>i});class a extends(()=>n(263184))().default{getInitialState(){return{open:!1}}}const i=new a},70206:(e,t,n)=>{n.r(t),n.d(t,{applyStudentGitHubGrant:()=>Ze,cancelSubscription:()=>ye,closeSubscriptionUpgradeModal:()=>Ae,handlePaymentIntentNextActions:()=>Ce,handlePlanChangeClick:()=>Ue,openSubscriptionUpgradeModal:()=>xe,openSubscriptionUpgradeModalForClaimAndUpgrade:()=>Me,payUnpaidInvoice:()=>be,refresh:()=>De,refreshBillingHistory:()=>Te,trackSubscriptionUpdate:()=>me,updateAddress:()=>ge,updateBillingEmail:()=>Se,updateCurrentSpace:()=>he,updatePaymentMethod:()=>fe,updateSubscription:()=>ue,updateSubscriptionToEducationPlan:()=>Ie,updateVatId:()=>ve});n(821057),n(667294);var a=()=>n(799891),i=()=>n(956057),s=()=>n(35980),r=()=>n(741633),o=()=>n(629719),d=()=>n(976102),c=()=>n(381348);var l=()=>n(681941),u=()=>n(788860),p=()=>n(513670),m=()=>n(696459),f=()=>n(979614),b=()=>n(824462),g=()=>n(917801),v=()=>n(308186),S=()=>n(528918),y=()=>n(106502),w=()=>n(572623),I=()=>n(527278),h=()=>n(693622),D=()=>n(341691),_=()=>n(151165),T=()=>n(876822),E=()=>n(293760),x=()=>n(518019),A=()=>n(245845),M=()=>n(749826),U=()=>n(214488),C=()=>n(9599),P=()=>n(148882),Z=()=>n(801072),N=()=>n(458335),O=()=>n(826955),B=()=>n(838266),F=()=>n(145613),k=()=>n(515323),j=()=>n(396992),L=()=>n(620252),Y=()=>n(615389),K=()=>n(548812),H=()=>n(111631),z=()=>n(254687),V=()=>n(28886);n(267602),n(653476),n(470928),n(241792);var q=()=>n(38812),G=()=>n(18281),J=()=>n(697623),Q=()=>n(939985),X=()=>n(46135),R=()=>n(745181),$=()=>n(419157),W=()=>n(897257),ee=()=>n(183922),te=()=>n(635596);async function ne(e){const{environment:t,spaceId:n}=e,a=(0,ee().Ap)({spaceId:n});if(!se||se!==a){let n;!function(e){ie&&te().ZP.removeListener(ie,e)}(t);const i=(t,a)=>{void 0!==n&&n!==a&&ae(e),n=a},s=p().P2(i,5e3);ie=te().ZP.addListener(a,s,void 0,t),se=a;const r=_().Z.state;if(!Object.keys(r).length)return ae(e)}}async function ae(e){const{environment:t,spaceId:n}=e;if((0,G().ro)(t,n))return;const a=await b().callApi({eventName:"getBillingSubscriptionBannerData",environment:t,data:{spaceId:n},headers:(0,r().Bb)({cellId:void 0,spaceId:n})});var i;"success"===a.type&&((null===(i=T().default.state.currentSpaceStore)||void 0===i?void 0:i.id)===n&&_().Z.setState(a.data.bannerData));const s=await b().callApi({eventName:"getSubscriptionEntitlements",environment:t,data:{spaceId:n}});var o;"success"===s.type&&((null===(o=T().default.state.currentSpaceStore)||void 0===o?void 0:o.id)===n&&E().default.setState(s.data))}let ie,se;var re=()=>n(444297),oe=()=>n(587510),de=n(785893);const ce="SubscriptionData",le=(0,u().vU)({updatingSubscription:{id:"subscriptionSettings.updatingSubscriptionMessage",defaultMessage:"Updating your subscription…"},paymentMethodUpdateAuthFailed:{id:"subscriptionSettings.paymentMethodUpdateAuthFailedMessage",defaultMessage:"We could not update your payment method. Please try again or contact support."},verifyingEligibility:{id:"subscriptionSettings.verifyingEligibilityMessage",defaultMessage:"Verifying eligibility…"},personalFree:{id:"subscriptionSettings.personalFreeMessage",defaultMessage:"You are now subscribed to Notion’s Personal Pro Plan for free."},educationPlusFree:{id:"subscriptionSettings.educationPlusFreeMessage",defaultMessage:"You are now subscribed to Notion's Education plan for free"},finishingUp:{id:"subscription.upgrade.finishing",defaultMessage:"Finishing up..."},overFreeBlockLimitMobileNativeDialog:{id:"subscriptionActions.overFreeBlockLimit.mobileNativeDialog",defaultMessage:"Your free blocks have been used up. Unfortunately, unlimited blocks cannot be purchased on mobile."}});async function ue(e){const{from:t,environment:n,spaceStore:a,billingEmail:i,paymentData:s,vatId:r,coupon:c,customerName:l,businessName:u,addressLine1:p,addressZip:m,addressCity:f,addressState:y,addressCountry:w,promoCodeId:I,useTestClock:h,sessionId:D,inAppOffer:_,desiredState:T,trialData:E}=e;g().Js({bannerStore:C().Z}),S().j({message:le.updatingSubscription});if(!W().subscriptionDataStoreInstance.state)throw new Error("Subscription data not loaded.");const A=await x().Z.awaitData(n,{spaceId:null==a?void 0:a.id});if(!A)throw new Error("Billing data not loaded");const M=(0,o().iv)(A),{plan:U,addOns:P,isTrial:Z}=function(e,t){if(!t)return{plan:void 0,addOns:[],isTrial:void 0};const n=e.items.filter((e=>"plan"!==(0,o().tw)(e))),a=t.items.find((e=>"plan"===(0,o().tw)(e))),i=t.items.filter((e=>"plan"!==(0,o().tw)(e)));return{isTrial:Boolean(t.trialEnd),plan:null==a?void 0:a.price.externalId,addOns:(0,d().dK)(n,i).map((e=>{let[t,n]=e;return{isCancellation:!n,priceId:(n??t).price.externalId,quantity:null==n?void 0:n.quantity}}))}}(M,T),N=await b().callApi({eventName:"updateSubscription",environment:n,data:{spaceId:a.id,plan:U,addOns:P,billingEmail:i,paymentMethodId:(0,q().optionalPaymentMethodIdGivenPaymentData)(s),vatId:r,coupon:c,customerName:l,businessName:u,addressLine1:p,addressZip:m,addressCity:f,addressState:y,addressCountry:w,promoCodeId:I,useTestClock:h,modalSessionId:D,inAppOffer:_,isTrial:Z,clientVersion:n.device.version,trialData:E,from:t}});if(S().x(),"failed"===N.type)throw v().x2(N),new Error("An error occurred while updating subscription");await we({environment:n,spaceStore:a,newDefaultTeamId:N.data.newDefaultTeamId});const O=W().subscriptionDataStoreInstance.state,B=a.id,F=a.getPlanType(),k=await x().Z.awaitData(n,{spaceId:null==a?void 0:a.id});if(!k)throw new Error("Billing data not loaded");if(me({environment:n,context:{spaceId:B,planType:F,from:t,isMmOrEnt:await(0,re().n)(n),trialData:E,modalId:D},oldData:A,newData:k,desiredState:T}),!O)throw new Error("Subscription data not loaded.");return Boolean(E)||pe({oldTier:(0,o().zt)(A.subscription),newTier:(0,o().zt)(k.subscription),oldAddOns:(0,o().xi)(A.subscription),newAddOns:(0,o().xi)(k.subscription)}),N.data}function pe(e){return!!(0,K().X3)()&&R().Z.open(e)}function me(e){var t,n;let{environment:a,context:i,oldData:s,newData:r,desiredState:d}=e;const c=(0,o().F6)(s.subscription),l=(0,o().zt)(s.subscription),u=(0,o().xi)(s.subscription),p=(0,o().Hw)(s.subscription),m=(0,o().bs)(s.subscription),b=s.email,g=(0,o().F6)(d),v=(0,o().zt)(d),S=(0,o().xi)(d),y=(0,o().Hw)(d),I=(0,o().bs)(d),h=Boolean(null==d?void 0:d.trialEnd),D=r.email,_=s.subscription,T=!(0,o().YK)(_)&&(0,o().YK)(d),E=(0,o().YK)(_)&&(0,o().YK)(d),x=(0,o().YK)(_)&&!(0,o().YK)(d);T&&g?f().k6(a,{plan:g,credit_amount:0}):E?f().wl(a,{billing_email_changed:b!==D,plan_changed:g!==c,plan_current:g,plan_old:c,currency_code:I,billing_address_changed:!1}):x&&c&&f().rx(a,{plan:c}),f()._j(a,{from:i.from,action:x?"cancel":"update",spaceId:i.spaceId,isMmOrEnt:i.isMmOrEnt,planType:i.planType,addressCountry:null===(t=r.address)||void 0===t?void 0:t.country,oldSubscriptionTier:l,newSubscriptionTier:v,oldCurrency:m,newCurrency:I,oldPriceId:c,newPriceId:g,oldAddOns:u,newAddOns:S,oldBillingInterval:p,newBillingInterval:y,creditAmount:0,isProfessionalTeamUser:(0,w().QZ)(),isTrial:h,trialEndDate:null===(n=s.subscription)||void 0===n?void 0:n.trialEnd,trialData:i.trialData,modalId:i.modalId})}async function fe(e){const{environment:t,stripe:n,spaceStore:a,paymentMethodId:i}=e,s=await b().callApi({eventName:"updatePaymentMethod",environment:t,data:{spaceId:a.id,paymentMethodId:i}});if("failed"!==s.type){if(s.data.clientSecret&&"requires_action"===s.data.status){if("succeeded"!==await Pe({stripe:n,clientSecret:s.data.clientSecret}))return void v().UW(I().Z.formatMessage(le.paymentMethodUpdateAuthFailed));const e=await b().callApi({eventName:"setDefaultPaymentMethod",environment:t,data:{spaceId:a.id,paymentMethodId:i}});if("failed"===e.type)return void v().x2(e)}await De(t)}else v().x2(s)}async function be(e){const{environment:t,invoiceId:n,paymentMethodId:a}=e,i=await b().callApi({eventName:"payInvoice",environment:t,data:{invoiceId:n,paymentMethodId:a}});"failed"!==i.type||v().x2(i)}async function ge(e){const{environment:t,spaceStore:n,address:a}=e;g().Js({bannerStore:C().Z}),S().j({message:le.updatingSubscription});const i=await b().callApi({eventName:"updateBillingInformation",environment:t,data:{spaceId:n.id,address:a}});if("failed"===i.type)throw S().x(),v().x2(i),i.error;f().wl(t,{billing_email_changed:!1,plan_changed:!1,billing_address_changed:!0}),await _e(t),await De(t),S().x()}async function ve(e){const{environment:t,spaceStore:n,vatId:a}=e;g().Js({bannerStore:C().Z}),S().j({message:le.updatingSubscription});const i=await b().callApi({eventName:"updateBillingInformation",environment:t,data:{spaceId:n.id,vatId:a}});if("failed"===i.type)throw S().x(),v().x2(i),i.error;f().wl(t,{billing_email_changed:!1,plan_changed:!1,billing_address_changed:!1}),await _e(t),await De(t),S().x()}async function Se(e){const{environment:t,spaceStore:n,email:a}=e;g().Js({bannerStore:C().Z}),S().j({message:le.updatingSubscription});const i=await b().callApi({eventName:"updateBillingInformation",environment:t,data:{spaceId:n.id,billingEmail:a}});if("failed"===i.type)throw S().x(),v().x2(i),i.error;f().wl(t,{billing_email_changed:!0,plan_changed:!1,billing_address_changed:!1}),await _e(t),await De(t),S().x()}async function ye(e){var t,n;const{environment:a,spaceStore:i,from:s}=e,r=await x().Z.awaitData(a,{spaceId:null==i?void 0:i.id});if(!r)throw new Error("Billing data not loaded");g().Js({bannerStore:C().Z}),S().j({message:le.updatingSubscription});const d=await b().callApi({eventName:"cancelSubscription",environment:a,data:{spaceId:i.id,cancelImmediately:e.cancelImmediately}});if("failed"===d.type)return S().x(),void v().x2(d);const c=(0,o().F6)(r.subscription);c&&f().rx(a,{plan:c}),await we({environment:a,spaceStore:i,newDefaultTeamId:void 0});if(!W().subscriptionDataStoreInstance.state)throw new Error("Subscription data not loaded.");return f()._j(a,{from:s,action:"cancel",spaceId:i.id,oldSubscriptionTier:(0,o().zt)(r.subscription),newSubscriptionTier:void 0,oldPriceId:null===(t=(0,o().a7)(r.subscription,"plan"))||void 0===t?void 0:t.price.externalId,oldCurrency:(0,o().bs)(r.subscription),newCurrency:void 0,oldAddOns:(0,o().xi)(r.subscription),oldBillingInterval:(0,o().Hw)(r.subscription),newBillingInterval:void 0,isCancelSubscription:!0,isProfessionalTeamUser:(0,w().QZ)(),trialEndDate:null===(n=r.subscription)||void 0===n?void 0:n.trialEnd}),S().x(),!0}async function we(e){let{environment:t,newDefaultTeamId:n,spaceStore:a}=e;if(await De(t),await _e(t),$().Z.reset(),t.currentUser.id&&void 0!==n){await H().m({userId:t.currentUser.id,spaceId:a.id,environment:t});const e=O().zX.createChildStore(a,{table:"team",id:n,spaceId:a.id});await e.load()}}const Ie=(0,p().Ds)((async function(e){const{environment:t,spaceStore:a,code:i}=e;S().j({message:le.verifyingEligibility});const s=W().subscriptionDataStoreInstance.state;if(!s)throw new Error("Subscription data not loaded.");const r=await b().callApi({eventName:"updateSubscriptionToEducationPlan",environment:t,data:{spaceId:a.id,code:i}});"failed"===r.type?v().x2(r):r.data.isEligible?Ee(s,t):n(737244).Z.setState({open:!0,handlePromoCode:async e=>{S().j({message:le.updatingSubscription});const n=await b().callApi({eventName:"updateSubscriptionToEducationPlan",environment:t,data:{spaceId:a.id,code:e}});"failed"===n.type?v().x2(n):n.data.isEligible?Ee(s,t):v().UW((0,de.jsx)(u()._H,{id:"subscriptionSettings.invalidPromoCodeError.message",defaultMessage:"This promo code is not valid."})),S().x()}}),S().x()}),1e3,{leading:!0,trailing:!1});async function he(e){const{environment:t,spaceId:n,isNewlyCreatedSpace:a}=e,i=W().subscriptionDataStoreInstance.spaceId;if(!t.currentUser.isLoggedIn()||i&&i===n)await W().subscriptionDataStoreInstance.waitUntilLoaded();else if(_().Z.setState({}),ne({environment:t,spaceId:n}),E().default.setState({}),a){const e={type:"unsubscribed_admin",users:[],joinedMemberIds:[],blockUsage:0,hasPaidNonzero:!1,timelineViewUsage:0,userSimilarity:{},spaceUsers:[],members:[],customerData:void 0,revenueCatEnabled:!1,addOns:[]};W().subscriptionDataStoreInstance.setState(e),W().subscriptionDataStoreInstance.spaceId=n,Y().O.setState(e.userSimilarity),De(t)}else De(t)}async function De(e){var t;const n=null===(t=T().default.state.currentSpaceStore)||void 0===t?void 0:t.id,i=e.currentUser.id;if(!n)throw new Error("No spaceId.");{const t=`${ce}:${n}:v2`,o=s().Z.get({userId:i,key:t});o&&(W().subscriptionDataStoreInstance.setState(o),W().subscriptionDataStoreInstance.spaceId=n,Y().O.setState(o.userSimilarity)),await async function(e){let{environment:t,spaceId:n,currentUserId:i,localKey:o}=e;await P().transactionQueue.drain();const d=M().default.checkGate({gateName:"dont_load_users"})||A().Z.state.shouldUseEdgeCache,[c,l]=await Promise.all([b().callApi({eventName:"getSubscriptionData",environment:t,data:{spaceId:n},headers:(0,r().Bb)({cellId:void 0,spaceId:n})}),d?Promise.resolve({type:"success",data:{users:[],joinedMemberIds:[],userSimilarity:{},shouldUseEdgeCache:!0},status:200}):b().callApi({eventName:"getVisibleUsers",environment:t,data:{spaceId:n},headers:(0,r().Bb)({spaceId:n})})]),u=M().default.checkGate({gateName:"users_edge_cache"});u&&await L().x.resetData(t,{spaceId:n});if("success"===c.type&&"success"===l.type){var p;const e={...c.data,...l.data};A().Z.setState({shouldUseEdgeCache:u&&l.data.shouldUseEdgeCache});try{s().Z.set({userId:i,key:o,value:e})}catch{a().log({level:"error",from:"subscriptionActions",type:"subscriptionDataTooLarge",data:{miscDataToConvertToString:{subscriptionDataJsonSize:JSON.stringify(e).length}}})}(null===(p=T().default.state.currentSpaceStore)||void 0===p?void 0:p.id)===n&&(W().subscriptionDataStoreInstance.setState(e),W().subscriptionDataStoreInstance.spaceId=n,Y().O.setState(e.userSimilarity),G().YK(e)&&f().jw(t))}else a().log({level:"error",from:"subscriptionActions",type:"fetchSubscriptionDataFailed",data:{miscDataToConvertToString:{getSubscriptionDataResponseType:c.type,getSubscriptionDataResponseStatus:c.status,getVisibleUserResponseType:l.type,getVisibleUserResponseStatus:l.status}}});await Promise.all([N().Z.awaitData(t,{spaceId:n},!0),y().aiDependency.load().then((e=>{let{completionActions:a}=e;return a.maybeUpdateAiEligibility(t,n,!0)}))])}({environment:e,spaceId:n,currentUserId:i,localKey:t}),await x().Z.resetData(e,{spaceId:n}),await k().U.resetData(e,{spaceId:n}),await U().Z.resetData(e,{spaceId:n})}}function _e(e){var t;const n=null===(t=T().default.state.currentSpaceStore)||void 0===t?void 0:t.id;if(!n)throw new Error("No spaceId.");return j().Z.resetData(e,{spaceId:n})}async function Te(e,t){const n=T().default.state.currentSpaceStore;if(!n)return;const a=await b().callApi({eventName:"getBillingHistory",environment:e,data:{spaceId:n.id,limit:t.state.billingEventsLimit}});"success"===a.type&&t.update((e=>({...e,billingEvents:a.data.events})))}async function Ee(e,t){await De(t),await _e(t),$().Z.reset();const n=()=>{pe({oldTier:e.subscriptionTier??"free",newTier:"student",oldAddOns:[],newAddOns:[]})||v().PV({message:I().Z.formatMessage(le.educationPlusFree)}),B().default.setState({...B().default.state,currentTab:"billing",defaultSubtab:void 0});const n=G().XX(e);f().jh(t,{plan:"student_free",old_plan:n?n.plan:void 0})};await D().shouldCreatePassword(t)?h().E({environment:t,onSubmit:n,onCancel:n}):n()}function xe(e,t){const{subscriptionTier:n,from:a,addOnFeature:s,coupon:r,isTrial:o,dismissMobilePlansModal:d,offer:c}=t,l=i().Il();f().Lc(e,{subscriptionTier:n,from:a,addOnFeature:s,currency_code:$().Z.state.selectedCurrencyCode,isTrial:o,modal_id:l}),F().Z.open({subscriptionTier:n,billingInterval:"month",addOnFeature:s,coupon:r,isTrial:o,sessionId:l,dismissMobilePlansModal:d,offer:c})}function Ae(e){const t=F().Z.state;t.open&&(f().LY(e,{modal_id:t.sessionId}),F().Z.setState({open:!1}))}function Me(e){X().default.open(e)}async function Ue(e){var t;const{environment:n,product:i,spaceStore:s,from:r,pageSection:u,churnState:f,billingData:b}=e,g=await z().aQ({environment:n,spaceId:s.id}),v=(null===(t=(0,o().a7)(null==b?void 0:b.subscription,"sites_custom_hostnames"))||void 0===t?void 0:t.quantity)??0,S=b.subscription;if(!(S&&(0,m().$K)(b.paymentMethod)||"free"===i))return void xe(n,{subscriptionTier:i,from:r});const y=(0,o().Lg)(b),w=(0,o().bs)(S),I=(0,o().Hw)(y),h=(0,o().Hw)(S),D=I??h,_=(0,o().ry)({spaceId:s.id,logFunction:a().log.bind(a()),subscriptionState:y}),T=(0,o().ry)({spaceId:s.id,logFunction:a().log.bind(a()),subscriptionState:S}),E=_??T;let x;if("free"===i)x=(0,d().t4)(y,"plan");else{if(!(w&&D&&E))throw new Error("Trying to update plan on a subscription with no items");{const e={product:i,currency:w,interval:D};x=(0,d().dP)((0,l().Vj)({prices:g,quantity:E,domainsQuantity:v}),y,e)}}if(!p().Xy(y,x)){if((0,d()._D)(y,x)){if("no_churn"===f||!f)return;if((0,c().s6)(Z().Z.getData(n,{spaceId:null==s?void 0:s.id}))&&(0,c().CF)("resurrection_offer",J().zt(),h)){if(!(await(0,Q().D)(n)))return}return 0===x.items.length?await ye({environment:n,spaceStore:s,from:r,cancelImmediately:"churn_immediately"===f}):await ue({environment:n,spaceStore:s,desiredState:x,from:r})}if(!(0,K().Ue)())return oe().af({environment:n,from:r,view:"plans",temporarySubscriptionTier:i,billingInterval:D,pageSection:u});(0,V().m)(n,{desiredProducts:[i],analyticsArgs:{from:r,view:"plans",pageSection:u}})}}async function Ce(e){S().j({message:le.finishingUp});const{paymentIntentData:t,stripe:n,onSuccess:a,onFailure:i}=e,s=t.paymentIntentClientSecret;let r=t.paymentIntentStatus;s&&"requires_action"===r&&(r=await Pe({stripe:n,clientSecret:s})),"succeeded"===r||"processing"===r?null==a||a():function(e){let{status:t}=e;return["requires_payment_method","requires_source"].includes(t)}({status:r})&&(null==i||i()),S().x()}async function Pe(e){let{stripe:t,clientSecret:n}=e;const{paymentIntent:a,setupIntent:i,error:s}=await t.handleNextAction({clientSecret:n});if(a)return a.status;if(i)return i.status;if(s.payment_intent)return s.payment_intent.status;if(s.setup_intent)return s.setup_intent.status;throw new Error(`Unexpected error handling intent: ${s.message}`)}async function Ze(e){const{environment:t,data:n}=e;await b().callApi({eventName:"applyStudentGitHubGrant",environment:t,data:n})}},745181:(e,t,n)=>{n.d(t,{Z:()=>i});n(267602),n(470928);class a extends(()=>n(263184))().default{getInitialState(){return{open:!1}}close(){this.state.open&&this.setState({open:!1})}open(e){let{oldTier:t,newTier:a,oldAddOns:i,newAddOns:s}=e;if(function(e){if(!e)return!1;return["plus","enterprise","business","student"].includes(e)}(a)){if(function(e,t){if(!e||!t)return!1;return"upgrade"===(0,n(122792).NY)({oldTier:e,newTier:t})}(t,a))return this.setState({productUpgrade:a,open:!0}),!0}if(s.length>i.length){const e=s.find((e=>!i.includes(e)));if(function(e){if(!e)return!1;return["ai"].includes(e)}(e))return this.setState({productUpgrade:e,open:!0}),!0}return!1}}const i=new a}}]);