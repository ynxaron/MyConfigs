"use strict";(globalThis.webpackChunknotion_next=globalThis.webpackChunknotion_next||[]).push([[69583],{912203:(e,t,o)=>{o.d(t,{$M:()=>y,GQ:()=>S,Jy:()=>T,LF:()=>F,NO:()=>m,Of:()=>I,SF:()=>p,TX:()=>b,XO:()=>g,Y_:()=>u,Ym:()=>v,bD:()=>_,cO:()=>d,fo:()=>C,rR:()=>f});o(267602),o(653476),o(228244);var i=()=>o(513670),n=()=>o(696459),a=()=>o(226413),r=()=>o(109477),s=()=>o(455222),l=()=>o(305580);(0,n().AO)((e=>(0,n().$K)(e)&&(0,n().$K)(e.target)&&(0,n().$K)(e.external_bot_id)?{true:{external_bot_id:e.external_bot_id,target:e.target}}:{false:e}));const c={checkbox:!0,date:!0,email:!0,multi_select:!0,number:!0,person:!0,phone_number:!0,relation:!0,select:!0,status:!0,text:!0,title:!0,url:!0,auto_increment_id:!1,button:!1,created_by:!1,created_time:!1,file:!1,formula:!1,last_edited_by:!1,last_edited_time:!1,last_visited_time:!1,location:!1,rollup:!1,verification:!1},u={checkbox:[{type:"checkbox"}],date:[{type:"date"}],email:[{type:"text"}],multi_select:[{type:"text"},{of:{type:"text"},type:"array"}],number:[{type:"number"}],person:[{type:"person"},{of:{type:"person"},type:"array"}],phone_number:[{type:"text"}],relation:[{type:"block"},{of:{type:"block"},type:"array"}],select:[{type:"text"},{of:{type:"text"},type:"array"}],status:[{type:"text"},{of:{type:"text"},type:"array"}],text:void 0,title:void 0,url:[{type:"text"}]};function p(e){return Boolean(c[e.type]&&!(0,a().NK)(e)&&(!(0,a().qQ)(e)||void 0===(0,a().q3)(e)))}function d(e){const{collectionFormat:t,collectionSchema:o,filter:s,sort:c,sourcePropertyIds:u}=e,d=(u??(0,n().Yd)(o)).filter(((t,i,n)=>{const r=o[t];return!(!r||!p(r))&&(("relation"!==r.type||!e.restrictCrossSpace||!(0,a().Qh)(e.spaceId,r))&&(!s||s([t,r],i,o)))}));if(0===d.length)return[];if(!t||!1===c)return d;const m=(0,l().i)(t,o,void 0,r().j5.Page).collection_page_properties||[];return i().MR(d,(e=>m.findIndex((t=>t.property===e))))}function m(e){const{collectionFormat:t,collectionSchema:o,sort:s}=e,c=(0,n().Yd)(o).filter(((e,t,i)=>{const n=o[e];return!(!n||!(0,a().U8)(n))}));if(0===c.length)return[];if(!t||!1===s)return c;const u=(0,l().i)(t,o,void 0,r().j5.Page).collection_page_properties||[];return i().MR(c,(e=>u.findIndex((t=>t.property===e))))}function f(e){return e.type===s().$E.InvalidCharacter?{type:e.type,character:e.character}:e.type===s().$E.TokenExpected?{type:e.type,token:e.token}:e.type===s().FY.MissingSchemaPropertyOnThisRow||e.type===s().FY.MissingSchemaPropertyOnCollection?{type:e.type,collectionId:e.collectionId,property:e.property}:e.type===s().FY.ThisRowBlockPropertyMismatchCollection?{type:e.type,thisRowCollection:e.thisRowCollection}:e.type===s().FY.MissingContextVariable?{type:e.type,valueId:e.valueId}:e.type===s().FY.FunctionCallTooFewArguments?{type:e.type,numArguments:e.numArguments}:e.type===s().FY.FunctionCallUnexpectedArgument?{type:e.type,parameterIndex:e.parameterIndex}:e.type===s().FY.FunctionCallArgumentWrongType?{type:e.type,argumentType:e.argumentType,libraryFunctionName:e.libraryFunction.name,parameterIndex:e.parameterIndex}:e.type===s().FY.MissingDataDependencyBlock?{type:e.type,blockPointer:e.blockPointer}:e.type===s().FY.MissingDataDependencyPerson?{type:e.type,personPointer:e.personPointer}:e.type===s().FY.MemberPropertyMismatchCollection?{type:e.type,blockCollection:e.blockCollection}:e.type===s().FY.DownstreamParseFailure?{type:e.type,collectionId:e.collectionId,property:e.property}:e.type===s().FY.ContextVariableWrongType?{type:e.type,valueId:e.valueId,expectedType:e.expectedType,resultType:e.resultType}:e.type===s().FY.DisallowedValueType?{type:e.type,expressionValue:e.expressionValue,allowedValueTypes:e.allowedValueTypes}:e.type===s().FY.LibraryFunctionExecutionError?{type:e.type,error:e.error,libraryFunctionName:e.libraryFunction.name}:{type:e.type}}const v={checkbox:!0,date:!0,email:!0,multi_select:!0,number:!0,person:!0,phone_number:!0,relation:!0,select:!0,status:!0,text:!0,title:!0,url:!0,button:!1,file:!1,verification:!1,auto_increment_id:!1,created_by:!1,created_time:!1,formula:!1,last_edited_by:!1,last_edited_time:!1,last_visited_time:!1,location:!1,rollup:!1};function y(e){return Boolean(v[e.type])}function g(e){const{collectionFormat:t,collectionSchema:o,filter:s,sort:c}=e,u=(0,n().Yd)(o).filter(((e,t,i)=>{var n;const r=o[e];return!(!r||!v[r.type])&&((!(0,a().qQ)(r)||null===(n=(0,a().q3)(r))||void 0===n||!n.auto_update_on_edit)&&(!s||s([e,r],t,o)))}));if(0===u.length)return[];if(!t||!1===c)return u;const p=(0,l().i)(t,o,void 0,r().j5.Page).collection_page_properties||[];return i().MR(u,(e=>p.findIndex((t=>t.property===e))))}const h={checkbox:!0,email:!0,multi_select:!0,number:!0,person:!0,phone_number:!0,relation:!0,select:!0,status:!0,text:!0,title:!0,url:!0,auto_increment_id:!1,button:!1,created_by:!1,created_time:!1,date:!1,file:!1,formula:!1,last_edited_by:!1,last_edited_time:!1,last_visited_time:!1,location:!1,rollup:!1,verification:!1};function _(e){return h[e.type]}const x={checkbox:!0,created_by:!0,created_time:!0,date:!0,email:!0,multi_select:!0,number:!0,person:!0,phone_number:!0,relation:!0,select:!0,status:!0,text:!0,title:!0,url:!0,last_edited_by:!0,last_edited_time:!0,auto_increment_id:!1,button:!1,file:!1,formula:!1,last_visited_time:!1,location:!1,rollup:!1,verification:!1};function b(e){return x[e.type]}function S(e){return 0===e}function C(e){return function(e){return"button_block"===e||"button_property"===e}(e)}function F(e){const{property:t,collectionSchema:o}=e;return!!o&&!o[t]}function T(e){const{collectionSchema:t,property:o,type:i}=e,n=null==t?void 0:t[o];return!n||("action"===i?!p(n):!v[n.type])}function I(e){let{automationTrigger:t,collectionSchema:o}=e;if("event"===(null==t?void 0:t.type)||"notification_event"===(null==t?void 0:t.type)){const{pagesAdded:e,pagePropertiesEdited:i,source:a}=t.event;if(void 0===a)return!1;const r="some"===i.type&&i.some,s="all"===i.type&&i.all;if((r||s||[]).some((e=>F({collectionSchema:o,property:e.property})||T({collectionSchema:o,property:e.property,type:"trigger"}))))return!1;const l="some"===i.type&&(!(0,n().$K)(i.some)||0===i.some.length),c="all"===i.type&&(!(0,n().$K)(i.all)||0===i.all.length);if(!e&&("none"===i.type||l||c))return!1}else{if("recurrence"!==(null==t?void 0:t.type))return!1;if(!t.recurrence)return!1}return!0}},870691:(e,t,o)=>{o.d(t,{CL:()=>a,Fv:()=>n,Ov:()=>c,uz:()=>l});o(670560);var i=()=>o(696459);const n={create:(e,t)=>({pointer:e,platform:t,typecheckStartTime:void 0,typecheckDurationMs:void 0,typecheckSuccess:void 0,totalActionDependencies:void 0,getDependenciesDurationMs:void 0,executionStartTime:void 0,executionDurationMs:void 0,executionSuccess:void 0,totalOperations:void 0,totalBlocksCreated:void 0,totalPagesCreated:void 0,totalPagesUpdated:void 0,totalUsersMentioned:void 0,totalActions:0,actionStats:{},transactionIds:void 0,formulaStats:void 0}),createAction:(e,t)=>({pointer:e,actionType:t,typecheckStartTime:void 0,typecheckDurationMs:void 0,typecheckSuccess:void 0,totalDependencies:void 0,getDependenciesDurationMs:void 0,executionStartTime:void 0,executionDurationMs:void 0,executionSuccess:void 0,totalOperations:void 0,blocksCreated:void 0,pagesCreated:void 0,pagesUpdated:void 0,usersMentioned:void 0,transactionIds:void 0,formulaStats:void 0}),getOrCreateAction:(e,t,o)=>(e.actionStats[t.id]||(e.actionStats[t.id]=n.createAction(t,o)),e.actionStats[t.id]),aggregate(e){let t,o,i,n,r,l,c,u;const p=Object.values(e.actionStats),d=[];for(const m of p)t=s(t,m.totalDependencies),o=s(o,m.getDependenciesDurationMs),i=s(i,m.totalOperations),n=s(n,m.blocksCreated),r=s(r,m.pagesCreated),l=s(l,m.pagesUpdated),c=s(c,m.usersMentioned),u=a(u,m.formulaStats),Array.isArray(m.transactionIds)&&m.transactionIds.length>0&&d.push(...m.transactionIds);return e.totalActionDependencies=t,e.getDependenciesDurationMs=o,e.totalOperations=i,e.totalBlocksCreated=n,e.totalPagesCreated=r,e.totalPagesUpdated=l,e.totalUsersMentioned=c,e.formulaStats=u,d.length>0&&(e.transactionIds=d),e.totalActions=p.length,e},aggregateActionStats(e,t){(0,i().$K)(t)&&(e.typecheckDurationMs=s(e.typecheckDurationMs,t.typecheckDurationMs),e.totalDependencies=s(e.totalDependencies,t.totalDependencies),e.getDependenciesDurationMs=s(e.getDependenciesDurationMs,t.getDependenciesDurationMs),e.executionDurationMs=s(e.executionDurationMs,t.executionDurationMs),e.totalOperations=s(e.totalOperations,t.totalOperations),e.blocksCreated=s(e.blocksCreated,t.blocksCreated),e.pagesCreated=s(e.pagesCreated,t.pagesCreated),e.pagesUpdated=s(e.pagesUpdated,t.pagesUpdated),e.usersMentioned=s(e.usersMentioned,t.usersMentioned),e.formulaStats=a(e.formulaStats,t.formulaStats),Array.isArray(t.transactionIds)&&t.transactionIds.length>0&&(e.transactionIds=e.transactionIds??[],e.transactionIds.push(...t.transactionIds)))}};function a(e,t){return(0,i().$K)(t)?{formulaTypecheckDurationMs:s(null==e?void 0:e.formulaTypecheckDurationMs,t.formulaTypecheckDurationMs),formulaTypecheckSuccess:r(null==e?void 0:e.formulaTypecheckSuccess,t.formulaTypecheckSuccess),formulaExecutionDurationMs:s(null==e?void 0:e.formulaExecutionDurationMs,t.formulaExecutionDurationMs),formulaExecutionSuccess:r(null==e?void 0:e.formulaExecutionSuccess,t.formulaExecutionSuccess),totalFormulas:s(null==e?void 0:e.totalFormulas,t.totalFormulas),simpleFormulaTypecheckDurationMs:s(null==e?void 0:e.simpleFormulaTypecheckDurationMs,t.simpleFormulaTypecheckDurationMs),simpleFormulaTypecheckSuccess:r(null==e?void 0:e.simpleFormulaTypecheckSuccess,t.simpleFormulaTypecheckSuccess),simpleFormulaExecutionDurationMs:s(null==e?void 0:e.simpleFormulaExecutionDurationMs,t.simpleFormulaExecutionDurationMs),simpleFormulaExecutionSuccess:r(null==e?void 0:e.simpleFormulaExecutionSuccess,t.simpleFormulaExecutionSuccess),totalSimpleFormulas:s(null==e?void 0:e.totalSimpleFormulas,t.totalSimpleFormulas)}:e}function r(e,t){return(0,i().$K)(e)&&(0,i().$K)(t)?e&&t:(0,i().$K)(e)?e:(0,i().$K)(t)?t:void 0}function s(e,t){return(0,i().$K)(t)?(e??0)+t:e}const l=(0,i().AO)((e=>(0,i().$K)(e.executionStartTime)&&(0,i().$K)(e.executionDurationMs)&&(0,i().$K)(e.executionSuccess)?{true:{...e,executionStartTime:e.executionStartTime,executionDurationMs:e.executionDurationMs,executionSuccess:e.executionSuccess}}:{false:e})),c=(0,i().AO)((e=>(0,i().$K)(e.executionStartTime)&&(0,i().$K)(e.executionDurationMs)&&(0,i().$K)(e.executionSuccess)?{true:{...e,executionStartTime:e.executionStartTime,executionDurationMs:e.executionDurationMs,executionSuccess:e.executionSuccess}}:{false:e}))},21463:(e,t,o)=>{o.d(t,{L:()=>f,Y:()=>d});o(821057),o(670560),o(122556),o(582845),o(250570),o(533019),o(721473),o(788208),o(22624);var i=()=>o(855741),n=()=>o(92960),a=()=>o(177634),r=()=>o(728670),s=()=>o(396136),l=()=>o(334810),c=()=>o(360517),u=()=>o(870691);const p=(0,o(788860).vU)({createPage:{id:"automations.actions.createPage",defaultMessage:"Add page toâ€¦"},createPageDescription:{id:"automations.actions.createPageDescription",defaultMessage:"Adds a new page to a database."},createPageVariableName:{id:"automations.actions.createPageVariableName",defaultMessage:"Page added"},createPageVariableNameWithStepNumber:{id:"automations.actions.createPageVariableNameWithStepNumber",defaultMessage:"Page added in step {stepNumber}"},createPageVariableDescription:{id:"automations.actions.createPageVariableDescription",defaultMessage:"The page created from an add page action"}}),d={relation:!0,person:!0,multi_select:!0,title:!1,text:!1,url:!1,email:!1,phone_number:!1,checkbox:!1,created_by:!1,last_edited_by:!1,file:!1,select:!1,status:!1,number:!1,date:!1,created_time:!1,last_edited_time:!1,last_visited_time:!1,formula:!1,rollup:!1,button:!1,auto_increment_id:!1,location:!1,verification:!1},m=new Set(["button","event","recurrence"]),f={type:"create_page",invertible:!0,hasSideEffects:!0,hasNewReversableEffect:!0,display:{icon:o(159732).R,name:p.createPage,description:p.createPageDescription},isAvailableForContext:e=>{let t=e.automation.getTriggerType();return"notification_event"===t&&(t="event"),"event"===t?e.isSubscribed:m.has(t)},resolveExecutionDependencies:function*(e,t){const i=[],n=t.getConfig();if(!n)return i;if(n.collection){i.push({type:"record_permission",pointer:n.collection,minimumRole:"content_only_editor"});const e=yield*o(870910).R.fetchRecord(n.collection),t=null==e?void 0:e.getDefaultTemplatePagePointer();t&&i.push({type:"record_permission",pointer:{spaceId:null==e?void 0:e.getSpaceId(),...t},minimumRole:"none"}),n.template_page_id&&i.push({type:"record_permission",pointer:{id:n.template_page_id,spaceId:n.collection.spaceId,table:s().iU},minimumRole:"reader"})}if(n.values)for(const o of Object.values(n.values))null!=o&&o.value&&i.push(...yield*e.getFormulaContentsDependencies({minimumRole:"reader",value:o.value}));return i},typecheck:(e,t)=>{const i=t.getConfig();if(!i)return{value:{validationFailures:[{type:"empty_config",key:"config",actionType:"create_page",shouldNotifyOnFailure:!0}]}};if(!i.collection)return{value:{validationFailures:[{type:"missing_required_config",actionType:"create_page",key:"collection",shouldNotifyOnFailure:!0}]}};const u=e.getRecordModel(i.collection);if(!u)return{value:{validationFailures:[{type:"collection_not_found",actionType:"create_page",key:i.collection.id,shouldNotifyOnFailure:!0}]}};if(!r().fh(u.pointer,e.getRecordModel))return{value:{validationFailures:[{type:"collection_in_trash",actionType:"create_page",key:"collection",shouldNotifyOnFailure:!0}]}};if(!i.collection.spaceId)return{error:new(c().MO)("Collection missing space ID")};if(i.template_page_id){const t=e.getRecordModel({id:i.template_page_id,table:s().iU});if(!t)return{value:{validationFailures:[{type:"invalid_optional_config",actionType:"create_page",key:"template",shouldNotifyOnFailure:!0}]}};if(!t.isTemplate())return{value:{validationFailures:[{type:"invalid_optional_config",actionType:"create_page",key:"template",shouldNotifyOnFailure:!0}]}};if(t.getParentId()!==i.collection.id)return{value:{validationFailures:[{type:"invalid_optional_config",actionType:"create_page",key:"template",shouldNotifyOnFailure:!0}]}}}let d=!1;for(const n of e.automationModel.getActionIds()){if(n===t.id)continue;const i=e.getRecordModel({id:n,spaceId:e.automationModel.getSpaceId(),table:o(922713).Xj});"create_page"===(null==i?void 0:i.type)&&(d=!0)}const m=(0,a().Kd)({source:"action",action_id:t.id,action_output_type:"page"}),f=(e.automationModel.getActionIds().indexOf(t.id)??-1)+1,v=d?e.intl.formatMessage(p.createPageVariableNameWithStepNumber,{stepNumber:f}):e.intl.formatMessage(p.createPageVariableName),y={description:e.intl.formatMessage(p.createPageVariableDescription),kind:n().FormulaContextValueKind.ContextValue,id:m,name:v,type:{type:"block",collection:i.collection},associatedCollectionForDisplay:i.collection,stepNumberForDisplay:f},{validationFailures:g,formulaStats:h}=(0,l().l)({collectionPointer:u.getSpaceShardedPointer(),collectionSchema:u.getNormalizedSchema(),config:i,context:e,actionType:"create_page"});return{value:{valueTypes:[y],validationFailures:g,stats:{formulaStats:h}}}},execute:async(e,t)=>{const{author:p,executeEffectMap:d,handleDataRequest:m,loadRecordModel:f,useCrdtDefault:y}=e,g=t.getConfig();if(null==g||!g.collection||!g.collection.spaceId)return{error:new(c().mK)({pointer:null==g?void 0:g.collection,actionId:t.id})};const h=await f(g.collection),_=await m({recordPointers:[g.collection]});if(!h)return{value:{values:[]}};const x=h.getSpaceShardedPointer();if(!r().fh(x,_.getRecordModel))return{error:new(c().O3)({pointer:x,actionId:t.id})};let b;if(g.template_page_id){const e={id:g.template_page_id,spaceId:g.collection.spaceId,table:s().iU};v(e,(await m({recordPointers:[e]})).getRecordModel)&&(b=g.template_page_id)}if(!(0,o(696459).$K)(b)){const e=null==h?void 0:h.getDefaultTemplatePagePointer();if(e){v(e,(await m({recordPointers:[e]})).getRecordModel)&&(b=e.id)}}const S=h.isPageTreeCollection(),C=h.getRootPagePointer(),F=await async function(e){const{isPageTreeCollection:t,rootPagePointer:o,actionId:i,loadRecordModel:n,useCrdtDefault:a}=e;if(t&&o){const e=await n(o);return e?{value:e.useCrdt()}:{error:new(c().mK)({pointer:o,actionId:i})}}return{value:a}}({isPageTreeCollection:S,rootPagePointer:C,actionId:t.id,loadRecordModel:f,useCrdtDefault:y});if(i().x.isFail(F))return F;const{value:T}=F;let I,k;const M={},P=[];if(b){const o=await e.executeEffectMap.initializeTemplateInDatabase({actionId:t.id,templateId:b,collection:g.collection,propertyUpdates:{},useCrdt:T,automationExecutionContext:e});if(i().x.isFail(o))return o;I=o.value.pageId,k=o.value.pageModel,o.value.stats&&u().Fv.aggregateActionStats(M,o.value.stats)}else{var w;I=(null===(w=e.spaceIdCreator)||void 0===w?void 0:w.idInSavedSpace(s().iU))??o(956057).Ar();const{model:t,operations:i}=o(530980).yJh.create({id:I,type:o(156642).Ti.page,parent:g.collection,space_id:g.collection.spaceId,createdBy:p||o(72539).r3},{useCrdt:T});k=t,P.push(...i),u().Fv.aggregateActionStats(M,{blocksCreated:1,pagesCreated:1})}const E=h.getNormalizedSchema();if(E){const o=await(0,l().g)({config:g,page:k,collectionPointer:x,collectionSchema:E,actionId:t.id,context:e});if(i().x.isFail(o))return o;u().Fv.aggregateActionStats(M,o.value.stats),P.push(...o.value.values)}if(S&&C){const e=(0,o(836230).A6)(C.table,s().iU);if(!e)throw new Error(`Could not find child path for parent table ${C.table} and child table ${s().iU}`);P.push({pointer:C,path:e,command:"insertChildrenAfter",args:{ids:[I]}})}if(P.length>0){const e=await d.saveTransaction({actionId:t.id,info:{type:"create_page",collection:x,pageId:I},operations:P});if(e.error)return e;u().Fv.aggregateActionStats(M,e.value.stats)}const D=(0,a().Kd)({source:"action",action_id:t.id,action_output_type:"page"}),A={kind:n().FormulaContextValueKind.ContextValue,id:D,value:{type:"block",value:k.pointer}};return e.runtimeRecordPointerSet.add(k.pointer),{value:{stats:M,values:[A]}}}};function v(e,t){if(!t(e))return!1;const o=!r().fh(e,t),i=r().GR(e,t);return!(o||i)}},334810:(e,t,o)=>{o.d(t,{g:()=>f,l:()=>m});o(670560);var i=()=>o(855741),n=()=>o(696459),a=()=>o(912203),r=()=>o(226413),s=()=>o(177634),l=()=>o(907874),c=()=>o(360517),u=()=>o(207006),p=()=>o(870691),d=()=>o(473304);function m(e){const{collectionPointer:t,collectionSchema:o,config:i,context:c,actionType:d}=e;if(!o)return{validationFailures:[]};const m=[];let f;const v=c.checkExperimentGate("collections_xws")?"cross_space_and_read_permissions":"read_permissions_only";for(const g of i.properties||[]){var y;const e={formulasModule:c.formulasModule,handleDataRequest:(0,s().lc)(c.getRecordModel),restrictUnaccessibleProperties:v,spaceId:c.automationModel.spaceId,valueTypes:c.valueTypes.slice(0),featureGates:(0,u().w)({checkExperimentGateFn:c.checkExperimentGate})},h=null===(y=i.values)||void 0===y?void 0:y[g],_=null==o?void 0:o[g];if("relation"===(null==_?void 0:_.type)&&c.checkExperimentGate("collections_xws")&&(0,r().Qh)(c.automationModel.spaceId,_)&&m.push({actionType:d,key:g,type:"cross_space_relation"}),!_||!(0,a().SF)(_)||null==h||!h.value)continue;const{result:x,hasCrossSpaceError:b,stats:S}=(0,l().typecheckSimpleFormulaOrFormula)({context:{...e,allowedReturnTypes:a().Y_[_.type]},value:h.value,collectionPointer:t});b&&m.push({actionType:d,key:g,type:"invalid_formula_cross_space"}),f=(0,p().CL)(f,S),(0,n().$K)(x.parseErrors)&&x.parseErrors.length>0&&m.push({actionType:d,key:g,type:"invalid_formula_parse_error"}),(0,n().$K)(x.typeErrors)&&x.typeErrors.length>0&&m.push({actionType:d,key:g,type:"invalid_formula_type_error",shouldNotifyOnFailure:!0}),(0,n().$K)(x.type)||m.push({actionType:d,key:g,type:"invalid_formula_missing_return_type"})}return{validationFailures:m,formulaStats:f}}async function f(e){const{config:t,page:o,collectionPointer:n,collectionSchema:r,actionId:u,context:m,getCurrentPropertyValue:f}=e,{simpleFormulasModule:v}=m,y=[];let g;for(const _ of t.properties||[]){var h;const e=null===(h=t.values)||void 0===h?void 0:h[_],x=null==r?void 0:r[_];if(!x||!(0,a().SF)(x))continue;const b=(0,l().setPropertyValueToFormulaReturnType)(n,_,x);if(!b)return{error:new(c().Ox)({actionId:u,property:_,collectionPointer:n})};const S=a().Y_[x.type],{result:C,stats:F}=await v.executeSimpleFormulaAsyncWithStats({value:(null==e?void 0:e.value)||{type:"simple",value:void 0},context:{...m,allowedValueTypes:S,returnType:b},executeFormula:m.executeContextualFormula});if(g=(0,p().CL)(g,F),i().x.isFail(C))return{error:new(c().x6)({actionId:u,cause:(0,a().rR)(C.error),stats:g})};const T=(0,s().ag)({result:C.value,page:o,action:(0,d().o9)(e),currentPropertyValue:null==f?void 0:f(_),propertyId:_,propertySchema:x});T&&y.push(...T)}return{value:{values:y,stats:{formulaStats:g}}}}},969583:(e,t,o)=>{o.r(t),o.d(t,{getActionRegistryItem:()=>Re,getActionRegistryItemsWithConcern:()=>Ne});o(241792);var i=()=>o(473304),n=(o(670560),o(267602),o(470928),()=>o(788860)),a=()=>o(855741),r=()=>o(696459),s=()=>o(912203),l=()=>o(92960),c=()=>o(177634),u=()=>o(907874),p=()=>o(922713),d=()=>o(955620),m=()=>o(360517),f=()=>o(207006),v=()=>o(870691);const y=(0,n().vU)({assistant:{id:"automations.actions.assistantBasic",defaultMessage:"Notion AI"},assistantDescription:{id:"automations.actions.assistantBasicDescription",defaultMessage:"Opens an Assistant session with the specified instructions applied."}}),g={type:"assistant_basic",invertible:void 0,hasSideEffects:!0,hasNewReversableEffect:!1,display:{icon:o(828042).t,name:y.assistant,description:y.assistantDescription},isAvailableForContext:e=>!!e.assistantFeatureGate.isAiAutomationButtonEnabledForUser()&&("button"===e.automation.getTriggerType()&&"button_block"===e.contextType),resolveExecutionDependencies:function*(e,t){const o=[];o.push({type:"record_permission",pointer:e.automationModel.getParentPointer(),minimumRole:"content_only_editor"}),o.push({minimumRole:"none",pointer:e.automationModel.getSpacePointer(),type:"record_permission"});const i=t.getConfig(),n=(0,p().bl)(i);if(a().x.isFail(n))return o;const{instructions:r,initialUserPrompt:s}=n.value;return r&&o.push(...yield*e.getFormulaContentsDependencies({minimumRole:"reader",value:r})),s&&o.push(...yield*e.getFormulaContentsDependencies({minimumRole:"reader",value:s})),o},typecheck:(e,t)=>{var i;const{automationModel:n,getRecordModel:s,getRecordRole:l}=e,y=n.getSpacePointer();if("button_block"!==e.contextType)return{value:{validationFailures:[{actionType:"assistant_basic",type:"unsupported_context_type",execute:!1}]}};if(null===(i=e.assistantFeatureGate)||void 0===i||!i.isAiAutomationButtonEnabledForUser())return{value:{validationFailures:[{actionType:"assistant_basic",type:"unsupported_skill",execute:!1}]}};const g=l(y);if(!g||(0,o(528514).gr)(g,"reader"))return{value:{validationFailures:[{actionType:"assistant_basic",type:"ai_disabled_for_guest"}]}};const h=s(y);if(!(0,r().$K)(h))return{error:new(m().MO)("Space model missing")};if(!h.isAiEnabledOnSpace())return{value:{validationFailures:[{actionType:"assistant_basic",type:"ai_disabled_in_space"}]}};const _=t.getConfig();if(!_)return{value:{validationFailures:[{actionType:"assistant_basic",type:"invalid_config"}]}};const x=(0,p().bl)(_);if(a().x.isFail(x))return{value:{validationFailures:[{actionType:"assistant_basic",type:"unsupported_skill"}]}};const{instructions:b,initialUserPrompt:S}=x.value;if(!b||0===(0,d().QaF)(b.value).trim().length)return{value:{validationFailures:[{actionType:"assistant_basic",type:"empty_instructions",key:"instructions"}]}};const C=[];let F;const T=e.checkExperimentGate("collections_xws")?"cross_space_and_read_permissions":"read_permissions_only",I={formulasModule:e.formulasModule,handleDataRequest:(0,c().lc)(e.getRecordModel),restrictUnaccessibleProperties:T,spaceId:e.automationModel.spaceId,valueTypes:e.valueTypes.slice(0),featureGates:(0,f().w)({checkExperimentGateFn:e.checkExperimentGate})};for(const[o,a]of[["instructions",b],["initialUserPrompt",S]]){if(!a)continue;const{result:e,hasCrossSpaceError:t,stats:i}=(0,u().typecheckSimpleFormulaOrFormula)({context:I,value:a});t&&C.push({actionType:"assistant_basic",type:"invalid_formula_cross_space",key:o}),F=(0,v().CL)(F,i),e.parseErrors&&e.parseErrors.length>0&&C.push({actionType:"assistant_basic",type:"invalid_formula_parse_error",key:o}),e.typeErrors&&e.typeErrors.length>0&&C.push({actionType:"assistant_basic",type:"invalid_formula_type_error",key:o}),e.type||C.push({actionType:"assistant_basic",type:"invalid_formula_missing_return_type",key:o})}return{value:{validationFailures:C,valueTypes:[],stats:{formulaStats:F}}}},execute:async(e,t)=>{const{simpleFormulasModule:i}=e,n=t.getConfig();if(!n)return{error:new(m().Qq)({actionId:t.id})};const r=(0,p().bl)(n);if(a().x.isFail(r))return{error:new(m().Qq)({actionId:t.id})};const u=r.value;let d,f,y=[];if(u.instructions){const{result:o,stats:n}=await i.executeSimpleFormulaAsyncWithStats({value:u.instructions,context:{...e,returnType:{type:"text"}},executeFormula:e.executeContextualFormula});if(f=n,a().x.isFail(o))return{error:new(m().x6)({actionId:t.id,cause:(0,s().rR)(o.error),stats:f})};y=(0,c().j4)(o.value)}if(u.initialUserPrompt){const{result:o,stats:n}=await i.executeSimpleFormulaAsyncWithStats({value:u.initialUserPrompt,context:{...e,returnType:{type:"text"}},executeFormula:e.executeContextualFormula});if(f=(0,v().CL)(f,n),a().x.isFail(o))return{error:new(m().x6)({actionId:t.id,cause:(0,s().rR)(o.error),stats:f})};d=(0,c().j4)(o.value)}const g=function(e){var t;const i=(0,o(309968).Vl)(),n=e.values.find((e=>e.kind===l().FormulaContextValueKind.ContextValue&&e.id===i));if(!n||"block"!==(null===(t=n.value)||void 0===t?void 0:t.type))return;return n.value.value}(e),h=await e.executeEffectMap.runAssistantWithInstructions({actionId:t.id,automationId:e.automationModel.id,instructions:y,initialUserPrompt:d,overrideCurrentPagePointer:g});return a().x.isSuccess(h)?{value:{values:[],stats:{formulaStats:f}}}:{error:h.error}}};o(30005);var h=()=>o(926724),_=()=>o(870910),x=()=>o(605974),b=()=>o(494616),S=()=>o(856466),C=()=>o(126301),F=(o(492176),o(122556),o(582845),o(250570),o(533019),o(721473),o(788208),o(22624),o(7961),o(653476),o(228244),()=>o(513670)),T=()=>o(156642),I=()=>o(72539),k=()=>o(956057),M=()=>o(530980),P=()=>o(481529),w=()=>o(396136),E=()=>o(752778);const D=(0,m().Fd)((async function(e){const{completeSprintAction:t,completeSprintExecutionContext:o}=e,i=await async function(e){const{sprintCollectionSchema:t,sprintCollectionPointer:o}=e.sprintCollectionContext,{context:i,action:n}=e.automationContext,a=x().qB[h().p$].current.reducer.getCombinatorFilter(t);return await V((()=>i.executeEffectMap.queryCollection({actionId:n.id,collection:o,userTimeZone:i.userTimeZone,filter:a,limit:1})),e)}(o);if(a().x.isFail(i))return i;const n=i.value.blockIds.at(0);if(!(0,r().$K)(n))return{error:new(m()._w)({actionId:o.automationContext.action.id})};const s=await async function(e){const{sprintCollectionSchema:t,sprintCollectionPointer:o}=e.sprintCollectionContext,{context:i,action:n}=e.automationContext,a=x().qB[h().p$].next.reducer.getCombinatorFilter(t);return await V((()=>i.executeEffectMap.queryCollection({actionId:n.id,collection:o,userTimeZone:i.userTimeZone,filter:a,limit:1})),e)}(o);if(a().x.isFail(s))return s;const l=F().Ps(s.value.blockIds),c=await Promise.all([A({currentSprintPageId:n,completeSprintExecutionContext:o}),R({currentSprintPageId:n,completeSprintExecutionContext:o})]);let u=c[0];const p=c[1],f=function(e){const{incompleteTasksResult:t,completeTasksResult:o}=e;if(a().x.isFail(t)||a().x.isFail(o))return;const i=t.value.blockIds.length,n=o.value.blockIds.length,r=i+n;return{completedTaskCount:n,incompleteTaskCount:i,totalTaskCount:r,completedTaskPercent:0===r?0:n/r}}({incompleteTasksResult:u,completeTasksResult:p}),v=o.automationContext.context.automationModel.isActive()?"recurrence_automation":"button_automation";let y,g;if((0,S().$X)({eventTracker:o.automationContext.context.eventTracker,properties:{action:"complete_sprint",from:v,completeSprintActionType:t,nextSprintDateRange:o.sprintCollectionContext.nextSprintDateRange,nextSprintInput:l?{type:"pointer",pointer:{id:l,table:w().iU,spaceId:o.spaceId}}:{type:"actionId"},currentSprintTaskSummary:f}}),l)g=l,y=1;else{const e=await async function(e){const{completeSprintExecutionContext:t,currentSprintPageId:o}=e,{sprintStatusNextOptionName:i,sprintStatusPropertyId:n}=t.sprintCollectionContext,{context:a,action:r}=t.automationContext,{recordMap:s,spaceId:l}=t,c={id:o,table:w().iU,spaceId:l},u=s.getModel(c);if(!u)return{error:new(m().Do)({actionId:r.id,pointer:c})};const p=G({intl:a.intl,userTimeZone:a.userTimeZone,getRecordModel:M().omK.fromRecordMap(s),incrementSprintIdAmount:1,sourceSprintPageModel:u}),f={title:(0,d().TPx)(p),[n]:[[i]]};return await U({completeSprintExecutionContext:t,pageProperties:f})}({completeSprintExecutionContext:o,currentSprintPageId:n});if(a().x.isFail(e))return e;g=e.value.blockId,y=2}const _=await async function(e){const{sprintUniqueIdPropertyId:t,sprintStatusPropertyId:o,sprintStatusFutureOptionName:i,sprintCollectionPointer:n}=e.sprintCollectionContext,{context:a,action:r}=e.automationContext,s={operator:"and",filters:[{property:o,filter:{operator:"status_is",value:{type:"is_option",value:i}}}]};return await V((()=>a.executeEffectMap.queryCollection({actionId:r.id,collection:n,filter:s,userTimeZone:a.userTimeZone,sort:[{property:t,direction:"ascending"}],limit:1})),e)}(o);if(a().x.isFail(_))return _;let b=_.value.blockIds[0];if(!b){const e=await K({completeSprintExecutionContext:o,sprintPageWithLargestUniqueId:g,incrementFutureSprintIdAmount:1});if(y=1===y?2:3,a().x.isFail(e))return e;b=e.value.blockId}const C=await async function(e){const{sprintUniqueIdPropertyId:t,sprintCollectionPointer:o}=e.sprintCollectionContext,{context:i,action:n}=e.automationContext;return await V((()=>i.executeEffectMap.queryCollection({actionId:n.id,collection:o,userTimeZone:i.userTimeZone,sort:[{property:t,direction:"descending"}],limit:1})),e)}(o);if(a().x.isFail(C))return C;const T=C.value.blockIds[0];if(function(e){var t;const{sprintStatusPropertySchema:o}=e.sprintCollectionContext;return(null===(t=o.options)||void 0===t?void 0:t.some((e=>e.id===h().Rw)))??!1}(o)){const e=await async function(e){const{sprintCollectionSchema:t,sprintCollectionPointer:o}=e.sprintCollectionContext,{context:i,action:n}=e.automationContext,a=x().qB[h().p$].last.reducer.getCombinatorFilter(t);return await V((()=>i.executeEffectMap.queryCollection({actionId:n.id,collection:o,userTimeZone:i.userTimeZone,filter:a,limit:1})),e)}(o);if(a().x.isFail(e))return e;const t=e.value.blockIds[0],i=await async function(e){const{completeSprintExecutionContext:t,currentSprintPageId:o}=e,{sprintStatusLastOptionName:i,sprintStatusPropertyId:n,sprintCollectionPointer:a}=t.sprintCollectionContext,{context:r,action:s}=t.automationContext,{spaceId:l}=t,c=[];i&&c.push(P().op.update({pointer:{id:o,table:w().iU,spaceId:l},path:["properties"],args:{[n]:[[i]]}}));return await r.executeEffectMap.saveTransaction({actionId:s.id,operations:c,info:{type:"update_pages",collection:a,editedProperties:[{id:n,type:"status"}],pageIds:[o]}})}({completeSprintExecutionContext:o,currentSprintPageId:n});if(a().x.isFail(i))return i;if(t){const e=await async function(e){const{completeSprintExecutionContext:t,lastSprintPageId:o}=e,{sprintStatusPastOptionName:i,sprintStatusPropertyId:n,sprintCollectionPointer:a}=t.sprintCollectionContext,{context:r,action:s}=t.automationContext,{spaceId:l}=t,c=[P().op.update({pointer:{id:o,table:w().iU,spaceId:l},path:["properties"],args:{[n]:[[i]]}})];return await r.executeEffectMap.saveTransaction({actionId:s.id,operations:c,info:{type:"update_pages",collection:a,editedProperties:[{id:n,type:"status"}],pageIds:[o]}})}({completeSprintExecutionContext:o,lastSprintPageId:t});if(a().x.isFail(e))return e}}else{const e=await async function(e){const{completeSprintExecutionContext:t,currentSprintPageId:o}=e,{sprintStatusPastOptionName:i,sprintStatusPropertyId:n,sprintCollectionPointer:a}=t.sprintCollectionContext,{context:r,action:s}=t.automationContext,{spaceId:l}=t,c=[P().op.update({pointer:{id:o,table:w().iU,spaceId:l},path:["properties"],args:{[n]:[[i]]}})];return await r.executeEffectMap.saveTransaction({actionId:s.id,operations:c,info:{type:"update_pages",collection:a,editedProperties:[{id:n,type:"status"}],pageIds:[o]}})}({completeSprintExecutionContext:o,currentSprintPageId:n});if(a().x.isFail(e))return e}const I=await async function(e){const{completeSprintExecutionContext:t,nextSprintPageId:o}=e,{sprintStatusCurrentOptionName:i,sprintStatusPropertyId:n,sprintCollectionPointer:a,nextSprintDateRange:r,sprintDatePropertyId:s}=t.sprintCollectionContext,{context:l,action:c}=t.automationContext,{spaceId:u}=t,p=[P().op.update({pointer:{id:o,table:w().iU,spaceId:u},path:["properties"],args:{[n]:[[i]],[s]:[(0,d().YCD)(["d",r])]}})];return await l.executeEffectMap.saveTransaction({actionId:c.id,operations:p,info:{type:"update_pages",collection:a,editedProperties:[{id:n,type:"status"}],pageIds:[o]}})}({completeSprintExecutionContext:o,nextSprintPageId:g});if(a().x.isFail(I))return I;const k=await async function(e){const{completeSprintExecutionContext:t,nextFutureSprintPageId:o}=e,{sprintStatusNextOptionName:i,sprintStatusPropertyId:n,sprintCollectionPointer:a}=t.sprintCollectionContext,{context:r,action:s}=t.automationContext,{recordMap:l,spaceId:c}=t,u={id:o,table:w().iU,spaceId:c},p=l.getModel(u);if(!p)return{error:new(m().Do)({actionId:s.id,pointer:u})};l.addModel(p);const d=[P().op.update({pointer:p.pointer,path:["properties"],args:{[n]:[[i]]}})];return await r.executeEffectMap.saveTransaction({actionId:s.id,operations:d,info:{type:"update_pages",collection:a,editedProperties:[{id:n,type:"status"}],pageIds:[o]}})}({completeSprintExecutionContext:o,nextFutureSprintPageId:b});if(a().x.isFail(k))return k;const E=await K({completeSprintExecutionContext:o,sprintPageWithLargestUniqueId:T,incrementFutureSprintIdAmount:y});if(a().x.isFail(E))return E;const D=new Set([]);for(;;){if(a().x.isFail(u))return u;if(0===u.value.blockIds.length)break;const e=u.value.blockIds.filter((e=>!D.has(e)));if("complete_sprint_and_move_incomplete_tasks_to_next_sprint"===t&&e.length>0){const t=await O({completeSprintExecutionContext:o,taskIds:e,nextSprintPageId:g});if(a().x.isFail(t))return t}else{if(!("complete_sprint_and_move_incomplete_tasks_to_backlog"===t&&e.length>0))break;{const t=await q(o,e);if(a().x.isFail(t))return t}}e.forEach((e=>D.add(e))),u=await A({currentSprintPageId:n,completeSprintExecutionContext:o})}return{value:{success:!0}}}),(e=>e.completeSprintExecutionContext.automationContext.context.automationModel.id));async function A(e){const{currentSprintPageId:t,completeSprintExecutionContext:o}=e,{taskStatusCompleteGroupName:i}=o.taskCollectionContext;return await N({currentSprintPageId:t,statusFilter:{operator:"status_is_not",value:{type:"is_group",value:i}},completeSprintExecutionContext:o})}async function R(e){const{currentSprintPageId:t,completeSprintExecutionContext:o}=e,{taskStatusCompleteGroupName:i}=o.taskCollectionContext;return await N({currentSprintPageId:t,statusFilter:{operator:"status_is",value:{type:"is_group",value:i}},completeSprintExecutionContext:o})}async function N(e){const{currentSprintPageId:t,statusFilter:o,completeSprintExecutionContext:i}=e,{taskStatusPropertyId:n,taskSprintRelationPropertyId:a,taskCollectionPointer:r}=i.taskCollectionContext,{context:s,action:l}=i.automationContext,c={operator:"and",filters:[{property:n,filter:o},{filter:{operator:"relation_contains",value:{type:"exact",value:t}},property:a}]};return await V((()=>s.executeEffectMap.queryCollection({limit:999,actionId:l.id,collection:r,userTimeZone:s.userTimeZone,filter:c})),i)}async function V(e,t){const{spaceId:o,recordMap:i}=t,{context:n}=t.automationContext,r=await e();if(a().x.isFail(r))return r;const s=r.value;if(s.recordMap)i.assign(s.recordMap.toRecordMap());else{const e=s.blockIds.map((e=>({id:e,table:w().iU,spaceId:o}))),t=await n.loadRecordModel(e);i.assign(t)}return{value:{blockIds:s.blockIds}}}async function K(e){const{completeSprintExecutionContext:t,sprintPageWithLargestUniqueId:o,incrementFutureSprintIdAmount:i}=e,{sprintStatusFutureOptionName:n,sprintStatusPropertyId:a}=t.sprintCollectionContext,{context:r,action:s}=t.automationContext,{recordMap:l,spaceId:c}=t,u={id:o,table:w().iU,spaceId:c},p=l.getModel(u);if(!p)return{error:new(m().Do)({actionId:s.id,pointer:u})};const f=G({intl:r.intl,userTimeZone:r.userTimeZone,getRecordModel:M().omK.fromRecordMap(l),incrementSprintIdAmount:i,sourceSprintPageModel:p}),v={title:(0,d().TPx)(f),[a]:[[n]]};return await U({completeSprintExecutionContext:t,pageProperties:v})}async function U(e){const{completeSprintExecutionContext:t,pageProperties:o}=e,{recordMap:i,sprintCollectionContext:n,automationContext:r,spaceId:s}=t,{context:l,action:c}=r,u=n.sprintCollectionPointer,p=i.getModel(u);if(!p)return{error:new(m().fH)("invalid_record",`Could not find collection record: ${u.id}`)};let d;const f=l.useCrdtDefault,v=p.getDefaultTemplatePagePointer();if(v){const e=await l.executeEffectMap.initializeTemplateInDatabase({actionId:c.id,templateId:v.id,collection:p.getSpaceShardedPointer(),propertyUpdates:o,useCrdt:f,automationExecutionContext:l});if(a().x.isFail(e))return e;d=e.value.pageId;const t={id:d,table:w().iU,spaceId:s},n=await l.loadRecordModel(t);if(!n)return{error:new(m().fH)("invalid_record",`Could not find new sprint page: ${t.id}`)};i.addModel(n)}else{var y;d=(null===(y=l.spaceIdCreator)||void 0===y?void 0:y.idInSavedSpace(w().iU))??k().Il();const{model:e,operations:t}=M().yJh.create({id:d,type:T().Ti.page,parent:{id:u.id,table:E().vF,spaceId:s},space_id:s,properties:o,createdBy:l.author||I().r3},{useCrdt:f});l.runtimeRecordPointerSet.add(e.pointer);const n=await l.executeEffectMap.saveTransaction({actionId:c.id,operations:t,info:{type:"create_page",collection:u,pageId:d}});if(a().x.isFail(n))return n;i.setModel(e.pointer,e)}return{value:{blockId:d}}}async function O(e){const{completeSprintExecutionContext:t,taskIds:o,nextSprintPageId:i}=e,{taskSprintRelationPropertyId:n,taskCollectionPointer:a}=t.taskCollectionContext,{context:r,action:s}=t.automationContext,{spaceId:l}=t,c=o.map((e=>P().op.update({pointer:{id:e,table:w().iU,spaceId:l},path:["properties"],args:{[n]:[(0,d().YCD)((0,d().$0A)(i,l))]}})));return await r.executeEffectMap.saveTransaction({actionId:s.id,operations:c,info:{type:"update_pages",collection:a,editedProperties:[{id:n,type:"relation"}],pageIds:o}})}async function q(e,t){const{taskSprintRelationPropertyId:o,taskCollectionPointer:i}=e.taskCollectionContext,{context:n,action:a}=e.automationContext,{spaceId:r}=e,s=t.map((e=>P().op.update({pointer:{id:e,table:w().iU,spaceId:r},path:["properties"],args:{[o]:void 0}})));return await n.executeEffectMap.saveTransaction({actionId:a.id,operations:s,info:{type:"update_pages",collection:i,editedProperties:[{id:o,type:"relation"}],pageIds:t}})}const $=(0,n().vU)({defaultSprintName:{id:"completeSprint.newSprint.defaultName",defaultMessage:"Sprint"},sprintNameWithId:{id:"completeSprint.newSprintWithId.name",defaultMessage:"Sprint {sprintId}"}});function G(e){const{intl:t,userTimeZone:o,getRecordModel:i,sourceSprintPageModel:n,incrementSprintIdAmount:a}=e,r=n.getRenderTitle({intl:t,userTimeZone:o,getRecordModel:i}),s=F().Z$(null==r?void 0:r.trim().split(" "));let l;if(s){const e=parseInt(s);isNaN(e)||(l=e+a)}return void 0!==l?t.formatMessage($.sprintNameWithId,{sprintId:l}):t.formatMessage($.defaultSprintName)}const L={type:"complete_sprint",invertible:!1,hasSideEffects:!0,hasNewReversableEffect:!1,isAvailableForContext:e=>"recurrence"===e.automation.getTriggerType(),resolveExecutionDependencies:(e,t)=>{const o=t.getConfig(),i=[];return null!=o&&o.sprint_collection&&i.push({type:"record_permission",pointer:o.sprint_collection,minimumRole:"editor"}),null!=o&&o.task_collection&&i.push({type:"record_permission",pointer:o.task_collection,minimumRole:"editor"}),_().R.return(i)},typecheck:(e,t)=>({value:{valueTypes:[]}}),execute:async(e,t)=>{var n,r,s,c,u,p,f,v,y,g,_;const F=t.getConfig();if(!F)return{error:new(m().Qq)({actionId:t.id})};const T=o(217465).RecordMap.create(),I=await e.loadRecordModel(F.sprint_collection);if(!I)return{error:new(m().Do)({actionId:t.id,pointer:F.sprint_collection})};T.addModel(I);const k=I.getNormalizedSchema();if(!(0,x().PB)({appUri:null===(n=I.getFormat())||void 0===n?void 0:n.app_config_uri,collectionSchema:k}))return{error:new(m().H2)({actionId:t.id,sprintCollectionPointer:I.pointer})};const M=null===(r=I.getFormat())||void 0===r||null===(r=r.app_uri_map)||void 0===r?void 0:r[h().b0.StatusV2];if(!M)return{error:new(m().Ox)({actionId:t.id,collectionPointer:F.sprint_collection,property:h().b0.StatusV2})};const P=null===(s=I.getFormat())||void 0===s||null===(s=s.app_uri_map)||void 0===s?void 0:s[h().b0.UniqueId];if(!P)return{error:new(m().Ox)({actionId:t.id,collectionPointer:F.sprint_collection,property:h().b0.UniqueId})};const w=null===(c=I.getFormat())||void 0===c||null===(c=c.app_uri_map)||void 0===c?void 0:c[h().b0.Dates];if(!w)return{error:new(m().Ox)({actionId:t.id,collectionPointer:F.sprint_collection,property:h().b0.Dates})};const E=k[M];if(!E||"status"!==E.type)return{error:new(m().Ox)({actionId:t.id,collectionPointer:F.sprint_collection,property:h().b0.StatusV2})};const A=null===(u=E.options)||void 0===u||null===(u=u.find((e=>e.id===h().df)))||void 0===u?void 0:u.value,R=null===(p=E.options)||void 0===p||null===(p=p.find((e=>e.id===h().Rw)))||void 0===p?void 0:p.value,N=null===(f=E.options)||void 0===f||null===(f=f.find((e=>e.id===h().SF)))||void 0===f?void 0:f.value,V=null===(v=E.options)||void 0===v||null===(v=v.find((e=>e.id===h().YE)))||void 0===v?void 0:v.value,K=null===(y=E.options)||void 0===y||null===(y=y.find((e=>e.id===h().eH)))||void 0===y?void 0:y.value;if(!(A&&N&&V&&K))return{error:new(m().fH)("invalid_property_schema",`Could not find required options for ${h().b0.StatusV2}.`)};const U={id:e.automationModel.id,table:b().cv,spaceId:I.id},O=e.automationModel;if(!O.isType("recurrence"))return{error:new(m().Do)({actionId:t.id,pointer:U})};const q=await e.loadRecordModel(F.task_collection);if(!q)return{error:new(m().Do)({actionId:t.id,pointer:F.task_collection})};T.addModel(q);const $=null===(g=q.getFormat())||void 0===g||null===(g=g.app_uri_map)||void 0===g?void 0:g[h().Es.Status];if(!$)return{error:new(m().Ox)({actionId:t.id,collectionPointer:F.task_collection,property:h().Es.Status})};const G=null===(_=q.getFormat())||void 0===_||null===(_=_.app_uri_map)||void 0===_?void 0:_[h().Es.TaskToSprintRelation];if(!G)return{error:new(m().Ox)({actionId:t.id,collectionPointer:F.task_collection,property:h().Es.TaskToSprintRelation})};const L=q.getNormalizedSchema(),j=L[$];if(!j||"status"!==j.type)return{error:new(m().Ox)({actionId:t.id,collectionPointer:F.task_collection,property:h().Es.Status})};const B=(0,S().F_)(e.intl,j);if(!B)return{error:new(m().fH)("invalid_property_schema",`Could not find required group for ${h().Es.Status}.`)};const H=function(e){let t,n;if(e.forEach((e=>{e.kind===l().FormulaContextValueKind.ContextValue&&(e.id===i().Pv&&"date"===e.value.type&&(0,o(803021).h)(e.value.value)?t=e.value.value:e.id===i().JL&&"text"===e.value.type&&(n=(0,d().QaF)(e.value.value)))})),!(t&&n))return;return{nextSprintDateRange:t,completeSprintActionType:n}}(e.values);let Z,W;if(H)Z=H.completeSprintActionType,W=H.nextSprintDateRange;else{const t=O.getTrigger().recurrence;if(!t)throw new(m().sF);const o=(0,C().Su)(t);if(!o)return{error:new(m().fH)("misc",`Invalid recurrence for sprint recurrence automation: ${O.id}`)};W=(0,C().IX)({userTimeZone:e.userTimeZone,sprintSchedule:o}),Z=F.complete_sprint_action}const Y={spaceId:I.space_id,automationContext:{action:t,context:e},sprintCollectionContext:{sprintCollectionPointer:F.sprint_collection,sprintCollectionSchema:k,nextSprintDateRange:W,sprintDatePropertyId:w,sprintStatusCurrentOptionName:N,sprintStatusFutureOptionName:K,sprintStatusNextOptionName:V,sprintStatusPastOptionName:A,sprintStatusLastOptionName:R,sprintStatusPropertyId:M,sprintStatusPropertySchema:E,sprintUniqueIdPropertyId:P},taskCollectionContext:{taskCollectionPointer:F.task_collection,taskCollectionSchema:L,taskSprintRelationPropertyId:G,taskStatusCompleteGroupName:B,taskStatusPropertyId:$,taskStatusPropertySchema:j},recordMap:T},z=await D({completeSprintAction:Z,completeSprintExecutionContext:Y});return a().x.isFail(z)?z:{value:{values:[]}}}};o(667294);var j=o(785893);const B=(0,o(827282).IU)("equalSquare",{viewBox:"0 0 18 18",svg:(0,j.jsxs)("g",{children:[(0,j.jsx)("path",{d:"M3.07 18H14.9c2.05 0 3.07-1.02 3.07-3.03V3.05c0-2.01-1.02-3.03-3.07-3.03H3.07C1.03.02 0 1.02 0 3.05v11.92C0 17 1.03 18 3.07 18Zm.02-1.57c-.98 0-1.52-.52-1.52-1.54V3.12c0-1.01.54-1.53 1.52-1.53h11.8c.97 0 1.52.52 1.52 1.53V14.9c0 1.02-.55 1.54-1.52 1.54Z"}),(0,j.jsx)("path",{d:"M5.31 11.55h7.36c.5 0 .84-.24.84-.73 0-.5-.33-.75-.84-.75H5.3c-.52 0-.85.25-.85.75 0 .49.35.73.85.73Zm0-3.6h7.36c.5 0 .84-.24.84-.74s-.33-.75-.84-.75H5.3c-.52 0-.85.25-.85.75s.35.74.85.74Z"})]})}),H=(0,n().vU)({defineVariablesName:{id:"automations.actions.defineVariablesName",defaultMessage:"Define variables"},defineVariablesDescription:{id:"automations.actions.defineVariablesDescription",defaultMessage:"Create and edit custom variables for your automation."},variableDescription:{id:"automations.actions.variableDescription",defaultMessage:"This is a variable of type: {readableReturnType}"}}),Z=new Set(["button","event","recurrence"]),W={type:"define_variables",invertible:void 0,hasSideEffects:!1,hasNewReversableEffect:!1,display:{icon:B,name:H.defineVariablesName,description:H.defineVariablesDescription},isAvailableForContext:e=>{let t=e.automation.getTriggerType();return"notification_event"===t&&(t="event"),"event"===t?e.isSubscribed:Z.has(t)},resolveExecutionDependencies:function*(e,t){var o;const i=[],n=null===(o=t.getConfig())||void 0===o?void 0:o.values;if((0,r().$K)(n))for(const a of Object.values(n))(0,r().$K)(a.value)&&i.push(...yield*e.getFormulaContentsDependencies({minimumRole:"reader",value:a.value}));return i},typecheck:(e,t)=>{const i=[],n=t.getConfig(),{values:a,variableIds:s}=n??{},p=[];let d;const m=e.checkExperimentGate("collections_xws")?"cross_space_and_read_permissions":"read_permissions_only";if((0,r().$K)(s)&&s.length>0&&(0,r().$K)(a)){const{intl:n}=e,y={formulasModule:e.formulasModule,handleDataRequest:(0,c().lc)(e.getRecordModel),restrictUnaccessibleProperties:m,spaceId:e.automationModel.spaceId,valueTypes:e.valueTypes.slice(0),featureGates:(0,f().w)({checkExperimentGateFn:e.checkExperimentGate})};for(const e of s){const s=a[e];if(!(0,r().$K)(s)||!(0,r().$K)(s.value))continue;const{result:m,hasCrossSpaceError:f,stats:g}=(0,u().typecheckSimpleFormulaOrFormula)({context:y,value:s.value});f&&p.push({actionType:"define_variables",key:e,type:"invalid_formula_cross_space"}),d=(0,v().CL)(d,g),(0,r().$K)(m.parseErrors)&&m.parseErrors.length>0&&p.push({actionType:"define_variables",key:e,type:"invalid_formula_parse_error"}),(0,r().$K)(m.typeErrors)&&m.typeErrors.length>0&&p.push({actionType:"define_variables",key:e,type:"invalid_formula_type_error",shouldNotifyOnFailure:!0}),(0,r().$K)(m.type)||p.push({actionType:"define_variables",key:e,type:"invalid_formula_missing_return_type"});const h=m.type??{type:"unknown"};i.push({description:n.formatMessage(H.variableDescription,{readableReturnType:n.formatMessage((0,o(834458).getHumanReadableType)(h)).toLocaleLowerCase()}),id:(0,c().Kd)({source:"action",action_id:t.id,action_output_type:"variable",variable_id:e}),kind:l().FormulaContextValueKind.ContextValue,name:s.name,type:h})}}return{value:{validationFailures:p,valueTypes:i,stats:{formulaStats:d}}}},execute:async(e,t)=>{const{formulasModule:o,simpleFormulasModule:i}=e,n=[],u=t.getConfig(),{values:p,variableIds:d}=u??{};let f;if((0,r().$K)(d)&&d.length>0&&(0,r().$K)(p))for(const y of d){const u=p[y];if((0,r().$K)(u)&&(0,r().$K)(u.value))if("simple"===u.value.type){const{result:o,stats:r}=await i.executeSimpleFormulaAsyncWithStats({value:u.value,context:{...e,returnType:{type:"text"}},executeFormula:e.executeContextualFormula});if(f=(0,v().CL)(f,r),a().x.isFail(o))return{error:new(m().x6)({actionId:t.id,cause:(0,s().rR)(o.error),stats:f})};n.push({id:(0,c().Kd)({source:"action",action_id:t.id,action_output_type:"variable",variable_id:y}),kind:l().FormulaContextValueKind.ContextValue,value:o.value})}else{const i=performance.now(),r=await o.executeFormulaAsync(u.value.value??[[""]],e),p=Math.trunc(performance.now()-i),d=a().x.isSuccess(r);if(f=(0,v().CL)(f,{formulaTypecheckDurationMs:void 0,formulaTypecheckSuccess:void 0,formulaExecutionDurationMs:p,formulaExecutionSuccess:d,totalFormulas:1,simpleFormulaTypecheckDurationMs:void 0,simpleFormulaTypecheckSuccess:void 0,simpleFormulaExecutionDurationMs:void 0,simpleFormulaExecutionSuccess:void 0,totalSimpleFormulas:void 0}),a().x.isFail(r))return{error:new(m().x6)({actionId:t.id,cause:(0,s().rR)(r.error),stats:f})};n.push({id:(0,c().Kd)({source:"action",action_id:t.id,action_output_type:"variable",variable_id:y}),kind:l().FormulaContextValueKind.ContextValue,value:r.value})}}return{value:{values:n,stats:{formulaStats:f}}}}};const Y=(0,n().vU)({duplicateBlocks:{id:"automations.actions.duplicateBlocks",defaultMessage:"Insert blocks"},duplicateBlocksDescription:{id:"automations.actions.duplicateBlocksDescription",defaultMessage:"Insert text or blocks on this page."}}),z={type:"duplicate_blocks",invertible:!0,hasSideEffects:!0,hasNewReversableEffect:!0,display:{icon:o(44037).a,name:Y.duplicateBlocks,description:Y.duplicateBlocksDescription},isAvailableForContext:e=>"button_block"===e.contextType,resolveExecutionDependencies:(e,t)=>{const o=[{type:"record_permission",pointer:e.automationModel.getParentPointer(),minimumRole:"content_only_editor"}];return e.parentPage&&o.push({type:"record_permission",pointer:e.parentPage.pointer,minimumRole:"content_only_editor"}),_().R.return(o)},typecheck:()=>({value:{valueTypes:[]}}),execute:async(e,t)=>{const o=F().Ps(t.getBlocks()??[]),i=t.getInsertionPoint(),n={};if((0,r().$K)(o)){const t=await e.executeEffectMap.duplicateBlockChildren({blockPointer:{table:w().iU,id:o,spaceId:e.automationModel.getSpaceId()},insertionPoint:i});a().x.isSuccess(t)&&v().Fv.aggregateActionStats(n,t.value.stats)}return{value:{stats:n,values:[]}}}};const Q=(0,n().vU)({modalConfirmation:{id:"automations.actions.modalConfirmation",defaultMessage:"Show confirmation"},modalConfirmationDescription:{id:"automations.actions.modalConfirmationDescription",defaultMessage:"Shows a confirmation window before proceeding."}}),J={type:"modal_confirmation",invertible:void 0,hasSideEffects:!1,hasNewReversableEffect:!1,display:{icon:o(456681).m,name:Q.modalConfirmation,description:Q.modalConfirmationDescription},isAvailableForContext:e=>"button"===e.automation.getTriggerType(),resolveExecutionDependencies:function*(e,t){const o=[],i=t.getConfig();return null!=i&&i.text&&o.push(...yield*e.getFormulaContentsDependencies({minimumRole:"reader",value:i.text})),o},typecheck:(e,t)=>{const o=t.getConfig();if(null==o||!o.text)return{value:{valueTypes:[]}};const i=[],n=e.checkExperimentGate("collections_xws")?"cross_space_and_read_permissions":"read_permissions_only",{result:a,hasCrossSpaceError:r,stats:s}=(0,u().typecheckSimpleFormulaOrFormula)({context:{formulasModule:e.formulasModule,handleDataRequest:(0,c().lc)(e.getRecordModel),restrictUnaccessibleProperties:n,spaceId:e.automationModel.spaceId,valueTypes:e.valueTypes.slice(0),featureGates:(0,f().w)({checkExperimentGateFn:e.checkExperimentGate})},value:o.text});return r&&i.push({actionType:"modal_confirmation",key:"text",type:"invalid_formula_cross_space"}),a.parseErrors&&a.parseErrors.length>0&&i.push({actionType:"modal_confirmation",type:"invalid_formula_parse_error",key:"text"}),a.typeErrors&&a.typeErrors.length>0&&i.push({actionType:"modal_confirmation",type:"invalid_formula_type_error",key:"text",shouldNotifyOnFailure:!0}),a.type||i.push({actionType:"modal_confirmation",type:"invalid_formula_missing_return_type",key:"text"}),{value:{validationFailures:i,valueTypes:[],stats:{formulaStats:s}}}},execute:async(e,t)=>{var o,i,n;const{simpleFormulasModule:r}=e,l=t.getConfig();let u,p=[];if(null!=l&&l.text){const{result:o,stats:i}=await r.executeSimpleFormulaAsyncWithStats({value:l.text,context:{...e,returnType:{type:"text"}},executeFormula:e.executeContextualFormula});if(u=i,a().x.isFail(o))return{error:new(m().x6)({actionId:t.id,cause:(0,s().rR)(o.error),stats:u})};p=(0,c().j4)(o.value)}(0,d().VrM)(p)>b().tb&&(p=(0,d().Zdj)(p,b().tb),p.push((0,d().V3y)("â€¦")));const f=await e.executeEffectMap.displayModal({format:{icon:null===(o=e.automationModel.getProperties())||void 0===o?void 0:o.icon,text:p,continueButtonText:(null==l||null===(i=l.continue_button)||void 0===i?void 0:i.text)??"",cancelButtonText:(null==l||null===(n=l.cancel_button)||void 0===n?void 0:n.text)??""}});return a().x.isFail(f)?f:"cancel"===f.value.result?{value:{formulaStats:u,stopExecution:!0,values:[]}}:{value:{values:[],formulaStats:u}}}};const X=(0,n().vU)({openPage:{id:"automations.actions.openPageOrUrl",defaultMessage:"Open page, form, or URL"},openPageDescription:{id:"automations.actions.openPageOrUrlDescription",defaultMessage:"Opens a specified page or URL."}}),ee={type:"open_page",invertible:!1,hasSideEffects:!1,hasNewReversableEffect:!1,display:{icon:o(843403).J,name:X.openPage,description:X.openPageDescription},isAvailableForContext:e=>"button"===e.automation.getTriggerType(),resolveExecutionDependencies:(e,t)=>{var o,i;const n=t.getConfig();return"page"===(null==n||null===(o=n.target)||void 0===o?void 0:o.type)?_().R.return([{type:"record_permission",pointer:null==n?void 0:n.target.page,minimumRole:"reader"}]):"variable"===(null==n||null===(i=n.target)||void 0===i?void 0:i.type)?_().R.return(e.getFormulaContextValueDependencies({targetId:n.target.id,minimumRole:"reader"})):_().R.return([])},typecheck:(e,t)=>{const o=t.getConfig();if(null==o||!o.target)return{value:{validationFailures:[{type:"missing_required_config",actionType:"open_page",key:"target"}]}};if("page"===o.target.type){if(!e.getRecordModel(o.target.page))return{value:{validationFailures:[{type:"missing_required_config",actionType:"open_page",key:"target",shouldNotifyOnFailure:!0}]}}}return{value:{valueTypes:[]}}},execute:(e,t)=>{const o=t.getConfig();if(null==o||!o.target)return Promise.resolve({error:new(m().mK)({pointer:null==o?void 0:o.target,actionId:t.id})});if("page"===o.target.type||"variable"===o.target.type){let i;if("page"===o.target.type)i=o.target.page;else if("variable"===o.target.type){const n=(0,c().dh)(e.values,o.target.id);if(!n)return Promise.resolve({error:new(m().Hb)({actionId:t.id,source:"action",variable:void 0})});if("block"===n.value.type)i=n.value.value;else{if("array"!==n.value.type)return Promise.resolve({error:new(m().Hb)({actionId:t.id,source:"action",variable:n.value})});{const e=n.value.values[0];if(!e||"block"!==e.type)return Promise.resolve({error:new(m().Hb)({actionId:t.id,source:"action",variable:n.value})});i=e.value}}}else(0,r().t1)(o.target);e.executeEffectMap.navigateToPage({actionId:t.id,page:i,openIn:t.getOpenPageIn()})}else"url"===o.target.type?e.executeEffectMap.openUrl({actionId:t.id,url:o.target.url}):(0,r().t1)(o.target);return Promise.resolve({value:{values:[]}})}};function te(e){return{...e,isAvailableForContext:t=>("canAddAction"!==t.checkType||!function(e){const{automationActions:t,checkType:o}=e;if("canAddAction"===o)return t.some((e=>e.isType("assistant_basic")));if("canSaveAction"===o)return t.length>1&&t.some((e=>e.isType("assistant_basic")));(0,r().t1)(o)}(t))&&e.isAvailableForContext(t),typecheck(t,o){const{runtimeStats:i}=t,n=i?v().Fv.getOrCreateAction(i,o.pointer,o.type):void 0,r=performance.now(),s=e.typecheck(t,o),l="modal_confirmation"===o.type?1:Math.trunc(performance.now()-r);return n&&(n.typecheckStartTime=r,n.typecheckDurationMs=l,a().x.isFail(s)?n.typecheckSuccess=!1:(v().Fv.aggregateActionStats(n,s.value.stats),n.typecheckSuccess=!0)),s},async execute(t,o){const{runtimeStats:i}=t,n=i?v().Fv.getOrCreateAction(i,o.pointer,o.type):void 0,r=performance.now(),s=await e.execute(t,o),l=Math.trunc(performance.now()-r);return n&&(n.executionStartTime=r,n.executionDurationMs=l,a().x.isFail(s)?(n.executionSuccess=!1,s.error instanceof m().x6&&v().Fv.aggregateActionStats(n,{formulaStats:s.error.data.stats})):(v().Fv.aggregateActionStats(n,s.value.stats),n.executionSuccess=!0)),s}}}var oe=()=>o(342792);const ie=(0,n().vU)({publishSite:{id:"automations.actions.publishSite",defaultMessage:"Publish site"},publishSiteDescription:{id:"automations.actions.publishSiteDescription",defaultMessage:"Publishes a specified page as a site."}}),ne={type:"publish_site",invertible:!1,hasSideEffects:!0,hasNewReversableEffect:!1,display:{icon:o(81979).o,name:ie.publishSite,description:ie.publishSiteDescription},isAvailableForContext:e=>!!e.checkExperimentGate("publish_site_automation_action")&&"event"===e.automation.getTriggerType(),resolveExecutionDependencies:(e,t)=>{var o,i;const n=[],a=t.getConfig();return a?("page"===(null===(o=a.target)||void 0===o?void 0:o.type)?n.push({type:"record_permission",pointer:a.target.page,minimumRole:"read_and_write"}):"variable"===(null==a||null===(i=a.target)||void 0===i?void 0:i.type)&&n.push(...e.getFormulaContextValueDependencies({targetId:a.target.id,minimumRole:"read_and_write"})),_().R.return(n)):_().R.return(n)},typecheck:(e,t)=>{const o=t.getConfig();if(null==o||!o.target)return{value:{valueTypes:[],validationFailures:[{type:"missing_required_config",actionType:"publish_site",key:"target"}]}};if("page"===o.target.type){if(!e.getRecordModel(o.target.page))return{value:{valueTypes:[],validationFailures:[{actionType:"publish_site",type:"missing_required_config",key:"target"}]}}}else if("variable"===o.target.type){const t=(0,c().vx)(e.valueTypes,o.target.id);if(!t)return{value:{valueTypes:[],validationFailures:[{actionType:"publish_site",type:"missing_target_variable",key:"target"}]}};if("block"!==t.type.type)return{value:{valueTypes:[],validationFailures:[{actionType:"publish_site",type:"invalid_formula_type_error",key:"target"}]}}}else(0,r().t1)(o.target);return{value:{valueTypes:[]}}},execute:async(e,t)=>{if(!e.author)return Promise.resolve({error:new(m().L)({actionId:t.id,contextValueId:"author"})});const i=t.getConfig();if(null==i||!i.target)return Promise.resolve({error:new(m().mK)({pointer:void 0,actionId:t.id})});let n;if("page"===i.target.type)n=i.target.page;else if("variable"===i.target.type){const o=(0,c().dh)(e.values,i.target.id);if("block"!==(null==o?void 0:o.value.type))return Promise.resolve({error:new(m().Hb)({actionId:t.id,source:"action",variable:null==o?void 0:o.value})});n=o.value.value}else(0,r().t1)(i.target);const a=await e.loadRecordModel(n);if(!a)return Promise.resolve({error:new(m().mK)({pointer:n,actionId:t.id})});const s=Date.now(),l=[],u=a.getFormat().site_id,p={id:u??(0,oe().ZP)(),table:o(928833).Gs,spaceId:a.getSpaceId()};return u||(l.push(P().op.update({pointer:p,path:[],args:{space_id:a.getSpaceId(),type:"site",version:1,last_version:0,parent_id:a.id,parent_table:a.table,created_time:s,created_by_id:e.author.id,created_by_table:e.author.table,last_edited_time:s,last_edited_by_id:e.author.id,last_edited_by_table:e.author.table,header:{}}})),l.push(P().op.update({pointer:a.pointer,path:["format"],args:{site_id:p.id}})),l.push({command:"setPermissionItem",pointer:n,path:["permissions"],args:{type:"public_permission",role:"reader"}}),await e.executeEffectMap.saveTransaction({actionId:t.id,operations:l,info:{type:"publish_site",pageId:n.id,siteId:p.id}})),Promise.resolve({value:{values:[]}})}};const ae=(0,n().vU)({queryCollection:{id:"automations.actions.queryCollection",defaultMessage:"Get pages"},queryCollectionDescription:{id:"automations.actions.queryCollectionDescription",defaultMessage:"Get a list of pages from a database with optional filters and sorts, to be used in a subsequent automation step."},queryCollectionPages:{id:"automations.actions.queryCollectionPages",defaultMessage:"Pages from step {stepNumber}"}}),re={type:"query_collection",invertible:void 0,hasSideEffects:!1,hasNewReversableEffect:!1,display:{icon:o(570328).e,name:ae.queryCollection,description:ae.queryCollectionDescription},isAvailableForContext:()=>!1,resolveExecutionDependencies:(e,t)=>{const o=t.getConfig();return null!=o&&o.collection?_().R.return([{type:"record_permission",pointer:null==o?void 0:o.collection,minimumRole:"reader"}]):_().R.return([])},typecheck:(e,t)=>{const o=t.getConfig();if(null==o||!o.collection)return{value:{valueTypes:[]}};const i=(0,c().Kd)({source:"action",action_id:t.id,action_output_type:"pages"}),n=e.automationModel.getActionIds().indexOf(t.id)??-1;return{value:{valueTypes:[{kind:l().FormulaContextValueKind.ContextValue,id:i,name:e.intl.formatMessage(ae.queryCollectionPages,{stepNumber:n+1}),type:{type:"array",of:{type:"block",collection:o.collection}}}]}}},execute:async(e,t)=>{const o=t.getConfig();if(null==o||!o.collection)return{value:{values:[]}};if(null==o||!o.collection.spaceId)return{error:new(m().mK)({pointer:null==o?void 0:o.collection,actionId:t.id})};const i={table:E().vF,id:null==o?void 0:o.collection.id,spaceId:null==o?void 0:o.collection.spaceId},n=await e.executeEffectMap.queryCollection({actionId:t.id,collection:i,userTimeZone:e.userTimeZone,filter:null==o?void 0:o.filter,sort:null==o?void 0:o.sort,limit:null==o?void 0:o.limit});if(n.error)return n;const a=(0,c().Kd)({source:"action",action_id:t.id,action_output_type:"pages"}),r={kind:l().FormulaContextValueKind.ContextValue,id:a,value:{type:"array",values:n.value.blockIds.map((e=>({type:"block",value:{table:w().iU,id:e,spaceId:i.spaceId}})))}};return{value:{stats:n.value.stats,values:[r]}}}};o(916054),o(749411);var se=()=>o(816512),le=()=>o(446866),ce=()=>o(696056),ue=()=>o(989478);const pe=(0,n().vU)({sendGmailNotification:{id:"automations.actions.sendGmailNotification",defaultMessage:"Send mail..."},sendGmailNotificationDescription:{id:"automations.actions.sendGmailNotificationDescription",defaultMessage:"Sends a notification to one or more people in Notion."}}),de=new Set(oe().Rz),me={type:"send_gmail_notification",invertible:void 0,hasSideEffects:!0,hasNewReversableEffect:!1,display:{icon:o(941954).w,name:pe.sendGmailNotification,description:pe.sendGmailNotificationDescription},isDisabledForContext:e=>{var t;const i=(null===(t=e.spaceModel)||void 0===t?void 0:t.getBotSettings())??{};return!(0,o(657120).hU)({spaceBotSettings:i,integrationId:o(235484).aG})},isAvailableForContext:e=>{const t=e.automation.getTriggerType();if(("canAddAction"===e.checkType||"canSaveAction"===e.checkType&&"button"!==t)&&!e.isSubscribed)return!1;const o=e.automationActions.filter((e=>e.isType("send_gmail_notification")));if(!("canAddAction"===e.checkType?o.length<1:o.length<=1))return!1;const n="event"===t||"notification_event"===t,a="button"===t,r=(0,i().AK)(e);return n||a||r},resolveExecutionDependencies:function*(e,t){var o,i,n;const a=[],r=t.getConfig(),s=null==r?void 0:r.external_bot_id;s&&a.push({type:"record_permission",pointer:{table:ce().cZ,id:s},minimumRole:"reader"});const l=[...(null==r||null===(o=r.to)||void 0===o||null===(o=o.value)||void 0===o?void 0:o.value)||[],...(null==r||null===(i=r.cc)||void 0===i||null===(i=i.value)||void 0===i?void 0:i.value)||[],...(null==r||null===(n=r.bcc)||void 0===n||null===(n=n.value)||void 0===n?void 0:n.value)||[]];return(0,d().lcG)(l).forEach((e=>a.push({type:"record_permission",pointer:{table:ue().KJ,id:e},minimumRole:"reader"}))),null!=r&&r.email_subject&&a.push(...yield*e.getFormulaContentsDependencies({minimumRole:"reader",value:r.email_subject})),null!=r&&r.email_body&&a.push(...yield*e.getFormulaContentsDependencies({minimumRole:"reader",value:r.email_body})),a},typecheck:(e,t)=>{var o,i,n,a,r,s;if(!e.isSubscribed)return{value:{validationFailures:[{type:"requires_subscription_upgrade",actionType:"send_gmail_notification",key:"subscription"}]}};const l=t.getConfig();if(!l||!l.external_bot_id)return{value:{validationFailures:[{type:"missing_required_config",actionType:"send_gmail_notification",key:"external_bot_id"}]}};const p=null==l?void 0:l.to;if(!p)return{value:{validationFailures:[{type:"missing_required_config",actionType:"send_gmail_notification",key:"to"}]}};if(!p.value||!p.value.value||0===(null===(o=p.value.value)||void 0===o?void 0:o.length))return{value:{validationFailures:[{type:"missing_required_config",actionType:"send_gmail_notification",key:"to"}]}};const m=(0,d().lcG)(p.value.value).map((t=>(0,se().Hl)({pointer:{table:ue().KJ,id:t},getRecordModel:e.getRecordModel}))),y=(0,le().CU)((0,d().Jcv)(p.value.value)).map((e=>({type:"email",value:e}))),g=(0,d().jyE)(p.value.value);if(m.every((e=>{var t;return(null===(t=e.asActor)||void 0===t?void 0:t.table)===ue().KJ&&e.asActor.getIsDeleted()}))&&0===(0,d().oOk)(p.value.value).length&&0===y.length&&0===g.length)return{value:{validationFailures:[{type:"invalid_required_config",actionType:"send_gmail_notification",key:"to"}]}};const h=e.getRecordModel({id:l.external_bot_id,table:ce().cZ});if(null==h||!h.alive)return{value:{validationFailures:[{type:"missing_required_config",actionType:"send_gmail_notification",key:"external_bot_id",shouldNotifyOnFailure:!0}]}};const _=parseInt(h.getLastEditedAt().toString());if(l.external_bot_id===(null===(i=l.auth_failure)||void 0===i?void 0:i.bot_id)&&null!==(n=l.auth_failure)&&void 0!==n&&n.should_reauthenticate&&_<((null===(a=l.auth_failure)||void 0===a?void 0:a.last_failure_time)??0))return{value:{validationFailures:[{type:"invalid_required_config",actionType:"send_gmail_notification",key:"external_bot_id"}]}};if(!l.email_subject||null===(r=l.email_subject)||void 0===r||!r.value||(0,d().PgY)(l.email_subject.value))return{value:{validationFailures:[{type:"missing_required_config",actionType:"send_gmail_notification",key:"email_subject"}]}};if(!l.email_body||null===(s=l.email_body)||void 0===s||!s.value||(0,d().PgY)(l.email_body.value))return{value:{validationFailures:[{type:"missing_required_config",actionType:"send_gmail_notification",key:"email_body"}]}};const x=[];let b;const S=e.checkExperimentGate("collections_xws")?"cross_space_and_read_permissions":"read_permissions_only",C={formulasModule:e.formulasModule,handleDataRequest:(0,c().lc)(e.getRecordModel),restrictUnaccessibleProperties:S,spaceId:e.automationModel.spaceId,valueTypes:e.valueTypes.slice(0),featureGates:(0,f().w)({checkExperimentGateFn:e.checkExperimentGate})};for(const[c,d]of[["email_subject",l.email_subject],["email_body",l.email_body]]){const{result:e,hasCrossSpaceError:t,stats:o}=(0,u().typecheckSimpleFormulaOrFormula)({context:C,value:d});t&&x.push({actionType:"send_gmail_notification",key:c,type:"invalid_formula_cross_space"}),b=(0,v().CL)(b,o),e.parseErrors&&e.parseErrors.length>0&&x.push({actionType:"send_gmail_notification",type:"invalid_formula_parse_error",key:c}),e.typeErrors&&e.typeErrors.length>0&&x.push({actionType:"send_gmail_notification",type:"invalid_formula_type_error",key:c,shouldNotifyOnFailure:!0}),e.type||x.push({actionType:"send_gmail_notification",type:"invalid_formula_missing_return_type",key:c})}return{value:{validationFailures:x,valueTypes:[],stats:{formulaStats:b}}}},execute:async(e,t)=>{var o,i,n,a,r,s,l,c;const{simpleFormulasModule:u}=e,p=null===(o=t.getConfig())||void 0===o?void 0:o.to,d=null===(i=t.getConfig())||void 0===i?void 0:i.cc,f=null===(n=t.getConfig())||void 0===n?void 0:n.bcc,v=null===(a=t.getConfig())||void 0===a?void 0:a.reply_to,y=null===(r=t.getConfig())||void 0===r?void 0:r.from_name,g=null===(s=t.getConfig())||void 0===s?void 0:s.email_subject,h=null===(l=t.getConfig())||void 0===l?void 0:l.email_body,_=null===(c=t.getConfig())||void 0===c?void 0:c.external_bot_id;if(!p||!p.value)return{error:new(m().Qq)({actionId:t.id,missingConfigKey:"to"})};if(!g)return{error:new(m().Qq)({actionId:t.id,missingConfigKey:"email_subject"})};if(!h)return{error:new(m().Qq)({actionId:t.id,missingConfigKey:"email_body"})};if(!_)return{error:new(m().Qq)({actionId:t.id,missingConfigKey:"external_bot_id"})};let x,b;try{const o=await fe(t,e,p,u,b);b=o.formulaStats;const i=await fe(t,e,d,u,b);b=i.formulaStats;const n=await fe(t,e,f,u,b);b=n.formulaStats;const a=await fe(t,e,v,u,b);b=a.formulaStats,x={to:o.value,cc:i.value,bcc:n.value,replyTo:a.value.at(0)}}catch(C){if(C instanceof m().fH)return{error:C};throw C}const S=await ye(t,e,h,u,b);if(b=S.formulaStats,0!==x.to.length){const o=y&&await ye(t,e,y,u,b),i=null==o?void 0:o.value;b=(null==o?void 0:o.formulaStats)??b;const n=await ye(t,e,g,u,b);b=n.formulaStats;const a=await e.executeEffectMap.sendGmailNotification({action:t,...x,fromName:i,subject:n.value,body:S.value,intl:e.intl,userTimeZone:e.userTimeZone});if(null!=a&&a.error)return a}else e.executeEffectMap.logMessage({data:{miscDataToConvertToString:{unresolvedOrEmptyTarget:p,actionId:t.id,spaceId:t.pointer.spaceId,automationId:e.automationModel.id}},from:"sendGmailNotification",level:"info",type:"sendGmailNotificationEmptyResolvedTargets"});return{value:{stats:{formulaStats:b,usersMentioned:new Set([...x.to,...x.cc,...x.bcc]).size},values:[]}}}};async function fe(e,t,o,i,n){if(null==o||!o.value)return{value:[],formulaStats:n};const{result:r,stats:l}=await i.executeSimpleFormulaAsyncWithStats({value:null==o?void 0:o.value,context:{...t,returnType:{type:"unknown"}},executeFormula:t.executeContextualFormula}),c=(0,v().CL)(n,l);if(a().x.isFail(r))throw new(m().x6)({actionId:e.id,cause:(0,s().rR)(r.error),stats:c});return{value:ve(r.value),formulaStats:c}}function ve(e){const t=[];switch(e.type){case"array":t.push(...e.values.flatMap(ve));break;case"person":e.value.table===ue().KJ&&(de.has(e.value.id)||t.push({type:"user",value:{table:ue().KJ,id:e.value.id}}));break;case"text":(0,le().CU)((0,d().QaF)(e.value)).forEach((e=>{(0,le().oH)(e)&&t.push({type:"email",value:e})}))}return t}async function ye(e,t,o,i,n){const{result:r,stats:l}=await i.executeSimpleFormulaAsyncWithStats({value:o,context:{...t,returnType:{type:"text"}},executeFormula:t.executeContextualFormula}),u=(0,v().CL)(n,l);if(a().x.isFail(r))throw new(m().x6)({actionId:e.id,cause:(0,s().rR)(r.error),stats:u});return{value:(0,c().j4)(r.value),formulaStats:u}}var ge=()=>o(226413);const he=(0,n().vU)({sendInAppNotification:{id:"automations.actions.sendInAppNotification",defaultMessage:"Send notification to..."},sendInAppNotificationDescription:{id:"automations.actions.sendInAppNotificationDescription",defaultMessage:"Sends a notification to one or more people in Notion."}}),_e={type:"send_in_app_notification",invertible:void 0,hasSideEffects:!0,hasNewReversableEffect:!1,display:{icon:o(394480).t,name:he.sendInAppNotification,description:he.sendInAppNotificationDescription},isAvailableForContext:e=>{let t=e.automation.getTriggerType();"notification_event"===t&&(t="event");if(!("event"===t||"button"===t||(0,i().AK)(e)))return!1;if("button"!==t&&!e.isSubscribed)return!1;const o=e.automationActions.filter((e=>e.isType("send_in_app_notification")));return"canAddAction"===e.checkType?o.length<1:o.length<=1},resolveExecutionDependencies:function*(e,t){var o;const i=[],n=t.getConfig(),a=null==n||null===(o=n.target)||void 0===o?void 0:o.type;if(!a)return[];if("property"===a){var s;const e=null==n||null===(s=n.target)||void 0===s?void 0:s.collectionPointer;e&&i.push({type:"record_permission",pointer:e,minimumRole:"reader"})}else if("formula"===a){var l;const e=null==n||null===(l=n.target)||void 0===l||null===(l=l.value)||void 0===l?void 0:l.value;(0,d().lcG)(e).forEach((e=>i.push({type:"record_permission",pointer:{table:ue().KJ,id:e},minimumRole:"reader"})))}else(0,r().t1)(a);return n.notification_message&&i.push(...yield*e.getFormulaContentsDependencies({minimumRole:"reader",value:n.notification_message})),i},typecheck:(e,t)=>{var o;const i=t.getConfig(),n=null==i?void 0:i.target;if(!i||!n)return{value:{validationFailures:[{type:"missing_required_config",actionType:"send_in_app_notification",key:"target",shouldNotifyOnFailure:!0}]}};if("property"===n.type){if(!n.propertyId)return{value:{validationFailures:[{type:"missing_required_config",actionType:"send_in_app_notification",key:"propertyId",shouldNotifyOnFailure:!0}]}};if(!n.collectionPointer)return{value:{validationFailures:[{type:"missing_required_config",actionType:"send_in_app_notification",key:"collectionPointer",shouldNotifyOnFailure:!0}]}};const t=e.getRecordModel({id:n.collectionPointer.id,table:E().vF}),o=null==t?void 0:t.getSchema()[n.propertyId];if(!o)return{value:{validationFailures:[{type:"deleted_required_config",actionType:"send_in_app_notification",key:"propertyId",shouldNotifyOnFailure:!0}]}};if(!(0,ge().U8)(o))return{value:{validationFailures:[{type:"invalid_required_config",actionType:"send_in_app_notification",key:"propertyId",shouldNotifyOnFailure:!0}]}}}else if("formula"===n.type){var a,r;const t=(0,d().lcG)(null===(a=n.value)||void 0===a?void 0:a.value).map((t=>(0,se().Hl)({pointer:{table:ue().KJ,id:t},getRecordModel:e.getRecordModel})));if(!n.value||!n.value.value||0===(null===(r=n.value.value)||void 0===r?void 0:r.length))return{value:{validationFailures:[{type:"missing_required_config",actionType:"send_in_app_notification",key:"formulaValue"}]}};if(t.every((e=>{var t;return(null===(t=e.asActor)||void 0===t?void 0:t.table)===ue().KJ&&e.asActor.getIsDeleted()}))&&0===(0,d().oOk)(n.value.value).length)return{value:{validationFailures:[{type:"invalid_required_config",actionType:"send_in_app_notification",key:"formulaValue"}]}}}if(!i.notification_message||null===(o=i.notification_message)||void 0===o||!o.value||(0,d().PgY)(i.notification_message.value))return{value:{validationFailures:[{type:"missing_required_config",actionType:"send_in_app_notification",key:"notification_message",shouldNotifyOnFailure:!0}]}};const s=[],l=e.checkExperimentGate("collections_xws")?"cross_space_and_read_permissions":"read_permissions_only",p={formulasModule:e.formulasModule,handleDataRequest:(0,c().lc)(e.getRecordModel),restrictUnaccessibleProperties:l,spaceId:e.automationModel.spaceId,valueTypes:e.valueTypes.slice(0),featureGates:(0,f().w)({checkExperimentGateFn:e.checkExperimentGate})},{result:m,hasCrossSpaceError:v,stats:y}=(0,u().typecheckSimpleFormulaOrFormula)({context:p,value:i.notification_message});return v&&s.push({actionType:"send_in_app_notification",key:"notification_message",type:"invalid_formula_cross_space"}),m.parseErrors&&m.parseErrors.length>0&&s.push({actionType:"send_in_app_notification",key:"notification_message",type:"invalid_formula_parse_error"}),m.typeErrors&&m.typeErrors.length>0&&s.push({actionType:"send_in_app_notification",key:"notification_message",type:"invalid_formula_type_error",shouldNotifyOnFailure:!0}),m.type||s.push({actionType:"send_in_app_notification",key:"notification_message",type:"invalid_formula_missing_return_type"}),{value:{validationFailures:s,valueTypes:[],stats:{formulaStats:y}}}},execute:async(e,t)=>{var i,n,l;const{simpleFormulasModule:u}=e,p=null===(i=t.getConfig())||void 0===i?void 0:i.target,f=null===(n=t.getConfig())||void 0===n?void 0:n.notification_message;if(!p||!f)return{error:new(m().Qq)({actionId:t.id,missingConfigKey:t.getConfig()?p?"notification_message":"target":"config"})};const y=new Set,g=null===(l=e.formulaVariableResolution)||void 0===l||null===(l=l.thisPageBlockModel)||void 0===l?void 0:l.pointer,h=null==g?void 0:g.id,_=p.type;let x;switch(_){case"formula":if(!p.value)return{error:new(m().Qq)({actionId:t.id,missingConfigKey:"target"})};const{result:i,stats:n}=await u.executeSimpleFormulaAsyncWithStats({value:p.value,context:{...e,returnType:{type:"person"}},executeFormula:e.executeContextualFormula});if(x=(0,v().CL)(x,n),a().x.isFail(i))return{error:new(m().x6)({actionId:t.id,cause:(0,s().rR)(i.error),stats:x})};const l=(0,c().j4)(i.value);(0,d().lcG)(l).forEach((e=>y.add(e)));break;case"property":const f=p.propertyId,g=p.collectionPointer;if(!f||!g)return{error:new(m().Qq)({actionId:t.id,missingConfigKey:f?"collectionPointer":"propertyId"})};const b=await e.loadRecordModel(g);if(!b||!h)return{error:new(m().mz)({actionId:t.id,propertyId:f,failedToResolve:{collectionId:g.id}})};{const i=await e.loadRecordModel({table:w().iU,id:h,spaceId:t.pointer.spaceId});if(!i)return{error:new(m().mz)({actionId:t.id,propertyId:f,failedToResolve:{blockId:h}})};const n=b.getNormalizedSchema()[f];if(!n||!(0,ge().U8)(n))return{error:new(m().mz)({actionId:t.id,propertyId:f,failedToResolve:{collectionId:g.id}})};const a="created_by"===n.type,r="last_edited_by"===n.type;if(a){const e=i.getCreatedByPointer();e&&e.table===ue().KJ&&y.add(e.id)}else if(r){const e=i.getLastEditedByPointer();e&&e.table===ue().KJ&&y.add(e.id)}else{const e=null==i?void 0:i.getProperties();if(!e)return{error:new(m().mz)({actionId:t.id,propertyId:f,failedToResolve:{blockId:i.id}})};{const t=e[f],a=(0,o(532850).DW)({textValue:t,propertySchema:n,blockCreatorPointer:i.getCreatedByPointer()});a.length>0&&a.map((e=>{y.add(e.id)}))}}}break;default:(0,r().t1)(_)}const{result:b,stats:S}=await u.executeSimpleFormulaAsyncWithStats({context:{...e,returnType:{type:"text"}},executeFormula:e.executeContextualFormula,value:f});if(x=(0,v().CL)(x,S),a().x.isFail(b))return{error:new(m().x6)({actionId:t.id,cause:b.error,stats:x})};if(0!==y.size){var C;const o=await e.executeEffectMap.sendInAppNotification({actionPointer:t.pointer,pagePointer:null===(C=e.formulaVariableResolution)||void 0===C||null===(C=C.thisPageBlockModel)||void 0===C?void 0:C.pointer,spaceId:t.pointer.spaceId,targets:Array.from(y),message:(0,c().j4)(b.value)});if(null!=o&&o.error)return o}else e.executeEffectMap.logMessage({data:{miscDataToConvertToString:{unresolvedOrEmptyTarget:p,actionId:t.id,spaceId:t.pointer.spaceId,automationId:e.automationModel.id}},from:"sendInAppNotification",level:"info",type:"sendInAppNotificationEmptyResolvedTargets"});return{value:{stats:{usersMentioned:y.size,formulaStats:x},values:[]}}}};var xe=()=>o(869963);const be=(0,n().vU)({httpRequest:{id:"automations.actions.httpRequest",defaultMessage:"Send webhook"},httpRequestDescription:{id:"automations.actions.httpRequestDescription",defaultMessage:"Calls a custom URL."}}),Se={type:"http_request",invertible:!1,hasSideEffects:!0,hasNewReversableEffect:!1,requiresPriorTransactionsCommitted:!0,display:{icon:e=>(0,o(742922).y)({transform:"scale(1.25)",...e}),name:be.httpRequest,description:be.httpRequestDescription},isAvailableForContext:e=>{const t=e.automation.getTriggerType();if(("canAddAction"===e.checkType||"canSaveAction"===e.checkType&&"button"!==t)&&!e.isSubscribed)return!1;const o=e.automationActions.filter((e=>e.isType("http_request")));return!!("canAddAction"===e.checkType?o.length<5:o.length<=5)&&("event"===t||"button"===t||(0,i().AK)(e))},isDisabledForContext:e=>{const t=e.spaceModel;if(!t)return!1;const o=t.getSettings();return!(!t.isEnterprisePlan()||!o.disallow_webhook_automation_action)},resolveExecutionDependencies:(e,t)=>_().R.return([]),typecheck:(e,t)=>{var o,i;if(!e.isSubscribed)return{value:{validationFailures:[{type:"requires_subscription_upgrade",actionType:"http_request",key:"subscription"}]}};const n=null===(o=t.getConfig())||void 0===o?void 0:o.url,a=[];(0,xe().lh)(n,{allowLocalhost:"local"===e.env})||a.push({type:"invalid_url",actionType:"http_request",key:"url"}),((null===(i=t.getConfig())||void 0===i||null===(i=i.customHeaders)||void 0===i?void 0:i.length)||0)>xe().Qb&&a.push({type:"too_many_custom_headers",actionType:"http_request",key:"customHeaders"});const r=new Set;for(const l of(null===(s=t.getConfig())||void 0===s?void 0:s.customHeaders)||[]){var s;l.key&&(0,xe().SJ)(l.key)&&!r.has(l.key.toLowerCase())||l.id&&a.push({type:"empty_custom_header_field",actionType:"http_request",key:["customHeaders",l.id,"key"]}),l.value&&(0,xe().lI)(l.value)||l.id&&a.push({type:"empty_custom_header_field",actionType:"http_request",key:["customHeaders",l.id,"value"]}),r.add(l.key.toLowerCase())}return a.length>0?{value:{validationFailures:a}}:{value:{valueTypes:[]}}},execute:async(e,t)=>{var o;const i=null===(o=e.formulaVariableResolution)||void 0===o?void 0:o.thisPageBlockModel,n=await e.executeEffectMap.sendHttpRequest({action:t,pagePointer:null==i?void 0:i.pointer,eventId:e.eventId});return n.error?n:{value:{values:[]}}}};const Ce=(0,n().vU)({slackNotification:{defaultMessage:"Send Slack notification toâ€¦",id:"automations.actions.slackNotification"},slackNotificationDescription:{defaultMessage:"Sends a Slack notification to a user or channel.",id:"automations.actions.slackNotificationDescription"}}),Fe={type:"slack_notification",invertible:void 0,hasSideEffects:!1,hasNewReversableEffect:!1,display:{icon:o(525372).P,name:Ce.slackNotification,description:Ce.slackNotificationDescription},isAvailableForContext:e=>{if("event"===e.contextType){const t=e.automationActions.filter((e=>e.isType("slack_notification")));return"canAddAction"===e.checkType?t.length<1:t.length<=1}return!!e.automation.isButtonType()||!!(0,i().AK)(e)},resolveExecutionDependencies:(e,t)=>{const o=t.getConfig();return null!=o&&o.external_bot_id?_().R.return([{minimumRole:"reader",pointer:{id:o.external_bot_id,table:ce().cZ},type:"record_permission"}]):_().R.return([])},typecheck:(e,t)=>{const o=t.getConfig();if(null==o||!o.external_bot_id)return{value:{validationFailures:[{type:"missing_required_config",actionType:"slack_notification",key:"external_bot_id"}]}};const i=e.getRecordModel({id:o.external_bot_id,table:ce().cZ});return i&&i.alive?o.target?{value:{valueTypes:[]}}:{value:{validationFailures:[{type:"missing_required_config",actionType:"slack_notification",key:"target"}]}}:{value:{validationFailures:[{type:"missing_required_value",actionType:"slack_notification",key:"external_bot_id",shouldNotifyOnFailure:!0}]}}},execute:async(e,t)=>{const o=await e.executeEffectMap.sendSlackNotification({action:t});return a().x.isFail(o)?o:{value:{values:[]}}}};var Te=()=>o(942275),Ie=()=>o(728670),ke=()=>o(334810);const Me=(0,n().vU)({updatePages:{id:"automations.actions.updatePages",defaultMessage:"Edit pages inâ€¦"},updatePagesDescription:{id:"automations.actions.updatePagesDescription",defaultMessage:"Edits the properties of specified pages in a database."}}),Pe=new Set(["button","event"]);async function we(e){const{pointer:t,context:o,actionId:i}=e,n=await o.loadRecordModel(t);if(!n)return{error:new(m().Do)({pointer:t,actionId:i})};const a=await(0,Te().Rd)({block:n,loadRecordModel:o.loadRecordModel});return a?{value:a.getSpaceShardedPointer()}:{error:new(m().Do)({pointer:t,actionId:i})}}function Ee(e){const{actionModels:t,contextValue:i}=e,{automationValueInfo:n,collectionPointer:a,actionModel:r}=(0,o(367026).w)({actionModels:t,id:i.id});return"action"!==n.source?{error:new(m().Hb)({source:"global",variable:i.value})}:r&&"create_page"===r.getType()&&a?{value:a}:{error:new(m().Hb)({actionId:n.action_id,source:"action",variable:i.value})}}const De={type:"update_pages",invertible:!0,hasSideEffects:!0,hasNewReversableEffect:!1,display:{icon:o(519454).R,name:Me.updatePages,description:Me.updatePagesDescription},isAvailableForContext:e=>{let t=e.automation.getTriggerType();"notification_event"===t&&(t="event");const o=(0,i().AK)(e);if("event"===t||o){if(!e.isSubscribed)return!1;const t=e.automationActions.filter((e=>{var t;return e.isType("update_pages")&&"collection"===(null===(t=e.getConfig())||void 0===t||null===(t=t.target)||void 0===t?void 0:t.type)}));return"canAddAction"===e.checkType?t.length<5:t.length<=5}return Pe.has(t)||o},resolveExecutionDependencies:function*(e,t){var o,i;const n=[],a=t.getConfig();if("collection"===(null==a||null===(o=a.target)||void 0===o?void 0:o.type)?n.push({type:"record_permission",pointer:null==a?void 0:a.target.collection,minimumRole:"content_only_editor"}):"variable"===(null==a||null===(i=a.target)||void 0===i?void 0:i.type)&&n.push(...e.getFormulaContextValueDependencies({minimumRole:"content_only_editor",targetId:a.target.id})),null!=a&&a.values)for(const r of Object.values(a.values))null!=r&&r.value&&n.push(...yield*e.getFormulaContentsDependencies({minimumRole:"reader",value:r.value}));return n},typecheck:(e,t)=>{var i,n;const s=t.getConfig();if(null==s||!s.target)return{value:{validationFailures:[{type:"missing_required_config",actionType:"update_pages",key:"target",shouldNotifyOnFailure:!0}]}};let l;if("collection"===s.target.type){const t=function(e,t){if(!(0,Ie().fh)(e.collection,t))return{error:[{actionType:"update_pages",key:"collection",type:"collection_in_trash",shouldNotifyOnFailure:!0}]};return{value:{collectionModel:t(e.collection)}}}(s.target,e.getRecordModel);if(a().x.isFail(t))return{value:{validationFailures:t.error}};const{value:{collectionModel:i}}=t;l=i;const n=null==i?void 0:i.getNormalizedSchema();if(s.target.filter&&i&&n){const t=function(e){const{filter:t,collectionModel:i,collectionSchema:n}=e,a=new Set;(0,o(520509).WU)({propertyIdSet:a,filter:t});let r=!1;return a.forEach((e=>{const t=null==n?void 0:n[e];if("relation"===(null==t?void 0:t.type))r=r||(0,ge().Qh)(i.pointer.spaceId,t);else if("rollup"===(null==t?void 0:t.type)&&t.relation_property){const e=null==n?void 0:n[t.relation_property];"relation"===(null==e?void 0:e.type)&&(r=r||(0,ge().Qh)(i.pointer.spaceId,e))}})),r}({filter:s.target.filter,collectionModel:i,collectionSchema:n});if(t&&e.checkExperimentGate("collections_xws"))return{value:{validationFailures:[{actionType:"update_pages",key:"filter",type:"cross_space_property_in_filter"}]}}}}else if("page"===s.target.type){const t=function(e,t){if(!(0,Ie().fh)(e.page,t))return{error:[{actionType:"update_pages",key:"block",type:"block_in_trash"}]};const o=t(e.page),i=null!=o&&o.isPageBlock()?(0,Te().J2)({block:o,getRecordModel:t}):void 0;return{value:{collectionModel:i}}}(s.target,e.getRecordModel);if(a().x.isFail(t))return{value:{validationFailures:t.error}};const{value:{collectionModel:o}}=t;l=o}else if("variable"===s.target.type){const t=function(e,t,o){const i=(0,c().vx)(t,e.id);if(!i)return{error:[{actionType:"update_pages",key:"target",type:"missing_target_variable",shouldNotifyOnFailure:!0}]};if("block"===i.type.type&&i.type.collection){return!(0,Ie().fh)(i.type.collection,o)?{error:[{actionType:"update_pages",key:"collection",type:"collection_in_trash",shouldNotifyOnFailure:!0}]}:{value:{collectionModel:o(i.type.collection)}}}if("array"===i.type.type&&"block"===i.type.of.type&&i.type.of.collection){return!(0,Ie().fh)(i.type.of.collection,o)?{error:[{actionType:"update_pages",key:"collection",type:"collection_in_trash",shouldNotifyOnFailure:!0}]}:{value:{collectionModel:o(i.type.of.collection)}}}return{error:[{actionType:"update_pages",key:"target",type:"missing_target_variable",shouldNotifyOnFailure:!0}]}}(s.target,e.valueTypes,e.getRecordModel);if(a().x.isFail(t))return{value:{validationFailures:t.error}};const{value:{collectionModel:o}}=t;l=o}else(0,r().t1)(s.target);if(!(0,r().$K)(null==s?void 0:s.properties))return{value:{validationFailures:[{type:"missing_required_config",actionType:"update_pages",key:"property",shouldNotifyOnFailure:!0}]}};const{validationFailures:u,formulaStats:p}=(0,ke().l)({collectionPointer:null===(i=l)||void 0===i?void 0:i.getSpaceShardedPointer(),collectionSchema:null===(n=l)||void 0===n?void 0:n.getNormalizedSchema(),config:s,context:e,actionType:"update_pages"});return{value:{valueTypes:[],validationFailures:u,stats:{formulaStats:p}}}},execute:async(e,t)=>{const i=performance.now();let n=i;const s=t.getConfig();if(null==s||!s.target)return{error:new(m().mK)({pointer:null==s?void 0:s.target,actionId:t.id})};let u,p,d,f=e.loadRecordModel;if("collection"===(null==s?void 0:s.target.type)){const o=await f(s.target.collection);if(!o)return{error:new(m().Do)({pointer:s.target.collection,actionId:t.id})};let i;for(const t of e.values){if(t.kind!==l().FormulaContextValueKind.ContextValue)continue;const e=(0,c().MY)(t.id);if("global"!==e.source)continue;if("current_user"!==e.global)continue;const o=t.value;"person"===o.type&&(o.value.table===ue().KJ&&(i=o.value))}const n=await e.executeEffectMap.queryCollection({actionId:t.id,collection:s.target.collection,userTimeZone:e.userTimeZone,currentUserPointer:i,filter:s.target.filter,limit:s.target.limit,sort:s.target.sort});if(a().x.isFail(n))return n;d=n.value.blockIds,u=o.getNormalizedSchema(),p=s.target.collection,n.value.recordMap&&(f=M().s85.tryUntilFound(f,M().s85.fromRecordMapWithRole(n.value.recordMap)))}else if("variable"===s.target.type){const o=(0,c().dh)(e.values,s.target.id);if(!o)return{error:new(m().L)({actionId:t.id,contextValueId:s.target.id})};if("block"===o.value.type){e.runtimeRecordPointerSet.add(o.value.value);let i=await we({pointer:o.value.value,context:e,actionId:t.id});if(a().x.isFail(i)){const t=Ee({actionModels:e.actionModels,contextValue:o});if(a().x.isFail(t))return i;i=t}d=[o.value.value.id],p=i.value;const n=await e.executeEffectMap.getCollectionSchema({actionId:t.id,pointer:p});if(a().x.isFail(n))return n;u=n.value.collectionSchema}else{if("array"!==o.value.type)return"undefined"===o.value.type?{value:{values:[]}}:{error:new(m().Hb)({actionId:t.id,source:"action",variable:o.value})};{if(0===o.value.values.length)return{value:{values:[]}};const i=o.value.values[0];if("block"!==i.type)return{error:new(m().Hb)({actionId:t.id,source:"action",variable:i})};e.runtimeRecordPointerSet.add(i.value);const n=await f(i.value),r=n?await(0,Te().Rd)({block:n,loadRecordModel:f}):void 0;if(!r)return{error:new(m().Do)({pointer:i.value,actionId:t.id})};const s=r.getSpaceShardedPointer();d=F().oA(o.value.values.map((e=>"block"===e.type?e.value.id:void 0)));const l=await e.executeEffectMap.getCollectionSchema({actionId:t.id,pointer:s});if(a().x.isFail(l))return l;u=l.value.collectionSchema,p=s}}}else if("page"===s.target.type){const o=s.target.page,i=await we({pointer:o,context:e,actionId:t.id});if(a().x.isFail(i))return i;d=[o.id],p=i.value;const n=await e.executeEffectMap.getCollectionSchema({actionId:t.id,pointer:p});if(a().x.isFail(n))return n;u=n.value.collectionSchema}else(0,r().t1)(s.target);const y={};v().Fv.aggregateActionStats(y,{pagesUpdated:d.length});const g=[],h=e.values.filter((e=>e.kind!==l().FormulaContextValueKind.ThisRow));for(const c of d){const d={table:w().iU,id:c,spaceId:p.spaceId},_=await f(d);if(!_)return{error:new(m().Do)({pointer:d,actionId:t.id})};const x=await e.makeGetRecordModelFn([_.pointer]);if(!(0,Ie().fh)(_.pointer,x))return{error:new(m().O3)({pointer:_.pointer,actionId:t.id})};const b=_.getProperties(),S=await(0,ke().g)({config:s,page:_,collectionPointer:p,collectionSchema:u,actionId:t.id,context:{...e,values:[...h,{kind:l().FormulaContextValueKind.ThisRow,value:{type:"block",value:_.pointer}}]},getCurrentPropertyValue:e=>null==b?void 0:b[e]});if(a().x.isFail(S))return S;if(g.push(...S.value.values),v().Fv.aggregateActionStats(y,S.value.stats),e.author&&g.push(P().op.update({pointer:{table:w().iU,id:c,spaceId:p.spaceId},path:[],args:{last_edited_time:Date.now(),last_edited_by_table:e.author.table,last_edited_by_id:e.author.id}})),(0,r().$K)(e.actionExecutionTimeoutMs)&&performance.now()-i>=e.actionExecutionTimeoutMs)return{error:new(m().gr)({actionId:t.id})};(0,r().$K)(e.actionExecutionMaxEventLoopBlockTimeMs)&&performance.now()-n>=e.actionExecutionMaxEventLoopBlockTimeMs&&(await(0,o(839002).AJ)(),n=performance.now())}if(g.length>0){const o=(s.properties??[]).map((e=>{var t;const o=null===(t=u)||void 0===t?void 0:t[e];if(o)return{id:e,type:o.type}})).filter(r().$K),i=await e.executeEffectMap.saveTransaction({actionId:t.id,info:{type:"update_pages",pageIds:d,collection:p,editedProperties:o},operations:g});if(a().x.isFail(i))return i;v().Fv.aggregateActionStats(y,{totalOperations:g.length})}return{value:{stats:y,values:[]}}}};const Ae={query_collection:te(re),create_page:te(o(21463).L),update_pages:te(De),open_page:te(ee),slack_notification:te(Fe),duplicate_blocks:te(z),modal_confirmation:te(J),complete_sprint:te(L),send_in_app_notification:te(_e),send_gmail_notification:te(me),assistant_basic:te(g),define_variables:te(W),http_request:te(Se),publish_site:te(ne)};function Re(e){return Ae[e]}function Ne(e){return(0,i().FP)(e).map((e=>Re(e)))}},207006:(e,t,o)=>{o.d(t,{w:()=>n});const i=["collections_xws"];function n(e){const{checkExperimentGateFn:t}=e;return i.reduce(((e,o)=>(e[o]=t(o),e)),{})}},869963:(e,t,o)=>{o.d(t,{Qb:()=>s,SJ:()=>d,Y6:()=>a,aB:()=>r,lI:()=>m,lh:()=>l});o(122556),o(582845),o(250570),o(533019),o(721473),o(788208),o(22624);var i=()=>o(608575),n=()=>o(994085);const a=2048,r=1e3,s=10;function l(e,t){if(!e)return!1;if(e.length>a)return!1;const o=i().parse(e);return!(!o||!o.host)&&(("http:"===o.protocol||"https:"===o.protocol)&&(!!(t.allowLocalhost||"localhost"!==o.hostname&&"127.0.0.1"!==o.hostname&&"0.0.0.0"!==o.hostname)&&(0,n().m)(e)))}const c=/^[\w-]+$/,u=/^[\w\s:;.,\\\/"'?!(){}[\]@<>=+*#$&|~^%-]+$/,p=new Set(["user-agent","content-type","host","content-length","accept-encoding","connection"]);function d(e){return e.length<=r&&!p.has(e.toLowerCase())&&c.test(e)}function m(e){return e.length<=r&&u.test(e)}},309968:(e,t,o)=>{o.d(t,{Hr:()=>u,Nq:()=>S,TW:()=>f,Vl:()=>s,ZH:()=>h,_V:()=>y,lg:()=>b,q6:()=>m,xL:()=>c});var i=()=>o(874459),n=()=>o(92960),a=()=>o(177634);const r=(0,o(788860).vU)({buttonAutomationCurrentUserDescription:{defaultMessage:"The user who clicked this button",id:"automations.contextValue.buttonAutomationCurrentUserDescription"},buttonAutomationCurrentUserName:{defaultMessage:"Whoever clicked",id:"automations.contextValue.buttonAutomationCurrentUserName"},buttonAutomationCurrentUserTooltip:{defaultMessage:"The person who clicked the button",id:"automations.contextValue.buttonAutomationCurrentUserTooltip"},buttonAutomationThisPageDescription:{defaultMessage:"The page containing this button",id:"automations.contextValue.buttonAutomationThisPageDescription"},buttonAutomationThisPageName:{defaultMessage:"This page",id:"automations.contextValue.buttonAutomationThisPageName"},buttonAutomationThisPageTooltip:{defaultMessage:"The page containing this button",id:"automations.contextValue.buttonAutomationThisPageTooltip"},eventAutomationCurrentUserDescription:{defaultMessage:"The user who made the edit that triggered this automation to run.",id:"automations.contextValue.eventAutomationCurrentUserDescription"},eventAutomationCurrentUserName:{defaultMessage:"Whoever triggered",id:"automations.contextValue.eventAutomationCurrentUserName"},eventAutomationCurrentUserTooltip:{defaultMessage:"The person whose action triggered this automation",id:"automations.contextValue.eventAutomationCurrentUserTooltip"},eventAutomationThisPageDescription:{defaultMessage:"The page that was edited to trigger this automation to run.",id:"automations.contextValue.eventAutomationThisPageDescription"},eventAutomationThisPageName:{defaultMessage:"Trigger page",id:"automations.contextValue.eventAutomationThisPageName"},eventAutomationThisPageTooltip:{defaultMessage:"The page that triggered this automation",id:"automations.contextValue.eventAutomationThisPageTooltip"},now:{id:"automations.triggers.now.label",defaultMessage:"Time triggered"},nowDescription:{id:"automations.triggers.now.description",defaultMessage:"The time when this automation begins to run."},nowTooltip:{id:"automations.triggers.now.tooltip",defaultMessage:"The time this automation was triggered"},pageCreator:{id:"automations.triggers.pageCreator.label",defaultMessage:"Page creator"},pageCreatorDescription:{id:"automations.triggers.pageCreator.description",defaultMessage:"The user who created the page that was edited to trigger this automation to run."},pageCreatorTooltip:{id:"automations.triggers.pageCreator.tooltip",defaultMessage:"Person who created page"},today:{id:"automations.triggers.today.label",defaultMessage:"Date triggered"},todayDescription:{id:"automations.triggers.today.description",defaultMessage:"The date when this automation begins to run."},todayTooltip:{id:"automations.triggers.today.tooltip",defaultMessage:"The date this automation was triggered"}});function s(){return(0,a().Kd)({source:"global",global:"button_page"})}function l(e,t,o){return{description:o,name:e,tooltip:t,compile:(i,a)=>({description:o?i.formatMessage(o):void 0,id:s(),kind:n().FormulaContextValueKind.ContextValue,name:i.formatMessage(e),tooltipName:i.formatMessage(t),type:{collection:a,type:"block"}}),evaluate:e=>({kind:n().FormulaContextValueKind.ContextValue,id:s(),value:{type:"block",value:e}})}}const c=l(r.buttonAutomationThisPageName,r.buttonAutomationThisPageTooltip,r.buttonAutomationThisPageDescription),u=l(r.eventAutomationThisPageName,r.eventAutomationThisPageTooltip,r.eventAutomationThisPageDescription);function p(){return(0,a().Kd)({source:"global",global:"current_user"})}function d(e,t,o){return{description:o,name:e,tooltip:t,compile:i=>({description:o?i.formatMessage(o):void 0,id:p(),kind:n().FormulaContextValueKind.ContextValue,name:i.formatMessage(e),tooltipName:i.formatMessage(t),type:{type:"person"}}),evaluate:e=>({id:p(),kind:n().FormulaContextValueKind.ContextValue,value:{type:"person",value:e}})}}const m=d(r.buttonAutomationCurrentUserName,r.buttonAutomationCurrentUserTooltip,r.buttonAutomationCurrentUserDescription),f=d(r.eventAutomationCurrentUserName,r.eventAutomationCurrentUserTooltip,r.eventAutomationCurrentUserDescription);function v(){return(0,a().Kd)({source:"global",global:"now"})}const y={description:r.nowDescription,name:r.now,tooltip:r.nowTooltip,compile(e){return{description:this.description?e.formatMessage(this.description):void 0,id:v(),kind:n().FormulaContextValueKind.ContextValue,name:e.formatMessage(this.name),tooltipName:this.tooltip?e.formatMessage(this.tooltip):void 0,type:{type:"date"}}},evaluate:e=>({id:v(),kind:n().FormulaContextValueKind.ContextValue,value:{type:"date",value:(0,i().CQ)(Date.now(),e)}})};function g(){return(0,a().Kd)({source:"global",global:"today"})}const h={description:r.todayDescription,name:r.today,tooltip:r.todayTooltip,compile(e){return{description:this.description?e.formatMessage(this.description):void 0,id:g(),kind:n().FormulaContextValueKind.ContextValue,name:e.formatMessage(this.name),tooltipName:this.tooltip?e.formatMessage(this.tooltip):void 0,type:{type:"date"}}},evaluate:e=>({id:g(),kind:n().FormulaContextValueKind.ContextValue,value:{type:"date",value:(0,i().hT)(Date.now(),e)}})};function _(){return(0,a().Kd)({source:"global",global:"page_creator"})}function x(e,t){return{description:r.pageCreatorDescription,name:e,tooltip:t,compile(o){return{description:this.description?o.formatMessage(this.description):void 0,id:_(),kind:n().FormulaContextValueKind.ContextValue,name:o.formatMessage(e),tooltipName:o.formatMessage(t),type:{type:"person"}}},evaluate:e=>({id:_(),kind:n().FormulaContextValueKind.ContextValue,value:{type:"person",value:e}})}}const b=x(r.pageCreator,r.pageCreatorTooltip),S=x(r.pageCreator,r.pageCreatorTooltip)},853031:(e,t,o)=>{o.r(t),o.d(t,{hasAccessDefaultFn:()=>h,hasAccessToCode:()=>S,hasAccessToProperty:()=>b,hasReadPermissionsAccess:()=>_,hasSameSpaceAccess:()=>x,testOnly:()=>C});o(122556),o(582845),o(250570),o(533019),o(721473),o(788208),o(22624),o(267602),o(653476);var i=()=>o(513670),n=()=>o(839002),a=()=>o(855741),r=()=>o(696459),s=()=>o(226413),l=()=>o(92960),c=()=>o(216316),u=()=>o(177634),p=()=>o(407589),d=()=>o(748627);function*m(e){const{collectionPointer:t,context:o,propertyId:i,propertySchema:n,visitedPointers:a,hasAccessFn:r}=e,s=(0,c().M)({...t,propertyId:i});if(a.has(s))return!0;a.add(s);const l=r({propertySchema:n,spaceId:o.spaceId});return"boolean"==typeof l?l:yield*l}function*f(e){var t,o;const{collectionPointer:n,depth:p,collectionSchema:m,context:f,propertyId:v,propertySchema:y,visitedPointers:h,hasAccessFn:_}=e;if("v2"!==y.version||p>l().FORMULA_MAX_DEPTH)return!1;const x=(0,c().M)({...n,propertyId:v});if(h.has(x))return!0;if(h.add(x),!(0,r().$K)(null===(t=y.formula2)||void 0===t?void 0:t.code))return!0;const b=(0,d().H)(null===(o=y.formula2)||void 0===o?void 0:o.code);if(a().x.isFail(b))return!1;const{spaceId:S}=f,C=(0,c().jm)({formulaTypecheckContextValues:[{kind:l().FormulaContextValueKind.ThisRow,type:{collection:n,type:"block"}}],node:b.value,spaceId:S}),F=(0,i().mN)(C,(e=>(0,c().M)(e)));if(0===F.length)return!0;const{getRecordModel:T}=yield{collectionBlockProperties:[{blockPointers:[],collectionPointer:n,property:v,schema:m}],recordPointers:F.filter((e=>(0,u().no)(e)))};for(const i of F)if((0,s().rv)(i)){const e=T(i);if(!(0,r().$K)(e))return!1;const t=i.propertyId,o=e.getSchema(),n=o[t];if(!n)continue;if((0,s().no)(n)||(0,s().AF)(n)){if(!(yield*g({collectionPointer:i,collectionSchema:o,context:f,depth:p+1,propertyId:t,propertySchema:n,visitedPointers:h,hasAccessFn:_})))return!1}else if((0,s().p_)(n)){if(!(yield*g({collectionPointer:i,collectionSchema:o,context:f,depth:p,propertyId:t,propertySchema:n,visitedPointers:h,hasAccessFn:_})))return!1}}else if(!(0,r().$K)(T(i)))return!1;return!0}function*v(e){const{collectionPointer:t,depth:o,collectionSchema:i,context:n,propertyId:a,propertySchema:r,visitedPointers:u,hasAccessFn:d}=e;if("v2"===r.version||o>l().FORMULA_MAX_DEPTH)return!1;const m=(0,c().M)({...t,propertyId:a});if(u.has(m))return!0;u.add(m);const f=(0,p().b$)(r.formula);if(0===f.length)return!0;for(const l of f){const e=i[l];if(e)if((0,s().no)(e)||(0,s().AF)(e)){if(!(yield*g({collectionPointer:t,depth:o+1,collectionSchema:i,context:n,propertyId:l,propertySchema:e,visitedPointers:u,hasAccessFn:d})))return!1}else if((0,s().p_)(e)){if(!(yield*g({collectionPointer:t,collectionSchema:i,context:n,depth:o,propertyId:l,propertySchema:e,visitedPointers:u,hasAccessFn:d})))return!1}}return!0}function*y(e){const{collectionPointer:t,depth:o,collectionSchema:i,context:n,propertyId:a,propertySchema:r,visitedPointers:u,hasAccessFn:p}=e;if(o>l().FORMULA_MAX_DEPTH)return!1;const d=(0,c().M)({...t,propertyId:a});if(u.has(d))return!0;if(u.add(d),!r.relation_property||!r.target_property)return!0;const m=i[r.relation_property];if(!m||"relation"!==m.type)return!0;const f=p({propertySchema:m,spaceId:n.spaceId});if(!("boolean"==typeof f?f:yield*f))return!1;const v=(0,s().j0)(m);if(!v)return!0;const{getRecordModel:y}=yield{recordPointers:[v]},h=y(v),_=null==h?void 0:h.getNormalizedSchema();if(r.target_property_type&&_){const e=_[r.target_property];if(e&&r.target_property_type===e.type){if((0,s().AF)(e))return yield*g({collectionPointer:v,collectionSchema:_,context:n,depth:o+1,propertyId:r.target_property,propertySchema:e,visitedPointers:u,hasAccessFn:p});if((0,s().p_)(e))return yield*g({collectionPointer:v,collectionSchema:_,context:n,depth:o,propertyId:r.target_property,propertySchema:e,visitedPointers:u,hasAccessFn:p})}}return!0}function*g(e){const{collectionPointer:t,depth:o,collectionSchema:i,context:n,propertyId:a,propertySchema:r,visitedPointers:l,hasAccessFn:c}=e;return(0,s().p_)(r)?yield*m({collectionPointer:t,context:n,propertyId:a,propertySchema:r,visitedPointers:l,hasAccessFn:c}):(0,s().AF)(r)?"v2"===r.version?yield*f({collectionPointer:t,depth:o,collectionSchema:i,context:n,propertyId:a,propertySchema:r,visitedPointers:l,hasAccessFn:c}):yield*v({collectionPointer:t,depth:o,collectionSchema:i,context:n,propertyId:a,propertySchema:r,visitedPointers:l,hasAccessFn:c}):!(0,s().no)(r)||(yield*y({collectionPointer:t,depth:o,collectionSchema:i,context:n,propertyId:a,propertySchema:r,visitedPointers:l,hasAccessFn:c}))}function*h(e){const{propertySchema:t,spaceId:o}=e,i=(0,s().j0)(t);if(!(0,r().$K)(i))return!0;const{getRecordModel:n}=yield{recordPointers:[i]},a=n(i);return(0,r().$K)(a)&&x({spaceId:o,propertySchema:t})}function*_(e){const{propertySchema:t}=e,o=(0,s().j0)(t);if(!(0,r().$K)(o))return!0;const{getRecordModel:i}=yield{recordPointers:[o]},n=i(o);return(0,r().$K)(n)}function x(e){const{propertySchema:t,spaceId:o}=e;return!(0,s().Qh)(o,t)}async function b(e){const{collectionPointer:t,collectionSchema:o,context:i,propertyId:a,hasAccessFn:r}=e,s=o[a];return!s||await async function(e){const{context:t}=e;try{const o=g(e);let i=o.next();for(;!i.done;){const e=t.handleDataRequest(i.value);i=o.next((0,n().tI)(e)?await e:e)}return i.value}catch(o){return!0}}({collectionPointer:t,depth:0,collectionSchema:o,context:i,propertyId:a,propertySchema:s,visitedPointers:new Set,hasAccessFn:r})}function S(e){const{context:t}=e;try{const o=function*(e){const{collectionPointer:t,depth:o,context:n,code:p,visitedPointers:m,hasAccessFn:f}=e,v=(0,d().H)(p);if(a().x.isFail(v))return!1;const{spaceId:y}=n,h=n.valueTypes.filter((e=>e.kind!==l().FormulaContextValueKind.ThisRow)),_=(0,c().jm)({formulaTypecheckContextValues:t?[...h,{kind:l().FormulaContextValueKind.ThisRow,type:{collection:t,type:"block"}}]:[],node:v.value,spaceId:y}),x=(0,i().mN)(_,(e=>(0,c().M)(e)));if(0===x.length)return!0;const{getRecordModel:b}=yield{collectionBlockProperties:[],recordPointers:x.filter((e=>(0,u().no)(e)))};for(const i of x)if((0,s().rv)(i)){const e=b(i);if(!(0,r().$K)(e))return!1;const t=i.propertyId,a=e.getSchema(),l=a[t];if(!l)continue;if((0,s().no)(l)||(0,s().AF)(l)){if(!(yield*g({collectionPointer:i,collectionSchema:a,context:n,depth:o+1,propertyId:t,propertySchema:l,visitedPointers:m,hasAccessFn:f})))return!1}else if((0,s().p_)(l)&&!(yield*g({collectionPointer:i,collectionSchema:a,context:n,depth:o,propertyId:t,propertySchema:l,visitedPointers:m,hasAccessFn:f})))return!1}else if(!(0,r().$K)(b(i)))return!1;return!0}(e);let n=o.next();for(;!n.done;){const e=t.handleDataRequest(n.value);n=o.next(e)}return n.value}catch(o){return!0}}const C={hasAccessDefaultFn:h,hasAccessToProperty:b,hasAccessToFormula1Property:v,hasAccessToFormula2Property:f,hasAccessToRelationProperty:m,hasAccessToRollupProperty:y}},907874:(e,t,o)=>{o.r(t),o.d(t,{analyzeSimpleFormulaOrFormulaSync:()=>s,executeSimpleFormulaAsyncWithStats:()=>m,filterTextValueToSimpleFormulaValueTokens:()=>h().hX,fromSimpleFormulaArrayValue:()=>h().A6,getDependenciesForSimpleFormula:()=>h().w9,getDependenciesForSimpleFormulaOrFormula:()=>h().fK,getReferencedContextValueIds:()=>h().UB,isAnnotationSimpleValueToken:()=>h().S3,setPropertyValueToFormulaReturnType:()=>h().H0,setPropertyValueToSimpleFormulaReturnType:()=>h().qW,simpleFormulaValueTypeToFormulaReturnType:()=>h().LX,simpleFormulaValueWithoutToken:()=>h().Ck,singleSimpleValueTokenToTextToken:()=>h().L4,toSimpleFormulaArrayValue:()=>h().iC,toSimpleFormulaSingleValue:()=>h().YD,typecheckSimpleFormulaOrFormula:()=>l});o(670560),o(122556),o(582845),o(250570),o(533019),o(721473),o(788208),o(22624);var i=()=>o(696459),n=()=>o(955620),a=()=>o(853031),r=()=>o(22183);function s(e){const{context:t,value:o}=e;if((0,i().$K)(o)&&(0,i().$K)(o.value)){if("simple"===o.type)return function(e,t){const o=[],i=[];for(const a of e){const e=(0,n().hDy)(a);if(!(0,n().IVR)(e))continue;const s=(0,r().analyzeFormulaSync)([a],t);o.push(...s.parseErrors??[]),i.push(...s.typeErrors??[])}return{type:{type:"text"},parseErrors:o,typeErrors:i}}(o.value,t);{const e=(0,r().analyzeFormulaSync)(o.value,t);return(0,i().$K)(e.type)?e:{parseErrors:e.parseErrors,type:{type:"unknown"},typeErrors:e.typeErrors}}}return{type:{type:"unknown"}}}function l(e){const{context:t,value:o,collectionPointer:i}=e,r=performance.now(),l=s({context:t,value:o}),c=Math.trunc(performance.now()-r),u=!(l.typeErrors&&0!==l.typeErrors.length||l.parseErrors&&0!==l.parseErrors.length),p=!!u&&function(e){let{context:t,value:o,collectionPointer:i}=e;if(!t.featureGates.collections_xws||!o.value)return!1;let r=!1;if("formula"===o.type){(0,a().hasAccessToCode)({collectionPointer:i,context:t,depth:0,code:o.value,visitedPointers:new Set,hasAccessFn:a().hasSameSpaceAccess})||(r=!0)}else if("simple"===o.type)for(const s of o.value){const e=(0,n().hDy)(s);if(!(0,n().IVR)(e))continue;(0,a().hasAccessToCode)({collectionPointer:i,context:t,depth:0,code:[s],visitedPointers:new Set,hasAccessFn:a().hasSameSpaceAccess})||(r=!0)}return r}({context:t,value:o,collectionPointer:i});return{result:l,hasCrossSpaceError:p,stats:{formulaTypecheckDurationMs:void 0,formulaTypecheckSuccess:void 0,formulaExecutionDurationMs:void 0,formulaExecutionSuccess:void 0,totalFormulas:void 0,simpleFormulaTypecheckDurationMs:void 0,simpleFormulaTypecheckSuccess:void 0,simpleFormulaExecutionDurationMs:void 0,simpleFormulaExecutionSuccess:void 0,totalSimpleFormulas:void 0,..."simple"===o.type?{simpleFormulaTypecheckDurationMs:c,simpleFormulaTypecheckSuccess:u,totalSimpleFormulas:1}:{formulaTypecheckDurationMs:c,formulaTypecheckSuccess:u,totalFormulas:1}}}}o(267602),o(653476),o(241792);var c=()=>o(855741),u=()=>o(532850),p=()=>o(177634);function d(e){return!("number"===e.type||"text"===e.type||"checkbox"===e.type)}async function m(e){const{context:t,value:o}=e,n=performance.now(),a=await f(e),r=Math.trunc(performance.now()-n),s=c().x.isSuccess(a);return"simple"===o.type?d(t.returnType)?{result:a,stats:{formulaTypecheckDurationMs:void 0,formulaTypecheckSuccess:void 0,formulaExecutionDurationMs:void 0,formulaExecutionSuccess:void 0,totalFormulas:void 0,simpleFormulaTypecheckDurationMs:void 0,simpleFormulaTypecheckSuccess:void 0,simpleFormulaExecutionDurationMs:r,simpleFormulaExecutionSuccess:s,totalSimpleFormulas:1}}:{result:a}:"formula"===o.type?{result:a,stats:{formulaTypecheckDurationMs:void 0,formulaTypecheckSuccess:void 0,formulaExecutionDurationMs:r,formulaExecutionSuccess:s,totalFormulas:1,simpleFormulaTypecheckDurationMs:void 0,simpleFormulaTypecheckSuccess:void 0,simpleFormulaExecutionDurationMs:void 0,simpleFormulaExecutionSuccess:void 0,totalSimpleFormulas:void 0}}:(0,i().t1)(o.type)}async function f(e){const{context:t,executeFormula:o,ignoreErrors:a,value:r}=e,{returnType:s}=t,l=r.value;if("simple"===r.type){let e=l;if(!d(s)&&g(e)){const i=await v({context:t,executeFormula:o,value:e});if(c().x.isFail(i))return a?{value:{type:"undefined"}}:i;e=i.value}if("number"===s.type){const t=u().VY(e);return(0,i().$K)(t)&&!isNaN(t)?{value:{type:"number",value:t}}:{value:{type:"undefined"}}}if("text"===s.type)return{value:{type:"text",value:e??[]}};if("checkbox"===s.type){return{value:{type:"checkbox",value:"true"===n().QaF(e)}}}return o(t,e)}return"formula"===r.type?o(t,l):(0,i().t1)(r.type)}async function v(e){const{context:t,executeFormula:o,ignoreErrors:a,value:r}=e;if(!(0,i().$K)(r))return{value:void 0};const s=[];let l=[];for(const i of r)if(l=n().hDy(i),n().sP4(l)){const e=await o(t,[i]);if(c().x.isFail(e)&&!a)return e;c().x.isSuccess(e)&&s.push(...y((0,p().j4)(e.value),l))}else if(n().jRb(l)){const e=await o(t,[i]);if(c().x.isFail(e)&&!a)return e;c().x.isSuccess(e)&&s.push(...y((0,p().j4)(e.value),l))}else s.push(i);return{value:s}}function y(e,t){if(0===n().VrM(e))return e;const o=t.filter((e=>n().inx(e)));return 0===o.length?e:n().Zxt(e.map((e=>{const t=n().hDy(e);return 0===t.length?n().V3y(n().WiV(e),o):n().V3y(n().WiV(e),n().wrb(t,o))})))}function g(e){if(!(0,i().$K)(e))return!1;let t;for(const o of e)if(t=n().hDy(o),0!==t.length&&n().IVR(t))return!0;return!1}var h=()=>o(610856)},394480:(e,t,o)=>{o.d(t,{t:()=>n});o(667294);var i=o(785893);const n=(0,o(827282).IU)("bell",{viewBox:"0 0 16 16",svg:(0,i.jsx)("path",{d:"M1.36914 11.7627C1.36914 12.3369 1.80664 12.7266 2.51074 12.7266H5.32031C5.38184 14.0322 6.44824 15.2285 8 15.2285C9.55176 15.2285 10.6182 14.0391 10.6797 12.7266H13.4893C14.2002 12.7266 14.6309 12.3369 14.6309 11.7627C14.6309 11.0381 13.9678 10.416 13.3457 9.81445C12.8672 9.34277 12.751 8.39941 12.6621 7.46289C12.5732 4.87207 11.8213 3.14258 10.0371 2.49316C9.77734 1.59082 9.01855 0.900391 8 0.900391C6.98145 0.900391 6.22266 1.59082 5.96289 2.49316C4.17871 3.14258 3.42676 4.87207 3.33789 7.46289C3.24902 8.39941 3.13965 9.34277 2.6543 9.81445C2.03906 10.416 1.36914 11.0381 1.36914 11.7627ZM3.00293 11.4756V11.3936C3.18066 11.1953 3.57715 10.833 3.91211 10.4434C4.38379 9.90332 4.60254 8.92578 4.6709 7.62695C4.75293 4.85156 5.60059 3.92871 6.70801 3.62793C6.87207 3.58691 6.96777 3.50488 6.98145 3.32031C7.01562 2.62305 7.39844 2.1582 8 2.1582C8.60156 2.1582 8.99121 2.62305 9.01855 3.32031C9.03223 3.50488 9.12793 3.58691 9.29883 3.62793C10.3994 3.92871 11.2539 4.85156 11.3291 7.62695C11.3975 8.92578 11.623 9.90332 12.0879 10.4434C12.4297 10.833 12.8125 11.1953 12.9834 11.3936V11.4756H3.00293ZM6.6123 12.7266H9.3877C9.33984 13.5811 8.7793 14.1348 8 14.1348C7.22754 14.1348 6.66699 13.5811 6.6123 12.7266Z"})})},742922:(e,t,o)=>{o.d(t,{y:()=>n});o(667294);var i=o(785893);const n=(0,o(827282).IU)("codeFile",{viewBox:"0 0 23 24",svg:(0,i.jsx)("path",{d:"M4.195 11.86c0-.266.078-.488.235-.665.156-.182.38-.3.672-.351.494-.089.849-.271 1.062-.547.214-.281.32-.73.32-1.344V6.961c0-1.115.263-1.938.79-2.469.525-.536 1.333-.804 2.421-.804.203 0 .375.023.516.07.177.057.31.146.398.265a.646.646 0 01.141.422c0 .339-.148.558-.445.657a1.14 1.14 0 01-.157.039l-.171.015c-.625.047-1.066.222-1.32.524-.256.302-.384.8-.384 1.492v2.414c0 .672-.182 1.198-.546 1.578-.36.38-.86.604-1.5.672-.032 0-.047.013-.047.039.005.02.02.034.047.04.64.062 1.14.283 1.5.663.364.38.546.906.546 1.578v2.414c0 .693.128 1.19.383 1.492.255.303.696.48 1.32.532.053 0 .1.002.141.008l.133.03c.333.09.5.308.5.657a.68.68 0 01-.14.43.816.816 0 01-.407.273 1.48 1.48 0 01-.437.063c-1.12 0-1.948-.266-2.485-.797-.531-.526-.797-1.352-.797-2.477V14.79c0-.614-.106-1.062-.32-1.344-.213-.28-.568-.463-1.062-.547-.292-.062-.516-.182-.672-.359-.157-.177-.235-.404-.235-.68zm15.602 0c0 .275-.078.502-.235.68-.156.176-.382.296-.68.358-.5.084-.856.266-1.07.547-.208.282-.312.73-.312 1.344v1.992c0 1.125-.266 1.95-.797 2.477-.531.531-1.36.797-2.484.797-.151 0-.297-.021-.438-.063a.757.757 0 01-.414-.265.715.715 0 01-.133-.438c0-.182.042-.328.125-.437a.674.674 0 01.383-.22l.117-.03c.047-.006.097-.008.149-.008.625-.052 1.065-.23 1.32-.532.255-.302.383-.799.383-1.492v-2.414c0-.672.182-1.208.547-1.61.364-.405.864-.616 1.5-.632.026-.005.039-.018.039-.039 0-.026-.013-.04-.04-.04-.635-.015-1.135-.226-1.5-.632-.364-.406-.546-.945-.546-1.617V7.172c0-.693-.128-1.193-.383-1.5-.255-.307-.695-.48-1.32-.516l-.18-.015a1.233 1.233 0 01-.148-.04c-.297-.109-.446-.328-.446-.656 0-.166.045-.307.133-.422a.777.777 0 01.414-.265c.14-.047.31-.07.508-.07 1.089 0 1.896.268 2.422.804.526.531.789 1.354.789 2.469v1.992c0 .615.107 1.06.32 1.336.214.276.568.461 1.063.555.297.052.523.169.68.351a.967.967 0 01.234.664z"})})},941954:(e,t,o)=>{o.d(t,{w:()=>n});o(667294);var i=o(785893);const n=(0,o(827282).IU)("gmailLogo",{viewBox:"52 42 88 66",svg:(0,i.jsxs)("g",{children:[(0,i.jsx)("path",{fill:"#4285f4",d:"M58 108h14V74L52 59v43c0 3.32 2.69 6 6 6"}),(0,i.jsx)("path",{fill:"#34a853",d:"M120 108h14c3.32 0 6-2.69 6-6V59l-20 15"}),(0,i.jsx)("path",{fill:"#fbbc04",d:"M120 48v26l20-15v-8c0-7.42-8.47-11.65-14.4-7.2"}),(0,i.jsx)("path",{fill:"#ea4335",d:"M72 74V48l24 18 24-18v26L96 92"}),(0,i.jsx)("path",{fill:"#c5221f",d:"M52 51v8l20 15V48l-5.6-4.2c-5.94-4.45-14.4-.22-14.4 7.2"})]})})},994085:(e,t,o)=>{o.d(t,{m:()=>l});o(492176),o(7961),o(398858),o(461318),o(33228);const i="://",n="www.",a=/.+\..+\..+/,r=/\.{2,}/,s=/.+\..+/;function l(e){const t=e.trim();if(0===t.length)return!1;if(-1===t.indexOf(".")&&-1===t.indexOf("localhost"))return!1;if("."===t.at(t.length-1)||-1!==t.indexOf(" "))return!1;let o,l=`${-1===t.indexOf(i)?"http://":""}${t}`;try{o=new URL(l)}catch(u){const e=-1===l.indexOf(n),[t,a]=l.split(i);l=`${t}${i}${e?"www.":""}${a}`;try{o=new URL(l)}catch(u){return!1}}const c=o.hostname;return!r.test(c)&&(!(t.includes(n)&&"localhost"!==c&&!a.test(c))&&!("localhost"!==c&&!s.test(c)))}}}]);