"use strict";(globalThis.webpackChunknotion_next=globalThis.webpackChunknotion_next||[]).push([[68101],{792931:(e,t,n)=>{n.r(t),n.d(t,{CoEditingTasksManager:()=>u});n(821057),n(670560),n(267602),n(228244);var o=()=>n(955620),r=()=>n(792409),i=()=>n(342792),s=()=>n(539410);async function a(e,t,o){const r=(0,i().ZP)(),s=new AbortController,a=[{id:(0,i().ZP)(),type:"autocorrect",text:o},{id:(0,i().ZP)(),type:"config",value:{type:"autocorrect"}}],c=await n(824462).callStreamApi({eventName:"runInferenceTranscript",environment:e,data:{traceId:r,spaceId:t,transcript:a,generateTitle:!1},abortSignal:s.signal,headers:(0,n(741633).Bb)({spaceId:t})});if("success"!==c.type)throw c.error;let u="";if(n(956898).H1.is(c.data))for await(const n of c.data){if("error"===n.type)throw new Error(`Failed to get inference ${n.errorCode}${n.message}`);"assistant"===n.type&&(u+=n.value)}return u}function c(e,t,r,i){n(269299).createAndCommit({userAction:"blockActionRegistry.autoCorrectAction",environment:e,canUndo:!0,perform:a=>{const c=(0,s().oG)(e,a,t),u=(0,n(695644).Mg)({mode:"word",before:r,after:[[i]],isIncompleteAfter:!1,insertCursor:!1,insertionAnnotation:[o().GKr.SuggestionInsertText,c.id],deletionAnnotation:[o().GKr.SuggestionRemoveText,c.id]});n(945287).Bj({environment:e,store:t.getBlockTitleStore(),value:u,transaction:a}),(0,n(126672).t)({blockStore:t,discussionId:c.id,transaction:a}),(0,s().vh)({environment:e,transaction:a,discussionStore:c})}})}class u{constructor(){this.requests=[],this.currentRequest=null,this.currentRequestCancelled=!1}addRequest(e){var t;e.blockStore.id===(null===(t=this.currentRequest)||void 0===t?void 0:t.blockStore.id)&&(this.currentRequestCancelled=!0),this.requests.some((t=>t.blockStore.id===e.blockStore.id))||(this.requests.push(e),this.triggerRun())}triggerRun(){this.currentRequest||this.run()}async run(){if(this.currentRequest)throw new Error("CoEditingTasksManager.run called while a request is already in progress");const e=this.requests.shift();if(e){this.currentRequest=e;try{if("blockImproveWriting"===e.type)await this.runBlockImproveWriting(e)}catch(t){!function(e,t){const o=n(680146).IE(t,{tags:{from:"coEditingTaskManager"}});n(799891).log({level:"error",from:"coEditingTaskManager",type:e,error:(0,r().Ui)(t),data:{},sentryEventId:o})}(e.type,t)}finally{this.currentRequest=null,this.currentRequestCancelled=!1}this.run()}}async runBlockImproveWriting(e){const{environment:t,blockStore:n}=e,r=n.getTitleValue(),i=await a(t,n.getSpaceId(),r);if(!i||this.currentRequestCancelled)return;const s=(0,o().QaF)(r);s===(0,o().QaF)(n.getTitleValue())&&s!==i&&c(t,n,r,i)}}},695644:(e,t,n)=>{n.d(t,{Mg:()=>d,Q$:()=>u,n9:()=>l});n(821057),n(670560),n(267602),n(653476),n(30005),n(241792);var o=n.n(n(467266)),r=n.n(n(205242)),i=()=>n(513670),s=()=>n(696459),a=()=>n(659278),c=()=>n(955620);let u=function(e){return e[e.removed=-1]="removed",e[e.added=1]="added",e[e.same=0]="same",e}({});function l(e,t){const n=new(r())({timeout:2,editCost:6}),o=n.main(t,e);return n.cleanupSemantic(o),o}function d(e){const{before:t,after:n,isIncompleteAfter:r,insertCursor:d}=e,f={count:0,encoding:{},decoding:{},annotationEncoding:{},annotationDecoding:{}},p=e=>{const t=f.encoding[e];if(t)return t;{const t=String.fromCharCode(f.count);return f.count++,f.encoding[e]=t,f.decoding[t]=e,t}},h=e=>{const t=o()(e),n=f.annotationEncoding[t];if(n)return n;{const n=String.fromCharCode(f.count);return f.count++,f.annotationEncoding[t]=n,f.annotationDecoding[n]=e,n}},g=t=>i().xH(c().lzi(t).map((t=>{let n=[];n="word"===e.mode?t[0].split(" ").map((e=>`${e} `)):a().p4(t[0]);const o=n.map(p);if(c().km_(t)){const e=c().hDy(t),n=c().I$B(e);n&&(o[0]=h({type:"mention",value:n}),e.forEach((e=>{c().ZAl(e)||c().kuv(e)||c().QVC(e)||(o.unshift(h({type:"start",value:e})),o.push(h({type:"end",value:e})))})))}else if(c().YrK(t)){const e=c().hDy(t),n=c().Ap(e);if(n){o[0]=h({type:"equation",value:n});for(const t of e)c().ZAl(t)||c().kuv(t)||c().QVC(t)||(o.unshift(h({type:"start",value:t})),o.push(h({type:"end",value:t})))}}else if(c().AJd(t)){c().hDy(t).forEach((e=>{o.unshift(h({type:"start",value:e})),o.push(h({type:"end",value:e}))}))}return o}))).join("");if(f.count>65535)throw new Error("This string has way too many different characters.");const y=l(g(n),g(t)),v=[];let m=[],q=0;const k=r?i().qr(y,(e=>0===e[0]||1===e[0])):0;let C=!1;const w=e.insertionAnnotation,I=e.deletionAnnotation;return y.forEach((e=>{let[t,n]=e;n.split("").forEach((e=>{if(f.decoding[e]){const n=f.decoding[e];t===u.added?v.push([n,[...m,w]]):t===u.removed&&(!r||q<=k)?v.push([n,[...m,I]]):(r&&d&&!C&&q===k+1&&(C=!0,v.push(["",[["tc"]]])),v.push([n,m]))}else{const n=f.annotationDecoding[e];if(t===u.added)if("mention"===n.type)v.push([c().qyI,[...m,w,n.value]]);else if("start"===n.type)m=[...m,n.value];else if("end"===n.type)m=m.filter((e=>!i().Xy(e,n.value)));else if("equation"===n.type){const e=c().xey(n.value),t=c().qZ6(e,[...m,w]);v.push(t)}else(0,s().t1)(n);else if(t===u.removed){if("mention"===n.type)v.push([c().qyI,[...m,I,n.value]]);else if("equation"===n.type){const e=c().xey(n.value),t=c().qZ6(e,[...m,I]);v.push(t)}}else if(t===u.same)if("mention"===n.type)v.push([c().qyI,[...m,n.value]]);else if("start"===n.type)m=[...m,n.value];else if("end"===n.type)m=m.filter((e=>!i().Xy(e,n.value)));else if("equation"===n.type){const e=c().xey(n.value),t=c().qZ6(e,m);v.push(t)}else(0,s().t1)(n)}})),r&&(q+=1)})),c().Zxt(v)}}}]);