"use strict";(globalThis.webpackChunknotion_next=globalThis.webpackChunknotion_next||[]).push([[57229],{365929:(e,t,o)=>{o.d(t,{aI:()=>r,wS:()=>i});var n=()=>o(589549);function r(){n().j.setState({visible:!0})}function i(){n().j.setState({visible:!1})}},589549:(e,t,o)=>{o.d(t,{j:()=>r});class n extends(()=>o(263184))().default{getInitialState(){return{visible:!1}}}const r=new n},432659:(e,t,o)=>{o.d(t,{jo:()=>L,l3:()=>N,Ex:()=>G});o(821057),o(670560),o(122556),o(582845),o(250570),o(533019),o(721473),o(788208),o(22624),o(241792);var n=()=>o(353329),r=()=>o(396136),i=()=>o(139978),l=()=>o(255933),a=()=>o(306164),c=()=>o(955620),s=()=>o(696459),p=()=>o(54512),d=()=>o(384667),m=()=>o(295274),u=()=>o(421654),f=()=>o(282662),v=()=>o(332542),h=()=>o(636340),S=()=>o(145284),g=()=>o(968377),w=()=>o(269299),_=()=>o(932753),y=()=>o(576808),T=()=>o(907005),I=()=>o(527278),C=()=>o(876822),k=()=>o(972776),b=()=>o(749826),V=()=>o(826955),P=()=>o(833186),B=()=>o(877727),x=()=>o(281236),M=()=>o(382474),R=()=>o(298032),A=(o(267602),o(653476),()=>o(917881)),F=()=>o(688745);function O(e){const{environment:t,transaction:o,collectionStore:r,template:i,targetCollectionStore:l,logger:a}=e,{value:c}=i,s=(0,R().rU)(e);if(!s)throw new Error(`relationPropertyPointer not created for ${i.templateId}`);if("property"!==s.type)throw new Error(`Instance pointer returned is not of property type: ${s.type}`);const p=new(k().Z)(t);p.setContext({type:"collectionPage",collectionStore:r});const{inverseRelationPropertyId:d}=A().n7({environment:t,transaction:o,intl:I().Z.getIntl(),collectionContextStore:p,collectionStore:r,property:s.id,targetCollectionStore:l,hasInverseRelation:!0,inverseName:void 0,propertyName:c.name,autoRelate:c.autoRelate,propertyLimit:1===c.limit?"1":"no_limit"});if(d){const e=function(e){let{environment:t,sourceCollectionStore:o,targetCollectionStore:r}=e;const i=(0,M().Hq)({environment:t,collectionStore:o}),l=(0,M().Hq)({environment:t,collectionStore:r});if(!i||!l)return;const a=(0,n().Js)(l).map((e=>x().globalWorkflowTemplates.fromId(e))).filter((e=>(0,n().yw)(e)));for(const n of a)if(n.relatedCollectionTemplateId===i.templateId)return n}({environment:t,sourceCollectionStore:r,targetCollectionStore:l});e&&(a.log(`Instantiating relation property template "${e.templateId}" because it is the inverse of "${i.templateId}".`),(0,F().cP)({transaction:o,collectionStore:l,templateId:e.templateId,instance:{type:"property",id:d,collectionId:l.id},logger:a}))}return s}var E=()=>o(737128);function N(e){var t;let{environment:o,transaction:n,template:r,parentStore:l,existingCollectionInfo:a,inMemoryRecordCache:s,selectedFeatureTemplateIds:f,collectionViewBlockType:v="collection_view_page",relationInfos:S,logger:g}=e;g.log(`Instantiating collection template "${r.templateId}".`);const{collectionStore:w,collectionViewBlockStore:A}=function(e){var t;let o,{environment:n,transaction:r,template:i,parentStore:l,existingCollectionInfo:a,collectionViewBlockType:s="collection_view_page",inMemoryRecordCache:p,logger:d}=e;if(!(0,x().isCollectionTemplateParentStore)(l))throw new Error(`Parent store is not a valid  collection template parent store ${l.table}`);if(a){const{collectionStore:e,collectionViewStore:t}=a;o=a.collectionViewBlockStore,t&&_().dp({collectionViewBlockStore:o,collectionViewStore:t,transaction:r}),e&&_().A9({collectionViewBlockStore:o,collectionStore:e,transaction:r})}else o=U({environment:n,transaction:r,parentStore:l,collectionViewBlockType:s,inMemoryRecordCache:p});const{name:m,icon:u,description:f}=i.value.targetCollection,v=_().rl({environment:n,collectionViewBlockStore:o,transaction:r,collectionValue:{name:(0,c().TPx)(m),icon:u,description:f,format:{workflow_template_id:i.templateId,item_name_config:i.value.targetCollection.itemName,item_name_config_v2:null===(t=i.value.targetCollection.format)||void 0===t?void 0:t.item_name_config_v2},schema:{title:{name:I().Z.formatMessage(T().Mg.namePropertyTitle),type:"title"}}}});if(!C().default.state.currentSpaceStore)throw new Error("No current space store");return{collectionStore:v,collectionViewBlockStore:o}}({environment:o,transaction:n,template:r,parentStore:l,existingCollectionInfo:a,collectionViewBlockType:v,inMemoryRecordCache:s,logger:g});(0,F().cP)({transaction:n,collectionStore:w,templateId:r.templateId,instance:{type:"collection",id:w.id},logger:g});const{allFeatureTemplates:N,nonRelationPropertyTemplates:G}=j({template:r,selectedFeatureTemplateIds:f}),L=[];for(const i of G){const e=(0,R().ao)({environment:o,transaction:n,collectionStore:w,template:i,logger:g,origin:"collection_creation"});"collection_view"===(null==e?void 0:e.type)&&L.push(e)}if(0===L.length)throw new Error("No collection view templates to create");const Q=V().Xr.createChildStore(A,{table:i().np,id:L[0].id});S&&function(e){let{environment:t,transaction:o,currentCollectionStore:n,relationInfos:r,logger:i}=e;for(const l of r){const{sourceCollectionStore:e,targetCollectionStore:r}=Z({currentCollectionStore:n,relationInfo:l});O({environment:t,transaction:o,origin:"collection_creation",collectionStore:e,targetCollectionStore:r,template:l.relationPropertyTemplate,logger:i})}}({environment:o,transaction:n,currentCollectionStore:w,relationInfos:S,logger:g});const z=(0,x().getPropertyTemplates)(N);return(0,E().U)({transaction:n,collectionStore:w,propertyTemplates:z}),(0,E().M)({transaction:n,collectionStore:w,propertyTemplates:z}),function(e){const{transaction:t,collectionStore:o,template:n,logger:r}=e,{format:i}=n.value.targetCollection;if("object"!=typeof(null==i?void 0:i.collection_default_template))return;const l=(0,M().CX)({collectionStore:o,sourceTemplateType:"block",dependencyMap:n.dependencyMap??{},sourcePrimitiveId:i.collection_default_template.template_page_id});l?u().FH({stores:[o],update:{collection_default_template:{template_page_id:l}},transaction:t}):r.warn("Unable to resolve collection default template, omitting it.")}({transaction:n,template:r,collectionStore:w,logger:g}),"tasks"===r.category&&"control"!==(0,B().D)()&&(0,P().maybeAddAppTemplateMetadataForTasks)({environment:o,collectionStore:w,collectionViewBlockStore:A,transaction:n}),function(e){let{transaction:t,collectionViewBlockStore:o}=e;const n=o.getFormat();("workflow_template_placeholder"===n.collection_view_sub_type||n.placeholder_workflow_template_id)&&u().FH({stores:[o],update:{placeholder_workflow_template_id:void 0,collection_view_sub_type:void 0},transaction:t})}({transaction:n,collectionViewBlockStore:A}),null!==(t=r.value.exampleRows)&&void 0!==t&&t.length&&b().default.checkGate({gateName:"packaging_m3.1"})&&function(e){let{environment:t,transaction:o,collectionStore:n,collectionViewStore:r,collectionViewBlockStore:i,exampleRows:l,dependencyMap:a}=e;const c=new(k().Z)(t);c.setContext({type:"collectionView",collectionViewBlockStore:i,collectionStore:n,collectionViewStore:r,pageVisitSourceOverride:void 0});const s=c.defaultPageTemplateStore.state,{inMemoryRecordCache:p}=i;for(const u of l){const{newStore:e}=d().IW({environment:t,collectionContextStore:c,groupsPointer:[],insertAtIndex:0,shouldCoerce:!0,transaction:o,from:{createBlock:"workflow_template"},inMemoryRecordCache:p}),r=W({collectionStore:n,dependencyMap:a,exampleRow:u});(0,y().b)({environment:t,store:e,properties:r.properties,transaction:o}),s&&m().ob({title:"template",environment:t,store:e,templateStore:s,isKeyboard:!1,isCreateIn:!1,transaction:o,inMemoryRecordCache:p,from:"collection_template_actions"});const i=e.getIconStore();u.icon&&i&&h().sO({store:i,value:u.icon,transaction:o})}}({environment:o,transaction:n,collectionStore:w,collectionViewStore:Q,collectionViewBlockStore:A,exampleRows:r.value.exampleRows,dependencyMap:r.dependencyMap??{}}),n.postSubmitCallbacks.push((e=>{e||p().W(o,{from:"workflow_template",type:A.getType()??"collection_view_page",creating_block_id:A.id,collection_view_block_id:A.id,collection_view_id:Q.id,collection_id:w.id,view_type:Q.getType()})})),{collectionStore:w,collectionViewStore:Q,collectionViewBlockStore:A}}async function G(e){const{environment:t,parentStore:o,title:n,onFinish:r}=e,{serverCommitResult:l,performResult:{collectionViewBlockStore:a}}=w().createAndCommit({userAction:"workflowTemplatesOnboardingModal.addEmptyDatabase",environment:t,canUndo:!0,perform:r=>{let l=e.collectionViewBlockStore;void 0===l&&(l=U({environment:t,transaction:r,parentStore:o,collectionViewBlockType:"collection_view_page",inMemoryRecordCache:o.inMemoryRecordCache}),p().W(t,{from:"workflow_template",type:"page",new_page_id:l.id,creating_block_id:l.id}));const a=_().rl({environment:t,collectionViewBlockStore:l,transaction:r,collectionValue:{name:n?(0,c().TPx)(n):void 0}}),s=h().ae({environment:t,table:i().np,inMemoryRecordCache:l.inMemoryRecordCache,value:{type:"table",parent_id:l.id,parent_table:l.table,space_id:l.getSpaceId(),format:{collection_pointer:a.pointer},alive:!0},transaction:r}),d=V().Xr.createChildStore(l,s.pointer);return f().R3({parentStore:l.getCollectionViewsStore(),appendStore:d,transaction:r}),{collectionViewBlockStore:l}}});await l,r&&r(a)}function W(e){let{exampleRow:t,dependencyMap:o,collectionStore:n}=e;const r={properties:{}};for(const[i,l]of Object.entries(t.properties))r.properties[(0,M().Zl)({collectionStore:n,sourceTemplateType:"property",dependencyMap:o,sourcePrimitiveId:i})]=l;return r}function U(e){let{environment:t,transaction:o,parentStore:n,collectionViewBlockType:r,inMemoryRecordCache:i}=e;const l=h().j4({environment:t,type:r,inMemoryRecordCache:i,transaction:o});return h().sW({store:l,transaction:o,data:{parent_id:n.id,parent_table:n.table,alive:!0}}),L({environment:t,spaceViewStore:C().default.state.currentSpaceViewStore,parentStore:n,collectionViewBlockStore:l,transaction:o,appendOrPrepend:"append"}),l}function L(e){let{environment:t,parentStore:o,collectionViewBlockStore:n,transaction:i,appendOrPrepend:c,spaceViewStore:p}=e;if(o.table===r().iU)v().jG({parentStore:o,childStore:n,transaction:i});else if(o.table===l().bx){if((null==p?void 0:p.getSpaceId())!==o.id)throw new Error(`spaceViewStore doesn't match parent with ID ${o.id}`);S().Hj({environment:t,spaceStore:o,spaceViewStore:p,pageStore:n,isPrivate:!0,transaction:i})}else o.table===a().e0?g().c0({teamStore:o,store:n,transaction:i,location:{type:c}}):(0,s().t1)(o)}function j(e){let{template:t,selectedFeatureTemplateIds:o}=e;if(o){const e=new Set((0,n().Js)(t));for(const n of o)if(!e.has(n))throw new Error(`Feature template ID ${n} is not part of collection template ${t.templateId}`)}const{templateItems:r}=t.value,i=(0,n().uC)(r,"required"),l=(0,n().uC)(r,"optionalDefaultOn"),a=new Set([...i,...o??l]),c=Array.from(a).map(x().globalWorkflowTemplates.featureFromId),s=[],p=[];for(const d of c)(0,n().yw)(d)?s.push(d):p.push(d);return{allFeatureTemplates:c,relationPropertyTemplates:s,nonRelationPropertyTemplates:p}}function Z(e){let{currentCollectionStore:t,relationInfo:o}=e;const{type:n,collectionStore:r}=o;return"source"===n?{sourceCollectionStore:r,targetCollectionStore:t}:"target"===n?{sourceCollectionStore:t,targetCollectionStore:r}:void(0,s().t1)(n)}},833186:(e,t,o)=>{o.r(t),o.d(t,{createCollectionTemplateFromModalState:()=>ee,createMinimalCollectionTemplateWithoutModal:()=>Y,createPlaceholderWorkflowTemplateBlock:()=>ie,getTemplateOnboardingVersion:()=>D,handleSelectTemplateFromOnboardingModal:()=>J,maybeAddAppTemplateMetadataForTasks:()=>ne,moveToNextOnboardingStep:()=>de,moveToPreviousOnboardingStep:()=>pe,onNavigateToPlaceholderWorkflowTemplateBlock:()=>le,openSelectedTemplateOnboardingModalForInAppFlows:()=>H,openTemplateOnboardingModal:()=>z,retryAiSetup:()=>ae,setFollowUpInputFocused:()=>ce,setPreviewCollectionViewTemplateId:()=>se,switchModalToTemplate:()=>X,toggleFeatureSelectionInPreview:()=>re});o(821057),o(267602),o(653476),o(470928),o(241792);var n=()=>o(506347),r=()=>o(926724),i=()=>o(353329),l=()=>o(156642),a=()=>o(956057),c=()=>o(255393),s=()=>o(955620),p=()=>o(625230),d=()=>o(513670),m=()=>o(855741),u=()=>o(696459),f=()=>o(384667),v=()=>o(421654),h=()=>o(528918),S=()=>o(636340),g=()=>o(47443),w=()=>o(102182),_=()=>o(269299),y=()=>o(576808),T=()=>o(594546),I=()=>o(614027),C=()=>o(527278),k=()=>o(803728),b=(o(159867),o(93383),o(228244),()=>o(680146)),V=()=>o(342792);o(492176),o(670560),o(7961);class P{constructor(){this.root=new B}append(e){if(this.root.isEmpty())this.root.addChild(e);else{const t=this.toNodes().at(-1);if(!t)throw new Error("Last node not found");t.addChild(e)}}toNodes(){return this.root.getSelectedPath()}toValues(){return this.toNodes().map((e=>e.value))}removeLast(){const e=this.toNodes().at(-1);if(!e)return;const t=e.value;return e.remove(),t}removeLastMatching(e){const t=this.toNodes().findLastIndex((t=>e(t.value)));if(-1===t)return[];const o=[];for(;this.toNodes().length>t;){const e=this.removeLast();void 0!==e&&o.push(e)}return o}}class B{constructor(){this.children=[],this.selectedChild=void 0}addChild(e){const t=new x(e,this);return this.children.push(t),this.selectedChild=t,t}getSelectedPath(){var e;return(null===(e=this.selectedChild)||void 0===e?void 0:e.toSelectedPath())??[]}isEmpty(){return 0===this.children.length}getChildren(){return this.children}setSelectedChild(e){if(!this.children.includes(e))throw new Error("Cannot select a node that is not a child");this.selectedChild=e}removeChild(e){const t=this.children.indexOf(e);-1!==t&&(this.children.splice(t,1),this.selectedChild===e&&(this.selectedChild=void 0))}}class x{constructor(e,t){this.value=void 0,this.children=[],this.selectedChild=void 0,this.parent=void 0,this.isRemoved=!1,this.value=e,this.parent=t}addChild(e){const t=new x(e,this);return this.children.push(t),this.selectedChild=t,t}toSelectedPath(){const e=[this];return this.selectedChild&&e.push(...this.selectedChild.toSelectedPath()),e}retry(e){if(this.isRemoved)throw new Error("Cannot retry on a removed node");this.parent.addChild(e)}select(e){if(this.isRemoved)throw new Error("Cannot select on a removed node");const t=this.parent.getChildren(),o=e(t.map((e=>e.value)),this.value);if(void 0===o)return!1;const n=t.find((e=>e.value===o));return n?this.parent.setSelectedChild(n):this.parent.addChild(o),!0}selectOrRetry(e){if(!this.select(e)){const t=e([],void 0);void 0!==t&&this.retry(t)}}remove(){if(this.children.length>0)throw new Error("Cannot remove a node that has children");if(this.isRemoved)throw new Error("Node is already removed");this.parent.removeChild(this),this.isRemoved=!0}getChildren(){return this.children}setSelectedChild(e){if(!this.children.includes(e))throw new Error("Cannot select a node that is not a child");this.selectedChild=e}removeChild(e){const t=this.children.indexOf(e);-1!==t&&(this.children.splice(t,1),this.selectedChild===e&&(this.selectedChild=void 0),e.isRemoved=!0)}}class M extends(()=>o(263184))().default{getInitialState(){return{isBusy:!1,transcriptTree:new P}}setPrompt(e){this.setState({...this.state,prompt:e})}}class R{constructor(e){var t;this.environment=void 0,this.generatedSetupCount=0,this.store=void 0,this.error=void 0,this.spaceId=void 0,this.eventBase=void 0,this.abortController=void 0,this.onSetupReady=void 0,this.setPrompt=e=>{this.store.setState({...this.store.state,prompt:e})},this.submitPrompt=async e=>{var t;const{from:n}=e,r="follow-up"===n,{isBusy:i,prompt:l}=this.store.state;if(i||!l)return!1;this.store.setState({...this.store.state,isBusy:!0}),null===(t=this.store.state.transcriptTree.toNodes().find((e=>"config"===e.value.type)))||void 0===t||t.selectOrRetry((e=>{const t=e.find((e=>"config"===e.type&&"setup-generator"===e.value.type));return t||{id:(0,V().ZP)(),type:"config",value:{type:"setup-generator"}}}));try{var a;const e=this.store.state.transcriptTree.toNodes().find((e=>"user"===e.value.type));if(e&&!r)e.selectOrRetry((e=>{const t=e.find((e=>"user"===e.type&&(0,s().Z$K)(l,e.value)));if(t)return t;{var o;const e=null===(o=this.environment.currentUser)||void 0===o?void 0:o.id;if(!e)throw new Error("Current user not found");return{id:(0,V().ZP)(),type:"user",value:l,userId:e}}}));else{var c;const e=null===(c=this.environment.currentUser)||void 0===c?void 0:c.id;if(!e)throw new Error("Current user not found");this.store.state.transcriptTree.append({id:(0,V().ZP)(),type:"user",value:l,userId:e})}const t=this.store.state.transcriptTree.toValues();if(!t.slice(t.findLastIndex((e=>"user"===e.type))+1).some((e=>"setup"===e.type))){const e=(0,V().ZP)(),n=new AbortController;this.abortController=n;let r=!1;try{const i=await(0,o(298721)._O)({environment:this.environment,abortSignal:n.signal,upsellFrom:"ai_limit_setup_generator",data:{traceId:e,generateTitle:!1,transcript:t,spaceId:this.spaceId},onResponse:e=>{"setup-operations"===e.type&&this.store.setState({...this.store.state,progress:e.progress}),"retry"!==e.type||r||(r=!0,w().oV({label:"This is taking a little longer than usual"}))}});if(this.abortController=void 0,this.store.setState({...this.store.state,progress:void 0,feedbackArgs:this.computeFeedbackArgs()}),!m().x.isSuccess(i))return b().rn(i.error,{from:"fullPageTranslationActions.generateAndApplyTranslationMapToPage",type:"error"}),this.onSetupReady({error:i.error}),!1;const l=function(e){const t=new Map;for(const o of e){const e="string"==typeof o.id?o.id:String(o.id),n=t.get(e);n&&"setup-operations"===n.type&&"setup-operations"===o.type?t.set(e,{...n,operations:[...n.operations,...o.operations]}):t.set(e,o)}return Array.from(t.values())}(i.value.filter((e=>"inference"!==e.type&&"final_inferences"!==e.type)));for(const e of l)this.store.state.transcriptTree.append(e)}finally{this.abortController=void 0}}const n=null===(a=this.store.state.transcriptTree.toValues().findLast((e=>"setup"===e.type)))||void 0===a?void 0:a.setup;if(!n)throw new Error("Missing setup step");return this.generatedSetupCount++,this.store.setState({...this.store.state,setup:n,prompt:void 0}),this.trackGeneratedSetup(n),this.onSetupReady({value:n}),!0}catch(p){return p instanceof Error&&"AbortError"===p.name||(b().rn(p,{from:"setupGenerator.submitPrompt",type:"error"}),this.onSetupReady({error:this.error})),!1}finally{this.store.setState({...this.store.state,isBusy:!1,feedbackArgs:this.computeFeedbackArgs()})}},this.stopGenerating=()=>{var e;null===(e=this.abortController)||void 0===e||e.abort()},this.discardLatestSetup=()=>{var e,t;const o=null===(e=this.store.state.transcriptTree.toValues().findLast((e=>"user"===e.type)))||void 0===e?void 0:e.value;if(!o)return;this.store.state.transcriptTree.removeLastMatching((e=>"user"===e.type));const n=null===(t=this.store.state.transcriptTree.toValues().findLast((e=>"setup"===e.type)))||void 0===t?void 0:t.setup;this.store.setState({...this.store.state,prompt:o,setup:n,feedbackArgs:this.computeFeedbackArgs()}),n&&this.onSetupReady({value:n}),(0,T().j)({environment:this.environment,event:{eventName:"setup_generator_try_again_clicked",eventProperties:this.eventBase}})};const{environment:n,spaceId:r,onSetupReady:i,initialPrompt:l,analyticsArgs:a}=e;this.environment=n,this.spaceId=r,this.eventBase={flow_id:a.workflowTemplatesFlowId??(0,V().ZP)(),origin:a.origin,has_selection_modal_search_query:a.hadSelectionModalSearchEntered},this.store=new M,this.store.state.transcriptTree.append({id:(0,V().ZP)(),type:"config",value:{type:"setup-generator"}});const c=null===(t=this.environment.currentUser)||void 0===t?void 0:t.id;if(!c)throw new Error("Current user not found");l&&(this.store.setState({...this.store.state,prompt:l}),this.store.state.transcriptTree.append({id:(0,V().ZP)(),type:"user",value:l,userId:c})),this.onSetupReady=i,(0,T().j)({environment:n,event:{eventName:"setup_generator_session_started",eventProperties:this.eventBase}})}computeFeedbackArgs(){const{setup:e}=this.store.state,t=null==e?void 0:e.metadata.setupId;if(t&&this.store.state.transcriptTree)return{spaceId:this.spaceId,traceId:t,transcript:this.store.state.transcriptTree.toValues()}}trackSessionStarted(){(0,T().j)({environment:this.environment,event:{eventName:"setup_generator_session_started",eventProperties:this.eventBase}})}trackSessionEnded(e){const{reason:t}=e;(0,T().j)({environment:this.environment,event:{eventName:"setup_generator_session_ended",eventProperties:{...this.eventBase,generated_setup_count:this.generatedSetupCount,reason:t}}})}trackGeneratedSetup(e){const{metadata:t}=e,{setupId:o,promptInfo:n}=t,r=e.allTemplates.filter((e=>(0,i().U2)(e,"collection"))).length,l=e.allTemplates.filter((e=>(0,i().U2)(e,"collection_view"))).length,a=e.allTemplates.filter((e=>(0,i().U2)(e,"property"))).length;(0,T().j)({environment:this.environment,event:{eventName:"setup_generator_generated_setup",eventProperties:{...this.eventBase,setup_id:o,prompt_type:"custom",collection_count:r,collection_view_count:l,property_count:a,total_duration_ms:e.metadata.timing.total,warning_count:e.metadata.warnings.length,error_count:e.metadata.errors.length,use_case:null==n?void 0:n.useCase,prompt_specificity:null==n?void 0:n.specificity,prompt_language:null==n?void 0:n.language}}})}}var A=()=>o(972776),F=()=>o(749826),O=()=>o(826955),E=()=>o(365929),N=()=>o(432659),G=()=>o(298032),W=()=>o(281236);function U(e){let{environment:t,parentStore:o,collectionTemplate:n}=e;if(!o.getSpaceId())throw new Error(`Space ID not found for ${o}`);const r=(0,i().Js)(n).map((e=>W().globalWorkflowTemplates.fromId(e))).filter((e=>(0,i().yw)(e))),l=[];for(const i of r){const{relatedCollectionTemplateId:e}=i,n=(0,W().getChildCollectionStoreByTemplateId)({environment:t,parentStore:o,collectionTemplateId:e});n&&l.push({type:"target",collectionStore:n,relationPropertyTemplate:i})}return l}var L=()=>o(877727),j=()=>o(382474),Z=()=>o(533808),Q=()=>o(184441);function z(e){let{template:t,parentStore:o,origin:n,version:r,existingCollectionInfo:i,relationInfos:l,navigateToOnFinish:a="created_collection",setupGenerator:c,flowId:s,onClose:p}=e;const d=t?(0,Z().BQ)({collectionTemplate:t,origin:n,flowId:s,parentStore:o}):(0,Z().W)({origin:n,flowId:s,parentStore:o});Q().default.setState({open:!0,isSaving:!1,currentStepIndex:0,version:r,existingCollectionInfo:i,relationInfos:l??[],navigateToOnFinish:a,setupGenerator:c,onClose:p,...d})}function D(e){if(!e.template)return"in_app_template_onboarding_full_with_discovery";const{includeTemplateSelectionStep:t,hasSetupGenerator:o}=e;return o?t?"in_app_template_onboarding_ai_with_discovery":"in_app_template_onboarding_ai":t?"in_app_template_onboarding_full_with_discovery":"in_app_template_onboarding_full"}const q=(0,o(788860).vU)({setupGenerationError:{id:"setupGenerator.error.failedToGenerateSetup",defaultMessage:"Sorry, something went wrong while completing this request. Please try again."}});function $(e){let{environment:t,parentStore:o,template:n,initialAiPrompt:r,analyticsArgs:l}=e;const a=o.getSpaceId(),s=(0,i().Wl)(n.templateId)&&void 0!==a?new R({environment:t,analyticsArgs:l,spaceId:a,initialPrompt:r,onSetupReady:e=>{const t=Q().default.state;if(!t.open)return;if(m().x.isFail(e)){if(e.error instanceof c().vU)return;return void w().oV({label:C().Z.formatMessage(q.setupGenerationError)})}const o=e.value;if(t.setupGenerator!==s)return;(0,W().appendToAiGeneratedTemplates)(o.allTemplates.filter((e=>e.isAiGenerated)));const n=o.allTemplates.find((e=>(0,i().U2)(e,"collection")));if(!n)throw new Error("No collection template found");X(n)}}):void 0;return s}function H(e){var t;let{template:o,environment:n,aiPrompt:r,...i}=e;const{parentStore:l,relationInfos:a,origin:c,flowId:s}=i,p=U({environment:n,parentStore:l,collectionTemplate:o}),m=$({environment:n,template:o,parentStore:l,initialAiPrompt:r,analyticsArgs:{origin:c,hadSelectionModalSearchEntered:((null===(t=i.collectionTemplatesSearchQuery)||void 0===t?void 0:t.length)??0)>0,workflowTemplatesFlowId:s}});z({...i,template:o,version:D({template:o,includeTemplateSelectionStep:!1,hasSetupGenerator:Boolean(m)}),relationInfos:d().mN([...a??[],...p],(e=>e.collectionStore.id)),setupGenerator:m})}function J(e){var t,o;let{template:n,environment:r,analyticsArgs:i}=e;const l=Q().default.state;if(!l.open)return;const{parentStore:a,relationInfos:c,origin:p,flowId:m}=l,u=U({environment:r,parentStore:a,collectionTemplate:n}),f=d().mN([...c??[],...u],(e=>e.collectionStore.id)),v=$({environment:r,template:n,parentStore:a,analyticsArgs:{origin:p,hadSelectionModalSearchEntered:((null===(t=l.collectionTemplatesSearchQuery)||void 0===t?void 0:t.length)??0)>0,workflowTemplatesFlowId:m},initialAiPrompt:l.collectionTemplatesSearchQuery?(0,s().TPx)(l.collectionTemplatesSearchQuery):void 0}),h=D({template:n,includeTemplateSelectionStep:!0,hasSetupGenerator:Boolean(v)}),S={...l,open:!0,isSaving:!1,currentStepIndex:(0,Z().J3)(l),version:h,relationInfos:f??[],setupGenerator:v,isFollowUpInputFocused:!1,...(0,Z().BQ)({collectionTemplate:n,origin:p,flowId:m,parentStore:a})};null!==(o=n.value.onboarding)&&void 0!==o&&o.isMinimal?ee({environment:r,modalState:S}):("suggested_template"===i.type&&(0,T().j)({environment:r,event:{eventName:"suggested_collection_template_clicked",eventProperties:{from_modal_template_picker:!0,selected_index:i.allOrderedTemplateIds.indexOf(n.templateId),collection_template_ids_shown:i.allOrderedTemplateIds,...(0,Z().px)({origin:p,parentStore:a,collectionTemplatesSearchQuery:l.collectionTemplatesSearchQuery,flowId:m,collectionTemplate:n})}}}),Q().default.setState(S))}function X(e){const t=Q().default.state;if(!t.open||!t.collectionTemplate)return;let o={...t,...(0,Z().BQ)({collectionTemplate:e,origin:t.origin,flowId:t.flowId,parentStore:t.parentStore}),isSaving:!1};if(t.collectionTemplate.templateId===e.templateId){const e=o.userCustomizations.featureTemplateSelections,n=t.userCustomizations.featureTemplateSelections,r=e.map((e=>{const t=n.find((t=>t.template.templateId===e.template.templateId));return"required"!==e.optionality&&t?{...e,selected:t.selected}:e}));o={...o,userCustomizations:{...o.userCustomizations,featureTemplateSelections:r}}}Q().default.setState(o)}function Y(e){let{environment:t,template:o,parentStore:n,existingCollectionInfo:r,relationInfos:i}=e;_().createAndCommit({userAction:"workflowTemplates.createMinimalCollectionTemplate",environment:t,canUndo:!0,perform:e=>{(0,N().l3)({environment:t,transaction:e,template:o,parentStore:n,existingCollectionInfo:r,inMemoryRecordCache:n.inMemoryRecordCache,relationInfos:i,logger:new(W().WorkflowTemplateLogger)})}})}function K(e){var t,o;let{environment:r,modalState:i,collectionViewBlockStore:l,collectionStore:a}=e;if(!a)return;const{collectionTemplate:c,existingCollectionInfo:s,userCustomizations:d,navigateToOnFinish:m}=i;!function(e){let{environment:t,collectionViewBlockStore:o,navigateTo:r,result:i}=e;const l=F().default.checkGate({gateName:"packaging_m3.1"});"created_collection"===r?g()._c({environment:t,store:o,visitType:I().vu.Link,pageVisitSource:n().tY.WorkflowTemplateOnboarding,callback:()=>{l?(0,E().aI)():(0,k().yM)(t,"collection_add_item_button_tooltip")}}):"skip"===r||(0,u().t1)(r);const a=Q().default.getState();!a.open&&a.isShowingLoadingState&&h().x();Q().default.close(i)}({environment:r,collectionViewBlockStore:l,navigateTo:m,result:{type:"accepted_template"}}),(0,T().j)({environment:r,event:{eventName:"workflow_template_onboarding_done",eventProperties:{record_titles_is_empty:d.recordTitles.map((e=>0===e.length)),selected_feature_template_ids:d.featureTemplateSelections.filter((e=>"required"!==e.optionality&&e.selected)).map((e=>e.template.templateId)),step:(0,Z().IA)(i),target_page_ids:[l.id],collection_ids:[a.id],existing_block_id:null==s||null===(t=s.collectionViewBlockStore)||void 0===t?void 0:t.id,...(0,Z().px)(i)}}}),p().j({name:"collection_created_from_workflow_template",args:{template_id:c.templateId,origin:i.origin,experiment_group:(0,L().D)({disableExposureLogging:!0})}}),null===(o=i.setupGenerator)||void 0===o||o.trackSessionEnded({reason:"instantiated"})}function ee(e){let{environment:t,modalState:o}=e;if(!o.collectionTemplate||o.isSaving)return;const{collectionTemplate:n,parentStore:r,existingCollectionInfo:i,relationInfos:l,userCustomizations:a}=o;Q().default.setState({...o,isSaving:!0});const{performResult:c}=_().createAndCommit({userAction:"WorkflowTemplatesOnboardingModal.getStarted",environment:t,canUndo:!0,perform:e=>{const{collectionStore:o,collectionViewStore:c,collectionViewBlockStore:s}=(0,N().l3)({environment:t,transaction:e,template:n,parentStore:r,existingCollectionInfo:i,inMemoryRecordCache:r.inMemoryRecordCache,selectedFeatureTemplateIds:(0,W().getSelectedFeatureTemplateIds)(a),relationInfos:l,logger:new(W().WorkflowTemplateLogger)});return function(e){let{environment:t,transaction:o,collectionStore:n,collectionViewStore:r,collectionViewBlockStore:i,recordTitles:l}=e;const a=new(A().Z)(t);a.setContext({type:"collectionView",collectionViewBlockStore:i,collectionStore:n,collectionViewStore:r,pageVisitSourceOverride:void 0});const c=l.filter((e=>e.length>0));for(const s of c)te({environment:t,transaction:o,collectionContextStore:a,title:s})}({environment:t,transaction:e,collectionStore:o,collectionViewStore:c,collectionViewBlockStore:s,recordTitles:a.recordTitles}),{collectionViewBlockStore:s,collectionStore:o}}});K({environment:t,modalState:o,collectionViewBlockStore:c.collectionViewBlockStore,collectionStore:c.collectionStore})}function te(e){let{environment:t,transaction:o,collectionContextStore:n,title:r}=e;const{newStore:i}=f().IW({environment:t,collectionContextStore:n,groupsPointer:[],insertAtIndex:0,shouldCoerce:!0,templateStore:n.defaultPageTemplateStore.state,transaction:o,from:{createBlock:"workflow_template"},inMemoryRecordCache:t.defaultRecordCache.inMemoryRecordCache}),l=[r];return(0,y().b)({environment:t,store:i,properties:{title:[l]},transaction:o}),i}const oe={assigneeProperty:"notion://tasks/assign_property",statusProperty:"notion://tasks/status_property",dueDateProperty:"notion://tasks/due_date_property"};function ne(e){let{environment:t,transaction:o,collectionStore:n,collectionViewBlockStore:i}=e;const l=r().Ym,c=r().NB,s=(0,j().Vc)({environment:t,collectionStore:n}),p={};for(const[r,a]of Object.entries(oe)){const e=s.find((e=>e.templateId.includes(r)));if(!e)return;p[a]=e.instancePointer.id}v().FH({stores:[n],update:{app_config_uri:l,app_uri_map:p},transaction:o}),v().FH({stores:[i],update:{app_id:a().Il(),app_config_uri:c,app_uri_map:{[l]:n.id,[c]:i.id}},transaction:o})}function re(e){var t;let{template:o,environment:n}=e;const r=Q().default.state;if(!r.open||!r.collectionTemplate)return;const l=(null===(t=r.userCustomizations.featureTemplateSelections.find((e=>e.template.templateId===o.templateId)))||void 0===t?void 0:t.selected)??!1;Q().default.setState({...r,userCustomizations:(0,Z().xo)({userCustomizations:r.userCustomizations,templateId:o.templateId})});var a;F().default.checkGate({gateName:"workflow_templates_settings_dev"})&&function(e){let{environment:t,template:o,isCurrentlySelected:n,collectionStore:r}=e;if(!r)return;(0,i().Zl)(o)&&(n?_().createAndCommit({userAction:"workflowTemplatesOnboardingPreview.removeFeatureTemplate",environment:t,perform:e=>{(0,G().OI)({environment:t,transaction:e,collectionStore:r,template:o})}}):_().createAndCommit({userAction:"workflowTemplatesOnboardingPreview.addFeatureTemplate",environment:t,canUndo:!0,perform:e=>{(0,G().rU)({environment:t,transaction:e,collectionStore:r,template:o,logger:new(W().WorkflowTemplateLogger),origin:"onboarding_preview"})}}))}({environment:n,template:o,isCurrentlySelected:l,collectionStore:null===(a=r.collectionViewBlockStore)||void 0===a?void 0:a.getCollectionStore()})}function ie(e){let{environment:t,transaction:o,parentStore:n,collectionTemplate:r}=e;const i=S().j4({environment:t,type:l().Ti.collectionViewPage,spaceId:n.getSpaceId(),format:{collection_view_sub_type:"workflow_template_placeholder",placeholder_workflow_template_id:r.templateId,page_icon:r.value.targetCollection.icon},properties:{title:(0,s().TPx)(r.value.targetCollection.name)},inMemoryRecordCache:n.inMemoryRecordCache,transaction:o});S().sW({store:i,data:{parent_id:n.id,parent_table:n.table,alive:!0},transaction:o});const a=O().G.createChildStore(n,i.pointer);return(0,N().jo)({environment:t,parentStore:n,collectionViewBlockStore:a,transaction:o,appendOrPrepend:"append"}),a}function le(e){let{environment:t,collectionTemplate:o,collectionViewBlockStore:r}=e;const i=r.getParentStore(),l=i&&(0,W().isCollectionTemplateParentStore)(i)?i:r;if(t.device.isMobile)return Y({environment:t,template:o,parentStore:l,existingCollectionInfo:{collectionViewBlockStore:r,collectionStore:void 0,collectionViewStore:void 0},relationInfos:[]}),g()._c({environment:t,store:r,visitType:I().vu.Link,pageVisitSource:n().tY.WorkflowTemplateOnboarding}),{didOpenOnboardingModal:!1};const a="placeholder_block",c=(0,Z().px)((0,Z().BQ)({collectionTemplate:o,origin:a,flowId:void 0,parentStore:l}));return(0,T().j)({environment:t,event:{eventName:"suggested_collection_template_clicked",eventProperties:{...c,from_modal_template_picker:!1,selected_index:0,collection_template_ids_shown:[o.templateId]}}}),H({environment:t,template:o,origin:a,parentStore:l,aiPrompt:void 0,flowId:c.flow_id,existingCollectionInfo:{collectionViewBlockStore:r,collectionStore:void 0,collectionViewStore:void 0}}),{didOpenOnboardingModal:!0}}function ae(){const e=Q().default.state;if(!e.open)return;const t=e.setupGenerator;t&&(t.discardLatestSetup(),void 0===t.store.state.setup&&pe())}function ce(e){const t=Q().default.state;t.open&&Q().default.setState({...t,isFollowUpInputFocused:e})}function se(e){Q().default.state.open&&Q().default.updatePreviewCollectionViewTemplateId(e)}function pe(){const e=Q().default.state;if(!e.open)return;const t=(0,Z().AQ)(e);t>=0&&Q().default.setState({...e,isFollowUpInputFocused:!1,currentStepIndex:t})}function de(){const e=Q().default.state;if(!e.open)return;const t=(0,Z().J3)(e);t>=0&&Q().default.setState({...e,isFollowUpInputFocused:!1,currentStepIndex:t})}},533808:(e,t,o)=>{o.d(t,{BQ:()=>m,W:()=>p,BL:()=>d,J3:()=>g,se:()=>I,AQ:()=>y,oL:()=>c,lq:()=>u,px:()=>f,IA:()=>S,vg:()=>h,Ds:()=>w,_u:()=>_,Zg:()=>v,xo:()=>C});o(821057),o(267602),o(653476),o(470928),o(241792);var n=()=>o(353329);const r={in_app_template_onboarding_full_with_discovery:["templateSelection","features","viewsSelection"],in_app_template_onboarding_full:["features","viewsSelection"],in_app_template_onboarding_ai_with_discovery:["templateSelection","setupGenerator","features","viewsSelection"],in_app_template_onboarding_ai:["setupGenerator","features","viewsSelection"],in_app_template_onboarding_minimal:["intro"],in_app_template_onboarding_minimal_with_discovery:["templateSelection","intro"]};var i=()=>o(342792),l=()=>o(696459),a=()=>o(281236);function c(e){var t;if(!e||!e.dependencyMap||"board"!==e.value.type)return;const o=null===(t=e.value.format)||void 0===t||null===(t=t.board_columns_by)||void 0===t?void 0:t.property;if(!o)return;const n=e.dependencyMap[`property:${o}`];return n?a().globalWorkflowTemplates.fromIdOfType({templateId:n,type:"property"}):void 0}const s=3;function p(e){let{origin:t,flowId:o,parentStore:n}=e;return{collectionTemplate:void 0,origin:t,flowId:o??(0,i().ZP)(),collectionTemplatesSearchQuery:void 0,parentStore:n}}function d(e){let{template:t}=e;return{recordTitles:new Array(s).fill(""),featureTemplateSelections:t.value.templateItems.map((e=>function(e,t){const o=a().globalWorkflowTemplates.fromId(e);if(!(0,n().Zl)(o))throw new Error(`Template ${e} in collection template is not a feature template`);if("required"===t)return{template:o,optionality:"required",selected:!0};if("optionalDefaultOn"===t)return{template:o,optionality:"optionalDefaultOn",selected:!0};if("optionalDefaultOff"===t)return{template:o,optionality:"optionalDefaultOff",selected:!1};(0,l().t1)(t)}(e.pointer,e.optionality)))}}function m(e){const{collectionTemplate:t,origin:o,flowId:n,parentStore:r}=e;return{collectionTemplate:t,userCustomizations:d({template:t}),previewCollectionViewTemplateId:void 0,origin:o,flowId:n??(0,i().ZP)(),parentStore:r,collectionTemplatesSearchQuery:void 0}}function u(e){if(!e.collectionTemplate)throw new Error("Collection template cannot be undefined");return{collectionTemplate:e.collectionTemplate,previewCollectionViewTemplateId:e.previewCollectionViewTemplateId,userCustomizations:e.userCustomizations,origin:e.origin,flowId:e.flowId,collectionTemplatesSearchQuery:e.collectionTemplatesSearchQuery,parentStore:e.parentStore}}function f(e){var t,o;return{origin:e.origin,has_selection_modal_search_query:((null===(t=e.collectionTemplatesSearchQuery)||void 0===t?void 0:t.length)??0)>0,flow_id:e.flowId,collection_template_id:null===(o=e.collectionTemplate)||void 0===o?void 0:o.templateId,destination_type:e.parentStore.table,destination_id:e.parentStore.id}}function v(e){return"property"===e.type&&"relation"!==e.value.type||"compound"===e.type}function h(e){const{version:t}=e;return r[t].filter((e=>"viewsSelection"!==e))}function S(e){const{currentStepIndex:t}=e;return h(e)[t]}function g(e){const{currentStepIndex:t,collectionTemplate:o}=e,n=h(e);for(let r=t+1;r<n.length;r++){const e=n[r];if(!(o&&T({step:e,template:o})))return r}return-1}function w(e){return g(e)>=0}function _(e){return y(e)>=0}function y(e){const{currentStepIndex:t,collectionTemplate:o}=e,n=h(e);for(let r=t-1;r>=0;r--){const e=n[r];if(!(o&&T({step:e,template:o})))return r}return-1}function T(e){let{step:t,template:o}=e;switch(t){case"viewsSelection":return I(o).length<=1;case"intro":case"setupGenerator":case"recordTitles":case"templateSelection":case"features":return!1;default:(0,l().t1)(t)}}function I(e){const t=(0,n().uC)(e.value.templateItems,"required"),o=(0,n().uC)(e.value.templateItems,"optionalDefaultOn");return a().globalWorkflowTemplates.allOfType({templateIds:[...t,...o],type:"collection_view"})}function C(e){let{userCustomizations:t,templateId:o}=e;const n=t.featureTemplateSelections,r=n.find((e=>e.template.templateId===o));if(!r||"required"===r.optionality)return t;const i={...r,selected:!r.selected};return{...t,featureTemplateSelections:n.map((e=>e.template.templateId===o?i:e))}}}}]);