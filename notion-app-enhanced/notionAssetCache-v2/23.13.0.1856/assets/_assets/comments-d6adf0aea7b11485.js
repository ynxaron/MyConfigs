(globalThis.webpackChunknotion_next=globalThis.webpackChunknotion_next||[]).push([[58324],{431150:(e,t,o)=>{"use strict";o.r(t),o.d(t,{Comment:()=>bt,CommentFileBlock:()=>Oo().Z,Discussion:()=>Gt,DiscussionIndicator:()=>eo().ZP,DiscussionInput:()=>yt().Z,DiscussionReactionBar:()=>Ye,MarginCommentsSection:()=>Do,NewDiscussionMenu:()=>Vo,PropertyDiscussionIndicator:()=>ro,ReactionBar:()=>$e,ReplyDiscussionMenu:()=>Ho,SuggestionContext:()=>Xt,discussionHelpers:()=>P(),discussionViewActions:()=>n,reactionActions:()=>De()});var n={};o.r(n),o.d(n,{isCommentUnread:()=>_t});o(267602),o(653476);var i=o(667294),s=()=>o(492788),r=()=>o(219727),a=()=>o(657320),l=()=>o(98642),c=()=>o(142735),d=()=>o(846550),u=()=>o(933868),m=()=>o(955620),p=()=>o(788860),g=()=>o(707513),h=()=>o(799454),f=()=>o(308186),x=()=>o(844085),v=()=>o(990966),y=()=>o(269299),b=()=>o(312578),S=()=>o(654133),C=()=>o(67961),j=()=>o(765513),k=()=>o(46335),w=()=>o(837416),_=()=>o(852465),L=()=>o(176691),M=()=>o(155350),R=()=>o(827282),B=o(785893);const D=(0,R().IU)("suggestionExtraSmall",{viewBox:"0 0 10 9",svg:(0,B.jsxs)("g",{children:[(0,B.jsx)("path",{d:"M5.175 4.745l-.906.339c-.07.027-.14.012-.205-.045-.064-.057-.08-.127-.048-.212l.342-.899L7.492.798l.814.813-3.131 3.134zm3.4-3.397L7.76.53l.359-.352A.617.617 0 018.48.005a.364.364 0 01.33.105l.14.14c.1.105.145.226.134.365a.596.596 0 01-.168.366l-.341.366z"}),(0,B.jsx)("path",{d:"M4.91 1.962L5.969.906H2.704c-.354 0-.66.072-.92.216-.26.14-.46.341-.601.601-.142.26-.212.566-.212.92v2.754c0 .354.074.66.222.92.148.26.345.461.591.605.249.141.524.212.827.212h.25v.694c0 .214.056.382.167.506a.603.603 0 00.465.184.84.84 0 00.383-.092c.125-.06.27-.16.434-.301l1.138-.991h1.846c.353 0 .66-.07.92-.212.26-.144.46-.345.6-.605a1.89 1.89 0 00.213-.92V2.643c0-.114-.007-.223-.022-.327l-.433.443-.601.602V5.32c0 .253-.064.442-.192.567-.125.126-.314.188-.567.188h-1.85a.757.757 0 00-.307.051.962.962 0 00-.256.192L3.743 7.349v-.926c0-.125-.031-.214-.093-.267a.372.372 0 00-.256-.082h-.608c-.251 0-.44-.062-.568-.188-.125-.125-.188-.314-.188-.567V2.72c0-.253.063-.442.188-.567.128-.128.317-.192.568-.192H4.91z"})]})});var I=()=>o(874210),T=()=>o(998901),A=()=>o(687647),Z=()=>o(197666),E=()=>o(826955),F=()=>o(388573),K=()=>o(547592),V=()=>o(444851),P=()=>o(19029);function U(e){return e.isFirstComment&&"comment_unfurl"!==e.discussionLocation&&!e.blockStore.isPost()}var H=()=>o(3391),N=()=>o(8208),O=(o(670560),()=>o(506347)),z=()=>o(156642),W=()=>o(989478),Y=()=>o(513670),$=()=>o(696459),X=()=>o(959137),J=()=>o(827973),q=()=>o(448419),G=()=>o(1910),Q=()=>o(198829),ee=()=>o(255577),te=()=>o(388284),oe=()=>o(508181),ne=()=>o(205228),ie=()=>o(247724),se=()=>o(352230),re=()=>o(239482),ae=()=>o(148126),le=()=>o(466970),ce=()=>o(688798),de=()=>o(688049),ue=()=>o(314379),me=()=>o(599631),pe=()=>o(953293),ge=()=>o(954593);const he=(0,R().IU)("reopen",{viewBox:"0 0 14 14",svg:(0,B.jsx)("path",{d:"M1.64844 7.88477C1.64844 10.791 3.98047 13.1289 6.88086 13.1289C9.78125 13.1289 12.1133 10.791 12.1133 7.88477C12.1133 7.53906 11.873 7.29297 11.5273 7.29297C11.1934 7.29297 10.9707 7.53906 10.9707 7.88477C10.9707 10.1582 9.14844 11.9805 6.88086 11.9805C4.61328 11.9805 2.79688 10.1582 2.79688 7.88477C2.79688 5.59961 4.60156 3.78906 6.86328 3.78906C7.25 3.78906 7.60742 3.81836 7.90625 3.88281L6.3125 5.46484C6.20703 5.57617 6.1543 5.69922 6.1543 5.85156C6.1543 6.17383 6.39453 6.41992 6.71094 6.41992C6.875 6.41992 7.00977 6.36719 7.10938 6.26172L9.51758 3.83594C9.64062 3.71289 9.69922 3.57227 9.69922 3.41406C9.69922 3.26172 9.63477 3.10938 9.51758 2.99219L7.10938 0.548828C7.00977 0.4375 6.875 0.378906 6.71094 0.378906C6.39453 0.378906 6.1543 0.636719 6.1543 0.953125C6.1543 1.10547 6.20703 1.24023 6.30664 1.3457L7.72461 2.74609C7.4668 2.69336 7.16797 2.66406 6.86328 2.66406C3.96875 2.66406 1.64844 4.98438 1.64844 7.88477Z"})}),fe=(0,R().IU)("resolve",{viewBox:"0 0 16 16",svg:(0,B.jsx)("path",{d:"M6.6123 14.2646C7.07715 14.2646 7.43945 14.0869 7.68555 13.7109L14.0566 3.96973C14.2344 3.69629 14.3096 3.44336 14.3096 3.2041C14.3096 2.56152 13.8311 2.09668 13.1748 2.09668C12.7236 2.09668 12.4434 2.26074 12.1699 2.69141L6.57812 11.5098L3.74121 7.98926C3.48828 7.68848 3.21484 7.55176 2.83203 7.55176C2.16895 7.55176 1.69043 8.02344 1.69043 8.66602C1.69043 8.95312 1.7793 9.20605 2.02539 9.48633L5.55273 13.7588C5.84668 14.1074 6.1748 14.2646 6.6123 14.2646Z"})});var xe=()=>o(733641),ve=()=>o(739479),ye=()=>o(876822),be=()=>o(7186),Se=()=>o(539410),Ce=(o(241792),o(228244),()=>o(659278)),je=()=>o(568017),ke=()=>o(762478),we=()=>o(628370),_e=()=>o(154186),Le=()=>o(754668),Me=()=>o(103908),Re=()=>o(150569),Be=()=>o(606757),De=()=>o(879077),Ie=()=>o(18748),Te=()=>o(539245),Ae=()=>o(718611),Ze=()=>o(981697),Ee=()=>o(472675);function Fe(e){let{reactionStores:t,initialIndex:o}=e;const[n,s]=i.useState(o),a=(0,p().YB)(),l=(0,r().O7)(),d=(0,c().VK)((()=>(0,Ae().e_)(l)),[l]),u=(0,c().VK)((()=>t.map(((e,t)=>{const o=e.getIcon();if(!o)return;const i="raw"!==d||Ce().xo.isCustomEmojiString(o);return(0,B.jsx)("span",{style:i&&t!==n?{opacity:.5}:{},children:(0,B.jsx)(Le().Z,{size:14,char:o})},o)})).filter($().$K)),[t,n,d]),m=(0,c().VK)((()=>t[n].getActorStores().map((e=>({id:e.id,store:e,name:e.getDisplayName(a)}))).filter($().$K)),[t,n,a]);return(0,B.jsxs)(Q().Z,{menuType:se().o.ActionSheet,children:[(0,B.jsx)(Te().Z,{tabStyle:{flex:1,justifyContent:"center",display:"flex",minWidth:60},tabs:u,selectedIndex:n,onChange:e=>s(e)}),m.map((e=>(0,B.jsx)(Ie().ZP,{title:e.name,dontShrinkIcon:!0,icon:(0,B.jsx)(Ee().S,{authorStore:e.store,avatarSize:20,avatarStyle:{width:20,height:20},placeholderStyle:{width:20,height:20}})},e.id)))]})}function Ke(e){const t=(0,r().Fy)(),o=(0,c().VK)((()=>E().bh.getUserVisibleReactions(e.store)),[e.store]),n=(0,i.useRef)(null),s=(0,Ze().Z)({onLongPress:()=>{var e;return null===(e=n.current)||void 0===e?void 0:e.setOpen(!0)}});if(!t.isMobile)return(0,B.jsx)(B.Fragment,{children:e.children});const a=o.findIndex((t=>!e.reactionStore||t===e.reactionStore))??0;return(0,B.jsx)(q().ZP,{ref:n,renderOrigin:()=>(0,B.jsx)("div",{...s,onTouchStart:e=>{e.stopPropagation(),s.onTouchStart()},onTouchMove:e=>{e.stopPropagation(),s.onTouchMove(e)},onTouchEnd:e=>{e.stopPropagation(),s.onTouchEnd()},onTouchCancel:e=>{e.stopPropagation(),s.onTouchCancel()},children:e.children}),popupType:t.isTablet?q().Z4.Popup:q().Z4.SlideUp,render:()=>(0,B.jsx)(Fe,{initialIndex:a,reactionStores:o})},e.store.id)}const Ve=(0,p().vU)({addReaction:{defaultMessage:"Add reaction",id:"ReactionBar.newReaction.ariaLabel"},resolveDiscussion:{defaultMessage:"Resolve",id:"ReactionBar.resolveDiscussion.ariaLabel"},emojiPickerTitle:{defaultMessage:"Reaction",id:"ReactionBar.emojiModalMenu.title"}});function Pe(){const{isMobile:e}=(0,r().Fy)();return(0,d().yK)((t=>({reaction:{display:"flex",margin:"1px",padding:"1px 6px 1px 6px",justifyContent:"center",alignItems:"center",gap:"4px",border:`1px solid ${t.regularDividerColor}`,borderRadius:"100px",fontSize:14,fontVariantNumeric:"tabular-nums",background:t.whiteButtonBackground,height:25},count:{color:t.mediumTextColor,fontSize:e?g().JB.UISmall.mobile:g().JB.UISmall.desktop},countReacted:{color:t.blueColor},reacted:{background:je().ZP.blueWithAlpha(.08),border:`1px solid ${t.filterPillBorder}`,fontWeight:500},reactedHover:{background:je().ZP.blueWithAlpha(.18)},emojiStyle:{color:"black",display:"flex"},reactionIcon:{width:18,height:18,fill:t.mediumIconColor,marginTop:-.5,marginRight:1},dropShadow:{boxShadow:t.marginDiscussionSelectedShadow}})),[e])}function Ue(e){let{store:t,disabled:o,onClick:n,dropShadow:i}=e;const s=(0,c().VK)((()=>t.getActors()),[t]),a=(0,c().VK)((()=>t.getIcon()),[t]),l=Pe(),{currentUser:d}=(0,r().O7)();if(!s||!a)return null;if(0===s.length)return null;const u=s.some((e=>e.id===d.id)),m={...l.reaction,...u&&l.reacted,...i&&l.dropShadow},p={...l.count,...u&&l.countReacted};return(0,B.jsx)(S().Z,{textWrap:!0,style:{maxWidth:250,width:"max-content"},placement:T().Placement.Bottom,delayThreshold:300,renderTooltip:()=>(0,B.jsx)(He,{store:t,icon:a}),render:e=>(0,B.jsxs)(_e().Z,{disabled:o,style:m,hoveredStyle:u?l.reactedHover:void 0,onClick:n,...e,children:[(0,B.jsx)("span",{style:l.emojiStyle,children:(0,B.jsx)(Le().Z,{size:14,char:a})}),(0,B.jsx)("span",{style:p,children:s.length})]})})}function He(e){let{store:t,icon:o}=e;const n=(0,p().YB)(),i=(0,c().VK)((()=>t.getActorStores()),[t]),s=(0,c().VK)((()=>i.map((e=>e.getDisplayName(n))).filter($().$K)),[i,n]),r=Ce().xo.isCustomEmojiString(o),a=(0,c().VK)((()=>{if(r){const e=Ce().xo.fromCustomEmojiString(o).pointer;return(0,Be().KX)({parentStore:void 0,pointer:e})}}),[o,r]),l=(0,c().VK)((()=>{if(null!=a&&a.isDefined())return null==a?void 0:a.getModel().getRenderTitle()}),[a]);return r?a?(0,B.jsx)(Me().Z,{type:"custom",customEmojiStore:a,text:(0,B.jsx)(Ne,{names:s,emojiNameOrIcon:(0,B.jsx)("span",{className:"notranslate",children:l}),isDeletedCustomEmoji:!1}),deletedText:(0,B.jsx)(Ne,{names:s,emojiNameOrIcon:(0,B.jsx)("span",{className:"notranslate",children:l}),isDeletedCustomEmoji:!0})}):null:(0,B.jsx)(Me().Z,{type:"unicode",emoji:o,text:(0,B.jsx)(Ne,{names:s,emojiNameOrIcon:(0,B.jsx)(Le().Z,{size:12,char:o}),isDeletedCustomEmoji:!1})})}function Ne(e){let{names:t,emojiNameOrIcon:o,isDeletedCustomEmoji:n}=e;const i=(0,d().yK)((e=>({text:{color:e.mediumInvertedTextColor}})),[]);return t.length>50?(0,B.jsx)(p()._H,{defaultMessage:"{additionalNames, plural, one {{names} and {additionalNames} other <medium>reacted with</medium> {icon}} other {{names} and {additionalNames} others <medium>reacted with</medium> {icon}}} {isDeletedCustomEmoji, select, true {<medium>(deleted)</medium>} other {}}",id:"ReactionBar.hoverTooltip.textAbbreviated",values:{additionalNames:t.length-50,names:t.slice(0,50).join(", "),medium:e=>(0,B.jsx)("span",{style:i.text,children:e}),icon:o,isDeletedCustomEmoji:n}}):(0,B.jsx)(p()._H,{defaultMessage:"{nameOrNames} <medium>reacted with</medium> {icon} {isDeletedCustomEmoji, select, true {<medium>(deleted)</medium>} other {}}",id:"ReactionBar.hoverTooltip.text",values:{numberOfNames:t.length,nameOrNames:t.join(", "),medium:e=>(0,B.jsx)("span",{style:i.text,children:e}),icon:o,isDeletedCustomEmoji:n}})}function Oe(e){const{store:t,discussionLocation:o,onEmojiSelection:n,style:s}=e,a=(0,r().O7)(),l=(0,i.useRef)(null),c=(0,r().Fy)(),u=(0,d().yK)((e=>({container:{padding:2,display:"flex",boxShadow:e.lightBoxShadow,backgroundColor:e.buttonGroupBackground,borderRadius:c.isMobile?3:4,...s},addIcon:{width:21,height:21,fill:e.icon.secondary},iconButton:{height:24,width:24,flex:"0 0 auto"}})),[c.isMobile,s]),m=(0,p().YB)();return(0,B.jsx)("div",{style:u.container,children:(0,B.jsx)(G().Z,{hasBackground:!0,ariaLabel:m.formatMessage(Ve.addReaction),showShadow:!1,icon:()=>(0,ge().V)(u.addIcon),style:u.iconButton,ref:l,onClick:()=>We(a,m,t,null==l?void 0:l.current,o,n)})})}function ze(e){let{store:t,discussionLocation:o,onEmojiSelection:n}=e;const s=(0,r().O7)(),a=(0,i.useRef)(null),l=Pe(),c=(0,p().YB)();return(0,B.jsx)(_e().Z,{style:{...l.reaction,minWidth:"2em"},ref:a,onClick:()=>We(s,c,t,null==a?void 0:a.current,o,n),children:(0,ge().V)(l.reactionIcon)})}function We(e,t,o,n,i,s){if(!(n instanceof Element))return;const r=n.getBoundingClientRect();ke().$(e,{originGap:4,originRect:r,popupWidth:Re().FZ,popupHeight:Re().kX,isSmallWidth:!1,title:t.formatMessage(Ve.emojiPickerTitle),currentTab:"emoji",tabs:[{type:"emoji",title:(0,B.jsx)(p()._H,{defaultMessage:"Emoji",id:"recordIcon.emojiTab.title"}),hideRandomButton:!0,onChange:(t,n)=>{s&&s(),y().createAndCommit({environment:e,userAction:"Comment.toggleReactionFromMenu",canUndo:!0,perform:s=>{De().toggleReaction({environment:e,transaction:s,store:o,icon:t,discussionLocation:i}),n&&n.keepVisible||ke().Z()}})}}]})}function Ye(e){const{parentStore:t,discussionLocation:o,onReact:n,focused:s}=e,[a,l]=(0,i.useState)(!1),u=(0,d().yK)((e=>({reactionIcon:{height:21,width:21,fill:e.mediumIconColor},resolveIcon:{height:16,width:16,fill:e.mediumIconColor},container:{gap:"4px",marginTop:"post_discussion"===o?0:12,paddingBottom:"post_discussion"===o?12:0,display:"flex",flexWrap:"wrap",willChange:"transform",transition:"transform 200ms ease",transformOrigin:"center left",transform:s?"scale3d(1.05)":"scale(1)"},reactionItem:{display:"flex",flexDirection:"row"},actionButton:{borderRadius:"50%",marginLeft:2}})),[s,o]),m=e=>{y().createAndCommit({userAction:"Discussion.handleResolve",environment:x,canUndo:!0,perform:e=>{(0,be().D)({environment:x,discussionStore:t,transaction:e,discussionLocation:o})}}),h().Xv(),null==e||e.stopPropagation()},g=(0,c().VK)((()=>t.canComment()),[t]),f=(0,c().VK)((()=>{var e;return t.canEdit()&&!(null!==(e=t.getParentStore())&&void 0!==e&&e.isPost())}),[t]),x=(0,r().O7)(),v=(0,i.useRef)(null),b=(0,p().YB)(),C=a||e.focused,j=(0,c().VK)((()=>E().bh.getUserVisibleReactions(t)),[t]),k=e=>()=>{e.isDefined()&&(null==n||n(),y().createAndCommit({environment:x,userAction:"Comment.toggleReaction",canUndo:!0,perform:n=>{De().toggleReaction({environment:x,transaction:n,store:t,icon:e.getIcon(),discussionLocation:o})}}))},w=()=>{We(x,b,t,null==v?void 0:v.current,o,n)};return(0,B.jsx)("div",{onMouseEnter:()=>l(!0),onMouseLeave:()=>l(!1),style:u.container,children:j.map(((o,n)=>(0,B.jsxs)("div",{style:u.reactionItem,children:[(0,B.jsx)(Ke,{reactionStore:o,store:t,children:(0,B.jsx)(Ue,{dropShadow:e.focused&&!e.disableShadow,disabled:!g,store:o,onClick:k(o)})}),n===j.length-1&&(0,B.jsxs)(we().Z,{animate:{opacity:C?1:0},style:{display:"flex",alignItems:"center",marginLeft:2},children:[g&&(0,B.jsx)(Ke,{store:t,children:(0,B.jsx)(S().Z,{renderTooltip:()=>(0,B.jsx)(p()._H,{...Ve.addReaction}),render:e=>(0,B.jsx)(G().Z,{style:u.actionButton,hasBackground:!1,showShadow:!1,ref:v,icon:()=>(0,ge().V)(u.reactionIcon),onClick:w,...e,ariaLabel:b.formatMessage(Ve.addReaction)})})}),f&&(0,B.jsx)(S().Z,{renderTooltip:()=>(0,B.jsx)(p()._H,{...Ve.resolveDiscussion}),render:e=>(0,B.jsx)(G().Z,{style:{borderRadius:"50%",marginLeft:4},hasBackground:!1,showShadow:!1,icon:()=>fe(u.resolveIcon),onClick:m,...e,ariaLabel:b.formatMessage(Ve.resolveDiscussion)})})]})]},o.id)))})}const $e=function(e){const{parentStore:t,discussionLocation:n,onReactionToggle:i,newReactionStyle:s}=e,a=(0,c().VK)((()=>t.canComment()),[t]),l=(0,c().VK)((()=>E().bh.getUserVisibleReactions(t)),[t]),d=(0,r().O7)(),u=(0,c().VK)((()=>{if(t.table===o(602299).x_){const e=t.getParentBlockStore();return Boolean(e&&e.pathIsDead())}if(t.table===o(542973).qF){const e=t.getParentStore();return Boolean(e&&e.pathIsDead())}return!1}),[t]),m=a&&!u&&l.length>0,p=a&&!u&&0===l.length;return(0,B.jsxs)("div",{style:{display:"flex",flexWrap:"wrap",gap:"4px"},children:[l.map((e=>(0,B.jsx)(Ke,{reactionStore:e,store:t,children:(0,B.jsx)(Ue,{disabled:!a||u,store:e,onClick:()=>{if(e.isDefined()){const o=y().createAndCommit({environment:d,userAction:"Comment.toggleReaction",canUndo:!0,perform:o=>De().toggleReaction({environment:d,transaction:o,store:t,icon:e.getIcon(),discussionLocation:n})});void 0!==o.performResult&&i&&i(o.performResult)}}})},e.id))),m&&(0,B.jsx)(Ke,{store:t,children:(0,B.jsx)(ze,{store:t,discussionLocation:n,onEmojiSelection:void 0!==i?()=>i("Added"):void 0})}),p&&(0,B.jsx)(Oe,{store:t,discussionLocation:n,onEmojiSelection:void 0!==i?()=>i("Added"):void 0,style:s})]})},Xe=(0,p().vU)({addReaction:{id:"comment.actions.addReaction.label",defaultMessage:"Add reaction"},acceptButton:{id:"comment.actions.acceptButton.label",defaultMessage:"Accept"},rejectButton:{id:"comment.actions.rejectButton.label",defaultMessage:"Reject"},moreActions:{id:"comment.actions.moreActions.label",defaultMessage:"More actions"},reopenButton:{id:"comment.actions.reopenButton.label",defaultMessage:"Re-open"},resolveButton:{id:"comment.actions.resolveButton.label",defaultMessage:"Resolve"}});function Je(e){const{discussionLocation:t,isFirstComment:o,blockStore:n}=e,s=(0,p().YB)(),l=(0,r().O7)(),d=l.device,m=(0,le().E)("mobile_use_bottom_sheet_popup_container"),g=(0,i.useRef)(null),f=(0,a().l)(),x=(0,c().VK)((()=>Boolean(e.discussionStore.getResolved())),[e.discussionStore]),v=(0,c().VK)((()=>e.store.isDefined()),[e.store]),b=(0,c().VK)((()=>{var e;return null===(e=ye().default.state.currentUserStore)||void 0===e?void 0:e.id}),[]),S=(0,c().VK)((()=>{const t=e.store.getCreatedById();return e.store.getCreatedByTable()===W().KJ&&b===t}),[b,e.store]),C=(0,c().VK)((()=>{var e;const t=null===(e=ye().default.state.currentSpaceStore)||void 0===e?void 0:e.getRole();return t&&u().zz(t)}),[]),j=(0,c().VK)((()=>n.getRole()),[n]),k=(0,c().VK)((()=>{var e;return null==f||null===(e=f.publicEditModeStore.state)||void 0===e?void 0:e.permission}),[null==f?void 0:f.publicEditModeStore]),{isFirstCommentOfSuggestionDiscussion:w,disableAccept:_}=(0,c().VK)((()=>{var t;const o="suggestion"===e.discussionStore.getType()&&e.discussionStore.getCommentPointers()[0].id===e.store.id,i=(null===(t=n.getNavigableBlockStore())||void 0===t?void 0:t.canEdit())??!1;return{isFirstCommentOfSuggestionDiscussion:o,disableAccept:o&&!i}}),[e.discussionStore,n,e.store]),L=(0,c().VK)((()=>n.pathIsDead()),[n]),M=(0,c().VK)((()=>U({isFirstComment:o,discussionLocation:t,blockStore:n})),[o,t,n]),R="comment_only"===j||"comment"===k;if(!v||!b)return null;const D=()=>{y().createAndCommit({userAction:"Comment.handleReopen",environment:l,canUndo:!0,perform:t=>{F().bh({environment:l,commentStore:e.store,discussionStore:e.discussionStore,transaction:t,discussionLocation:e.discussionLocation})}})},I=t=>{y().createAndCommit({userAction:"Comment.handleResolve",environment:l,canUndo:!0,perform:t=>{(0,be().D)({environment:l,commentStore:e.store,discussionStore:e.discussionStore,transaction:t,discussionLocation:e.discussionLocation})}}),h().Xv(),null==t||t.stopPropagation()},T=()=>{y().createAndCommit({userAction:"Suggestion.handleAccept",environment:l,canUndo:!0,perform:t=>{Se().Yo({action:"accept",environment:l,commentStore:e.store,discussionStore:e.discussionStore,transaction:t,discussionLocation:e.discussionLocation,currentPageStore:re().fM(e.discussionStore)})}}),h().Xv()},A=()=>{y().createAndCommit({userAction:"Suggestion.handleReject",environment:l,canUndo:!0,perform:t=>{Se().Yo({action:"reject",environment:l,commentStore:e.store,discussionStore:e.discussionStore,transaction:t,discussionLocation:e.discussionLocation,currentPageStore:re().fM(e.discussionStore)})}}),h().Xv()},Z=async()=>{var t,o;const n=e.store.getParentStore();if(!n||null==n||!n.isDefined())return null;let i=n.getParentStore();if(null===(t=i)||void 0===t||!t.isDefined())return null;var s;i.getType()===z().Ti.tableRow&&(i=null===(s=i)||void 0===s?void 0:s.getParentBlockStore());if(null===(o=i)||void 0===o||!o.isDefined())return null;const r=i.getModel().getRenderUrl({baseUrl:ne().default.domainBaseUrl,getRecordModel:e.store.getRecordModel,discussionId:n.id,pageVisitSource:O().tY.CopyLink}),a=await X().F.clipboardActions.load();a.copyString({environment:l,stringValue:r,copiedMessage:a.clipboardMessages.copiedLinkToClipboard})};if(!l.currentUser.isLoggedIn())return null;const E=j&&u().rz(j)||L;if(E)return null;const K=M&&!d.isMobile&&!R&&!E,V=[];d.isMobile&&!R&&!E&&e.isFirstComment&&(x?V.push("reopen"):V.push("resolve")),!w&&S&&V.push("edit"),o&&V.push("copyLink"),w||!S&&!C||V.push("delete");const P=V.length>0;return P||K||e.canShowReactions?(0,B.jsx)(q().ZP,{ref:g,popupType:d.isMobile?m?q().Z4.BottomSheet:q().Z4.SlideUp:q().Z4.Popup,bottomSheetInitialState:"half",buttonPopupStore:e.buttonPopupStore,placementToOrigin:q().pO.Right,stopClickPropagation:!0,renderOrigin:o=>(0,B.jsx)(Qe,{buttonConfig:{resolve:{visible:K&&!w,resolved:x,onResolve:I,onReopen:D},react:{visible:e.canShowReactions,onReact:()=>{var o;We(l,s,e.store,(null===(o=g.current)||void 0===o?void 0:o.getAnchor())??null,t,e.handleReaction)}},accept:{visible:w&&!_&&!x,onAccept:T},reject:{visible:w&&!x&&(!R||S),onReject:A},moreActions:{visible:P}},visible:e.visible,buttonPopupEvents:o,discussionLocation:e.discussionLocation,store:e.store}),render:t=>{let o;o=d.isMobile?m?{menuType:se().o.Modal,title:(0,B.jsx)(p()._H,{id:"comment.mobileCommentMenu.title",defaultMessage:"Comment"})}:{menuType:se().o.ActionSheet}:{menuType:se().o.Popup};const n=V.map((t=>"reopen"===t?{key:"reopen",render:e=>(0,B.jsx)(J().Z,{...e,icon:(0,ce().V)({height:16,width:16}),title:(0,B.jsx)(p()._H,{id:"comment.reopenDiscussion.button",defaultMessage:"Re-open discussion"})}),action:D}:"resolve"===t?{key:"resolve",render:e=>(0,B.jsx)(J().Z,{...e,icon:(0,xe().k)({height:16,width:16}),title:(0,B.jsx)(p()._H,{id:"comment.resolveDiscussion.button",defaultMessage:"Resolve comments"})}),action:()=>I()}:"edit"===t?{key:"edit",render:e=>(0,B.jsx)(J().Z,{...e,icon:(0,pe().R)({height:16,width:16}),title:(0,B.jsx)(p()._H,{id:"comment.editComment.button",defaultMessage:"Edit comment"})}),action:e.handleEditComment}:"delete"===t?{key:"delete",render:e=>(0,B.jsx)(J().Z,{...e,icon:(0,ve().y)({height:16,width:16}),title:(0,B.jsx)(p()._H,{id:"comment.deleteComment.button",defaultMessage:"Delete comment"})}),action:e.handleDeleteComment}:"copyLink"===t?{key:"copyLink",render:e=>(0,B.jsx)(J().Z,{...e,icon:(0,me().N)({height:16,width:16}),title:(0,B.jsx)(p()._H,{id:"comment.copyLinkToDiscussion.button",defaultMessage:"Copy link to discussion"})}),action:Z}:void(0,$().t1)(t)));return(0,B.jsx)("div",{className:ie().G6g,children:(0,B.jsxs)(Q().Z,{...o,children:[(0,B.jsx)(ee().Z,{type:ee().i.Vertical,initialFocus:void 0,onAccept:t.close,sections:Y().oA([n.length&&{key:0,render:e=>(0,B.jsx)(te().Z,{...e}),items:n}])}),!d.isMobile&&(0,B.jsx)(te().Z,{topBorder:!0,disableDesktopPadding:!1,children:(0,B.jsx)(oe().Z,{title:(0,B.jsx)(p()._H,{defaultMessage:"Learn about comments",id:"comments.learn"}),href:(0,ae().UY)("guides.comments"),analyticsFrom:"comments"})})]})})}}):null}function qe(e){return"accept"in e}function Ge(e){return"resolve"in e}function Qe(e){const{buttonPopupEvents:t,buttonConfig:o}=e,n=(0,r().O7)().device,i=(0,p().YB)(),s=(0,d().yK)((t=>({addIcon:{height:21,width:21,fill:t.mediumIconColor},container:{display:"flex",boxShadow:"0px 2px 12px 0px rgba(29, 27, 22, 0.06)",borderWidth:1,borderStyle:"solid",borderColor:t.stroke.secondary,position:"absolute",flexShrink:0,padding:"2px",backgroundColor:t.buttonGroupBackground,right:0,...n.isMobile?{borderRadius:6,top:-3}:{marginRight:0,marginTop:"updates_sidebar"===e.discussionLocation?6:0,opacity:e.visible?1:0,gap:1,borderRadius:6,transition:"opacity 100ms ease-out",zIndex:1,top:-4}}})),[n.isMobile,e.discussionLocation,e.visible]);return(0,B.jsxs)("div",{style:s.container,children:[qe(o)&&o.accept.visible&&(0,B.jsx)(S().Z,{renderTooltip:()=>(0,B.jsx)(p()._H,{...Xe.acceptButton}),render:e=>(0,B.jsx)(G().Z,{hasBackground:!1,showShadow:!1,icon:fe,onClick:o.accept.onAccept,ariaLabel:i.formatMessage(Xe.acceptButton),...e})}),qe(o)&&o.reject.visible&&(0,B.jsx)(S().Z,{renderTooltip:()=>(0,B.jsx)(p()._H,{...Xe.rejectButton}),render:e=>(0,B.jsx)(G().Z,{hasBackground:!1,showShadow:!1,icon:de().D,onClick:o.reject.onReject,iconStyle:{height:18,width:18},ariaLabel:i.formatMessage(Xe.rejectButton),...e})}),o.react.visible&&(0,B.jsx)(S().Z,{renderTooltip:()=>(0,B.jsx)(p()._H,{...Xe.addReaction}),render:e=>(0,B.jsx)(G().Z,{ariaLabel:i.formatMessage(Xe.addReaction),hasBackground:!1,showShadow:!1,icon:()=>(0,ge().V)(s.addIcon),onClick:o.react.onReact,...e})}),Ge(o)&&o.resolve.visible&&(0,B.jsx)(S().Z,{renderTooltip:()=>(0,B.jsx)(p()._H,{...o.resolve.resolved?Xe.reopenButton:Xe.resolveButton}),render:e=>(0,B.jsx)(G().Z,{hasBackground:!1,showShadow:!1,icon:o.resolve.resolved?he:fe,onClick:o.resolve.resolved?o.resolve.onReopen:o.resolve.onResolve,...e,ariaLabel:i.formatMessage(o.resolve.resolved?Xe.reopenButton:Xe.resolveButton)})}),o.moreActions.visible&&(0,B.jsx)(S().Z,{renderTooltip:()=>(0,B.jsx)(p()._H,{...Xe.moreActions}),render:e=>(0,B.jsx)(G().Z,{...t,...e,hasBackground:!1,showShadow:!1,icon:ue().o,ariaLabel:i.formatMessage(Xe.moreActions)})})]})}var et=()=>o(544607),tt=()=>o(904912),ot=()=>o(920991),nt=()=>o(125519),it=()=>o(585);const st=3;function rt(e){let{stores:t,collapsed:o,shouldShowGrayFogInScroller:n,onRemoveBlockFromComment:i}=e;return 0===t.length?null:t.length<=st?(0,B.jsx)("div",{style:{display:"flex",flexDirection:"column",gap:4},children:t.map((e=>(0,B.jsx)(nt().Z,{store:e,disabled:!1,commentProps:{shouldHideBlockActionMenu:o,onRemoveBlockFromComment:i}},e.id)))}):(0,B.jsx)(it().Z,{shouldShowGrayFog:n,children:t.map((e=>(0,B.jsx)(nt().Z,{store:e,disabled:!1,commentProps:{shouldHideBlockActionMenu:o,onRemoveBlockFromComment:i}},e.id)))})}var at=()=>o(453999);const lt=3,ct=4;function dt(e){let{stores:t,embedBlockLocation:o,onRemoveContent:n}=e;if(0===t.length)return null;if(t.length<=lt)return(0,B.jsx)("div",{style:{display:"flex",flexDirection:"column",gap:4},children:t.map((e=>(0,B.jsx)(ut,{store:e,embedBlockLocation:o,onRemoveContent:n,isLarge:!0},e.id)))});if(t.length<=ct)return(0,B.jsx)("div",{style:{display:"flex",gap:4},children:t.map((e=>(0,B.jsx)(ut,{store:e,embedBlockLocation:o,onRemoveContent:n,isLarge:!1},e.id)))});const i=t.slice(0,ct-1),s=t[ct-1],r=t.length-ct+1,a=t.slice(ct);return(0,B.jsxs)("div",{style:{display:"flex",gap:4},children:[i.map((e=>(0,B.jsx)(ut,{store:e,embedBlockLocation:o,onRemoveContent:n,isLarge:!1},e.id))),(0,B.jsxs)("div",{children:[(0,B.jsx)(_e().Z,{style:{position:"absolute",zIndex:1,width:48,height:48,display:"flex",alignItems:"center",justifyContent:"center",background:"rgba(0, 0, 0, 0.4)",borderRadius:8,color:"white",fontWeight:g().Ue.bold},hoveredStyle:{background:"rgba(0, 0, 0, 0.4)"},pressedStyle:{background:"rgba(0, 0, 0, 0.4)"},onClick:()=>{at().dK({blocks:[s]})},children:`+${r}`}),(0,B.jsx)(ut,{store:s,embedBlockLocation:o,onRemoveContent:n,isLarge:!1},s.id)]}),(0,B.jsx)("div",{style:{display:"none"},children:a.map((e=>(0,B.jsx)(ut,{store:e,embedBlockLocation:o,onRemoveContent:n,isLarge:!1},e.id)))})]})}function ut(e){let{store:t,isLarge:o,embedBlockLocation:n,onRemoveContent:i}=e;const s=(0,d().yK)((e=>({imageShared:{border:`1px solid ${e.stroke.secondary}`,borderRadius:8,cursor:"zoom-in"}})),[]);return(0,B.jsx)(tt().ZP,{store:t,blockLocation:n,disabled:!1,disableDrag:!0,disableResizers:!0,preserveScale:!0,inlineContentStyle:{...s.imageShared,...o?mt:pt},disableActions:!o,onRemoveBlockFromComment:o?i:void 0},t.id)}const mt={objectFit:"contain",width:"auto",height:"auto",maxWidth:240,maxHeight:240,minWidth:48,minHeight:48},pt={width:48,height:48,minWidth:48,minHeight:48};var gt=()=>o(410184);function ht(e){let{store:t}=e;const o=(0,c().VK)((()=>ot().default.getKeyState(ot().default.getBlockKey(t.id))),[t.id]),n=(0,p().YB)(),i=(0,d().yK)((e=>({wrapper:{height:48,width:214,display:"flex",alignItems:"center",background:"white",border:`1px solid ${e.regularDividerColor}`,borderRadius:12,padding:"8px 10px 8px 8px",gap:8},icon:{background:e.tint.regular,borderRadius:6,width:32,minWidth:32,height:32,display:"flex",alignItems:"center",justifyContent:"center"},fileDetails:{display:"flex",flexDirection:"column"},fileName:{fontSize:14,fontWeight:g().Ue.medium,lineHeight:"18px",color:e.text.primary,textOverflow:"ellipsis",whiteSpace:"nowrap",overflow:"hidden"},fileSizeText:{color:e.text.secondary},progressText:{color:e.text.tertiary},sizeAndProgressContainer:{display:"flex",alignItems:"center",gap:4,fontSize:12,lineHeight:"15px"}})),[]);if(!o)return(0,B.jsxs)("div",{style:i.wrapper,children:[(0,B.jsx)("div",{style:i.icon,children:(0,B.jsx)(b().Z,{})}),(0,B.jsx)("div",{style:i.fileDetails,children:(0,B.jsx)("div",{style:i.fileName,children:n.formatMessage({id:"commentFilePlaceholder.loading",defaultMessage:"Loading..."})})})]});const{name:s,size:r,progressPercent:a}=o;return(0,B.jsxs)("div",{style:i.wrapper,children:[(0,B.jsx)("div",{style:i.icon,children:(0,B.jsx)(b().Z,{})}),(0,B.jsx)("div",{style:{overflow:"hidden"},children:(0,B.jsxs)("div",{style:i.fileDetails,children:[(0,B.jsx)("div",{style:i.fileName,children:s}),(0,B.jsxs)("div",{style:i.sizeAndProgressContainer,children:[(0,B.jsx)("span",{style:i.fileSizeText,children:(0,P().formatFileSize)(r)}),(0,B.jsx)("span",{style:i.progressText,children:"—"}),(0,B.jsx)(b().Z,{}),(0,B.jsx)(gt().Z,{percentage:a,style:i.progressText})]})]})})]})}function ft(e){let{stores:t}=e;return 0===t.length?null:(0,B.jsx)("div",{style:{display:"flex",flexDirection:"column",gap:4},children:t.map((e=>(0,B.jsx)(ht,{store:e},e.id)))})}function xt(e){const t=e.discussionFormat===P().DiscussionFormat.Sidebar?et().vW.SidebarComment:et().vW.PageComment,{uploading:o,images:n,embeds:i,files:s}=(0,c().VK)((()=>{const[t,o]=Y().uK(e.contentStores,(e=>{const t=Boolean(ot().default.getKeyState(ot().default.getBlockKey(e.id))),o=(0,tt().lI)(e);return t||!o})),[n,i]=Y().uK(o,(e=>e.getType()===z().Ti.image)),[s,r]=Y().uK(i,(e=>"video"===e.getType()));return{uploading:t,images:n,embeds:s,files:r}}),[e.contentStores]);return 0===o.length&&0===n.length&&0===i.length&&0===s.length?null:(0,B.jsxs)("div",{style:{display:"flex",flexDirection:"column",gap:4,marginTop:8},children:[(0,B.jsx)(ft,{stores:o}),(0,B.jsx)(dt,{stores:n,embedBlockLocation:t,onRemoveContent:e.onRemoveContent}),i.length>0&&(0,B.jsx)("div",{style:{display:"flex",flexDirection:"column",gap:4},children:i.map((o=>(0,B.jsx)(tt().ZP,{store:o,blockLocation:t,disabled:!1,disableDrag:!0,disableResizers:!0,preserveScale:!0,inlineContentStyle:{},onRemoveBlockFromComment:e.onRemoveContent},o.id)))}),(0,B.jsx)(rt,{stores:s,collapsed:e.collapsed,shouldShowGrayFogInScroller:e.discussionHovered&&(e.discussionFormat===P().DiscussionFormat.Margin||e.discussionFormat===P().DiscussionFormat.Sidebar),onRemoveBlockFromComment:e.onRemoveContent})]})}function vt(){const e=(0,d().yK)((e=>({newBarLine:{height:"0px",borderBottom:`1px solid ${e.darkDividerColor}`,width:"100%",marginLeft:0},newBarWrapper:{color:e.mediumTextColor,textTransform:"uppercase",fontSize:10.5,letterSpacing:.5,fontWeight:g().Ue.semibold,display:"flex",alignItems:"center",margin:0,paddingTop:10,paddingBottom:10,paddingLeft:V().yx},newBarText:{padding:"0 10px",whiteSpace:"nowrap"},threadLine:{position:"absolute",backgroundColor:e.stroke.secondary,width:V().Ky,height:"100%",borderRadius:2,left:V().fT,top:-6}})),[]);return(0,B.jsxs)("div",{style:{position:"relative"},children:[(0,B.jsx)("div",{style:e.threadLine}),(0,B.jsxs)("div",{style:e.newBarWrapper,children:[(0,B.jsx)("div",{style:e.newBarLine}),(0,B.jsx)("div",{style:e.newBarText,children:(0,B.jsx)(p()._H,{id:"comment.newIndicator.label",defaultMessage:"New comments"})}),(0,B.jsx)("div",{style:e.newBarLine})]})]})}var yt=()=>o(887328);const bt=function(e){const{store:t,discussionContext:n,discussionLocation:R,shouldShowThreadLine:O,discussionStore:z,blockStore:W,collapsed:Y}=e,$=(0,r().O7)(),X=(0,p().YB)(),[J,q]=(0,i.useState)(!1),[G,Q]=(0,i.useState)(!1),[ee,te]=(0,i.useState)(!1),[oe,ne]=(0,i.useState)(!1),[ie,se]=(0,i.useState)("post_discussion"===R&&Y),re=(0,c().VK)((()=>e.store.isDefined()?new(H().Z)($,e.store.getSpaceId()):void 0),[$,e.store]),ae=(0,c().VK)((()=>_().le(e.store).filter((e=>(0,E().Vh)(e,{table:o(396136).iU,id:e.id},"alive").getValue()))),[e.store]),le=(0,c().VK)((()=>e.discussionStore.getResolved()),[e.discussionStore]),ce=(0,c().VK)((()=>null==re?void 0:re.state.files),[re]),de=(0,c().VK)((()=>null==re?void 0:re.state.textStore),[re]),ue=(0,i.useCallback)((e=>{const t=e.target;t instanceof HTMLElement&&(0,o(474788).E)(t)&&Q(!0)}),[]),me=(0,i.useCallback)((()=>{Q(!1)}),[]),pe=(0,i.useCallback)((()=>{Z().Z.state||te(!0)}),[]),ge=(0,i.useCallback)((()=>{te(!1)}),[]),he=(0,a().l)(),fe=(0,c().qz)(void 0,o(529048).Z),xe=(0,c().VK)((()=>fe.state.open),[fe]),ve=(0,o(309797).L2)(W),ye=(0,c().VK)((()=>(0,o(338855).cw)(e.store.id)),[e.store.id]),be=(0,c().VK)((()=>{const t=e.discussionStore.getComments();return Boolean(t&&t[0]===e.store.id)}),[e.discussionStore,e.store.id]),Se=(0,c().VK)((()=>{var t;const o=W.getRole(),n=U({isFirstComment:be,discussionLocation:R,blockStore:W}),i=W.pathIsDead(),s=o&&u().rz(o)||i,{device:r}=$,a="comment_only"===o||he&&"comment"===(null===(t=he.publicEditModeStore.state)||void 0===t?void 0:t.permission),l=n&&!r.isMobile&&!a&&!s;return ee||G||e.hoveringDiscussion&&n||xe||r.isMobile||e.showResolveButtonByDefaultIfPossible&&l}),[W,e.hoveringDiscussion,e.showResolveButtonByDefaultIfPossible,be,R,$,he,ee,G,xe]),Ce=(0,i.useContext)(o(939513).U),je=(0,c().VK)((()=>{const e=t.getCreatedByPointer();return e?{createdByPointer:e,lastEditedTime:t.getLastEditedTime(),createdTime:t.getCreatedTime(),text:t.getText(),reactions:E().bh.getUserVisibleReactions(t)}:null}),[t]),ke=(0,c().VK)((()=>{if(!je)return null;const e=E().t1.createChildStore(t,je.createdByPointer);return{displayName:e.getDisplayName(X),store:e}}),[je,X,t]),we=(0,c().VK)((()=>(0,o(286338).En)()),[]),_e=function(e){const{discussionLocation:t,isCommentCollapsed:o,isDiscussionCollapsed:n,maxLines:i}=e;if("post_discussion"===t)return o?i:void 0;return n?i:void 0}({discussionLocation:R,isCommentCollapsed:ie,isDiscussionCollapsed:Y,maxLines:e.maxLines}),Le=(0,i.useCallback)((()=>{y().createAndCommit({userAction:"Comment.deleteComment",environment:$,canUndo:!0,perform:t=>{F().YF({environment:$,commentStore:e.store,transaction:t,discussionLocation:R})},skipUpdatingEditedMetadata:!0})}),[$,e.store,R]),Me=(0,i.useCallback)((async()=>{const{accept:e}=await f().gt({message:(0,B.jsx)(p()._H,{defaultMessage:"Would you like to delete this comment?",id:"comment.confirmDialog.deleteComment.prompt"}),acceptLabel:(0,B.jsx)(p()._H,{defaultMessage:"Delete",id:"comment.confirmDialog.deleteComment.deleteButton.label"})});e&&(Le(),h().Xv(),N().Z.state.overlapsExistingDiscussionMenu&&!A().Z.state.open&&N().Z.setState({...N().Z.state,overlapsExistingDiscussionMenu:!1}),K().Cd($))}),[Le,$]),Re=(0,i.useCallback)((async t=>{const o=_().zP(e.store).getValue(),n=_().le(e.store).filter((e=>e.id!==t.id)),i=o&&o.length>0,s=0===n.length;!i&&s?(await Me(),q(!1)):y().createAndCommit({userAction:"Comment.handleRemoveFileFromActions",environment:$,canUndo:!0,perform:o=>{F().Zo({commentStore:e.store,fileBlocks:[t],transaction:o})}})}),[$,Me,e.store]),Be=(0,i.useCallback)((()=>{ne(!0)}),[]),De=(0,i.useCallback)((async()=>{if(!re)return;const t=_().zP(e.store).getValue()||[],n=re.state.textStore;y().createAndCommit({userAction:"Comment.handleEditComment",environment:$,canUndo:!0,perform:e=>{o(970105).sO({environment:$,store:n,value:t,transaction:e})}}),q(!0),await s().default.afterNextFlush(),await s().default.afterNextFlush(),v().setSelectionAtEnd({store:n})}),[re,$,e.store]),Ie=(0,i.useCallback)((async()=>{if(!re)return!1;if(!(0,P().hasCommentChanged)(re,e.store))return q(!1),!0;{const{accept:e}=await f().gt({message:(0,B.jsx)(p()._H,{defaultMessage:"Do you want to discard this edit?",id:"comment.confirmDialog.discardEdit.prompt"}),acceptLabel:(0,B.jsx)(p()._H,{defaultMessage:"Discard",id:"comment.confirmDialog.discardEdit.discardButton.label"})});if(e)return q(!1),!0}return!1}),[re,e.store]),Te=(0,i.useCallback)((async()=>{const t=null==de?void 0:de.getValue();t&&t.length>0||ce&&ce.length>0?y().createAndCommit({userAction:"Comment.handleSubmitEdit",environment:$,canUndo:!0,perform:o=>{F().DF({environment:$,store:e.store,text:t||[],transaction:o,discussionLocation:R,files:ce||[],property_id:z.getPropertyId(),blockStore:W})}}):await Me(),q(!1)}),[de,ce,$,e.store,R,z,W,Me]),Ae=(0,i.useCallback)((()=>{"post_discussion"===R&&se(!1)}),[R]),Ze=(0,i.useRef)(null),Fe=(0,i.useRef)(null);(0,l().c)(I().Z,(()=>({edit:De,handleCancelEdit:Ie,getNode:()=>Ze.current,isEditing:()=>J,discussionLocation:R,commentId:e.store.id})),[De,Ie,J,R,e.store.id]);const Ke=V().IX,Ve=null==je?void 0:je.text,Pe=void 0!==Ve&&Ve.length>0&&m().VrM(Ve)>0,Ue=Pe&&(0,P().isCommentAllEmojis)(Ve),He=function(e){let{discussionLocation:t,isAllEmojis:o,avatarSize:n}=e;return(0,d().yK)((e=>({container:{flexGrow:"comment_unfurl"===t?1:void 0,paddingTop:"comment_unfurl"===t?V().tD:V().En,paddingRight:"margin_comments"===t?12:16,paddingBottom:V().rb,paddingLeft:V().vi(t)},comment:{position:"relative",fontSize:14},commentElementsBelowUserRow:{paddingLeft:V().yx},avatar:{marginTop:0,marginRight:8,userSelect:"none"},avatarSuggestionBadge:{position:"relative",display:"flex",justifyContent:"center",alignItems:"center",borderRadius:100,background:"light"===e.mode?"#fff":"#000",width:16,height:16,border:`1px solid ${e.accentColors.uiBlue[200]}`,fill:e.accentColors.uiBlue[600]},avatarSuggestionBadgeBacking:{position:"absolute",width:"100%",height:"100%",borderRadius:100,background:e.accentColors.uiBlue[100]},discussionInputContainer:{width:"calc(100% + 8px)"},threadLine:{position:"absolute",backgroundColor:e.stroke.secondary,borderRadius:2,width:V().Ky,height:V().bd,left:V().fT,top:V().aH},userRow:{display:"flex",flexDirection:"row",alignItems:"center",userSelect:"none"},placeholder:{height:8,width:81,borderRadius:6,background:e.lightDividerColor},unfurlMoreWrapper:{color:e.lightTextColor,fontWeight:"comment_unfurl"===t?g().Ue.medium:void 0,display:"block",marginBottom:-1.5,pointerEvents:"auto"},attachIcon:{width:18,height:18,fill:e.mediumIconColor},text:{cursor:"comment_unfurl"!==t?"text":void 0,lineHeight:"20px",paddingTop:4,...o?{fontSize:32,lineHeight:"32px"}:{}},attachmentContainer:{display:"flex",alignItems:"center"},timestamp:{margin:"0 6px",flexBasis:"comment_unfurl"!==t?140:void 0,whiteSpace:"normal",flexGrow:"updates_sidebar"===t||"comment_unfurl"===t?void 0:1,display:"inline",color:e.text.tertiary},commentAttachment:{},commentAuthorPlaceholder:{marginRight:8,marginTop:"comment_unfurl"===t?14:2,height:n,width:n,borderRadius:20,flexShrink:0}})),[t,o,n])}({discussionLocation:R,isAllEmojis:Ue,avatarSize:Ke}),Ne=(0,i.useMemo)((()=>({type:"comment_match",commentId:e.store.id})),[e.store.id]),Oe="comment_unfurl"!==R,ze=Oe&&je&&je.reactions.length>0;if((0,i.useEffect)((()=>{oe&&Fe.current&&ze&&(x().bx({element:Fe.current,scrollerContext:Ce,vertical:{reveal:"closest"},horizontal:void 0,animate:!0}),ne(!1))}),[Ce,oe,ze]),!re)return null;if(!je||!ke)return null;let We;We=je.lastEditedTime&&je.lastEditedTime>je.createdTime+100?(0,B.jsxs)(B.Fragment,{children:[(0,B.jsx)(k().Z,{text:(0,L().IS)(je.createdTime,{useUltraCompactFormat:!0}),tooltipText:(0,B.jsx)(p()._H,{defaultMessage:"Created {absoluteCreatedTime}",id:"comment.createdAtTime.label",values:{absoluteCreatedTime:(0,L().uy)(je.createdTime)}}),icon:M().C})," ",(0,B.jsx)(k().Z,{text:(0,B.jsx)(p()._H,{defaultMessage:"(edited)",id:"comment.editedAtIndicator"}),tooltipText:(0,B.jsx)(p()._H,{defaultMessage:"Last edited {absoluteLastEditedTime}",id:"comment.editedAtTime.label",values:{absoluteLastEditedTime:(0,L().uy)(je.lastEditedTime)}}),icon:M().C})]}):(0,B.jsx)(k().Z,{text:(0,L().IS)(je.createdTime,{useUltraCompactFormat:!0}),tooltipText:(0,L().uy)(je.createdTime),icon:M().C});const Ye=ae.length>0&&(0,B.jsx)("div",{style:He.commentAttachment,children:(0,B.jsx)(xt,{contentStores:ae,onRemoveContent:Re,discussionFormat:(0,P().discussionLocationToDiscussionFormat)(R),collapsed:Y,discussionHovered:e.hoveringDiscussion})});return(0,B.jsxs)("div",{ref:Ze,onClick:e=>J&&e.stopPropagation(),style:He.container,children:[e.showNewBar&&(0,B.jsx)(vt,{}),(0,B.jsxs)("div",{style:He.comment,onFocus:ue,onBlur:me,onMouseMove:pe,onMouseLeave:ge,children:[(0,B.jsxs)("div",{style:He.userRow,children:[e.isSuggestionComment?(0,B.jsxs)("div",{style:{position:"relative"},children:[(0,B.jsx)(Ee().S,{authorStore:null==ke?void 0:ke.store,avatarSize:Ke,avatarStyle:He.avatar,placeholderStyle:He.commentAuthorPlaceholder}),(0,B.jsx)("div",{style:{position:"absolute",right:4,bottom:-4},children:(0,B.jsxs)("div",{style:He.avatarSuggestionBadge,children:[D({height:8.5}),(0,B.jsx)("div",{style:He.avatarSuggestionBadgeBacking})]})})]}):(0,B.jsx)(Ee().S,{authorStore:null==ke?void 0:ke.store,avatarSize:Ke,avatarStyle:He.avatar,placeholderStyle:He.commentAuthorPlaceholder}),(0,B.jsxs)("div",{style:{overflow:"hidden"},children:[(0,B.jsx)("span",{style:{fontWeight:g().Ue.medium,whiteSpace:"normal"},children:we?(0,B.jsx)(S().Z,{renderTooltip:()=>ke&&ke.store instanceof E().U6?(0,B.jsx)(o(80164).Z,{targetUserStore:ke.store}):null,placement:T().Placement.Top,alignment:T().Alignment.End,render:e=>(0,B.jsx)("span",{...e,children:ke.displayName}),delayThreshold:600,allowHover:!0,closeDelay:1500,isLightBackground:!0}):ke.displayName||(0,B.jsx)("span",{style:He.placeholder})}),(0,B.jsx)(C().Z,{isSmall:!0,isSecondaryColor:!0,isMultiline:!0,style:He.timestamp,children:We}),"comment_unfurl"===R&&le&&(0,B.jsx)("div",{style:{display:"inline-flex"},children:(0,B.jsx)(o(946563).Z,{children:(0,B.jsx)(p()._H,{id:"comment.unfurl.resolvedStatus",defaultMessage:"Resolved"})})})]})]}),O&&(0,B.jsx)("div",{style:He.threadLine}),(0,B.jsxs)("div",{style:He.commentElementsBelowUserRow,children:[Boolean(n)&&n,J&&(0,B.jsx)("div",{style:{marginTop:4},children:(0,B.jsx)(yt().Z,{containerStyle:He.discussionInputContainer,showAvatar:!1,parentStore:e.store,blockStore:W,onCancel:Ie,onSubmit:Te,discussionInputStore:re,isEditingExistingComment:!0,isMobileSlideUpMenu:!0,shouldSaveUnsentComments:!1,commentStore:e.store,discussionFormat:(0,P().discussionLocationToDiscussionFormat)(R),canDrop:!0})}),Pe&&!J&&(0,B.jsxs)("div",{style:{display:"flex",flexDirection:"row",justifyContent:"space-between"},children:[(0,B.jsx)(w().Z,{onMore:"comment_unfurl"===R?void 0:Ae,moreElement:(0,B.jsxs)(j().Z,{disableUnderline:!0,style:He.unfurlMoreWrapper,hoverColor:"blue",children:["…"," ",(0,B.jsx)("span",{children:(0,B.jsx)(p()._H,{id:"comment.truncated.showMoreLabel",defaultMessage:"more"})})]}),maxLines:_e,children:(0,B.jsx)(o(345837).Z,{style:He.text,store:_().zP(e.store),disabled:!0,disabledMentionTypes:{date:!0},disableEquationInteraction:!0,inPageFind:Ne})}),ve&&ye&&(0,B.jsx)(b().Z,{style:{alignSelf:"flex-end",marginRight:8,marginLeft:8}})]}),J||"comment_unfurl"===R?!Pe&&(0,B.jsxs)("div",{style:He.attachmentContainer,children:[(0,B.jsx)("div",{style:{marginRight:5},children:(0,o(679982).s)(He.attachIcon)}),(0,B.jsx)(p()._H,{defaultMessage:"{numberOfAttachments, plural, one {{numberOfAttachments} attachment} other {{numberOfAttachments} attachments}}",values:{numberOfAttachments:ae.length},id:"comment.unfurl.attachments.title"})]}):Ye,ze&&(0,B.jsx)("div",{ref:Fe,style:{marginTop:8},children:(0,B.jsx)($e,{parentStore:e.store,discussionLocation:R})})]}),"comment_unfurl"!==R&&!J&&!ve&&(0,B.jsx)(Je,{store:e.store,discussionStore:e.discussionStore,blockStore:W,discussionLocation:R,visible:Se,isFirstComment:be,buttonPopupStore:fe,canShowReactions:Oe,handleEditComment:De,handleDeleteComment:Me,handleReaction:Be})]})]})};o(122556),o(582845),o(250570),o(533019),o(721473),o(788208),o(22624),o(470928);var St=()=>o(580397),Ct=()=>o(349220),jt=()=>o(191586),kt=()=>o(32969),wt=()=>o(908102);function _t(e){var t;let{discussionStore:o,commentStore:n}=e;if(!n.isDefined())return!1;const i=null===(t=ye().default.state.currentUserStore)||void 0===t?void 0:t.id;const s=wt().Z.state.lastInteractionTimes[o.id];if(n.getCreatedById()===i)return!1;const r=function(){if(!o.isDefined()||!i)return 0;const{pageVisitStore:e}=ye().default.state,{lastViewTime:t,lastExitTime:n}=e.state;return n||t}();if(void 0===r)return!1;const a=(0,P().getAndSortCommentStoresByTime)(o).filter((e=>e.getCreatedById()===i)).reverse()[0],l=n.getCreatedTime();return!l||!(a&&l<a.getCreatedTime())&&(!(s&&l<s)&&l>r)}var Lt=()=>o(72539),Mt=()=>o(108714),Rt=()=>o(653457),Bt=()=>o(735501),Dt=()=>o(469203);const It="https://notion.notion.site/AI-Conflict-Detection-158efdeead058037b57efc2b77ad9c21";function Tt(e){let{origin:t}=e;const n=(0,d().yK)((e=>({learnMoreLink:{color:e.regularInvertedTextColor}})),[]);return(0,B.jsx)(o(125302).r,{origin:t,placementToOrigin:"bottom",tutorialId:"ai-comment-onboarding",tutorialStepId:"ai-comment-onboarding-tooltip",hideActions:!0,hideInsteadOfFlip:!0,header:(0,B.jsx)(p()._H,{id:"AiCommentOnboardingTooltip.header",defaultMessage:"Check for conflicts with Notion AI"}),content:(0,B.jsx)(p()._H,{id:"AiCommentOnboardingTooltip.content",defaultMessage:"Notion AI searches across your workspace and connected apps for conflicting information, using only sources that all members can access. {learnMoreLink}",values:{learnMoreLink:(0,B.jsx)(o(455241).d,{href:It,style:n.learnMoreLink})}})})}function At(e){const{discussionLocation:t,commentStore:o}=e,n=(0,c().VK)((()=>{if(!o)return!1;const e=o.getCreatedByPointer();return!!e&&e.id===Lt().GR.id}),[o]),i=(0,r().Fy)(),s=(0,d().yK)((e=>({container:{display:"flex",flexDirection:"row",gap:6,width:"100%",color:e.lightTextColor,fontSize:i.isMobile?g().JB.UISmall.mobile:g().JB.UISmall.desktop,paddingTop:V().En,paddingLeft:V().vi(t)+V().IX-8},warningIcon:{width:10,height:10,alignSelf:"center",display:"inline-block",verticalAlign:"text-bottom"},helpIcon:{color:e.lightTextColor,flexDirection:"row-reverse",gap:6,width:14,alignItems:"center",cursor:"pointer",textDecoration:"none",pointerEvents:"auto"},text:{maxWidth:200}})),[i,t]);return n?(0,B.jsxs)("div",{style:s.container,children:[(0,Bt().t)(s.warningIcon),(0,B.jsx)(Dt().s,{style:s.text,children:(0,B.jsx)(p()._H,{id:"aiCommentHeader.conflictingContent.label",defaultMessage:"Notion AI found potential conflicts"})}),(0,B.jsx)(Mt().Z,{href:It,external:!0,style:s.helpIcon,children:(0,Rt().m)({width:14,marginRight:4})})]}):null}var Zt=()=>o(297490),Et=()=>o(550888),Ft=()=>o(190322),Kt=()=>o(474999),Vt=()=>o(150376);var Pt=()=>o(527278);const Ut=(0,p().vU)({helpful:{id:"assistant.commentFeedback.helpful",defaultMessage:"Helpful"},notHelpful:{id:"assistant.commentFeedback.notHelpful",defaultMessage:"Not helpful"},feedbackPlaceholder:{id:"assistant.commentFeedback.feedbackPlaceholder",defaultMessage:"How can we improve?"},thankYou:{id:"assistant.commentFeedback.thankYou",defaultMessage:"Thank you for your feedback!"}});function Ht(e){const{blockStore:t}=e,n=t.id,i=function(e){const t=(0,r().O7)(),o=(0,c().VK)((()=>{const o=e.getNavigableBlockStore();if(o)return new(E().dV)(t,{table:Kt().te,id:o.id,spaceId:o.getSpaceId()})}),[t,e]);return(0,c().VK)((()=>{if(!o)return;const t=e.id,n=o.getRelatedContent().find((e=>e.targetId===t));return n?{feedback:Vt().Z.state[n.inferenceId],inferenceId:n.inferenceId}:void 0}),[o,e.id])}(t),s=null==i?void 0:i.feedback,a=null==i?void 0:i.inferenceId,l=(0,r().O7)(),u=(0,o(356140).W)(),m=(0,d().yK)((()=>({container:{display:"flex",flexDirection:"column",gap:12,width:"100%"},buttonRow:{display:"flex",flexDirection:"row",gap:8}})),[]);return a?(0,B.jsx)("div",{style:m.container,children:(0,B.jsxs)("div",{style:m.buttonRow,children:[(0,B.jsx)(Ft().ZP,{title:Pt().Z.formatMessage(Ut.helpful),variant:"tinted",icon:"thumbs_up"===s?o(449075).w:o(132280).P,onClick:()=>{if(!u||!a)return;const e=t.getNavigableBlockStore();e&&(0,Et().oJ)({environment:l,pageId:e.id,blockId:n,spaceId:u,inferenceId:a,thumbsUpOrDown:"up"})}}),(0,B.jsx)(Ft().ZP,{title:Pt().Z.formatMessage(Ut.notHelpful),variant:"tinted",icon:"thumbs_down"===s?o(582601).E:o(94565).A,onClick:()=>{if(!u||!a)return;const e=t.getNavigableBlockStore();e&&(0,Et().oJ)({environment:l,pageId:e.id,blockId:n,spaceId:u,inferenceId:a,thumbsUpOrDown:"down"})}})]})}):null}const Nt={block_menu:"8px 16px 0px",page_discussion:"8px 0px 0px",updates_sidebar:"4px 16px 12px",margin_comments:"8px 12px 6px",comment_unfurl:"0",post_discussion:"0px -16px 0px",updates_menu_mentions_comments:"4px 16px 12px",updates_menu_all_updates:"4px 16px 12px",updates_menu_archive:"4px 16px 12px",reply_menu_mentions_comments:"8px 16px 0px",reply_menu_all_updates:"8px 16px 0px",reply_menu_archive:"8px 16px 0px",reply_menu_updates_sidebar:"8px 16px 0px",ai_reject_all_suggestions:"0"},Ot=i.forwardRef((function(e,t){const n=(0,r().O7)(),{format:s,role:a,showMoreCommentsButton:l,onMoreCommentsClick:m,inputVisible:p,blockStore:g,store:h}=e,f=(0,o(480089).cR)(g),x=a&&u().rz(a)||f,v=n.currentUser.isLoggedIn(),y=(0,i.useRef)(null),b=(0,d().yK)((t=>({container:{position:"relative",padding:0,...s===P().DiscussionFormat.Page?{marginLeft:16,marginRight:16}:{}},discussionInputContainer:{padding:Nt[e.discussionLocation]},aiFeedbackContainer:{display:"flex",flexDirection:"row",gap:8,marginLeft:"page_discussion"===e.discussionLocation?32:24,padding:Nt[e.discussionLocation]}})),[s,e.discussionLocation]),S=(0,c().VK)((()=>{const e=h.getCommentStores()[0];if(!e)return!1;const t=e.getCreatedByPointer();return!!t&&t.id===Lt().GR.id}),[h]);return(0,B.jsx)(B.Fragment,{children:v&&!x&&(l||p)&&(0,B.jsxs)("div",{style:b.container,children:[l&&(0,B.jsx)(o(83447).Z,{onClick:m}),p&&(S?(0,B.jsxs)("div",{style:b.aiFeedbackContainer,ref:y,children:[(0,B.jsx)(Ht,{blockStore:g,location:e.discussionLocation}),(0,B.jsx)(Tt,{origin:y})]}):(0,B.jsx)(yt().Z,{autoFocus:!0,showAvatar:!0,containerStyle:b.discussionInputContainer,parentStore:e.store,onCancel:e.onCancel,onSubmit:e.onSubmit,discussionInputStore:e.discussionInputStore,isMobileSlideUpMenu:!1,shouldSaveUnsentComments:!0,onEditPreviousComment:e.onEditPreviousComment,inReplyToDiscussionId:e.store.id,discussionFormat:e.format,showCtaButtons:e.showCtaButtons,ref:t,onFileUploaded:e.onFileUploaded}))]})})}));var zt=()=>o(777346);function Wt(e){const t=(0,d().yK)((t=>{const o=V().vi(e.discussionLocation)+V().IX;return{newBarLine:{height:"0px",borderBottom:`1px solid ${t.darkDividerColor}`,marginLeft:0,flex:1},moreCommentsWrapper:{color:t.lightTextColor,fontSize:14,flexGrow:1,display:"flex",alignItems:"center",paddingLeft:8},button:{borderRadius:6,fontSize:14,color:t.mediumTextColor,justifyContent:"space-between",padding:"14px 0",margin:`0 0 0 ${o}px`,width:`calc(100% - ${o}px - 16px)`},buttonHovered:{background:t.focusDiscussionInputBackground},threadLine:{position:"absolute",backgroundColor:t.stroke.secondary,width:V().Ky,height:"100%",top:V().En-V()._e,left:V().vi(e.discussionLocation)+V().fT,borderRadius:2}}}),[e.discussionLocation]);return e.count<=0?null:(0,B.jsxs)("div",{style:{position:"relative"},children:[(0,B.jsx)("div",{style:t.threadLine}),(0,B.jsx)(zt().Z,{style:t.button,onClick:e.onClick,hoveredStyle:t.buttonHovered,children:(0,B.jsx)("div",{className:"discussion-show-all-button",style:t.moreCommentsWrapper,children:(0,B.jsx)(p()._H,{defaultMessage:"Show {moreCommentsNumber, plural, one {{moreCommentsNumber} reply} other {{moreCommentsNumber} replies}}",id:"discussion.showMoreCommentsSidebarButton.label",values:{moreCommentsNumber:e.count}})})},"show")]})}var Yt=()=>o(722917),$t=()=>o(641702);function Xt(e){const{discussionStore:t}=e,o=(0,p().YB)(),n=(0,c().VK)((()=>t.isSuggestionDiscussion()),[t]),i=(0,c().VK)((()=>{const t=e.discussionStore.getContext();return(t?(0,St().GW)({discussionContextData:t,discussionId:e.discussionStore.id,discussionType:(0,Ct().TO)(e.discussionStore.getType()),intl:o}):[])??[]}),[e.discussionStore,o]),s=(0,d().yK)((e=>({container:{marginTop:2},label:{color:e.text.uiBlueSecondary,fontSize:14,lineHeight:"18px"},labelDeleteColor:{color:e.text.tertiary},text:{color:e.text.uiBluePrimary,fontSize:14,lineHeight:1.29},textDeleteColor:{color:e.text.secondary},suggestionContextItem:{display:"block",marginBottom:4,whiteSpace:"pre-wrap",wordBreak:"break-word"},unfurlMoreWrapper:{color:e.lightTextColor,fontWeight:g().Ue.medium,display:"block",marginBottom:-1.5,pointerEvents:"auto"}})),[]),r=(0,Yt().Kc)(o).title;return n&&r&&0!==i.length?(0,B.jsx)("div",{style:s.container,children:(0,B.jsx)(w().Z,{maxLines:e.collapsed?1:void 0,clampOverride:{lineHeight:1.29,fontSize:14},moreElement:(0,B.jsxs)(j().Z,{disableUnderline:!0,style:s.unfurlMoreWrapper,hoverColor:"blue",children:["…"," ",(0,B.jsx)("span",{children:(0,B.jsx)(p()._H,{id:"suggestion.truncated.showMoreLabel",defaultMessage:"more"})})]}),children:i.map(((e,o)=>{let{label:n,value:i,shouldUseDeleteColor:r,removeQuotationMarks:a}=e;return(0,B.jsxs)("div",{style:s.suggestionContextItem,children:[(0,B.jsxs)("span",{style:{...s.label,...r&&s.labelDeleteColor},children:[n,": "]}),(0,B.jsxs)("span",{style:{...s.text,...r&&s.textDeleteColor},children:[a?null:"“",(0,B.jsx)(Jt,{value:i,discussionStore:t}),a?null:"”"]})]},o)}))})}):null}function Jt(e){let{value:t,discussionStore:o}=e;const n=(0,r().O7)(),i=(0,d().Fg)(),s=(0,c().VK)((()=>(0,$t().IY)({environment:n,textValue:{value:t,spaceId:o.pointer.spaceId},parentStore:o,disableHover:!0,disableStyleAnnotations:!0,disableInsertedDeletedAnnotations:!0,disableDateStyleAnnotations:!0,disableSuggestionAnnotations:!0,disabled:!0,theme:i,emojiType:(0,Ae().e_)(n),katex:n.KatexStore.getKatex(),formulaValueTypes:[]})),[n,t,o,i]);return(0,B.jsx)("span",{children:s})}function qt(e){const{onDismiss:t}=e,n=(0,i.useRef)(null),a=(0,p().YB)(),u=(0,r().O7)(),g=(0,c().VK)((()=>"suggestion"===e.store.getType()),[e.store]),h=(0,c().VK)((()=>_().D4(e.store)),[e.store]),b=(0,c().VK)((()=>h.filter((e=>e.isDefined())).filter((e=>Boolean(e.getAlive())))),[h]),S="page_discussion"===e.discussionLocation?3:5;(0,i.useEffect)((()=>{b.length===S&&D(!0)}),[b,S]);const C=(0,i.useRef)(e.discussionInputStore||new(H().Z)(u,e.store.pointer.spaceId)).current,j=(0,c().VK)((()=>(0,P().inputIsEmpty)(C)),[C]),k=(0,c().VK)((()=>(0,jt().Wt)(e.blockStore)&&!(0,jt().bm)(e.blockStore)),[e.blockStore]),w=(0,c().VK)((()=>e.store.getResolved()),[e.store]),[L,M]=(0,i.useState)(!1),[R,D]=(0,i.useState)(void 0!==e.collapsed&&!e.collapsed),[T,A]=(0,i.useState)(!0),K=(0,c().qz)(void 0,o(561280).Z),U=(0,c().VK)((()=>K.state.clientRect),[K]),N=e.format===P().DiscussionFormat.Sidebar,O=e.format===P().DiscussionFormat.Margin,z=(0,i.useRef)(null);(0,l().c)(o(244826).Z,(()=>({isSidebarFormat:()=>N,isMarginFormat:()=>O,getStore:()=>e.store,getInputStore:()=>C,getNode:()=>z.current,getMarginDiscussionScrollContainer:()=>n.current})),[N,O,e.store,C]);const W=(0,c().VK)((()=>{if(!N)return;return(0,P().getAndSortCommentStoresByTime)(e.store).find((t=>_t({discussionStore:e.store,commentStore:t})))}),[N,e.store]),X=(0,i.useRef)(W),J=void 0===X.current?W:X.current,q=(0,i.useCallback)((()=>{var t;if(R||b.length<=S||"block_menu"===e.discussionLocation)return b;if("page_discussion"===e.discussionLocation)return Y().pm(b,1);const o=[e.showAllRepliesAfterTimestamp,null===(t=X.current)||void 0===t?void 0:t.getCreatedTime(),null==W?void 0:W.getCreatedTime()].filter($().$K),n=o.length>0?Math.min(...o):void 0;if(n){const e=b.filter((e=>(e.getCreatedTime()||0)>n)),t=b.filter((e=>(e.getCreatedTime()||0)<=n));return t.length<=5?b:[...Y().pm(t,2),...e]}return Y().pm(b,2)}),[b,W,S,e.discussionLocation,e.showAllRepliesAfterTimestamp,R]),G=(0,c().VK)((()=>{const t=q(),o=new Set(t.map((e=>e.id))),n=b.filter((e=>!o.has(e.id)));return{commentStores:b,commentsToShow:t,commentsToCollapse:n,reactionsToShow:E().bh.getUserVisibleReactions(e.store)}}),[b,q,e.store],{useDeepEqual:!0}),Q=(0,i.useCallback)((()=>{if(!e.store.isDefined())return;const t=e.store.getContext();if(!t)return;const o=(0,St().Bb)({discussionContextData:t,discussionType:(0,Ct().TO)(e.store.getType()),discussionId:e.store.id,intl:a});return m().VP_(o,(t=>!m().xw5(t)||m().h19(t)===e.store.id))}),[e.store,a]),ee=(0,c().VK)((()=>{if(!N)return;return(0,P().getAndSortCommentStoresByTime)(e.store).find((t=>_t({discussionStore:e.store,commentStore:t})))}),[N,e.store]),te=(0,i.useRef)(null),oe=(0,i.useRef)(e.blockStore.clone()).current,ne=(0,d().yK)((t=>({discussionWrapper:{...e.format===P().DiscussionFormat.Page&&{margin:`0px ${V().n4}px 16px`,..."post_discussion"===e.discussionLocation&&{marginLeft:-16,marginBottom:G.reactionsToShow.length>0?0:12}},...e.format===P().DiscussionFormat.Menu&&{padding:"6px 0 12px",marginLeft:-2,boxShadow:e.isFirst?"none":`0 -1px 0 ${t.regularDividerColor}`,marginTop:e.isFirst?0:1},...e.format===P().DiscussionFormat.Margin&&{padding:"4px 0",borderRadius:8}},reactionBarWrapper:{paddingLeft:16,paddingRight:16,..."post_discussion"===e.discussionLocation&&{display:"flex",justifyContent:"space-between"}}})),[G.reactionsToShow.length,e.discussionLocation,e.format,e.isFirst]);(0,i.useEffect)((()=>{u.KatexStore.loadIfNeeded(Q)}),[u.KatexStore,Q]);const ie=(0,i.useCallback)((t=>{const{device:n}=u;if(!n.isMobile)return;if(!e.store.isDefined())return;t.stopPropagation(),t.preventDefault(),o(980316).Z.setState({open:!1});const i=Y().oA(kt().C.findSelectablesFromIds([e.store.getParentId()])),s=null==i?void 0:i[0];s&&x().XW({handle:s,vertical:{reveal:"bottom"},horizontal:{reveal:"closest"},animate:!0})}),[e.store,u]),se=(0,i.useCallback)((e=>{O||(e.stopPropagation(),D(!0))}),[O]),re=(0,i.useMemo)((()=>{const{commentStores:t,commentsToShow:i,commentsToCollapse:s}=G;if(O){const i=(0,P().lineClampForCommentCount)(t.length);if(!e.collapsed)return(0,B.jsx)(o(842574).Z,{style:{display:"flex",flexDirection:"column",maxHeight:500,overflowY:"scroll"},ref:n,type:o(520849).Z.Y,store:K,children:t.map(((o,n)=>{const s=g&&0===n;return(0,B.jsx)(bt,{store:o,discussionStore:e.store,blockStore:e.blockStore,hoveringDiscussion:L,discussionLocation:e.discussionLocation,showResolveButtonByDefaultIfPossible:e.showResolveButtonByDefaultIfPossible,maxLines:i,shouldShowThreadLine:n!==t.length-1,discussionContext:s?(0,B.jsx)(Xt,{discussionStore:e.store,collapsed:Boolean(e.collapsed)}):void 0,isSuggestionComment:s},o.id)}))});const s=t[0]&&(0,B.jsx)(bt,{store:t[0],discussionStore:e.store,blockStore:e.blockStore,hoveringDiscussion:L,discussionLocation:e.discussionLocation,showResolveButtonByDefaultIfPossible:e.showResolveButtonByDefaultIfPossible,maxLines:i,collapsed:e.collapsed,shouldShowThreadLine:1!==t.length,discussionContext:g?(0,B.jsx)(Xt,{discussionStore:e.store,collapsed:Boolean(e.collapsed)}):void 0,isSuggestionComment:g},t[0].id),r=t.length>1&&t[t.length-1]&&(0,B.jsx)(bt,{store:t[t.length-1],discussionStore:e.store,blockStore:e.blockStore,hoveringDiscussion:L,discussionLocation:e.discussionLocation,showResolveButtonByDefaultIfPossible:e.showResolveButtonByDefaultIfPossible,maxLines:i,collapsed:e.collapsed,shouldShowThreadLine:!1},t[t.length-1].id),a=t.length-2;return(0,B.jsxs)(B.Fragment,{children:[s,(0,B.jsx)(Wt,{insetButton:!O,count:a,onClick:se,discussionLocation:e.discussionLocation}),r]})}const r=s.length>0,a=i.map(((t,o)=>{const n=g&&0===o,s=n?(0,B.jsx)(Xt,{discussionStore:e.store,collapsed:Boolean(e.collapsed)}):0===o&&!r&&(e.format===P().DiscussionFormat.Menu||e.format===P().DiscussionFormat.Sidebar)&&(0,B.jsx)(Zt().Z,{format:e.format,discussionLocation:e.discussionLocation,store:e.store,blockStore:e.blockStore,onClick:ie}),a="post_discussion"===e.discussionLocation?(0,P().lineClampForCommentCount)(i.length):void 0;return(0,B.jsx)(bt,{store:t,discussionStore:e.store,blockStore:e.blockStore,hoveringDiscussion:L,discussionLocation:e.discussionLocation,showResolveButtonByDefaultIfPossible:e.showResolveButtonByDefaultIfPossible,discussionContext:s,isSuggestionComment:n,showNewBar:t.id===(null==J?void 0:J.id)&&0!==o,shouldShowThreadLine:o!==i.length-1,maxLines:a},t.id)})),l=g,c=l?(0,B.jsx)(Xt,{discussionStore:e.store,collapsed:Boolean(e.collapsed)}):(e.format===P().DiscussionFormat.Menu||e.format===P().DiscussionFormat.Sidebar)&&(0,B.jsx)(Zt().Z,{format:e.format,discussionLocation:e.discussionLocation,store:e.store,blockStore:e.blockStore,onClick:ie});return(0,B.jsxs)("div",{style:{position:"relative"},children:[N&&ee&&(0,B.jsx)(o(819792).z,{style:Qt}),r&&(0,B.jsx)(bt,{store:t[0],discussionStore:e.store,blockStore:e.blockStore,hoveringDiscussion:L,discussionLocation:e.discussionLocation,showResolveButtonByDefaultIfPossible:e.showResolveButtonByDefaultIfPossible,discussionContext:c,shouldShowThreadLine:1!==t.length,isSuggestionComment:l,collapsed:e.collapsed,maxLines:"post_discussion"===e.discussionLocation&&e.collapsed?(0,P().lineClampForCommentCount)(t.length):void 0},t[0].id),(0,B.jsx)(Wt,{insetButton:!O,count:s.length-1,onClick:se,discussionLocation:e.discussionLocation}),a]})}),[null==J?void 0:J.id,G,ie,se,ee,L,O,N,g,e.blockStore,e.collapsed,e.discussionLocation,e.format,e.showResolveButtonByDefaultIfPossible,e.store,K]),ae=(0,c().VK)((()=>e.blockStore.getRole()),[e.blockStore]),[le,ce]=(0,i.useState)(!0);(0,i.useEffect)((()=>{var e;const t=null===(e=n.current)||void 0===e?void 0:e.getNode();if(t){function i(){t&&ce(o(275200).N0(t))}return t.addEventListener("scroll",i),()=>t.removeEventListener("scroll",i)}}),[n]);const de=T&&!e.collapsed&&O&&U&&!le,ue=(0,i.useCallback)((()=>{const e=kt().C.findSelectableFromStore(oe);e&&x().XW({handle:e,vertical:{reveal:"bottom"},horizontal:{reveal:"closest"},animate:!0})}),[oe]),me=(0,i.useCallback)((()=>{C.reset()}),[C]),pe=(0,i.useCallback)((()=>{const t=u.currentUser.id;if(!t)return;const o=_().D4(e.store).filter((e=>e.getCreatedById()===t)),n=Y().Z$(o);if(!n)return;if(g&&1===o.length)return;const i=I().Z.find((t=>t.commentId===n.id&&t.discussionLocation===e.discussionLocation));i&&(v().clear({environment:u}),i.edit())}),[e.discussionLocation,g,e.store,u]),ge=(0,i.useCallback)((async()=>{if((0,P().hasCommentChanged)(C)){const{accept:e}=await f().gt({message:(0,B.jsx)(p()._H,{defaultMessage:"Do you want to discard this reply?",id:"discussion.confirmDialog.discardReply.prompt"}),acceptLabel:(0,B.jsx)(p()._H,{defaultMessage:"Discard",id:"discussion.confirmDialog.discardReplyButton.label"})});e?(me(),t&&t()):(await s().default.afterNextFlush(),v().setSelectionAtEnd({store:C.state.textStore}))}else me(),t&&t()}),[t,C,me]),he=(0,i.useCallback)((()=>{s().default.afterNextFlush((()=>{var e;const t=null===(e=n.current)||void 0===e?void 0:e.getNode();t&&t.scrollTo({top:t.scrollHeight,behavior:"smooth"})}))}),[n]),fe=Y().Ds((()=>{setTimeout((()=>A(!0)),50)}),50),xe=(0,i.useCallback)((async()=>{A(!1);const{device:t}=u;y().createAndCommit({userAction:"Discussion.handleSubmitReply",environment:u,canUndo:!0,perform:t=>{F().Xi({environment:u,discussionStore:e.store,textValue:C.state.textStore.getValue()||[],transaction:t,discussionLocation:e.discussionLocation,files:C.state.files,property_id:e.store.getPropertyId(),blockStore:e.blockStore})}}),me(),v().clear({environment:u}),he(),fe(),t.isMobile||(await s().default.afterNextFlush(),v().setSelectionAtStart({store:C.state.textStore}))}),[C,fe,e.blockStore,e.store,e.discussionLocation,he,u,me]),ve=(0,i.useCallback)((()=>{Z().Z.state||M(!0)}),[]),ye=(0,i.useCallback)((()=>{M(!1)}),[]);return 0===G.commentsToShow.length&&G.reactionsToShow.length>0||"post_discussion"===e.discussionLocation&&0===G.commentsToShow.length&&G.reactionsToShow.length>0?(0,B.jsxs)("div",{ref:z,style:{...ne.discussionWrapper,...ne.reactionBarWrapper},onMouseMove:ve,onMouseLeave:ye,children:[(0,B.jsx)(Ye,{focused:!0,disableShadow:!0,parentStore:e.store,discussionLocation:e.discussionLocation}),"post_discussion"===e.discussionLocation&&(0,B.jsx)(o(259878).W4,{pageVisitStore:e.pageVisitStore,presenceStore:e.presenceStore,rootStore:e.blockStore,maxUsers:5,isShowingInPostFeed:!0})]}):(0,B.jsx)(o(307369).Z,{store:oe,analyticsName:"discussion",canNativeDropOnto:!0,onNativeDrop:async e=>{let{files:t}=e;te.current&&await te.current.uploadFiles(t)},keepTextSelectionOnDrop:!0,shouldShowDropZone:!0,children:(0,B.jsxs)("div",{ref:z,style:ne.discussionWrapper,onMouseMove:ve,onMouseLeave:ye,children:[!e.collapsed&&(0,B.jsx)(At,{commentStore:h[0],discussionLocation:e.discussionLocation}),re,w?(0,B.jsx)("div",{style:{height:8}}):(0,B.jsx)(Ot,{ref:te,showMoreCommentsButton:!!de,onMoreCommentsClick:he,inputVisible:!(k||e.collapsed&&j&&"post_discussion"!==e.discussionLocation),store:e.store,blockStore:oe,format:e.format,discussionInputStore:C,discussionLocation:e.discussionLocation,onCancel:ge,onSubmit:xe,onEditPreviousComment:pe,showCtaButtons:!!O||void 0,onFileUploaded:ue,role:ae})]})})}const Gt=i.memo(qt),Qt={marginRight:4,position:"absolute",right:16,top:14};var eo=()=>o(527188),to=()=>o(251932),oo=()=>o(589525),no=()=>o(954452);const io=(0,p().vU)({commentsAriaLabel:{defaultMessage:"{count, plural, one {1 comment} other {{count} comments}}",id:"comments.components.discussionindicator.commentAriaLabel"},suggestionsAriaLabel:{defaultMessage:"{count, plural, one {1 suggestion} other {{count} suggestions}}",id:"comments.components.discussionindicator.suggestionAriaLabel"},reactionsAriaLabel:{defaultMessage:"{count, plural, one {1 reaction} other {{count} reactions}}",id:"comments.components.discussionindicator.reactionsAriaLabel"}});function so(e){const t=(0,p().YB)(),{store:n,propertyId:i,style:s}=e,{showIndicator:a,formattedReactionCount:l,onlySuggestions:u,icon:m,showReactionsIcon:h,onlyHasDraftIndicator:f,formattedCommentCount:x,handleClick:v,discussionIsSelected:y,commentsCount:b,shouldShowDraftIndicator:S}=(0,o(344569).Z)({store:n,recursivelyLoadAllDiscussions:!1,onlyCountBlockLevelDiscussions:!1,propertyId:i}),C=(0,d().yK)((e=>({iconButton:{background:y?e.selectLightGray[100]:void 0,gap:2},icon:{width:14,color:e.lightTextColor},commentCount:{marginLeft:2,color:e.lightTextColor,fontWeight:g().Ue.semibold,marginBottom:1},reactIcon:{width:14,height:14,color:e.lightTextColor},commentCaptionStyle:{fontWeight:g().Ue.semibold,...S?{color:e.icon.tertiary}:{color:e.lightTextColor,marginBottom:1}},reactionCaptionStyle:{fontWeight:g().Ue.semibold,color:e.lightTextColor}})),[y,S]),j=(0,r().O7)(),k=(0,c().VK)((()=>(0,oo().vK)(j)),[j]),w=(0,c().VK)((()=>(0,no().fg)(j,n)),[j,n]),{isPropertyInPageDetails:_}=(0,o(70191).d0)({store:n,propertyId:i});return!a||!_&&(k||w)?null:(0,B.jsxs)(to().gq,{style:s,children:[(b>0||f)&&(0,B.jsxs)(to().gq,{style:{position:"relative"},children:[(0,B.jsx)(G().Z,{ariaLabel:u?t.formatMessage(io.suggestionsAriaLabel,{count:x}):t.formatMessage(io.commentsAriaLabel,{count:x}),icon:m,style:C.iconButton,iconStyle:C.icon,onClick:v,caption:x,captionStyle:C.commentCaptionStyle}),S&&(0,B.jsx)(o(211332).Z,{customTop:3,customLeft:16,onlyShowDraftDot:!0})]}),h&&(0,B.jsx)(G().Z,{ariaLabel:t.formatMessage(io.reactionsAriaLabel,{count:l}),icon:o(381622).a,style:C.iconButton,iconStyle:C.icon,onClick:v,captionStyle:C.reactionCaptionStyle,caption:l})]})}const ro=i.memo(so);var ao=()=>o(887430),lo=()=>o(942226),co=()=>o(749826),uo=()=>o(311562),mo=()=>o(435308),po=()=>o(572948),go=()=>o(574767),ho=()=>o(958783),fo=(o(749411),()=>o(58988)),xo=()=>o(252100);function vo(e){let{discussionData:{groupedDiscussionsData:t,newDiscussionData:o,id:n},onClick:s}=e;const[a,l]=(0,i.useState)(!1),u=(0,r().O7)(),m=u.currentUser.id,h=(0,i.useCallback)((()=>{l(!0)}),[]),f=(0,i.useCallback)((()=>{l(!1)}),[]),x=o,v=(0,i.useCallback)((async e=>{if(x){const e=ye().default.state.mainEditorCurrentBlockStore;N().Z.setActiveWithSource("margin_comments"),await(0,xo().U)({currentBlockStore:e,discussionInputStore:o.discussionInputStore,environment:u})}else if(t.length>0){const o=t[0].discussionStore;await s(e,o)}}),[x,t,null==o?void 0:o.discussionInputStore,u,s]),{commentStores:y,reactionStores:b}=(0,c().VK)((()=>{if(t){return{commentStores:t.flatMap((e=>(0,_().D4)(e.discussionStore))),reactionStores:t.flatMap((e=>E().bh.getUserVisibleReactions(e.discussionStore)))}}return{commentStores:[],reactionStores:[]}}),[t]),S=(0,c().VK)((()=>{let e;if(x&&(e=o.parentBlockStore),t.length>0&&(e=t[0].parentBlockStore),!e)return;const n=y.map((e=>e.getCreatedById())).filter($().$K),i=b.map((e=>e.getActorPointers().map((e=>e.id)))).flat().filter($().$K);return Array.from(new Set([...n,...i,...x&&m?[m]:[]])).map((t=>E().U6.createChildStore(e,{table:W().KJ,id:t}))).slice(0,5)}),[t,x,y,b,m,null==o?void 0:o.parentBlockStore]),j=(0,c().VK)((()=>{const e=y.map((e=>e.getLastEditedTime())),t=b.map((e=>e.getCreatedTime()));return Math.max(...e,...t)}),[y,b]),w=(0,d().yK)((e=>({discussion:{background:a?e.hoveredMarginDiscussionBackground:e.contentBackground,width:no().Z,display:"flex",cursor:"pointer",border:`1px solid ${e.stroke.secondary}`,borderRadius:10,padding:"12px",alignItems:"center",gap:6},userAvatarsContainer:{display:"flex",justifyContent:"center",alignItems:"center",flexDirection:"row-reverse",marginRight:8},hiddenUsers:{fontSize:14,color:e.mediumTextColor,marginRight:6},lastEditedTime:{margin:"1px 0px 0px 0px",whiteSpace:"normal",display:"flex",justifyContent:"center",alignItems:"center",color:e.text.tertiary,fontSize:12,lineHeight:"15px"},commentAuthorAvatarStyle:{borderRadius:20,position:"relative",userSelect:"none",width:24,height:24,boxShadow:e.avatarBoxShadow,marginRight:-6},commentAuthorPlaceholderStyle:{width:20,height:20,borderRadius:20,marginRight:-3,position:"relative"},secondaryLabel:{fontSize:g().JB.UISmall.desktop,whiteSpace:"normal",display:"flex",justifyContent:"center",alignItems:"center",lineHeight:"21px",marginLeft:0,marginTop:0,color:e.text.tertiary},expandIcon:{width:g().JB.UISmall.desktop,height:g().JB.UISmall.desktop,fill:e.lightTextColor,marginTop:1},expandDiv:{display:"flex",justifyContent:"center",alignItems:"center",marginLeft:0}})),[a]),R=(0,B.jsx)("div",{style:w.secondaryLabel,children:(0,B.jsx)(p()._H,{defaultMessage:"Draft",id:"marginComments.collapsed.draft.label"})}),D=(0,B.jsxs)(B.Fragment,{children:[(0,B.jsx)("div",{style:w.expandDiv,children:(0,fo().s)(w.expandIcon)}),x?R:(0,B.jsx)("div",{style:w.secondaryLabel,children:(0,B.jsx)(p()._H,{defaultMessage:"Expand",id:"marginComments.collapsed.expand.label"})})]}),I=x?R:j&&(0,B.jsx)(C().Z,{isSmall:!0,isSecondaryColor:!0,isMultiline:!0,style:w.lastEditedTime,children:(0,B.jsx)(k().Z,{text:(0,L().IS)(j,{useUltraCompactFormat:!0}),tooltipText:(0,L().uy)(j),icon:M().C})});return(0,B.jsxs)("div",{style:w.discussion,onMouseEnter:h,onMouseLeave:f,onClick:v,className:ie().S9A,children:[(0,B.jsx)("div",{style:w.userAvatarsContainer,children:null==S?void 0:S.map((e=>(0,B.jsx)(Ee().S,{authorStore:e,avatarSize:24,avatarStyle:w.commentAuthorAvatarStyle,placeholderStyle:w.commentAuthorPlaceholderStyle},e.id)))}),(0,B.jsx)(yo,{reactionCount:b.length,commentCount:y.length+(x?1:0)}),a?D:I]})}function yo(e){const t=(0,d().yK)((e=>({commentCount:{fontSize:14,whiteSpace:"normal",marginLeft:0,color:e.text.primary,fontWeight:g().Ue.medium,lineHeight:"18px"},textPlaceholder:{background:e.lightDividerColor,height:14,width:81,borderRadius:4,marginLeft:4}})),[]);return e.commentCount>0?(0,B.jsx)("div",{style:t.commentCount,children:(0,B.jsx)(p()._H,{defaultMessage:"{numComments, plural, one {{numComments} comment} other {{numComments} comments}}",id:"marginComments.collapsed.numComments.count",values:{numComments:e.commentCount}})}):e.reactionCount>0?(0,B.jsx)("div",{style:t.commentCount,children:(0,B.jsx)(p()._H,{defaultMessage:"{numReactions, plural, one {{numReactions} reaction} other {{numReactions} reactions}}",id:"marginComments.collapsed.numReactions.count",values:{numReactions:e.reactionCount}})}):(0,B.jsx)("div",{style:t.textPlaceholder})}var bo=()=>o(177804),So=()=>o(141735),Co=()=>o(604068);function jo(e){let{discussionData:{parentBlockStore:t,discussionInputStore:o},isVisible:n}=e;const s=(0,i.useRef)(null),a=(0,r().O7)(),l=(0,i.useCallback)((async()=>{const e=await So().F.formulas.load();Co().Dc({environment:a,allowActionsWhileCommenting:!0,formulasModule:e})}),[a]),u=(0,c().VK)((()=>o.isEmpty()),[o]),m=(0,i.useCallback)((()=>{N().Z.setActiveWithSource("margin_comments")}),[]),p=(0,i.useCallback)((()=>{N().Z.resetActiveSource("margin_comments")}),[]),g=(0,i.useCallback)((()=>{u&&ho().default.reset(),N().Z.resetEditorActiveSources()}),[u]),h=(0,i.useCallback)((()=>{N().Z.setHoverWithSource("margin_comments")}),[]),f=(0,i.useCallback)((()=>{N().Z.resetHoverSource("margin_comments")}),[]),x=(0,i.useMemo)((()=>[`.${ie().mJW}`]),[]),v=(0,c().VK)((()=>N().Z.state.isActivelyComposing),[]),y=(0,c().VK)((()=>N().Z.state.isHovered&&!N().Z.state.isActivelyComposing),[]),b=Boolean(v||u);(0,bo().O)({active:n&&b,closeHandler:g,ref:s,excludedSelectors:x,ignoreKeydown:!0});const S=(0,d().yK)((e=>({discussion:{borderRadius:10,...v?{boxShadow:e.marginDiscussionSelectedShadow}:{border:`1px solid ${e.lightDividerColor}`},width:no().Z,background:e.selectedMarginDiscussionBackground,willChange:"transform",transition:"transform 200ms ease",transform:v?"translateX(-20px)":y?"translateX(-5px)":void 0},discussionInputContainer:{borderRadius:6,padding:"8px 0px 4px 12px",backgroundColor:y?e.hoveredMarginDiscussionBackground:void 0}})),[v,y]);return(0,B.jsx)("div",{style:S.discussion,ref:s,className:ie().S9A,onMouseEnter:h,onMouseLeave:f,children:(0,B.jsx)(yt().Z,{parentStore:t,discussionInputStore:o,shouldSaveUnsentComments:!1,isMobileSlideUpMenu:!1,discussionFormat:P().DiscussionFormat.Margin,onSubmit:l,onCancel:g,isNewComment:!0,blockStore:t,canDrop:!0,showAvatar:!1,containerStyle:S.discussionInputContainer,showCtaButtons:!0,onFocus:m,onBlur:p})})}function ko(e){let{discussionData:{discussionStore:t,parentBlockStore:n},timeMounted:s,onClick:a,isVisible:l,isDiscussionSelected:u,isDiscussionHovered:m}=e;const p=(0,i.useRef)(null),g=(0,r().O7)(),[f,x]=(0,i.useState)((()=>new(H().Z)(g,t.pointer.spaceId))),v=(0,le().E)("block_reactions"),y=t.id,b=(0,c().VK)((()=>t.getCommentStores().length>0),[t]),S=(0,c().VK)((()=>t.getReactionStores().length>0),[t]),C=(0,i.useMemo)((()=>[`.${(0,o(26970).dk)({discussionId:y})}`,`.${ie().mJW}`,`.${ie().S9A}`]),[y]),j=(0,i.useCallback)((async()=>{const e=I().Z.find((e=>e.isEditing()));if(e){if(!(await e.handleCancelEdit()))return}h().LZ()}),[]);(0,bo().O)({active:l&&u,closeHandler:j,ref:p,excludedSelectors:C,ignoreKeydown:!0});const k=(0,d().yK)((e=>({discussion:{border:u?void 0:`1px solid ${e.lightDividerColor}`,borderRadius:10,padding:u?"1px":void 0,background:u?e.selectedMarginDiscussionBackground:m?e.hoveredMarginDiscussionBackground:e.contentBackground,boxShadow:u?e.marginDiscussionSelectedShadow:void 0,width:no().Z,cursor:u?void 0:"pointer"},wrapper:{willChange:"transform",transition:"transform 200ms ease",transform:u?"translateX(-20px)":m?"translateX(-5px)":void 0}})),[m,u]),w=(0,i.useCallback)((async e=>{var n;u||(o(248825).Uw(g,{discussion_id:t.id,discussion_type:t.getType(),from:"margin_comments",parent_block_id:t.getParentId(),parent_collection_id:null===(n=t.getParentStore())||void 0===n?void 0:n.getParentCollectionIdUpToTwoLevels()}),await a(e,t))}),[a,t,u,g]);return(0,B.jsxs)("div",{className:ie().S9A,ref:p,style:k.wrapper,onClick:w,children:[S&&v&&(0,B.jsx)("div",{style:{width:no().Z},children:(0,B.jsx)(Ye,{focused:u,parentStore:t,discussionLocation:"margin_comments"})}),b&&(0,B.jsx)("div",{style:k.discussion,children:(0,B.jsx)(Gt,{store:t,blockStore:n,format:P().DiscussionFormat.Margin,isFirst:!1,isOnly:!1,showResolveButtonByDefaultIfPossible:!1,discussionLocation:"margin_comments",showAllRepliesAfterTimestamp:s,discussionInputStore:f,collapsed:!u})})]})}const wo=i.memo(ko);function _o(e){const{discussionData:t,isLastItem:o,isDiscussionSelected:n,discussionItemElementMap:s}=e,a=(0,d().yK)((()=>({discussionContainer:{transition:t.hide?void 0:"opacity 200ms ease-in-out",top:t.offsetTop,position:"absolute",paddingBottom:o?no().Vs:no().wo,zIndex:n?1:void 0,opacity:t.hide?0:1,display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center",pointerEvents:"auto"}})),[t.hide,t.offsetTop,n,o]);let l;const u=t.type,m=(0,r().O7)();(0,c().VK)((()=>(0,no().az)(m,t.parentBlockStore)),[m,t.parentBlockStore])?"existing"===u?l=(0,B.jsx)(wo,{...e,discussionData:t}):"new"===u?l=(0,B.jsx)(jo,{...e,discussionData:t}):"grouped"===u?l=(0,B.jsx)(vo,{...e,discussionData:t}):(0,$().t1)(u):l=null;const p=(0,i.useCallback)((()=>{go().Z.setState({source:"margin_comments",discussionIds:[t.id]})}),[t.id]),g=(0,i.useCallback)((()=>{go().Z.setState({discussionIds:[]})}),[]),h=(0,i.useCallback)((e=>{s.set(t.id,e)}),[t.id,s]);return(0,B.jsx)("div",{style:a.discussionContainer,onMouseEnter:p,onMouseLeave:g,ref:h,children:l})}const Lo=i.memo(_o),Mo=`.${po().zd}, .${po().FB}`;function Ro(e){let{pageBlockStore:t,timeMounted:n,isVisible:s,animating:a,pageViewBlockAccessor:l,width:u}=e;const m=(0,r().O7)(),p=(0,i.useRef)(null),g=(0,i.useRef)(new Map),h=(0,i.useRef)(new Map),f=(0,c().VK)((()=>go().Z.getFirstSelectedDiscussionId()),[]),x=(0,i.useCallback)((async(e,n)=>{(0,o(154057).X9)()||e.target instanceof Element&&e.target.closest(Mo)||await F().Ri({discussionStore:n,currentBlockStore:t,environment:m,analyticsFrom:"margin_comments",currentEl:p.current})}),[t,m]),[v,y]=(0,i.useState)({data:[],hasNewDiscussion:!1,selectedDiscussion:void 0}),[b,S]=(0,i.useState)(!1),{WindowSizeStore:C}=m,j=o(467171).R6(m.device.isElectronMac);(0,i.useEffect)((()=>{if(!s)return;const e=new(mo().default)((()=>({selectableRectMap:o(797522).default.state.selectableRectMap,pageContentStores:t.getContentStores(),sidebarIsAnimating:o(590972).default.state.isAnimating,windowHeight:C.state.height})),{debugName:"effectDataStore"}),n=new(mo().default)((()=>no().EM.state),{debugName:"discussionStoresStore"}),i=new(mo().default)((()=>{const e=ho().default.state,t=ho().default.getBlockStore(),n=ho().default.getClosestBlockStore();if(e.open&&e.rect&&"comment"===e.content&&(t||n)&&(!t||o(163085).Z.isBlockInFrame(t)&&!e.property_id))return{recomputeFocus:N().Z.state.isActivelyComposing,blockStore:t??e.blockStore,discussionInputStore:e.discussionInputStore}}),{debugName:"newMarginDiscussionArgsStore"}),r=new(mo().default)((()=>{if(!N().Z.state.isActivelyComposing)return A().Z.getFramePageFirstSelectedDiscussionId();A().Z.reset()}),{debugName:"selectedDiscussionIdStore"});let c=!1;const d=(0,Y().Ds)((()=>{const{selectableRectMap:o,pageContentStores:s,sidebarIsAnimating:d,windowHeight:u}=e.state,m=n.state,f=i.state,x=r.state;if(a||d)return;const C=l();if(!(C&&p.current&&o&&o.size))return;(0,no().H0)({discussionStores:m,pageContentStores:s,marginDiscussionItemRefs:g.current,selectedDiscussionId:x,newMarginDiscussionArgs:f,marginContainerElement:p.current,pageViewBlockElement:C,onComputeComplete:(e,t)=>{c||(h.current=t,b||S(!0),y(e))},computedOnce:b,topbarHeight:j,windowHeight:u,isFullWidth:t.isFullWidth(),prevSelectedDiscussionId:v.selectedDiscussion,previousDiscussionElements:h.current})}),5);return e.addListener(d),n.addListener(d),r.addListener(d),i.addListener(d),()=>{c=!0,e.removeListener(d),n.removeListener(d),r.removeListener(d),i.removeListener(d)}}),[s,a,l,b,t,v.selectedDiscussion,C,j]);const k=(0,d().yK)((()=>({marginCommentsContainer:{display:"flex",flexDirection:"column",paddingTop:8,paddingBottom:8,paddingLeft:no().fS,paddingRight:no().fS,width:u-2*no().fS,flexShrink:0,height:"100%",position:"relative",pointerEvents:"none",zIndex:o(492522).p8}})),[u]);return(0,B.jsx)("div",{style:k.marginCommentsContainer,ref:p,children:v.data.map(((e,t)=>(0,B.jsx)(Lo,{discussionData:e,timeMounted:n,onClick:x,isVisible:s,discussionItemElementMap:g.current,isDiscussionSelected:e.selected||"new"===e.type,isDiscussionHovered:e.id===f,isLastItem:t===v.data.length-1},`margin-discussion-${e.id}`)))})}const Bo=i.memo(Ro);function Do(e){let{pageBlockStore:t,isVisible:o,pageViewBlockAccessor:n,context:s,isCollapsedAnchor:a}=e;const[l,u]=(0,i.useState)(!1),m=(0,r().O7)(),p=(0,i.useMemo)((()=>(new Date).getTime()),[]),g=(0,c().VK)((()=>t.isFullWidth()||s===uo().S.CollectionPageView),[s,t]),h=(0,c().VK)((()=>"floating_right"===co().default.getEligibleGroup({experimentId:"floating_table_of_contents_variants",defaultGroup:"control"})),[]),f=(0,c().VK)((()=>a?{paddingLeft:g?96:h?16:42,height:0}:g?void 0:{position:"absolute",right:(0,no().oS)(m,(0,lo().wq)(t),(0,ao().Ks)(t))}),[a,g,m,t,h]),x=(0,i.useCallback)((()=>{u(!0)}),[]),v=(0,i.useCallback)((()=>{u(!1)}),[]),y=(0,d().yK)((()=>({marginCommentsSection:{display:o||l?"flex":"none",flexShrink:0,pointerEvents:"none",width:o?no().QB:0,...f}})),[o,l,f]);return(0,B.jsx)(we().Z,{animate:{opacity:o?1:0},onAnimationStart:x,onAnimationEnd:v,style:y.marginCommentsSection,children:(0,B.jsx)(Bo,{pageBlockStore:t,timeMounted:p,isVisible:o,animating:l,pageViewBlockAccessor:n,width:no().QB})})}var Io=()=>o(573357),To=()=>o(967092),Ao=()=>o(299519);const Zo=function(e){const{capture:t,children:n}=e,s=(0,i.useRef)(null);return(0,l().c)(o(81821).Z,(()=>({getNode:()=>s.current,isCaptured:()=>t})),[t]),(0,B.jsx)("div",{ref:s,children:i.Children.only(n)})};var Eo=()=>o(10271),Fo=()=>o(104088);function Ko(e){let{blockStore:t,discussionInputStore:o,handleDismiss:n}=e;const s=(0,r().O7)(),{device:a,WindowSizeStore:l}=s,u=(0,i.useCallback)((async()=>{const e=await So().F.formulas.load();Co().Dc({environment:s,allowActionsWhileCommenting:!0,formulasModule:e})}),[s]),m=(0,c().VK)((()=>({paddingLeft:a.isMobileNative?l.getSafePaddingLeftCSS(12):12,paddingRight:a.isMobileNative?l.getSafePaddingRightCSS(8):8})),[l,a.isMobileNative]),p=(0,d().yK)((()=>({inputWrapper:{width:a.isMobileNative?"100%":470,maxWidth:a.isMobileBrowser?"90vw":"100%",paddingTop:9,paddingBottom:a.isAndroid?12:8,paddingLeft:m.paddingLeft,paddingRight:m.paddingRight}})),[a,m]);return(0,Eo().Z)({shouldPreserveTextSelection:!0,shouldPreserveBlockSelection:!0,shouldRestoreSelection:!0}),(0,B.jsx)(Io().Z,{capture:!0,allowOpenLinkMenu:!0,render:()=>(0,B.jsx)(Ao().Z,{store:t,droppable:!0,render:()=>(0,B.jsx)(Zo,{capture:!0,children:(0,B.jsx)("div",{style:p.inputWrapper,children:(0,B.jsx)(yt().Z,{showAvatar:!0,parentStore:t,onCancel:n,onSubmit:u,discussionInputStore:o,isMobileSlideUpMenu:!0,shouldSaveUnsentComments:!1,discussionFormat:P().DiscussionFormat.Page,blockStore:t,canDrop:!0})})})},t.id)})}const Vo=function(){const e=(0,r().O7)(),t=(0,r().MO)(),n=(0,c().VK)((()=>ho().default.state.rect),[]),s=(0,c().VK)((()=>{if(ho().default.state.open&&"comment"===ho().default.state.content){const{discussionInputStore:o}=ho().default.state;if((0,oo().vK)(e))return null;if(ho().default.updateRect(),N().Z.state.isActivelyComposing){"comments_pane"===N().Z.state.clickEntryPoint&&N().Z.setActiveWithSource("popover_comments");const n=ho().default.getBlockStore();var t;if(n)return{blockStore:n,discussionInputStore:o,canMarginCommentsRender:!(null!==(t=ho().default.state)&&void 0!==t&&t.property_id)&&(0,no().az)(e,n)}}}return null}),[e]),a=(0,i.useCallback)((()=>{const t=null==s?void 0:s.discussionInputStore;t&&(0,o(40302).l)({discussionInputStore:t,environment:e})}),[e,s]),l=(0,i.useCallback)((()=>{ho().default.hasContent()?N().Z.resetEditorActiveSources():s&&(0,o(300329).C)(e)}),[e,s]);(0,i.useEffect)((()=>{function t(t){const n=ho().default.state,i=n.open&&"comment"===n.content&&n.discussionInputStore||void 0;i&&((0,o(879920).uK)({discussionInputStore:i,environment:e,discussionHelpers:P()}),t.preventDefault())}return window.addEventListener("beforeunload",t),()=>{window.removeEventListener("beforeunload",t)}}),[e]);const d=(0,c().VK)((()=>o(121700).Z.state.isOpen),[]);return(0,c().VK)((()=>N().Z.state.overlapsExistingDiscussionMenu),[])?null:(0,B.jsx)(To().ZP,{popupType:t?Fo().k.SlideUp:Fo().k.Popup,keepFocus:!0,open:null!==s&&(!s.canMarginCommentsRender||d),originRect:n,placementToOrigin:T().Placement.Bottom,alignmentToOrigin:T().Alignment.Center,originGap:4,onDismiss:l,render:()=>s?(0,B.jsx)(Ko,{blockStore:s.blockStore,discussionInputStore:s.discussionInputStore,handleDismiss:l}):null,onAnimationEnd:a})};var Po=()=>o(832924),Uo=()=>o(882637);const Ho=function(){const e=(0,r().O7)(),{device:t}=e,{open:o,rect:n}=(0,c().VK)((()=>{const{open:e,rect:t}=Uo().default.state;return{open:e,rect:t}}),[]);return(0,B.jsx)(To().ZP,{popupType:t.isMobile?Fo().k.SlideUp:Fo().k.Popup,open:o,originRect:n,placementToOrigin:T().Placement.Bottom,alignmentToOrigin:T().Alignment.Center,originGap:4,onDismiss:()=>K().UZ(e),render:()=>(0,B.jsx)(No,{})})};function No(){const e=(0,r().O7)(),{device:t}=e,o=(0,c().Kw)(Uo().default),n=(0,c().VK)((()=>Uo().default.state.open?Uo().default.state.discussionInputStore.state.textStore.getValue():null),[]);if((0,i.useEffect)((()=>{var e;const t=null===(e=Po().default.MenuScroller)||void 0===e?void 0:e.getNode();null==t||t.scrollTo({top:t.scrollHeight})}),[n,o]),o.open){const{discussionStore:n,discussionInputStore:i,blockStore:s,discussionLocation:r}=o;let a;return a=t.isMobile?{menuType:se().o.Modal,title:(0,B.jsx)(p()._H,{defaultMessage:"Comments",id:"discussion.mobileReplyMenu.title"}),right:(0,B.jsx)(p()._H,{defaultMessage:"Close",id:"discussion.mobileReplyMenu.closeButton.label"}),onClickRight:()=>K().UZ(e),whiteBackground:!0}:{menuType:se().o.Popup,width:420,minHeight:"100px",maxHeight:"50vh",maxWidth:"100%"},(0,B.jsx)(Q().Z,{className:ie().LoZ,...a,children:(0,B.jsx)(Io().Z,{capture:!0,allowMobileAutoScroll:!0,render:()=>"post_discussion"!==r?(0,B.jsx)(Gt,{store:n,discussionInputStore:i,onDismiss:()=>K().UZ(e),format:P().DiscussionFormat.Menu,isFirst:!0,isOnly:!0,discussionLocation:r,showResolveButtonByDefaultIfPossible:!0,blockStore:s,collapsed:!1}):null})})}return null}var Oo=()=>o(552814)},83447:(e,t,o)=>{"use strict";o.d(t,{Z:()=>l});o(667294);var n=()=>o(846550),i=()=>o(788860),s=()=>o(654133),r=()=>o(623596),a=o(785893);function l(e){const{onClick:t}=e,o=(0,n().yK)((e=>({moreCommentsWrapper:{position:"absolute",display:"flex",justifyContent:"center",alignItems:"flex-start",zIndex:1,left:0,right:0,height:30,background:`linear-gradient(to bottom, ${e.contentBackgroundTransparent} 0px, ${e.selectedMarginDiscussionBackground} 30px`,marginTop:-28},tooltip:{...(0,s().J)(e,!1),cursor:"pointer",display:"flex",justifyContent:"center",alignItems:"center",marginTop:-4,borderRadius:6,padding:"4px 10px 4px 8px"}})),[]),l=(0,n().Fg)();return(0,a.jsx)("div",{style:o.moreCommentsWrapper,children:(0,a.jsxs)("div",{style:o.tooltip,onClick:t,children:[(0,a.jsx)("div",{style:{marginRight:5},children:(0,r().K)({fill:l.regularInvertedTextColor,height:12,width:12})}),(0,a.jsx)(i()._H,{defaultMessage:"See more",id:"discussion.moreMessageTooltip"})]})})}},46335:(e,t,o)=>{"use strict";o.d(t,{Z:()=>l});o(667294);var n=()=>o(846550),i=()=>o(707513),s=()=>o(998901),r=()=>o(654133),a=o(785893);function l(e){let{text:t,tooltipText:o,icon:l}=e;const c=(0,n().yK)((e=>({icon:{height:"1em",width:"1em",marginRight:"0.25em",fill:e.mediumIconColor,marginBottom:"0.1em"},tooltip:{background:e.contentBackground,boxShadow:e.lightBoxShadow},container:{display:"flex",alignItems:"center",fontWeight:i().Ue.regular,color:e.mediumTextColor,fontSize:i().JB.UISmall.desktop,textAlign:"center"},text:{display:"inline"}})),[]);return(0,a.jsx)(r().Z,{style:c.tooltip,render:e=>(0,a.jsx)("div",{style:c.text,...e,children:t}),renderTooltip:()=>(0,a.jsxs)("div",{style:c.container,children:[l(c.icon),(0,a.jsx)("div",{children:o})]}),alignment:s().Alignment.Start,placement:s().Placement.Bottom})}},455241:(e,t,o)=>{"use strict";o.d(t,{d:()=>a});o(667294);var n=()=>o(846550),i=()=>o(788860),s=()=>o(653457),r=o(785893);function a(e){const{href:t,style:o}=e,a=(0,n().yK)((e=>({default:{display:"flex",marginTop:7,marginBottom:7,alignItems:"center",cursor:"pointer",textDecoration:"none",pointerEvents:"auto",width:"fit-content",color:e.mediumTextColor}})),[]);return(0,r.jsxs)("a",{href:t,target:"_blank",style:{...a.default,...o},children:[(0,s().m)({width:14,marginRight:4}),(0,r.jsx)(i()._H,{id:"LearnMoreLink.learnMore",defaultMessage:"Learn more"})]})}},81821:(e,t,o)=>{"use strict";o.d(t,{Z:()=>i});class n extends(()=>o(442))().Z{}const i=new n},981697:(e,t,o)=>{"use strict";o.d(t,{Z:()=>s});var n=o(667294),i=()=>o(219727);function s(e){const t=(0,i().O7)(),{onLongPress:o,hapticsEnabled:s=!0,timeout:r=300}=e,a=(0,n.useCallback)((()=>{var e,n,i;s&&(null!==(e=t.mobileNative)&&void 0!==e&&e.buzz?t.mobileNative.buzz():null===(n=(i=window.navigator).vibrate)||void 0===n||n.call(i,20));o()}),[t.mobileNative,s,o]),l=(0,n.useRef)(),c=(0,n.useRef)(0),d=(0,n.useRef)(0),u=(0,n.useCallback)((()=>clearTimeout(l.current)),[]);(0,n.useEffect)((()=>u),[u]);return{onTouchStart:(0,n.useCallback)((()=>{clearTimeout(l.current),l.current=setTimeout(a,r)}),[r,a]),onTouchMove:(0,n.useCallback)((e=>{const t=e.touches[0].clientX,o=e.touches[0].clientY;(Math.abs(t-c.current)>50||Math.abs(o-d.current)>50)&&clearTimeout(l.current)}),[]),onTouchEnd:u,onTouchCancel:u}}},688798:(e,t,o)=>{"use strict";o.d(t,{V:()=>i});o(667294);var n=o(785893);const i=(0,o(827282).IU)("arrowLeft",{viewBox:"0 0 30 30",svg:(0,n.jsx)("polygon",{points:"29 14 4.813 14 13.406 5.406 12 4 1 15 12 26 13.406 24.594 4.813 16 29 16"})})},912203:(e,t,o)=>{"use strict";o.d(t,{$M:()=>f,GQ:()=>C,Jy:()=>w,LF:()=>k,NO:()=>p,Of:()=>_,SF:()=>u,TX:()=>S,XO:()=>x,Y_:()=>d,Ym:()=>h,bD:()=>y,cO:()=>m,fo:()=>j,rR:()=>g});o(267602),o(653476),o(228244);var n=()=>o(513670),i=()=>o(696459),s=()=>o(226413),r=()=>o(109477),a=()=>o(455222),l=()=>o(305580);(0,i().AO)((e=>(0,i().$K)(e)&&(0,i().$K)(e.target)&&(0,i().$K)(e.external_bot_id)?{true:{external_bot_id:e.external_bot_id,target:e.target}}:{false:e}));const c={checkbox:!0,date:!0,email:!0,multi_select:!0,number:!0,person:!0,phone_number:!0,relation:!0,select:!0,status:!0,text:!0,title:!0,url:!0,auto_increment_id:!1,button:!1,created_by:!1,created_time:!1,file:!1,formula:!1,last_edited_by:!1,last_edited_time:!1,last_visited_time:!1,location:!1,rollup:!1,verification:!1},d={checkbox:[{type:"checkbox"}],date:[{type:"date"}],email:[{type:"text"}],multi_select:[{type:"text"},{of:{type:"text"},type:"array"}],number:[{type:"number"}],person:[{type:"person"},{of:{type:"person"},type:"array"}],phone_number:[{type:"text"}],relation:[{type:"block"},{of:{type:"block"},type:"array"}],select:[{type:"text"},{of:{type:"text"},type:"array"}],status:[{type:"text"},{of:{type:"text"},type:"array"}],text:void 0,title:void 0,url:[{type:"text"}]};function u(e){return Boolean(c[e.type]&&!(0,s().NK)(e)&&(!(0,s().qQ)(e)||void 0===(0,s().q3)(e)))}function m(e){const{collectionFormat:t,collectionSchema:o,filter:a,sort:c,sourcePropertyIds:d}=e,m=(d??(0,i().Yd)(o)).filter(((t,n,i)=>{const r=o[t];return!(!r||!u(r))&&(("relation"!==r.type||!e.restrictCrossSpace||!(0,s().Qh)(e.spaceId,r))&&(!a||a([t,r],n,o)))}));if(0===m.length)return[];if(!t||!1===c)return m;const p=(0,l().i)(t,o,void 0,r().j5.Page).collection_page_properties||[];return n().MR(m,(e=>p.findIndex((t=>t.property===e))))}function p(e){const{collectionFormat:t,collectionSchema:o,sort:a}=e,c=(0,i().Yd)(o).filter(((e,t,n)=>{const i=o[e];return!(!i||!(0,s().U8)(i))}));if(0===c.length)return[];if(!t||!1===a)return c;const d=(0,l().i)(t,o,void 0,r().j5.Page).collection_page_properties||[];return n().MR(c,(e=>d.findIndex((t=>t.property===e))))}function g(e){return e.type===a().$E.InvalidCharacter?{type:e.type,character:e.character}:e.type===a().$E.TokenExpected?{type:e.type,token:e.token}:e.type===a().FY.MissingSchemaPropertyOnThisRow||e.type===a().FY.MissingSchemaPropertyOnCollection?{type:e.type,collectionId:e.collectionId,property:e.property}:e.type===a().FY.ThisRowBlockPropertyMismatchCollection?{type:e.type,thisRowCollection:e.thisRowCollection}:e.type===a().FY.MissingContextVariable?{type:e.type,valueId:e.valueId}:e.type===a().FY.FunctionCallTooFewArguments?{type:e.type,numArguments:e.numArguments}:e.type===a().FY.FunctionCallUnexpectedArgument?{type:e.type,parameterIndex:e.parameterIndex}:e.type===a().FY.FunctionCallArgumentWrongType?{type:e.type,argumentType:e.argumentType,libraryFunctionName:e.libraryFunction.name,parameterIndex:e.parameterIndex}:e.type===a().FY.MissingDataDependencyBlock?{type:e.type,blockPointer:e.blockPointer}:e.type===a().FY.MissingDataDependencyPerson?{type:e.type,personPointer:e.personPointer}:e.type===a().FY.MemberPropertyMismatchCollection?{type:e.type,blockCollection:e.blockCollection}:e.type===a().FY.DownstreamParseFailure?{type:e.type,collectionId:e.collectionId,property:e.property}:e.type===a().FY.ContextVariableWrongType?{type:e.type,valueId:e.valueId,expectedType:e.expectedType,resultType:e.resultType}:e.type===a().FY.DisallowedValueType?{type:e.type,expressionValue:e.expressionValue,allowedValueTypes:e.allowedValueTypes}:e.type===a().FY.LibraryFunctionExecutionError?{type:e.type,error:e.error,libraryFunctionName:e.libraryFunction.name}:{type:e.type}}const h={checkbox:!0,date:!0,email:!0,multi_select:!0,number:!0,person:!0,phone_number:!0,relation:!0,select:!0,status:!0,text:!0,title:!0,url:!0,button:!1,file:!1,verification:!1,auto_increment_id:!1,created_by:!1,created_time:!1,formula:!1,last_edited_by:!1,last_edited_time:!1,last_visited_time:!1,location:!1,rollup:!1};function f(e){return Boolean(h[e.type])}function x(e){const{collectionFormat:t,collectionSchema:o,filter:a,sort:c}=e,d=(0,i().Yd)(o).filter(((e,t,n)=>{var i;const r=o[e];return!(!r||!h[r.type])&&((!(0,s().qQ)(r)||null===(i=(0,s().q3)(r))||void 0===i||!i.auto_update_on_edit)&&(!a||a([e,r],t,o)))}));if(0===d.length)return[];if(!t||!1===c)return d;const u=(0,l().i)(t,o,void 0,r().j5.Page).collection_page_properties||[];return n().MR(d,(e=>u.findIndex((t=>t.property===e))))}const v={checkbox:!0,email:!0,multi_select:!0,number:!0,person:!0,phone_number:!0,relation:!0,select:!0,status:!0,text:!0,title:!0,url:!0,auto_increment_id:!1,button:!1,created_by:!1,created_time:!1,date:!1,file:!1,formula:!1,last_edited_by:!1,last_edited_time:!1,last_visited_time:!1,location:!1,rollup:!1,verification:!1};function y(e){return v[e.type]}const b={checkbox:!0,created_by:!0,created_time:!0,date:!0,email:!0,multi_select:!0,number:!0,person:!0,phone_number:!0,relation:!0,select:!0,status:!0,text:!0,title:!0,url:!0,last_edited_by:!0,last_edited_time:!0,auto_increment_id:!1,button:!1,file:!1,formula:!1,last_visited_time:!1,location:!1,rollup:!1,verification:!1};function S(e){return b[e.type]}function C(e){return 0===e}function j(e){return function(e){return"button_block"===e||"button_property"===e}(e)}function k(e){const{property:t,collectionSchema:o}=e;return!!o&&!o[t]}function w(e){const{collectionSchema:t,property:o,type:n}=e,i=null==t?void 0:t[o];return!i||("action"===n?!u(i):!h[i.type])}function _(e){let{automationTrigger:t,collectionSchema:o}=e;if("event"===(null==t?void 0:t.type)||"notification_event"===(null==t?void 0:t.type)){const{pagesAdded:e,pagePropertiesEdited:n,source:s}=t.event;if(void 0===s)return!1;const r="some"===n.type&&n.some,a="all"===n.type&&n.all;if((r||a||[]).some((e=>k({collectionSchema:o,property:e.property})||w({collectionSchema:o,property:e.property,type:"trigger"}))))return!1;const l="some"===n.type&&(!(0,i().$K)(n.some)||0===n.some.length),c="all"===n.type&&(!(0,i().$K)(n.all)||0===n.all.length);if(!e&&("none"===n.type||l||c))return!1}else{if("recurrence"!==(null==t?void 0:t.type))return!1;if(!t.recurrence)return!1}return!0}},157955:(e,t,o)=>{"use strict";o.r(t),o.d(t,{DEFAULT_MAX_RECURRENCE_DUPLICATION_PER_TASK:()=>R,MAXIMUM_DAILY_RECURRENCES_IN_PATH:()=>C,MAXIMUM_NESTED_RECURRENCE_LEVEL:()=>S,MAX_RECURRENCE_INTERVAL:()=>f,MAX_RECURRENCE_NUMBER_OF_RUNS:()=>x,RRULE_WEEKDAYS_MAP:()=>h,convertFromUnpersistedRecurrenceConfig:()=>I,convertToUnpersistedRecurrenceConfig:()=>B,getFormattedEndCondition:()=>M,getFormattedNextRecurrenceTime:()=>L,getNextDateUtc:()=>_,getRecurrenceAfter:()=>k,isRunningBetweenMidnightAnd3AM:()=>w,isValidRecurrenceInterval:()=>v,isValidRecurrenceNumberOfRuns:()=>y,rruleFromRecurrence:()=>b,templateAncestorsViolateRecurrenceNesting:()=>j});o(267602),o(653476),o(241792);var n=()=>o(730120);o(670560);function i(e){for(var t=arguments.length,o=new Array(t>1?t-1:0),n=1;n<t;n++)o[n-1]=arguments[n];if(0===o.length)return e.map((e=>[e]));const s=[];for(const r of e)s.push(...i(o[0],...o.slice(1)).map((e=>[r,...e])));return s}var s=()=>o(696459),r=()=>o(326966),a=()=>o(803021),l=()=>o(646574),c=()=>o(998411),d=()=>o(578292);class u extends(()=>o(484885))().Ci{constructor(e,t){super(e,t)}after(e,t){return super.after(e,t)}}var m=()=>o(494616);const p=(0,o(788860).vU)({dateAtTime:{id:"automations.recurrenceHelpers.dateAtTime",defaultMessage:"{date} at {time}"},dateBetweenMidnightAnd3AM:{id:"automations.recurrenceHelpers.dateBetweenMidnightAnd3AM",defaultMessage:"{date} between 12–3 AM"},numberEndConditionDescription:{id:"automations.recurrenceHelpers.numberEndConditionDescription",defaultMessage:"{number, plural, one {After {number} run} other {After {number} runs}}"},noEndCondition:{id:"automations.recurrenceHelpers.noEndCondition",defaultMessage:"Never"}}),g={day:u.DAILY,week:u.WEEKLY,month:u.MONTHLY,year:u.YEARLY},h={MO:u.MO,TU:u.TU,WE:u.WE,TH:u.TH,FR:u.FR,SA:u.SA,SU:u.SU},f=99,x=999;function v(e){return(0,r().hj)(e)&&Number.isInteger(e)&&e>0&&e<=f}function y(e){return(0,r().hj)(e)&&Number.isInteger(e)&&e>0&&e<=x}function b(e){const{start_date:t,frequency:o,interval:n,weekdays:r,timezone:l,hour:c,minute:d}=e,m="week"===o&&r?r.map((e=>h[e])):void 0,p={};return(0,s().$K)(e.end_condition)&&("date"===e.end_condition.type?p.until=(0,a().pd)(e.end_condition.end_at):"number"===e.end_condition.type?p.count=e.end_condition.number_of_occurrences:(0,s().t1)(e.end_condition)),"month"===e.frequency&&(0,s().$K)(e.monthly_restriction)&&("monthdays"===e.monthly_restriction.type?p.bymonthday=e.monthly_restriction.monthdays:"weekdays_in_month"===e.monthly_restriction.type?p.byweekday=i(e.monthly_restriction.weekdays,e.monthly_restriction.week_numbers).map((e=>{let[t,o]=e;return h[t].nth(o)})):(0,s().t1)(e.monthly_restriction)),new u({freq:g[o],dtstart:(0,a().pd)(t),interval:n,byweekday:m,tzid:l,byhour:c??0,byminute:d??0,bysecond:0,...p})}const S=1,C=1;function j(e){var t;if(0===e.length)return{violatesConstraint:!1,templateNestingExceedsMaxDepth:!1,ancestorHasDailyTemplate:!1,nestedDepthOfAutomationAncestors:void 0,immediateAncestorRecurrenceType:void 0};const o=e.filter((e=>{var t;return"day"===(null===(t=e.getRecurrence())||void 0===t?void 0:t.frequency)})),n=e.length,i=null===(t=e[0].getRecurrence())||void 0===t?void 0:t.frequency,s=n>S,r=o.length>=C;return{violatesConstraint:s||r,templateNestingExceedsMaxDepth:s,ancestorHasDailyTemplate:r,nestedDepthOfAutomationAncestors:n,immediateAncestorRecurrenceType:i}}function k(e){const{recurrence:t,afterDate:o}=e;if((0,m().nA)(t)){const e=(0,a().kq)(o);return t.start_date>=e?new Date(t.start_date):void 0}{const e=b(t).after((0,a().pd)(o));if(!e)return;return(0,a().YL)(e)}}function w(e){return 0===e.hour||1===e.hour||2===e.hour}function _(e){return b(e).after((0,a().pd)((0,a().Jh)()))||void 0}function L(e){const{recurrence:t,intl:o}=e,i=_(I(t));if(!i)return;const s=w(t),r=n().ou.fromJSDate(i).toUTC().setZone("local",{keepLocalTime:!0}).setLocale((0,d().E2)(o)).setZone(t.timezone),a=(0,l().p6)({date:r,dateFormat:"relative",allowRelativeDates:!0,intl:o,shortenDate:!0});if(s)return o.formatMessage(p.dateBetweenMidnightAnd3AM,{date:a});{let e=r.toLocaleString(n().ou.TIME_SIMPLE);return t.timezone!==(0,c().r)()&&(e+=` ${r.toFormat("ZZZZ")}`),o.formatMessage(p.dateAtTime,{date:a,time:e})}}function M(e,t){return(0,s().$K)(e)?"number"===e.type?t.formatMessage(p.numberEndConditionDescription,{number:e.number_of_occurrences}):"date"===e.type?(0,l().p6)({date:n().ou.fromMillis(e.end_at),dateFormat:"relative",allowRelativeDates:!0,intl:t,shortenDate:!0}):void(0,s().t1)(e):t.formatMessage(p.noEndCondition)}const R=100;function B(e){return{...e,start_date:(0,a().kq)(e.start_date),end_condition:e.end_condition?"number"===e.end_condition.type?e.end_condition:"date"===e.end_condition.type?{type:"date",end_at:(0,a().kq)(e.end_condition.end_at)}:(0,s().t1)(e.end_condition):void 0}}function D(e,t){const o=n().ou.fromMillis(t.end_at).set({hour:e.hour??0,minute:e.minute??0});return{type:"date",end_at:(0,a().Jh)(o.toJSDate())}}function I(e){return{...e,start_date:(0,a().Jh)(new Date(e.start_date)),end_condition:e.end_condition?"number"===e.end_condition.type?e.end_condition:"date"===e.end_condition.type?D(e,e.end_condition):(0,s().t1)(e.end_condition):void 0}}},742922:(e,t,o)=>{"use strict";o.d(t,{y:()=>i});o(667294);var n=o(785893);const i=(0,o(827282).IU)("codeFile",{viewBox:"0 0 23 24",svg:(0,n.jsx)("path",{d:"M4.195 11.86c0-.266.078-.488.235-.665.156-.182.38-.3.672-.351.494-.089.849-.271 1.062-.547.214-.281.32-.73.32-1.344V6.961c0-1.115.263-1.938.79-2.469.525-.536 1.333-.804 2.421-.804.203 0 .375.023.516.07.177.057.31.146.398.265a.646.646 0 01.141.422c0 .339-.148.558-.445.657a1.14 1.14 0 01-.157.039l-.171.015c-.625.047-1.066.222-1.32.524-.256.302-.384.8-.384 1.492v2.414c0 .672-.182 1.198-.546 1.578-.36.38-.86.604-1.5.672-.032 0-.047.013-.047.039.005.02.02.034.047.04.64.062 1.14.283 1.5.663.364.38.546.906.546 1.578v2.414c0 .693.128 1.19.383 1.492.255.303.696.48 1.32.532.053 0 .1.002.141.008l.133.03c.333.09.5.308.5.657a.68.68 0 01-.14.43.816.816 0 01-.407.273 1.48 1.48 0 01-.437.063c-1.12 0-1.948-.266-2.485-.797-.531-.526-.797-1.352-.797-2.477V14.79c0-.614-.106-1.062-.32-1.344-.213-.28-.568-.463-1.062-.547-.292-.062-.516-.182-.672-.359-.157-.177-.235-.404-.235-.68zm15.602 0c0 .275-.078.502-.235.68-.156.176-.382.296-.68.358-.5.084-.856.266-1.07.547-.208.282-.312.73-.312 1.344v1.992c0 1.125-.266 1.95-.797 2.477-.531.531-1.36.797-2.484.797-.151 0-.297-.021-.438-.063a.757.757 0 01-.414-.265.715.715 0 01-.133-.438c0-.182.042-.328.125-.437a.674.674 0 01.383-.22l.117-.03c.047-.006.097-.008.149-.008.625-.052 1.065-.23 1.32-.532.255-.302.383-.799.383-1.492v-2.414c0-.672.182-1.208.547-1.61.364-.405.864-.616 1.5-.632.026-.005.039-.018.039-.039 0-.026-.013-.04-.04-.04-.635-.015-1.135-.226-1.5-.632-.364-.406-.546-.945-.546-1.617V7.172c0-.693-.128-1.193-.383-1.5-.255-.307-.695-.48-1.32-.516l-.18-.015a1.233 1.233 0 01-.148-.04c-.297-.109-.446-.328-.446-.656 0-.166.045-.307.133-.422a.777.777 0 01.414-.265c.14-.047.31-.07.508-.07 1.089 0 1.896.268 2.422.804.526.531.789 1.354.789 2.469v1.992c0 .615.107 1.06.32 1.336.214.276.568.461 1.063.555.297.052.523.169.68.351a.967.967 0 01.234.664z"})})},400939:e=>{var t=/[a-zA-Z0-9_\u0392-\u03c9\u00c0-\u00ff\u0600-\u06ff]+|[\u4e00-\u9fff\u3400-\u4dbf\uf900-\ufaff\u3040-\u309f\uac00-\ud7af]+/g;e.exports=function(e){var o=e.match(t),n=0;if(!o)return 0;for(var i=0;i<o.length;i++)o[i].charCodeAt(0)>=19968?n+=o[i].length:n+=1;return n}}}]);